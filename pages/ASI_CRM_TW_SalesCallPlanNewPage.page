<apex:page standardController="ASI_HK_CRM_Visitation_Plan_Detail__c" extensions="ASI_CRM_TW_SalesCallPlanPageNewCtrl" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false" cache="false" showHeader="false" standardStylesheets="false" action="{!dateValidation}" id="apexPage">
<html> 
<head> 
    <title>拜訪日報</title>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/> 
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/css/app.min.css')}"/>       
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/jQuery2.0.2.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/jquery.touchwipe.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/main.min.js')}"/>
    
    <script src="{!URLFOR($Resource.ASI_CRM_TW_jQuery, 'jquery-1.11.1.min.js')}"></script>


    <!-- Salesforce1 -->    
    <apex:includeScript value="/canvas/sdk/js/publisher.js" />
    
    <style type="text/css">
    .spinner {
        position: absolute;
        left: 50%;
        top: 50%;
        height:60px;
        width:60px;
        margin:0px auto;
        -webkit-animation: rotation .6s infinite linear;
        -moz-animation: rotation .6s infinite linear;
        -o-animation: rotation .6s infinite linear;
        animation: rotation .6s infinite linear;
        border-left:6px solid rgba(0,174,239,.15);
        border-right:6px solid rgba(0,174,239,.15);
        border-bottom:6px solid rgba(0,174,239,.15);
        border-top:6px solid rgba(0,174,239,.8);
        border-radius:100%;
        z-index:99;
    }

    @-webkit-keyframes rotation {
    from {-webkit-transform: rotate(0deg);}
    to {-webkit-transform: rotate(359deg);}
    }
    @-moz-keyframes rotation {
    from {-moz-transform: rotate(0deg);}
    to {-moz-transform: rotate(359deg);}
    }
    @-o-keyframes rotation {
    from {-o-transform: rotate(0deg);}
    to {-o-transform: rotate(359deg);}
    }
    @keyframes rotation {
    from {transform: rotate(0deg);}
    to {transform: rotate(359deg);}
    }
    </style>

    <!-- CSS goes in the document HEAD or added to your external stylesheet -->
    <style type="text/css">
        /* Added by Victor (introv) 20201225 for 6th tab */
        .span-one-sixth {
            display: block;
            position: relative;
            float: left;
            width: 16.66%;
        }
        .number_of_mouth{width:10%;height:20px}
        table a:link {
            color: #666;
            //font-weight: bold;
            text-decoration:underline;
        }
        table a:visited {
            color: #999999;
            font-weight:bold;underline;
        }
        table a:active,
        table a:hover {
            color: #bd5a35;
            text-decoration:underline;
        }
        table {
            font-family:Century Gothic, sans-serif, Microsoft JhengHei;
            color:#666;
            font-size:10px;
            text-shadow: 1px 1px 0px #fff;
            background:#eaebec;
            
            //border:#ccc 1px solid;
        
            -moz-border-radius:10px;
            -webkit-border-radius:10px;
            border-radius:10px;
        
            -moz-box-shadow: 0 1px 2px #d1d1d1;
            -webkit-box-shadow: 0 1px 2px #d1d1d1;
            box-shadow: 0 1px 2px #d1d1d1;          
        }
        table th {
            padding:5px 10px 5px 10px;
            //border-top:1px solid #fafafa;
            //border-bottom:1px solid #e0e0e0;
        
            //background: #ddeeff;
            //background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));
            //background: -moz-linear-gradient(top,  #FF9966,  #FF9966);
        }
        table th:first-child {
            text-align: left;
            padding-left:20px;
        }
        table tr:first-child th:first-child {
            -moz-border-radius-topleft:10px;
            -webkit-border-top-left-radius:10px;
            border-top-left-radius:10px;
        }
        table tr:first-child th:last-child {
            -moz-border-radius-topright:10px;
            -webkit-border-top-right-radius:10px;
            border-top-right-radius:10px;
        }
        table tr {
            text-align: center;
            padding-left:20px;
        }
        table td:first-child {
            text-align: left;
            padding-left:20px;
            border-left: 0;
        }
        table td {
            padding:13px;
            //border-top: 1px solid #ffffff;
            //border-bottom:1px solid #e0e0e0;
            //border-left: 1px solid #e0e0e0;
        
            background: #fafafa;
            background: -webkit-gradient(linear, left top, left bottom, from(#fbfbfb), to(#fafafa));
            background: -moz-linear-gradient(top,  #fbfbfb,  #fafafa);
        }
        table tr.even td {
            background: #f6f6f6;
            background: -webkit-gradient(linear, left top, left bottom, from(#f8f8f8), to(#f6f6f6));
            background: -moz-linear-gradient(top,  #f8f8f8,  #f6f6f6);
        }
        table tr:last-child td {
            border-bottom:0;
        }
        table tr:last-child td:first-child {
            -moz-border-radius-bottomleft:10px;
            -webkit-border-bottom-left-radius:10px;
            border-bottom-left-radius:10px;
        }
        table tr:last-child td:last-child {
            -moz-border-radius-bottomright:10px;
            -webkit-border-bottom-right-radius:10px;
            border-bottom-right-radius:10px;
        }
        table tr:hover td {
            //background: #f2f2f2;
            background: -webkit-gradient(linear, left top, left bottom, from(#E0ECF8), to(#E0ECF8));
            //background: -moz-linear-gradient(top,  #f2f2f2,  #f0f0f0);  
        }
        table.gridtable {
            width: 100%;
            margin-left:auto; 
            margin-right:auto;
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
            font-size:14px;
            color:#333333;
            //border-width: 1px;
            //border-color: #666666;
            border-collapse: collapse;
        }
        table.gridtable th {
            //border-width: 1px;
            //padding: 8px;
            //border-style: solid;
            //border-color: #666666;
            //background-color: #dedede;
            font-weight: bold;
            background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));
        }
        table.gridtable td {
            //border-width: 1px;
            //padding: 8px;
            //border-style: solid;
            //border-color: #666666;
            background-color: #ffffff;
        }
        .hBanner {
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
            font-size: 16px;
            color: #333;
            line-height: 90%;
            margin: .2em 0 .4em 0; 
            text-decoration-line: underline;
            border-bottom:1px dotted;
        }
        fieldset {
            border-style:none;
        }
        label {
            display:inline-block;
            cursor:pointer;
            //position:relative;
            //padding-left:25px;
            //margin-right:3px;
            font-size:13px;
            margin-left:-8px;
        }        
        .wrapper {
            width:150px;
            margin:0;
        }
        .myButton {
            -moz-box-shadow:inset 0px 1px 0px 0px #ffffff;
            -webkit-box-shadow:inset 0px 1px 0px 0px #ffffff;
            box-shadow:inset 0px 1px 0px 0px #ffffff;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #f9f9f9), color-stop(1, #e9e9e9));
            background:-moz-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-webkit-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-o-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-ms-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
            filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f9f9f9', endColorstr='#e9e9e9',GradientType=0);
            background-color:#f9f9f9;
            -moz-border-radius:6px;
            -webkit-border-radius:6px;
            border-radius:6px;
            border:1px solid #dcdcdc;
            display:inline-block;
            cursor:pointer;
            color:#666666;
            font-size:15px;
            padding:5px 15px;
            text-decoration:none;
            text-shadow:0px 1px 0px #ffffff;
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
        }
        .myButton:hover {
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #e9e9e9), color-stop(1, #f9f9f9));
            background:-moz-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-webkit-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-o-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-ms-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:linear-gradient(to bottom, #e9e9e9 5%, #f9f9f9 100%);
            filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#e9e9e9', endColorstr='#f9f9f9',GradientType=0);
            background-color:#e9e9e9;
        }
        .myButton:active {
            position:relative;
            top:1px;
        }
    </style>
    <script type="text/javascript">
        var isClicked = false;
        
        // A $( document ).ready() block.
        $( document ).ready(function() {
            $('.spinner').hide();
        });

        function OnRowClick(row) {
            document.getElementById("{!$Component.apexPage.formSalesCallPlan.hdnField}").value = row.rowIndex;    
        }
        function OnRowClick2(row) {
            document.getElementById("{!$Component.apexPage.formSalesCallPlan.hdnField2}").value = row.rowIndex;    
        }
        
        function checkDoubleSubmit(obj){
            if (isClicked) {
                return false;
            }else {
                isClicked = true;
                obj.className = 'btnDisabled';//only shows the button as disabled.
                refreshCurrentTab();
                return true;
            }
        }      
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
        
        function showPosition(position) {
            document.getElementById("{!$Component.apexPage.formSalesCallPlan.longitude}").value = position.coords.longitude;             
            document.getElementById("{!$Component.apexPage.formSalesCallPlan.latitude}").value = position.coords.latitude;  
            console.log("Longitude: " + position.coords.longitude + "\nLatitude: " + position.coords.latitude);
        }
        
        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred."
                    break;
            }
        }
    
    function removeSecond(that){
        
        console.log('before.   ' + that.value);
        that.value = that.value.substring(0, 16);
        console.log('after.   ' + that.value);
    }
     
    </script>
</head> 
<body>

<div data-role="page">
    <div class="spinner"></div>
    <div data-role="content">
        <apex:form id="formSalesCallPlan" enctype="multipart/form-data">
        <apex:inputHidden id="hdnField" value="{!theRow}"/>
        <apex:inputHidden id="hdnField2" value="{!theRow2}"/>
        
        <apex:inputHidden value="{!Longitude}"  id="longitude" /><br/> 
        <apex:inputHidden value="{!Latitude}" id="latitude" /><br />
            
        <section class="border-bottom">
            <div class="content">
                <table class="gridtable">
                    <th>實際開始時間</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));"><apex:input type="datetime-local" value="{!VisitDateF}" onchange="removeSecond(this);"/></td>

                    <th>實際結束時間</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));"><apex:input type="datetime-local" value="{!VisitDateT}" onchange="removeSecond(this);" /></td>
                    
                    <th>擇期原因</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); -moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px"><apex:input type="text" value="{!strCxlReason}" /></td>
                    
                    <th>取消原因</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); -moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px"><apex:inputField value="{!objVisitPlanDetail.ASI_CRM_Cancel_Reason__c}" /></td>
                    
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>拜訪目的</th>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); width: 80%;-moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px; -moz-border-radius-bottomright: 0px;-webkit-border-bottom-right-radius: 0px;border-bottom-right-radius: 0px;" > 
                            <apex:input type="text" value="{!strObjective}" />
                        </td>
                    </tr>
                </table>
                <table class="gridtable">
                    <tr>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#FFFFFF)); width: 80%" rowspan="2"> 
                            <apex:inputTextarea value="{!strRemarks}"/>
                        </td>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#FFFFFF))">
                            <apex:commandButton styleclass="myButton" action="{!quickSave}" value="儲存" onclick="return checkDoubleSubmit(this)" rendered="{!allowEdit}"/>
                            <apex:commandButton styleclass="myButton" action="{!Save}" value="提交" onclick="return checkDoubleSubmit(this)" rendered="{!allowEdit}" style="margin-top: 6px"/>
                        </td>
                    </tr>
                </table>

                <!-- <apex:pageMessages id="pageMsgs" /> -->
                <apex:messages id="pageMsgs" styleClass="error" style="color: red" />
        
                <div style="width: 100%">
                    
                </div>
            </div>
        </section>
       
        <div id="tabbed-list-view-nav" class="tabbed-list-view-nav">
            <!--
            <a href="#" class="{!If (CurrentPage == '0', 'span-20 on', 'span-20')}">Page 1</a>
            <a href="#" class="{!If (CurrentPage == '1', 'span-20 on', 'span-20')}">Page 2</a>
            <a href="#" class="{!If (CurrentPage == '2', 'span-20 on', 'span-20')}">Page 3</a>
            <a href="#" class="{!If (CurrentPage == '3', 'span-20 on', 'span-20')}">Page 4</a>
            <a href="#" class="{!If (CurrentPage == '4', 'span-20 on', 'span-20')}">Page 5</a>
            -->
            <a href="#" class="{!If (CurrentPage == '0', 'span-one-sixth on', 'span-one-sixth')}">Page 1</a>
            <a href="#" class="{!If (CurrentPage == '1', 'span-one-sixth on', 'span-one-sixth')}">Page 2</a>
            <a href="#" class="{!If (CurrentPage == '2', 'span-one-sixth on', 'span-one-sixth')}">Page 3</a>
            <a href="#" class="{!If (CurrentPage == '2-1', 'span-one-sixth on', 'span-one-sixth')}">Page 3-1</a>
            <a href="#" class="{!If (CurrentPage == '3', 'span-one-sixth on', 'span-one-sixth')}">Page 4</a>
            <a href="#" class="{!If (CurrentPage == '4', 'span-one-sixth on', 'span-one-sixth')}">Page 5</a>
        </div>
        
        <ul class="tabbed-list-view slide-{!CurrentPage}">
            <li>
                <!-- Start of Page 1 -->
                 <br/>
                <span class="hBanner">步驟 1. 計劃 &amp; 準備</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>客戶代碼</th>
                        <th>區</th>
                        <th>客戶名稱</th>
                        <th>{!$ObjectType.ASI_CRM_AccountsAdditionalField__c.fields.ASI_CRM_Account_Segment__c.label}</th>
                        <th>{!$ObjectType.ASI_CRM_AccountsAdditionalField__c.fields.ASI_CRM_TW_Action_Grade__c.label}</th>
                        <th>次通路</th>
                        <th>地址</th>
                        <th>電話</th>
                        <th>業務員</th>
                    </tr>
                    <tr>
                        <td><apex:outputLink value="{!URLFOR($Action.Account.Edit, objAccount.id)}" target="_blank">{!objAccount.ASI_KOR_Customer_Code__c}</apex:outputLink></td>
                        <td>{!objAccount.ASI_TH_CRM_Region__c}</td>
                        <td>{!objAccount.Name}</td>
                        <td>{!objAccountAddt.ASI_CRM_Account_Segment__r.Name}</td>
                        <td>{!objAccountAddt.ASI_CRM_TW_Action_Grade__r.Name}</td>
                        <td>{!objAccountAddt.ASI_CRM_CN_Sub_Channel__r.Name}</td>
                        <td>{!objAccount.ASI_HK_CRM_Address__c}</td>
                        <td>{!objAccount.Phone}</td>
                        <td>{!objAccount.Owner.Name}</td>
                    </tr>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th style="background:#EAEAEA">Year</th>
                        <th colspan="4" style="background:#EAEAEA">月銷量</th>
                        <th style="background:#EAEAEA">形象指標</th>
                        <th style="background:#EAEAEA">銷售潛力</th>
                    </tr>
                    <tr>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th>PRT 銷量</th>
                        <th>PRT 佔比</th>
                        <th>總銷量</th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <apex:repeat value="{!lstSVCon}" var="objSalesVolCon">
                    <tr>
                        <td>{!objSalesVolCon.strRecDate}</td>
                        <td>{!objSalesVolCon.strType}</td>
                        <td>{!objSalesVolCon.decVol}</td>
                        <td>{!objSalesVolCon.strShare}</td>
                        <td>{!objSalesVolCon.decTotal}</td>
                        <apex:variable value="v1" var="" rendered="{!allowSetup}"><td>{!objAccountAddt.ASI_TH_CRM_OutletImage__r.Name}</td></apex:variable>
                        <apex:variable value="v2" var="" rendered="{!!allowSetup}"><td><font color="red">空白</font></td></apex:variable>
                        <td>{!objAccountAddt.ASI_CRM_Sales_Potential__c}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th style="background:#EAEAEA">最近訪查日期</th>
                        <th colspan="4" style="background:#EAEAEA">月銷量</th>
                        <th style="background:#EAEAEA">形象指標</th>
                        <th style="background:#EAEAEA">銷售潛力</th>
                    </tr>
                    <tr>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th>PRT 銷量</th>
                        <th>PRT 佔比</th>
                        <th>總銷量</th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <apex:repeat value="{!lstSVCal}" var="objSalesVolCal">
                    <tr>
                        <td>{!objSalesVolCal.strRecDate}</td>
                        <td>{!objSalesVolCal.strType}</td>
                        <td>{!objSalesVolCal.decVol}</td>
                        <td>{!objSalesVolCal.strShare}</td>
                        <td>{!objSalesVolCal.decTotal}</td>
                        <apex:variable value="v1" var="" rendered="{!allowSetup}"><td>{!objAccountAddt.ASI_TH_CRM_OutletImage__r.Name}</td></apex:variable>
                        <apex:variable value="v2" var="" rendered="{!!allowSetup}"><td><font color="red">空白</font></td></apex:variable>
                        <td>{!strCalSalesPotential}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>Key man</th>
                        <th>職稱</th>
                        <th>生日</th>
                        <th>行動電話</th>
                        <th>信箱</th>
                    </tr>
                    <apex:repeat value="{!objAccount.Contacts}" var="Contact">
                    <tr>
                        <td><apex:outputLink value="{!URLFOR($Action.Contact.Edit, Contact.id)}" target="_blank">{!Contact.Name}</apex:outputLink></td>
                        <td>{!Contact.Title}</td>
                        <td><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                            <apex:param value="{!Contact.Birthdate}" /> 
                        </apex:outputText></td>
                        <td>{!Contact.MobilePhone}</td>
                        <td>{!Contact.Email}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
        
                <table class="gridtable" style="{!IF(!allowEdit,'display:none','')}">
                    <tr>
                        <th>General Photos</th>                        
                    </tr>
                </table>
                <div style="float: left; width:25%;{!IF(!allowEdit,'display:none','')}">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 1)" />
                    <div id="divFileGeneralMsg"></div>
                </div>
                
                <!--<div class="hBanner">&nbsp;&nbsp;General Photos</div>
                <div style="float: left; width:25%">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 1)" />
                    <div id="divFileGeneralMsg"></div>
                </div>-->
                <br/>
                <br/>

                <div style="float: right;">
                    <input type="button" class="myButton" value="添加聯絡人" onclick="window.open('{!URLFOR( $Action.Contact.NewContact , $ObjectType.Contact ,[accid= objAccount.Id ])}&retURL={!objAccount.Id}', '_blank');" style="{!IF(!allowEdit,'display:none','')}" />
                </div> 
                <div style="float: right;">&nbsp;&nbsp;</div>               
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">     
                    <apex:commandlink target="_blank" action="{!outletImageSetup}"><!-- style="{!IF(allowSetup,'display:none','')}"--> 
                        <apex:commandButton styleclass="myButton" value="店形象設置"/>
                    </apex:commandlink><br/><br/>               
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 1 -->
            </li>
            <li>
                <!-- Start of Page 2 -->
                <br/>
                <span class="hBanner">步驟 2. 問候/ 步驟 3. 追踪銷售進度</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>品牌</th>
                        <th>優先權</th>
                        <th>Sales Out<br/>{!LastOfftakeYear}年{!LastOfftakeMonth}月</th>
                        <th>鋪貨</th>
                        <th>排面</th>
                        <th>
                            <apex:outputText value="OFF-標價/ ON-進店價" rendered="{!strChannelCode != 'CVS' && strChannelCode != 'WS' && strChannelCode != 'HYP' && strChannelCode != 'SUP'}"/>
                            <apex:outputText value="標價" rendered="{!strChannelCode == 'HYP' || strChannelCode == 'SUP'}"/>
                        </th>
                        <th>實際售價</th>
                        <th>庫存</th>
                        <th>銷量(bot.)<br/>{!LastDepletionYear}年{!LastDepletionMonth}月</th>
                    </tr>
                    <apex:repeat value="{!lstSalesMovnt}" var="objSalesMovnt">
                    <tr>
                        <td>{!objSalesMovnt.strItmGroup}</td>
                        <td>{!objSalesMovnt.strPriority}</td>
                        <td>{!objSalesMovnt.decQTDPurchase}</td>
                        <td>
                            <apex:selectRadio value="{!objSalesMovnt.strSalesMovntOpt}" style="width:170px;">
                                <apex:selectOptions value="{!SalesMovntOpt}" />
                                <!--<apex:selectOption itemLabel="Yes" itemValue="Y"/>
                                <apex:selectOption itemLabel="No" itemValue="N"/>-->
                            </apex:selectRadio>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decFacing}" id="decFacing" rendered="{!LEN(objSalesMovnt.strErrorMessageFacing)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageFacing)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decFacing}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageFacing}</div>
                            </apex:outputPanel>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decListPrice}" id="decListPrice" rendered="{!LEN(objSalesMovnt.strErrorMessageListPrice)==0 && strChannelCode != 'CVS' && strChannelCode != 'WS'}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageListPrice)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decListPrice}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageListPrice}</div>
                            </apex:outputPanel>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decActualRSP}" id="decActualRSP" rendered="{!LEN(objSalesMovnt.strErrorMessageActualRSP)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageActualRSP)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decActualRSP}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageActualRSP}</div>
                            </apex:outputPanel>                        
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decCurrentStock}" id="decCurrentStock" rendered="{!LEN(objSalesMovnt.strErrorMessageCurrentStock)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageCurrentStock)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decCurrentStock}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageCurrentStock}</div>
                            </apex:outputPanel>                        
                        </td>
                        <td>{!objSalesMovnt.decTurnoverBotl}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable" style="{!IF(!allowEdit,'display:none','')}">
                    <tr>
                        <th>Merchan Photos</th>                        
                    </tr>
                </table>
                <div style="float: left; width:25%;{!IF(!allowEdit,'display:none','')}">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 2)" />
                    <div id="divFilePromoStatusMsg1"></div>
                </div>
                <br/>
                <br/>
                <!--<div class="hBanner">&nbsp;&nbsp;Merchan Photos</div>
                <div style="float: left; width:25%">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 2)" />
                    <div id="divFilePromoStatusMsg1"></div>
                </div>-->
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">
                    <input type="button" class="myButton" value="客戶訂貨通知單" onClick="window.open('/apex/asi_crm_tw_marketsurvey_page?accountId={!objAccount.Id}&channelCode={!strChannelCode}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div> 
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">
                    <input type="button" class="myButton" value="月銷售調查" onClick="window.open('/apex/asi_crm_tw_marketsurvey_page?accountId={!objAccount.Id}&channelCode={!strChannelCode}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div> 
                <div style="float: right;">&nbsp;&nbsp;</div>               
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">
                    <input type="button" class="myButton" value="瓶頭回收" onClick="window.open('/apex/ASI_CRM_TW_CapCollection_Page?accountId={!objAccount.Id}&channelCode={!strChannelCode}&vpid={!strVPID}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 2 -->
            </li>
            <li>
                <!-- Start of Page 3 -->
                <br>
                    <span class="hBanner">步驟 4. 佈達活動與活動執行進度追蹤/ 步驟 5. 取得訂單</span>
                </br>
                <!--
                <br>
                    <table>
                        <tr>
                            <td>
                                <apex:commandButton styleclass="myButton" action="{!clearAllOptions}" value="全部清除" rerender="brandlist, typelist"  onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                            </td>
                            <td>
                                <apex:commandButton styleclass="myButton" action="{!selectAllOptions}" value="全部選取" rerender="brandlist, typelist"  onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                            </td>
                            <td>
                                <apex:commandButton styleclass="myButton" action="{!filterPromoStatus}" value="搜尋" rerender="suppliertableid, promoList"  onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                            </td>
                        </tr>
                    </table>
                </br>-->
                <br>
                    <section class="border-bottom">
                        <div class="content">
                            <table style="gridtable">
                                <tr>
                                    <td>
                                        <!--
                                        Brand
                                        <apex:selectCheckboxes value="{!selectedBrands}" label="Brand" id="brandlist">
                                            <apex:selectOptions value="{!brandList}"></apex:selectOptions>
                                        </apex:selectCheckboxes>
                                        -->
                                        <td width='100px'><apex:outputlabel style="font-weight: bold !important" value="Brand"/></td>
                                        <td width='40%'>
                                            <apex:selectList style="height:auto !important;border:0px !important;padding:0px !important;font-size:16px;" value="{!selectedBrands}" size="4" multiselect="true">
                                                <apex:selectOptions value="{!brandList}" ></apex:selectOptions>
                                            </apex:selectList>
                                            <!--
                                            <apex:outputPanel rendered="{!strErrorMessageObjectives!=null}">
                                                <div style="color: red;">{!strErrorMessageObjectives}</div>
                                            </apex:outputPanel>-->
                                        </td>
                                    </td>
                                    <td>
                                        <!--
                                        Type
                                        <apex:selectCheckboxes value="{!selectedTypes}" label="Type" id="typelist">
                                            <apex:selectOptions value="{!typeList}"></apex:selectOptions>
                                        </apex:selectCheckboxes>-->
                                        <td width='100px'><apex:outputlabel style="font-weight: bold !important" value="Type"/></td>
                                        <td width='40%'>
                                            <apex:selectList style="height:auto !important;border:0px !important;padding:0px !important;font-size:16px;" value="{!selectedTypes}" size="4" multiselect="true">
                                                <apex:selectOptions value="{!typeList}" ></apex:selectOptions>
                                            </apex:selectList>
                                            <!--
                                            <apex:outputPanel rendered="{!strErrorMessageObjectives!=null}">
                                                <div style="color: red;">{!strErrorMessageObjectives}</div>
                                            </apex:outputPanel>-->
                                        </td>
                                    </td>
                                    <td>
                                        <td width='100px'><apex:outputlabel style="font-weight: bold !important" value=""/></td>
                                        <td width='40%'>
                                            <apex:commandButton styleclass="myButton" action="{!filterPromoStatus}" value="搜尋" rerender="suppliertableid, promoList"  onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                                        </td>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </section>
                </br>
                <br/>
                <br/>
                <br/>
                <apex:pageBlock id="suppliertableid">
                    <table class="gridtable" id="gridtableid">
                        <tr>
                            <th width='2%'></th>
                            <th width='8%'>活動代碼</th>
                            <th width='12%'>活動名稱</th>
                            <th width='8%'>活動期間</th>
                            <th width='8%'>採購期限</th>
                            <th width='10%'>參與活動</th>
                            <th width='15%'>供貨商</th>
                            <th width='5%'>作業項目</th>
                            <th width='5%'>完成否</th>
                            <th width='20%'>照片上傳</th>
                            <th width='10%'>備注</th>
                            <th width='2%'></th>
                        </tr>
                        <apex:repeat value="{!lstPromoStatus}" var="objPromoStatus" id="promoList">
                        <tr onmouseover="OnRowClick(this)" style="{!IF(objPromoStatus.excludedByFilter,'display:none','')}">
                            <td>
                                <apex:commandButton styleclass="myButton" value="x" action="{!RemoveRow}" rerender="suppliertableid" rendered="{!allowEdit}"   onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                            </td>
                            <td>
                                <apex:outputLink value="{!URLFOR($Action.Attachment.Download, objPromoStatus.idAttachment)}" target="_blank" rendered="{!If(objPromoStatus.idAttachment == null,false,true)}"> {!objPromoStatus.strPromo}</apex:outputLink>
                                <apex:outputText rendered="{!If(objPromoStatus.idAttachment == null,true,false)}">{!objPromoStatus.strPromo}</apex:outputText>
                            </td>
                            <td>{!objPromoStatus.strDesc}</td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dteStart}" /> 
                                </apex:outputText>
                                <br/>
                                <apex:outputText >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至</apex:outputText>
                                <br/>
                                <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                    <apex:param value="{!objPromoStatus.dteEnd}" /> 
                                </apex:outputText>
                            </td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dtePurchaseDue}" /> 
                            </apex:outputText></td>
                            <td>
                                <div>
                                    <apex:input value="{!objPromoStatus.decOfferUnit}" id="decOfferUnit" rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)==0}" type="number" style="width: 70%;"/>&nbsp;口
                                    <apex:outputPanel rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)!=0}">
                                         <apex:input styleClass="error" value="{!objPromoStatus.decOfferUnit}" type="number"/>
                                         <div style="color: red;"><strong>Error:</strong>&nbsp;{!objPromoStatus.strErrorMessageOfferUnit}</div>
                                    </apex:outputPanel>      
                                </div>
                            </td>
                            <td>         
                                <div style="float: center;">                   
                                    <apex:selectList value="{!objPromoStatus.idSupplier}" size="1" label="">
                                        <apex:selectOptions value="{!supplierList}"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                            </td>
                            <td>
                                <apex:outputText >{!objPromoStatus.strTask}</apex:outputText>
                            </td>
                            <td>
                                <apex:inputcheckbox value="{!objPromoStatus.blnDone}" onchange="doneChecked(this, '{!objPromoStatus.idRec}')" disabled="{!disableDone}"/>
                            </td>                           
                            <td>
                                <apex:outputPanel rendered="{!if(!objPromoStatus.blnNew && allowEdit, true, false)}">
                                    <input type="file" id="file1_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 31)" /><br/>
                                    <small><output id="divFilePromoStatusMsg1_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file2_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 32)"/><br/>
                                    <small><output id="divFilePromoStatusMsg2_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file3_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 33)"/><br/>
                                    <small><output id="divFilePromoStatusMsg3_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file4_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 34)"/><br/>
                                    <small><output id="divFilePromoStatusMsg4_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!if(objPromoStatus.blnNew && allowEdit, true, false)}" style="color:red">請先儲存再上載</apex:outputPanel>
                            </td>
                            <td>
                                <apex:inputtextarea value="{!objPromoStatus.strRemarks}" />                        
                            </td>
                            <td>
                                <div style="float: left ;display:inline-block">
                                    <apex:commandButton styleclass="myButton" value="增加" action="{!AddRow}" rerender="suppliertableid" rendered="{!allowEdit}"   onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                                </div>                           
                            </td>
                        </tr>
                        </apex:repeat>
                    </table>
                </apex:pageblock>

                <br/>
                <div style="float: right">
                    <input type="button" class="myButton" value="Brand Portfolio" onClick="window.open('https://pernod-ricard.my.salesforce.com/_ui/core/chatter/groups/GroupProfilePage?g=0F9D0000000Uc63');"/>
                    <!-- <apex:commandButton value="Purchase Order" /> -->
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 3 -->
            </li>


            <li>
                <!-- Start of Page 3-1 -->
                <br>
                    <span class="hBanner">步驟 4. 佈達活動與活動執行進度追蹤/ 步驟 5. 取得訂單</span>
                </br>
                <br/>
                <br/>
                <br/>
                <apex:pageBlock id="suppliertableid2">
                    <table class="gridtable" id="gridtableid2">
                        <tr>
                            <th width='2%'></th>
                            <th width='8%'>活動代碼</th>
                            <th width='12%'>活動名稱</th>
                            <th width='8%'>活動期間</th>
                            <th width='8%'>採購期限</th>
                            <th width='10%'>參與活動</th>
                            <th width='15%'>供貨商</th>
                            <th width='5%'>作業項目</th>
                            <th width='5%'>完成否</th>
                            <th width='20%'>照片上傳</th>
                            <th width='10%'>備注</th>
                            <th width='2%'></th>
                        </tr>
                        <apex:repeat value="{!lstPromoStatusWithOfferUnit}" var="objPromoStatus" id="promoList2">
                        <tr onmouseover="OnRowClick2(this)">
                            <td>
                                <apex:commandButton styleclass="myButton" value="x" action="{!RemoveRow2}" rerender="suppliertableid2" rendered="{!allowEdit}"  onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                            </td>
                            <td>
                                <apex:outputLink value="{!URLFOR($Action.Attachment.Download, objPromoStatus.idAttachment)}" target="_blank" rendered="{!If(objPromoStatus.idAttachment == null,false,true)}"> {!objPromoStatus.strPromo}</apex:outputLink>
                                <apex:outputText rendered="{!If(objPromoStatus.idAttachment == null,true,false)}">{!objPromoStatus.strPromo}</apex:outputText>
                            </td>
                            <td>{!objPromoStatus.strDesc}</td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dteStart}" /> 
                                </apex:outputText>
                                <br/>
                                <apex:outputText >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至</apex:outputText>
                                <br/>
                                <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                    <apex:param value="{!objPromoStatus.dteEnd}" /> 
                                </apex:outputText>
                            </td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dtePurchaseDue}" /> 
                            </apex:outputText></td>
                            <td>
                                <div>
                                    <apex:input value="{!objPromoStatus.decOfferUnit}" id="decOfferUnit" rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)==0}" type="number" style="width: 70%;"/>&nbsp;口
                                    <apex:outputPanel rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)!=0}">
                                         <apex:input styleClass="error" value="{!objPromoStatus.decOfferUnit}" type="number"/>
                                         <div style="color: red;"><strong>Error:</strong>&nbsp;{!objPromoStatus.strErrorMessageOfferUnit}</div>
                                    </apex:outputPanel>      
                                </div>
                            </td>
                            <td>         
                                <div style="float: center;">                   
                                    <apex:selectList value="{!objPromoStatus.idSupplier}" size="1" label="">
                                        <apex:selectOptions value="{!supplierList}"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                            </td>
                            <td>
                                <apex:outputText >{!objPromoStatus.strTask}</apex:outputText>
                            </td>
                            <td>
                                <apex:inputcheckbox value="{!objPromoStatus.blnDone}" onchange="doneChecked(this, '{!objPromoStatus.idRec}')" disabled="{!disableDone}"/>
                            </td>                           
                            <td>
                                <apex:outputPanel rendered="{!if(!objPromoStatus.blnNew && allowEdit, true, false)}">
                                    <input type="file" id="file1_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 31)" /><br/>
                                    <small><output id="divFilePromoStatusMsg1_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file2_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 32)"/><br/>
                                    <small><output id="divFilePromoStatusMsg2_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file3_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 33)"/><br/>
                                    <small><output id="divFilePromoStatusMsg3_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small><br/>
                                    <input type="file" id="file4_{!objPromoStatus.idRec}" onchange="fileChosen(this, '{!objPromoStatus.idRec}', 34)"/><br/>
                                    <small><output id="divFilePromoStatusMsg4_{!objPromoStatus.idRec}" style="margin-left:10px;"/></small>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!if(objPromoStatus.blnNew && allowEdit, true, false)}" style="color:red">請先儲存再上載</apex:outputPanel>
                            </td>
                            <td>
                                <apex:inputtextarea value="{!objPromoStatus.strRemarks}" />                        
                            </td>
                            <td>
                                <div style="float: left ;display:inline-block">
                                    <apex:commandButton styleclass="myButton" value="增加" action="{!AddRow2}" rerender="suppliertableid2" rendered="{!allowEdit}"   onclick="$('.spinner').show();" oncomplete="$('.spinner').hide();" />
                                </div>                           
                            </td>
                        </tr>
                        </apex:repeat>
                    </table>
                </apex:pageblock>

                <br/>
                <div style="float: right">
                    <input type="button" class="myButton" value="Brand Portfolio" onClick="window.open('https://pernod-ricard.my.salesforce.com/_ui/core/chatter/groups/GroupProfilePage?g=0F9D0000000Uc63');"/>
                    <!-- <apex:commandButton value="Purchase Order" /> -->
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 3-1 -->
            </li>

            <li>
                <!-- Start of Page 4 -->
                <br/>
                <span class="hBanner">步驟 6. 檢查平行輸入/ 步驟 7. 結束拜訪 &amp; 記錄</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>日期</th>
                        <th>品牌</th>
                        <th>容量</th>
                        <th>擺放處</th>
                        <th>進口商</th>
                        <th>酒精度</th>
                        <th>發現數量</th>
                        <th>預估數量</th>
                        <th style="{!IF(!allowEdit,'display:none','')}">GMA Photo</th>
                    </tr>
                    <apex:repeat value="{!lstGMARec}" var="objGMA">
                    <tr>
                        <td><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                            <apex:param value="{!objGMA.dteDate}" /> 
                        </apex:outputText></td>
                        <td>{!objGMA.strSubBrand}</td>
                        <td>{!objGMA.strSize}</td>
                        <td>{!objGMA.strDisplay}</td>
                        <td>{!objGMA.strImporter}</td>
                        <td>{!objGMA.decAlcholo}</td>
                        <td>{!objGMA.decVol}</td>
                        <td>{!objGMA.decEstVol}</td>
                        <td style="{!IF(!allowEdit,'display:none','')}">
                            <input type="file" onchange="fileChosen(this, '{!objGMA.idRec}', 3)" />
                            <div id="divFileGMAMsg_{!objGMA.idRec}"></div>
                        </td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <div style="float: right;">
                    <input type="button" class="myButton" value="New GMA" onClick="window.open('/a6V/e?{!GMAtoVPDId}={!objVisitPlanDetail.Name}&{!GMAtoVPDId}_lkid={!objVisitPlanDetail.Id}&{!GMAtoAccId}={!encodedAccountName}&{!GMAtoAccId}_likd={!objAccount.id}&retURL=%2F{!objVisitPlanDetail.Id}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div>
                <div style="float: right; width: 10%">
                    &nbsp;
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 4 -->
            </li>
            <li>
                <!-- Start of Page 5 -->
                <br/>
                <span class="hBanner">Online Pass Order</span>
                <br/>
                <br/>
                <br/>
                <apex:pageBlock id="passorderid">
                    <table class="gridtable" id="passorderid">
                        <tr>
                            <th width='2%'></th>
                            <th>產品名稱</th>
                            <th>供貨商</th>
                            <th>數量(瓶/盒)</th>
                            <th>備註</th>
                            <th width='5%'></th>
                        </tr>
                        <apex:repeat value="{!listPassOrder}" var="objPassOrder">
                        <tr onmouseover="OnRowClick(this)">
                            <td>
                                <apex:commandButton styleclass="myButton" value="x" action="{!RemoveRow_PassOrder}" rerender="passorderid" rendered="{!allowEdit}"/>
                            </td>
                            <td>         
                                <div style="float: center;">                   
                                    <apex:selectList value="{!objPassOrder.idItemGroup}" size="1" label="">
                                        <apex:selectOptions value="{!ItemGroupList}"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                            </td>
                            <td>         
                                <div style="float: center;">                   
                                    <apex:selectList value="{!objPassOrder.idSupplier}" size="1" label="">
                                        <apex:selectOptions value="{!supplierList}"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                            </td>
                            <td>
                                <apex:input value="{!objPassOrder.decQuantity}" id="decQuantity" rendered="{!LEN(objPassOrder.strErrorMessageQty)==0}" type="number"/> 
                                <apex:outputPanel rendered="{!LEN(objPassOrder.strErrorMessageQty)!=0}">
                                     <apex:input styleClass="error" value="{!objPassOrder.decQuantity}" type="number"/>
                                     <div style="color: red;"><strong>Error:</strong>&nbsp;{!objPassOrder.strErrorMessageQty}</div>
                                </apex:outputPanel>       
                            </td>
                            <td>
                                <apex:input value="{!objPassOrder.strRemark}" type="text"/>
                            </td>
                            <td>
                                <div style="float: left ;display:inline-block">
                                    <apex:commandButton styleclass="myButton" value="增加" action="{!AddRow_PassOrder}" rerender="passorderid" rendered="{!allowEdit}"/>
                                </div>                           
                            </td>
                        </tr>
                        </apex:repeat>
                    </table>
                </apex:pageBlock>
                <!-- End of Page 5 -->
            </li>
        </ul><!--.tabbed-list-view-->
        </apex:form>

    </div><!-- /content -->
</div><!-- /page -->
<apex:repeat value="{!lstPromoStatus}" var="promostatus">
        <script>
            if('{!promostatus.blnDone}' == 'true')
            {
                console.log('true id: {!promostatus.idRec}');
                document.getElementById('file1_{!promostatus.idRec}').setAttribute("disabled", "disabled");
                document.getElementById('file2_{!promostatus.idRec}').setAttribute("disabled", "disabled");
                document.getElementById('file3_{!promostatus.idRec}').setAttribute("disabled", "disabled");
                document.getElementById('file4_{!promostatus.idRec}').setAttribute("disabled", "disabled");
            }
       </script>
    </apex:repeat>

<script type="text/javascript">
    var maxStringSize = 6000000;    //Maximum String size is 6,000,000 characters
    var maxFileSize = 4350000;      //After Base64 Encoding, this is the max file size
    var chunkSize = 950000;         //Maximum Javascript Remoting message size is 1,000,000 characters
    var file;
    var attachment;
    var attachment_EV;
    var attachmentName;
    var attachmentName_EV;
    var fileSize;
    var positionIndex;
    var doneUploading;
    var doneUploading_EV;
    j$ = jQuery.noConflict();

    function doneChecked(checkboxElement, parentRecId) {
        if(checkboxElement.checked){
            document.getElementById('file1_' + parentRecId).setAttribute("disabled", "disabled");
            document.getElementById('file2_' + parentRecId).setAttribute("disabled", "disabled");
            document.getElementById('file3_' + parentRecId).setAttribute("disabled", "disabled");
            document.getElementById('file4_' + parentRecId).setAttribute("disabled", "disabled");
        }
        else{
            document.getElementById('file1_' + parentRecId).removeAttribute("disabled");
            document.getElementById('file2_' + parentRecId).removeAttribute("disabled");
            document.getElementById('file3_' + parentRecId).removeAttribute("disabled");
            document.getElementById('file4_' + parentRecId).removeAttribute("disabled");
        }
    }

    
    function fileChosen(fileChosenEvent, parentRecId, pType) {
        
        // Get file
        file = fileChosenEvent.files[0];
        
        // Is it an image?
        if(!file.type.match('image')) {
            alert('Must use an image! Received: ' + file.type);
            return;
        }
        console.log(file);
        
        if(file.size <= maxFileSize) {
            attachmentName = file.name;
            var fileReader = new FileReader();
            
            fileReader.onload = function(readerEvent) {
                if (pType == 1)
                    attachmentName = 'General_' + file.name;
                else if (pType == 2)
                    attachmentName = 'Merchan_' + file.name;
                else if (pType == 3)
                    attachmentName = 'GMA_' + file.name;
                else if (pType == 31 || pType == 32 || pType == 33 || pType == 34)
                {
                    if(file.type == 'image/jpeg')                     
                        	attachmentName = 'PromoStatus_ReImg.jpg';
						else if(file.type == 'image/png')                      
							attachmentName = 'PromoStatus_ReImg.png';
                        else
                            attachmentName = 'PromoStatus_ReImg.' + file.type;
                }
                // attachmentName = 'PromoStatus_' + file.name;
                
                console.log('Resize upload');

                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext("2d");
                
                var img = new Image();
                img.onload = function (imageEvent) {
                    var W = img.width;
                    var H = img.height;
                    var ratio = W/H;
                    canvas.width = W;
                    canvas.height = H;
                    ctx.drawImage(img, 0, 0); //draw image
                    if(W>=H)
                        resample_hermite(canvas, W, H, 320, 320/ratio);
                    else
                        resample_hermite(canvas, W, H, 320*ratio, 320);
                }
                img.src = readerEvent.target.result;
            }
            fileReader.readAsDataURL(file);  //Read the body of the file
            
            function resample_hermite(canvas, W, H, W2, H2){
                var time1 = Date.now();
                W2 = Math.round(W2);
                H2 = Math.round(H2);
                var img = canvas.getContext("2d").getImageData(0, 0, W, H);
                var img2 = canvas.getContext("2d").getImageData(0, 0, W2, H2);
                var data = img.data;
                var data2 = img2.data;
                var ratio_w = W / W2;
                var ratio_h = H / H2;
                var ratio_w_half = Math.ceil(ratio_w/2);
                var ratio_h_half = Math.ceil(ratio_h/2);
                
                for(var j = 0; j < H2; j++){
                    for(var i = 0; i < W2; i++){
                        var x2 = (i + j*W2) * 4;
                        var weight = 0;
                        var weights = 0;
                        var weights_alpha = 0;
                        var gx_r = gx_g = gx_b = gx_a = 0;
                        var center_y = (j + 0.5) * ratio_h;
                        for(var yy = Math.floor(j * ratio_h); yy < (j + 1) * ratio_h; yy++){
                            var dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
                            var center_x = (i + 0.5) * ratio_w;
                            var w0 = dy*dy //pre-calc part of w
                            for(var xx = Math.floor(i * ratio_w); xx < (i + 1) * ratio_w; xx++){
                                var dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                                var w = Math.sqrt(w0 + dx*dx);
                                if(w >= -1 && w <= 1){
                                    //hermite filter
                                    weight = 2 * w*w*w - 3*w*w + 1;
                                    if(weight > 0){
                                        dx = 4*(xx + yy*W);
                                        //alpha
                                        gx_a += weight * data[dx + 3];
                                        weights_alpha += weight;
                                        //colors
                                        if(data[dx + 3] < 255)
                                            weight = weight * data[dx + 3] / 250;
                                        gx_r += weight * data[dx];
                                        gx_g += weight * data[dx + 1];
                                        gx_b += weight * data[dx + 2];
                                        weights += weight;
                                        }
                                    }
                                }       
                            }
                        data2[x2]     = gx_r / weights;
                        data2[x2 + 1] = gx_g / weights;
                        data2[x2 + 2] = gx_b / weights;
                        data2[x2 + 3] = gx_a / weights_alpha;
                        }
                    }
                console.log("hermite = "+(Math.round(Date.now() - time1)/1000)+" s");
                canvas.getContext("2d").clearRect(0, 0, Math.max(W, W2), Math.max(H, H2));
                canvas.width = W2;
                canvas.height = H2;
                canvas.getContext("2d").putImageData(img2, 0, 0);
                
                //attachment = window.btoa(this.result);  //Base 64 encode the file before sending it
                attachment = canvas.toDataURL(file.type);
                attachment = attachment.substring(attachment.indexOf(',')+1,attachment.length);
                //alert(attachment);
                
                positionIndex=0;
                fileSize = attachment.length;
                console.log("Total Attachment Length: " + fileSize);
                doneUploading = false;
                if(fileSize < maxStringSize) {
                    uploadAttachment(parentRecId, pType, null);
                } else {
                    alert("Base 64 Encoded file is too large.  Maximum size is " + maxStringSize + " your file is " + fileSize + ".");
                }
            }
        } else {
                alert("File must be under 4.3 MB in size.  Your file is too large.  Please try again.");
        }
    }
    
    function uploadAttachment_EV(parentRecId, pType, fileId) {
            var attachmentBody_EV = "";
            if(fileSize <= positionIndex + chunkSize) {
                attachmentBody_EV = attachment_EV.substring(positionIndex);           
                doneUploading_EV = true;
            } else {
                attachmentBody_EV = attachment_EV.substring(positionIndex, positionIndex + chunkSize);
            }

            console.log("Uploading " + attachmentBody_EV.length + " chars of " + fileSize);
            ASI_CRM_TW_SalesCallPlanPageNewCtrl.insertAttachment(parentRecId, attachmentBody_EV, attachmentName_EV, pType, fileId, 

                    function(result, event) {
                        console.log('result:' + result);
                        if(event.type === 'exception') {
                            console.log("exception");
                            console.log(event);
                        } else if(event.status) {
                            console.log('event status :' + event.status);
                            if(result.substring(0,3) == '00P') {
                                if(doneUploading_EV == true) {
                                    if (pType == 31){
                                        j$('#divFilePromoStatusMsg1_' + parentRecId).text('上傳成功！可繼續下一張.');
                                        j$("#file1_"+ parentRecId).prop("disabled", false);
                                        j$("#file2_"+ parentRecId).prop("disabled", false);
                                        j$("#file3_"+ parentRecId).prop("disabled", false);
                                        j$("#file4_"+ parentRecId).prop("disabled", false);
                                    }
                                    else if (pType == 32) {
                                        j$('#divFilePromoStatusMsg2_' + parentRecId).text('上傳成功！可繼續下一張.');
                                        j$("#file1_"+ parentRecId).prop("disabled", false);
                                        j$("#file2_"+ parentRecId).prop("disabled", false);
                                        j$("#file3_"+ parentRecId).prop("disabled", false);
                                        j$("#file4_"+ parentRecId).prop("disabled", false);
                                    }
                                    else if (pType == 33) {
                                        j$('#divFilePromoStatusMsg3_' + parentRecId).text('上傳成功！可繼續下一張.');
                                        j$("#file1_"+ parentRecId).prop("disabled", false);
                                        j$("#file2_"+ parentRecId).prop("disabled", false);
                                        j$("#file3_"+ parentRecId).prop("disabled", false);
                                        j$("#file4_"+ parentRecId).prop("disabled", false);
                                    }
                                    else if (pType == 34) {
                                        j$('#divFilePromoStatusMsg4_' + parentRecId).text('上傳成功！可繼續下一張.');
                                        j$("#file1_"+ parentRecId).prop("disabled", false);
                                        j$("#file2_"+ parentRecId).prop("disabled", false);
                                        j$("#file3_"+ parentRecId).prop("disabled", false);
                                        j$("#file4_"+ parentRecId).prop("disabled", false);
                                    }

                                    //alert(result);
                                } else{
                                    positionIndex += chunkSize;
                                    uploadAttachment_EV(parentRecId, pType, result);
                                }
                            }
                        }else {
                            console.log('event :' + event.message);
                        }
                    },
                    {buffer: true, escape: true, timeout: 120000}
            );
        }

    function uploadAttachment(parentRecId, pType, fileId) {
        var attachmentBody = "";
        if(fileSize <= positionIndex + chunkSize) {
            attachmentBody = attachment.substring(positionIndex);
            doneUploading = true;
        } else {
            attachmentBody = attachment.substring(positionIndex, positionIndex + chunkSize);
        }
        
        if (pType == 1) {
            j$('#divFileGeneralMsg').text('Uploading General Photo, please wait');
        }
        else if (pType == 2) {
            j$('#divFilePromoStatusMsg1').text('Uploading Merchan Photo, please wait...');
        }
        else if (pType == 3) {
            j$('#divFileGMAMsg_' + parentRecId).text('Uploading GMA Photo, please wait');
        }
        else if (pType == 31) {
            j$('#divFilePromoStatusMsg1_' + parentRecId).text('圖片上傳中,請等待至結束,才能上傳下一張.');
            document.getElementById("file1_"+ parentRecId).disabled = true; 
            document.getElementById("file2_"+ parentRecId).disabled = true; 
            document.getElementById("file3_"+ parentRecId).disabled = true;
            document.getElementById("file4_"+ parentRecId).disabled = true;
        }
        else if (pType == 32) {
            j$('#divFilePromoStatusMsg2_' + parentRecId).text('圖片上傳中,請等待至結束,才能上傳下一張.');
            document.getElementById("file1_"+ parentRecId).disabled = true; 
            document.getElementById("file2_"+ parentRecId).disabled = true; 
            document.getElementById("file3_"+ parentRecId).disabled = true;
            document.getElementById("file4_"+ parentRecId).disabled = true;
        }
        else if (pType == 33) {
            j$('#divFilePromoStatusMsg3_' + parentRecId).text('圖片上傳中,請等待至結束,才能上傳下一張.');
            document.getElementById("file1_"+ parentRecId).disabled = true; 
            document.getElementById("file2_"+ parentRecId).disabled = true; 
            document.getElementById("file3_"+ parentRecId).disabled = true;
            document.getElementById("file4_"+ parentRecId).disabled = true;
        }
        else if (pType == 34) {
            j$('#divFilePromoStatusMsg4_' + parentRecId).text('圖片上傳中,請等待至結束,才能上傳下一張.');
            document.getElementById("file1_"+ parentRecId).disabled = true; 
            document.getElementById("file2_"+ parentRecId).disabled = true; 
            document.getElementById("file3_"+ parentRecId).disabled = true;
            document.getElementById("file4_"+ parentRecId).disabled = true;
        }
       
        
        console.log("Uploading " + attachmentBody.length + " chars of " + fileSize);
        ASI_CRM_TW_SalesCallPlanPageNewCtrl.insertAttachment(parentRecId, attachmentBody, attachmentName, pType, fileId, 
        function(result, event) {
            console.log(result);
            if(event.type === 'exception') {
                console.log("exception");
                console.log(event);
            } else if(event.status) {
                if(result.substring(0,3) == '00P') {
                    if(doneUploading == true) {
                        if (pType == 1) {
                            j$('#divFileGeneralMsg').text('General Photo Upload Successful');
                        }
                        else if (pType == 2) {
                            j$('#divFilePromoStatusMsg1').text('Merchan Photo Upload Successful');
                        }
                        else if (pType == 3) {
                            j$('#divFileGMAMsg_' + parentRecId).text('GMA Photo Upload Successful');
                        }
                        //alert(result);
                    } else {
                        positionIndex += chunkSize;
                        uploadAttachment(parentRecId, pType, result);
                    }
                }
            } else {
                console.log(event.message);
            }
        },
        {buffer: true, escape: true, timeout: 120000}
        );
        if (doneUploading == true && (pType == 31 || pType == 32 || pType == 33 || pType == 34))
            {
                attachmentName_EV = file.name;
                var fileReader_EV = new FileReader();

                fileReader_EV.onload = function(readerEvent) {
                    if (pType == 31 || pType == 32 || pType == 33 || pType == 34)
                    {
                        if(file.type == 'image/jpeg')                     
                        	attachmentName_EV = 'EV_PromoStatus_OriImg.jpg';
						else if(file.type == 'image/png')                      
							attachmentName_EV = 'EV_PromoStatus_OriImg.png';
                        else
                            attachmentName_EV = 'EV_PromoStatus_OriImg' + file.type;                      

                    }
                    
                    console.log('EV upload');
                    
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext("2d");
                    
                    var img_EV = new Image();
                    img_EV.onload = function (imageEvent) {
                        var W_EV = img_EV.width;
                        var H_EV = img_EV.height;
                        console.log(W_EV + ',' + H_EV);
                        canvas.width = W_EV;
                        canvas.height = H_EV;
                        ctx.drawImage(img_EV, 0, 0);
                        attachment_EV = canvas.toDataURL(file.type);
                        attachment_EV = attachment_EV.substring(attachment_EV.indexOf(',')+1,attachment_EV.length);
                        
                        positionIndex = 0;
                        fileSize = attachment_EV.length;
                        console.log("Total Attachment Length: " + fileSize);               
                        doneUploading_EV = false;
                        if(fileSize < maxStringSize) {
                            uploadAttachment_EV(parentRecId, pType, null);
                        } else {
                            alert("Base 64 Encoded file is too large.  Maximum size is " + maxStringSize + " your file is " + fileSize + ".");
                        }
                    }
                    
                    img_EV.src = readerEvent.target.result;
                }
                fileReader_EV.readAsDataURL(file);
            }
    }
</script>

</body>
</html>
</apex:page>