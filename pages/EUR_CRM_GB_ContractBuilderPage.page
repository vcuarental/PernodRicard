<apex:page id="EUR_CRM_GB_ContractBuilderPage" standardController="EUR_CRM_Contract__c" extensions="EUR_CRM_GB_ContractBuilderController">

    <apex:variable var="housePouringWrapper" value="{!mtWrapByMtExtId['GB_House_Pouring_Spirits']}" />
    <apex:variable var="premiumPouringSpiritsWrapper" value="{!mtWrapByMtExtId['GB_Premium_Pouring_Spirits']}" />
    <apex:variable var="housePouringChampagneWrapper" value="{!mtWrapByMtExtId['GB_House_Pouring_Champagne']}" />
    <apex:variable var="mustStockWrapper" value="{!mtWrapByMtExtId['GB_Must_Stock_Item']}" />
    <apex:variable var="mayStockWrapper" value="{!mtWrapByMtExtId['GB_May_Stock_Item']}" />
    <apex:variable var="cocktailWrapper" value="{!mtWrapByMtExtId['GB_Cocktail']}" />
    <apex:variable var="mktgSupportWrapper" value="{!mtWrapByMtExtId['GB_Marketing_Support']}" />
    <apex:variable var="tripWrapper" value="{!mtWrapByMtExtId['GB_Trips']}" />
    <apex:variable var="educationWrapper" value="{!mtWrapByMtExtId['GB_Educations']}" />
    <apex:variable var="posWrapper" value="{!mtWrapByMtExtId['GB_Point_of_Sales']}" />
    <apex:variable var="freeStockWrapper" value="{!mtWrapByMtExtId['GB_Free_Stock']}" />
    <apex:variable var="lumpSumWrapper" value="{!mtWrapByMtExtId['GB_Lump_Sum']}" />
    <apex:variable var="barSupportWrapper" value="{!mtWrapByMtExtId['GB_Bar_support']}" />

    <head>
        <apex:stylesheet value="/sCSS/21.0/sprites/1297816277000/Theme3/default/gc/versioning.css" />

        <apex:stylesheet value="{!URLFOR($Resource.EUR_CRM_jQuery_Lib, '/libs/jquery/css/redmond/jquery-ui-1.10.3.custom.min.css')}" />
        <apex:stylesheet value="{!URLFOR($Resource.EUR_CRM_jQuery_Lib, '/styles/common.css')}" />
        <!--
        <apex:stylesheet value="/sCSS/21.0/sprites/1297816277000/Theme3/default/gc/extended.css" />
        <apex:includeScript value="{!URLFOR($Resource.EUR_CRM_jQuery_Lib, '/libs/DataTables/jquery.dataTables.min.js')}" />
        -->

        <link href="{!URLFOR($Resource.EUR_CRM_jQuery_DataTables, 'css/jquery.dataTables.css')}" media="screen" rel="stylesheet" type="text/css" />

        <apex:includeScript value="{!URLFOR($Resource.EUR_CRM_jQuery_Lib, '/libs/jquery/js/jquery-1.9.1.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.EUR_CRM_jQuery_Lib, '/libs/jquery/js/jquery-ui-1.10.3.custom.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.EUR_CRM_jQuery_DataTables, 'js/jquery.dataTables.js')}"/>

        <script>
            $ = jQuery.noConflict();

            var isAllInputValid = true;

            var allSdmById={};
            var bqByIdToCalculateTotalFreeCases = {};

            //DataTable Variable
            var cpiHousePouring;
            var bqHousePouring;
            var cpiPremiumPouringSpirits;
            var bqPremiumPouringSpirits;
            var cpiHousePouringChampagne;
            var bqHousePouringChampagne;
            var cpiMustStock;
            var bqMustStock;
            var cpiMayStock;
            var bqMayStock;
            var cpiCocktail;
            var bqCocktail;
            var cpiMktgSupport;
            var bqMktgSupport;
            var cpiTrip;
            var bqTrip;
            var cpiEducation;
            var bqEducation;
            var cpiPOS;
            var bqPOS;
            var cpiFreeStock;
            var bqFreeStock;

            //Common Data Table Properties
            var basicDataTableProperties = {
                "bDestroy":true,
                "bStateSave":true,
                "aaSorting": [[1, "asc"]],
                "bSearch":false,
                "bFilter" : true
            };

            var cpi_EUR_CRM_Action = "{!$Label.EUR_CRM_Action}";
            var cpi_EUR_CRM_Brand_Quality__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Brand_Quality__c.label}";
            var cpi_EUR_Min_Qty_Per_Annum_9L__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_Min_Qty_Per_Annum_9L__c.label}";
            var cpi_EUR_CRM_Retro_Per_9L__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Retro_Per_9L__c.label}";
            var cpi_EUR_CRM_Stock_Deal_Mechanic__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Stock_Deal_Mechanic__c.label}";
            var cpi_EUR_CRM_Total_Spend__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Total_Spend__c.label}";
            var cpi_EUR_CRM_Available_by_the_Glass__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Available_by_the_Glass__c.label}";
            var cpi_EUR_CRM_No_of_Cocktails__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_No_of_Cocktails__c.label}";
            var cpi_EUR_CRM_Cocktail_Menu__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Cocktail_Menu__c.label}";
            var cpi_EUR_CRM_No_of_People__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_No_of_People__c.label}";
            var cpi_EUR_CRM_Free_Cases_9L__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Free_Cases_9L__c.label}";
            var cpi_EUR_CRM_POS_type__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_POS_type__c.label}";
            var cpi_EUR_CRM_Value__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Value__c.label}";
            var cpi_EUR_CRM_Optics__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Optics__c.label}";
            var cpi_EUR_CRM_Total_Spend_inc_free_cases__c = "{!$ObjectType.EUR_CRM_Contract_Product_Item__c.fields.EUR_CRM_Total_Spend_inc_free_cases__c.label}";

            //Brand Quality Column Definition
            var brandQualityColumns = [
                {"sTitle": cpi_EUR_CRM_Action},
                {"sTitle": cpi_EUR_CRM_Brand_Quality__c},
                {"sTitle": "Category"}
            ]

            $(document).ready(
                function(){
                    preventReturnKeyPress();
                    removeSymbol();
                    setTables();
                    console.log('allSdmById => ', allSdmById);
                    console.log('bqByIdToCalculateTotalFreeCases => ', bqByIdToCalculateTotalFreeCases);
                }
            );

            //fix to remove charster ','
            function removeSymbol(){
                $('.cpiQty, .cpiRetro').each(function(index, elem ){
                    elem.value = elem.value.replace(/\,/g,'');
                });
            }

            function preventReturnKeyPress(){
                $("input,select").keypress(function(e){
                    return e.keyCode!==13;
                });
            }

            function setTables(){
                setHousePouringTable();
                setPremiumPouringSpiritsTable();
                setHousePouringChampagneTable();
                setMuskStockTable();
                setMayStockTable();
                setCocktailTable();
                setMarketingPackageTables();
            }

            function setHousePouringTable(){
                var cpiHousePouring_dataTableProperties = basicDataTableProperties;
                cpiHousePouring_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle": cpi_EUR_Min_Qty_Per_Annum_9L__c},
                    {"sTitle": cpi_EUR_CRM_Retro_Per_9L__c},
                    {"sTitle": cpi_EUR_CRM_Optics__c},
                    {"sTitle": cpi_EUR_CRM_Stock_Deal_Mechanic__c},
                    {"sTitle": cpi_EUR_CRM_Free_Cases_9L__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend_inc_free_cases__c}

                ];
                cpiHousePouring = $("#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}").dataTable(cpiHousePouring_dataTableProperties);

                var bqHousePouring_dataTableProperties = basicDataTableProperties;
                bqHousePouring_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqHousePouring = $("#{!BQ_TABLE_PREFIX}{!housePouringWrapper.mtId}").dataTable(bqHousePouring_dataTableProperties);

                calculateFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}"));
                calculateTotalSpendForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}"));
                calculateTotalSpendFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}"));
                $('#span_footer_total_housePouring').text(sumTotalSpend($('#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}')));
                $('#span_footer_totalFreeCases_housePouring').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}'), 'cpiTotalSpendFC'));
                //setCaiTotalSpendFreeCases($('#{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}'), '{!housePouringWrapper.mtExtId}');

            }

            function setPremiumPouringSpiritsTable(){
                var cpiPremiumPouringSpirits_dataTableProperties = basicDataTableProperties;
                cpiPremiumPouringSpirits_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle": cpi_EUR_Min_Qty_Per_Annum_9L__c},
                    {"sTitle": cpi_EUR_CRM_Retro_Per_9L__c},
                    {"sTitle": cpi_EUR_CRM_Optics__c},
                    {"sTitle": cpi_EUR_CRM_Stock_Deal_Mechanic__c},
                    {"sTitle": cpi_EUR_CRM_Free_Cases_9L__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend_inc_free_cases__c}
                ];
                cpiPremiumPouringSpirits = $("#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}").dataTable(cpiPremiumPouringSpirits_dataTableProperties);

                var bqPremiumPouringSpirits_dataTableProperties = basicDataTableProperties;
                bqPremiumPouringSpirits_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqPremiumPouringSpirits = $("#{!BQ_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}").dataTable(bqPremiumPouringSpirits_dataTableProperties);

                calculateFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}"));
                calculateTotalSpendForEachCPI($("#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}"));
                calculateTotalSpendFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}"));
                $('#span_footer_total_PremiumPouringSpirits').text(sumTotalSpend($('#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}')));
                $('#span_footer_totalFreeCases_PremiumPouringSpirits').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}'), 'cpiTotalSpendFC'));
                //setCaiTotalSpendFreeCases($('#{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}'), '{!premiumPouringSpiritsWrapper.mtExtId}');
            }

            function setHousePouringChampagneTable(){
                var cpiHousePouringChampagne_dataTableProperties = basicDataTableProperties;
                cpiHousePouringChampagne_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle": cpi_EUR_Min_Qty_Per_Annum_9L__c},
                    {"sTitle": cpi_EUR_CRM_Retro_Per_9L__c},
                    {"sTitle": cpi_EUR_CRM_Available_by_the_Glass__c},
                    {"sTitle": cpi_EUR_CRM_Stock_Deal_Mechanic__c},
                    {"sTitle": cpi_EUR_CRM_Free_Cases_9L__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend__c},
                    {"sTitle": cpi_EUR_CRM_Total_Spend_inc_free_cases__c}
                ];
                cpiHousePouringChampagne = $("#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}").dataTable(cpiHousePouringChampagne_dataTableProperties);

                var bqHousePouringChampagne_dataTableProperties = basicDataTableProperties;
                bqHousePouringChampagne_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqHousePouringChampagne = $("#{!BQ_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}").dataTable(bqHousePouringChampagne_dataTableProperties);

                calculateFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}"));
                calculateTotalSpendForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}"));
                calculateTotalSpendFreeCasesForEachCPI($("#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}"));
                $('#span_footer_total_housePouringChampagne').text(sumTotalSpend($('#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}')));
                $('#span_footer_totalFreeCases_housePouringChampagne').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}'), 'cpiTotalSpendFC'));
                //setCaiTotalSpendFreeCases($('#{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}'), '{!housePouringChampagneWrapper.mtExtId}');
            }


            function setMuskStockTable(){
                var cpiMustStock_dataTableProperties = basicDataTableProperties;
                cpiMustStock_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c}
                ];
                cpiMustStock = $("#{!CPI_TABLE_PREFIX}{!mustStockWrapper.mtId}").dataTable(cpiMustStock_dataTableProperties);

                var bqMustStock_dataTableProperties = basicDataTableProperties;
                bqMustStock_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqMustStock = $("#{!BQ_TABLE_PREFIX}{!mustStockWrapper.mtId}").dataTable(bqMustStock_dataTableProperties);
            }

            function setMayStockTable(){
                var cpiMayStock_dataTableProperties = basicDataTableProperties;
                cpiMayStock_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c}
                ];
                cpiMayStock = $("#{!CPI_TABLE_PREFIX}{!mayStockWrapper.mtId}").dataTable(cpiMayStock_dataTableProperties);

                var bqMayStock_dataTableProperties = basicDataTableProperties;
                bqMayStock_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqMayStock = $("#{!BQ_TABLE_PREFIX}{!mayStockWrapper.mtId}").dataTable(bqMayStock_dataTableProperties);
            }

            function setCocktailTable(){
                setCocktailLineItemTable();
                var bqCocktail_dataTableProperties = basicDataTableProperties;
                bqCocktail_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqCocktail = $("#{!BQ_TABLE_PREFIX}{!cocktailWrapper.mtId}").dataTable(bqCocktail_dataTableProperties);
            }

            function setCocktailLineItemTable(){
                var cpiCocktail_dataTableProperties = basicDataTableProperties;

                cpiCocktail_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle":cpi_EUR_CRM_No_of_Cocktails__c},
                    {"sTitle":cpi_EUR_CRM_Cocktail_Menu__c}
                ];
                cpiCocktail = $("#{!CPI_TABLE_PREFIX}{!cocktailWrapper.mtId}").dataTable(cpiCocktail_dataTableProperties);
            }

            function setMktgSupportTable(){
                var cpiMktgSupport_dataTableProperties = basicDataTableProperties;
                cpiMktgSupport_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle":cpi_EUR_CRM_Value__c}
                ];
                cpiMktgSupport = $("#{!CPI_TABLE_PREFIX}{!mktgSupportWrapper.mtId}").dataTable(cpiMktgSupport_dataTableProperties);

                var bqMktgSupport_dataTableProperties = basicDataTableProperties;
                bqMktgSupport_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqMktgSupport = $("#{!BQ_TABLE_PREFIX}{!mktgSupportWrapper.mtId}").dataTable(bqMktgSupport_dataTableProperties);
                $('#footer_total_MktgSupport').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!mktgSupportWrapper.mtId}'), 'cpiValue'));
            }

            function setTripTable(){
                var cpiTrip_dataTableProperties = basicDataTableProperties;
                cpiTrip_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle":"Trip Name"},
                    {"sTitle": cpi_EUR_CRM_No_of_People__c},
                    {"sTitle":cpi_EUR_CRM_Value__c}
                ];

                var bqTrip_contractMechanicColumns = [
                    {"sTitle": cpi_EUR_CRM_Action},
                    {"sTitle": cpi_EUR_CRM_Brand_Quality__c},
                    // {"sTitle": "Trip Name"},
                    {"sTitle": "Category"}
                ]
                cpiTrip = $("#{!CPI_TABLE_PREFIX}{!tripWrapper.mtId}").dataTable(cpiTrip_dataTableProperties);

                var bqTrip_dataTableProperties = basicDataTableProperties;
                bqTrip_dataTableProperties["aoColumns"] = bqTrip_contractMechanicColumns;
                bqTrip = $("#{!BQ_TABLE_PREFIX}{!tripWrapper.mtId}").dataTable(bqTrip_dataTableProperties);
                $('#footer_total_Trip').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!tripWrapper.mtId}'), 'cpiValue'));
            }

            function setEducationTable(){
                var cpiEducation_dataTableProperties = basicDataTableProperties;
                cpiEducation_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle": "Education Name"},
                    {"sTitle":cpi_EUR_CRM_Value__c}
                ];

                var bqEducation_contractMechanicColumns = [
                    {"sTitle": cpi_EUR_CRM_Action},
                    {"sTitle": cpi_EUR_CRM_Brand_Quality__c},
                    // {"sTitle": "Education Name"},
                    {"sTitle": "Category"}
                ];
                cpiEducation = $("#{!CPI_TABLE_PREFIX}{!educationWrapper.mtId}").dataTable(cpiEducation_dataTableProperties);

                var bqEducation_dataTableProperties = basicDataTableProperties;
                bqEducation_dataTableProperties["aoColumns"] = bqEducation_contractMechanicColumns;
                bqEducation = $("#{!BQ_TABLE_PREFIX}{!educationWrapper.mtId}").dataTable(bqEducation_dataTableProperties);
                $('#footer_total_Education').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!educationWrapper.mtId}'), 'cpiValue'));
            }

            function setPOSTable(){
                var cpiPOS_dataTableProperties = basicDataTableProperties;
                cpiPOS_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle":cpi_EUR_CRM_POS_type__c},
                    {"sTitle":cpi_EUR_CRM_Value__c}
                ];
                cpiPOS = $("#{!CPI_TABLE_PREFIX}{!posWrapper.mtId}").dataTable(cpiPOS_dataTableProperties);

                var bqPOS_dataTableProperties = basicDataTableProperties;
                bqPOS_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqPOS = $("#{!BQ_TABLE_PREFIX}{!posWrapper.mtId}").dataTable(bqPOS_dataTableProperties);
                $('#footer_total_POS').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!posWrapper.mtId}'), 'cpiValue'));
            }

            function setFreeStockTable(){
                var cpiFreeStock_dataTableProperties = basicDataTableProperties;
                cpiFreeStock_dataTableProperties["aoColumns"] = [
                    {"sTitle":cpi_EUR_CRM_Action},
                    {"sTitle":cpi_EUR_CRM_Brand_Quality__c},
                    {"sTitle":cpi_EUR_CRM_Value__c}
                ];
                cpiFreeStock = $("#{!CPI_TABLE_PREFIX}{!freeStockWrapper.mtId}").dataTable(cpiFreeStock_dataTableProperties);

                var bqFreeStock_dataTableProperties = basicDataTableProperties;
                bqFreeStock_dataTableProperties["aoColumns"] = brandQualityColumns;
                bqFreeStock = $("#{!BQ_TABLE_PREFIX}{!freeStockWrapper.mtId}").dataTable(bqFreeStock_dataTableProperties);
                $('#footer_total_FreeStock').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!freeStockWrapper.mtId}'), 'cpiValue'));
            }

            function setMarketingPackageTables(){
                setMktgSupportTable();
                setTripTable();
                setEducationTable();
                setPOSTable();
                setFreeStockTable();
            }

            function validateQty(input){
                var decimal=  /^([+]?)([0-9]*)(\.[0-9]{1})?$/;
                return decimal.test(input);
            }

            function validateDecimal(input){
                var decimal=  /^([+]?)([0-9]*)(\.[0-9]+)?$/;
                return decimal.test(input);
            }

            function calculateTotalSum(tableEle, className) {
                var allCpiContentRow = tableEle.find(".caiContent");
                var totalValue = 0;
                for (i=0; i<allCpiContentRow.length; i++){
                    var cpiContentRow = $(allCpiContentRow[i]);
                    var cpiValueCell = cpiContentRow.find("input." + className);
                    var cpiValue = cpiValueCell.val();
                    // console.log('cpiValueCell => ', cpiValueCell.text());
                    if (!cpiValue) {
                        cpiValue = parseFloat(cpiContentRow.find("span." + className).text());
                    }
                    // console.log('cpiValue => ', cpiValue);
                    if (cpiValue && validateDecimal(cpiValue)) {
                        cpiValueCell.removeClass('error-input');
                        totalValue += parseFloat(cpiValue);
                    } else {
                        cpiValueCell.addClass('error-input');
                    }
                }
                return totalValue.toFixed(2);
            }

            // function setCaiTotalSpendFreeCases(tableEle, mtExtId) {
            //     // console.log('setCaiTotalSpendFreeCases : ');
            //     setCaiTotalSpendFreeCasesApex(mtExtId, calculateTotalSum(tableEle, 'cpiTotalSpendFC'));
            // }

            function calculateTotalSpendFreeCasesForCPI(cpiRow) {
                var totSpFCases=0;
                // var isInputValid = false;
                // console.log('cpiRow => ', cpiRow);
                var frCasesText = cpiRow.find("[id*='cpiFreeCases']").text();
                var bqId = cpiRow.find("[id*='cpiFreeCases']").attr('id').split('cpiFreeCases_')[1];
                var bqOSG = parseFloat(bqByIdToCalculateTotalFreeCases[bqId]);
                // console.log('id => ', bqId);
                // console.log('bqOSG => ', bqOSG);
                var freeCases = parseFloat(frCasesText);
                // var qty = cpiRow.find("input.cpiQty").val();
                if (freeCases && bqOSG) {
                    totSpFCases = precise_round(freeCases * bqOSG, 2)
                    return totSpFCases
                }
                // if (validateQty(qty)){
                //     cpiRow.find("input.cpiQty").removeClass('error-input');
                //     isInputValid = true;
                // }else{
                //     cpiRow.find("input.cpiQty").addClass('error-input');
                //     isAllInputValid = false;
                // }
                //
                // var retro = cpiRow.find("input.cpiRetro").val();
                // if (validateDecimal(retro)){
                //     cpiRow.find("input.cpiRetro").removeClass('error-input');
                //     isInputValid = true;
                // }else{
                //     cpiRow.find("input.cpiRetro").addClass('error-input');
                //     isAllInputValid = false;
                // }
                //
                //
                // if (isInputValid){
                //     qty = (qty != null && qty != undefined && qty != "NaN")?parseFloat(qty):0;
                //     retro = (retro != null && retro != undefined && retro != "NaN")?parseFloat(retro):0;
                //     console.log('qty => ', qty, ' retro => ', retro, 'freeCases => ', freeCases);
                //     // console.log('qty => ', qty);
                //     // console.log('retro => ', retro);
                //     totSpFCases = (qty + freeCases) * retro;
                //     totSpFCases = precise_round(totSpFCases, 2);
                //     console.log('totSpFCases => ', totSpFCases);
                //     totSpFCases = isNaN(totSpFCases) ? 0 : totSpFCases;
                //     return totSpFCases;
                // }

                return 0;
            }

            function calculateTotalSpendForCPI(cpiRow){
                var totalSpendVal=0;
                var isInputValid = false;

                var qty = cpiRow.find("input.cpiQty").val();//cliRow.children().children(".cpiQty").val();
                if (validateQty(qty)){
                    cpiRow.find("input.cpiQty").removeClass('error-input');
                    isInputValid = true;
                }else{
                    cpiRow.find("input.cpiQty").addClass('error-input');
                    isAllInputValid = false;
                }

                var retro = cpiRow.find("input.cpiRetro").val();//cliRow.children().children(".cpiRetro").val();
                if (validateDecimal(retro)){
                    cpiRow.find("input.cpiRetro").removeClass('error-input');
                    isInputValid = true;
                }else{
                    cpiRow.find("input.cpiRetro").addClass('error-input');
                    isAllInputValid = false;
                }

                if (isInputValid){
                    qty = (qty != null && qty != undefined && qty != "NaN")?parseFloat(qty):0;
                    retro = (retro != null && retro != undefined && retro != "NaN")?parseFloat(retro):0;

                    totalSpendVal = precise_round(qty*retro, 2);
                    totalSpendVal = isNaN(totalSpendVal)?0:totalSpendVal;
                    return totalSpendVal;
                }

                return 0;
            }

            function calculateTotalSpendFreeCasesForEachCPI(tableEle) {
                var allCpiContentRow = tableEle.find(".caiContent");

                for (i=0; i<allCpiContentRow.length; i++){
                    var cpiContentRow = $(allCpiContentRow[i]);
                    var tSpend = calculateTotalSpendFreeCasesForCPI(cpiContentRow);
                    cpiContentRow.find("span.cpiTotalSpendFC").text(tSpend);//cliCon[tentRow.children().children(".cpiTotalSpend").text(tSpend);
                }
            }

            function calculateTotalSpendForEachCPI(tableEle){
                var allCpiContentRow = tableEle.find(".caiContent");

                for (i=0; i<allCpiContentRow.length; i++){
                    var cpiContentRow = $(allCpiContentRow[i]);
                    var tSpend = calculateTotalSpendForCPI(cpiContentRow);
                    console.log('tSpend => ', tSpend);
                    cpiContentRow.find("span.cpiTotalSpend").text(tSpend);//cliContentRow.children().children(".cpiTotalSpend").text(tSpend);
                }
            }

            function calculateFreeCasesForEachCPI(tableEle) {
                var allCpiContentRow = tableEle.find(".caiContent");
                for (i=0; i<allCpiContentRow.length; i++){
                    var cpiContentRow = $(allCpiContentRow[i]);
                    var tFreeCases = calculateFreeCasesForCPI(cpiContentRow);
                    console.log('tFreeCases => ', tFreeCases);
                    cpiContentRow.find("[id*='cpiFreeCases']").text(tFreeCases);
                }
            }

            function sumTotalSpend(tableEle){
                var sTotalSpend = 0;
                var totalSpendArr = tableEle.find("span.cpiTotalSpend");

                for (i=0; i<totalSpendArr.length; i++){
                    var totalSpendEle = $(totalSpendArr[i]);
                    var fTotalSpend = parseFloat(totalSpendEle.text())
                    fTotalSpend = isNaN(fTotalSpend) ? 0 : fTotalSpend;
                    sTotalSpend += fTotalSpend;
                }

                sTotalSpend = isNaN(sTotalSpend) ? 0 : sTotalSpend;
                return precise_round(sTotalSpend, 2);
            }

            function precise_round(num,decimals){
                return Math.round(num*Math.pow(10,decimals))/Math.pow(10,decimals);
            }

            function calculateFreeCasesForCPI(cpiRow) {
                // console.log('cpiRow => ', cpiRow);
                var isInputValid = false;
                var freeCases = 0;
                try{
                    var sdmId = cpiRow.find("select.cpiSDM").val();
                    if (!sdmId) { return 0;}
                    var qty = cpiRow.find("input.cpiQty").val();
                    var sdm = allSdmById[sdmId];
                    var sdmQtyBuy = sdm['EUR_CRM_Qty_Buy__c'];
                    var sdmQtyFree = sdm['EUR_CRM_Qty_Free__c'];
                    if (validateQty(qty)){
                        cpiRow.find("input.cpiQty").removeClass('error-input');
                        isInputValid = true;
                    }else{
                        cpiRow.find("input.cpiQty").addClass('error-input');
                    }
                    // console.log('stockDealId => ', sdmId);
                    // console.log('sdm => ', sdm);
                    // console.log('sdmQtyBuy => ', sdmQtyBuy);
                    // console.log('sdmQtyFree => ', sdmQtyFree);

                    if (isInputValid) {
                        freeCases = (qty / sdmQtyBuy ) * sdmQtyFree;
                        if (freeCases !== Infinity && freeCases) {
                            freeCases =  precise_round(freeCases, 2);
                        }
                    }
                } catch (err) {
                    console.error('error in calculateFreeCasesForCPI => ', err);
                }
                console.log('freeCases => ', freeCases);
                return freeCases;
            }

        </script>

        <style>
            body {
                margin-top: 40px;
                font-size: 12px;
                font-family: Helvetica,Arial,Verdana,sans-serif;
                width:100%;
            }

            table.dataTable {
                width: 100% !important;
            }

            .loadingOverlay{
                opacity: 0.4;
                postion: absolute;
                top:0px;
                left:0px;
                background-color:#001100;
                width:100%;
                z-index: 5000
            }

            #container1{
                width:100%;
            }

            #tabLink{
                font-size: 9px;
            }

            input.error-input {
                border-color: red;
            }
        </style>
    </head>


    <body>


    <apex:actionStatus id="loading" >
        <apex:facet name="start">
            <c:EUR_CRM_LoadingStatus BackColor="#ffffff"
                                     borderColor="#6B6B6B"
                                     borderSize="1"
                                     height="50px"
                                     width="120px"
                                     margintop="-25px"
                                     marginleft="-60px"
                                     ImageUrl="{!$Resource.loadingStatus}"
                                     Message="Loading..."/>
        </apex:facet>
    </apex:actionStatus>

    <apex:form >
        <div id="contentLoading" style="display:none;">
            <div style="text-align: center;">
                <p>Loading...
                    <img src="/img/loading.gif" alt="Loading graphic" /></p>
            </div>
        </div>

        <!--Start of Creating and populating stock deal mechanic map by Id for dynamic calculation on VF page
        (for HousePouringSpirits, PremiumPouringSpirits, HousePouringChampagne-->
        <apex:repeat var="sdmId" value="{!stockDealMechanicById}">
            <apex:repeat var="sdm" value="{!stockDealMechanicById[sdmId]}">
                <script>
                    allSdmById['{!sdm.Id}'] = {
                        'EUR_CRM_Qty_Buy__c': '{!sdm.EUR_CRM_Qty_Buy__c}'
                    ,   'EUR_CRM_Qty_Free__c': '{!sdm.EUR_CRM_Qty_Free__c}'
                    };
                </script>
            </apex:repeat>
        </apex:repeat>
        <apex:repeat value="{!bqByIdToCalculateTotalFreeCases}" var="bqId">
            <apex:repeat value="{!bqByIdToCalculateTotalFreeCases[bqId]}" var="bq">
                <script>
                    bqByIdToCalculateTotalFreeCases['{!bqId}'] = '{!bq.EUR_CRM_OSG__c}';
                </script>
            </apex:repeat>
        </apex:repeat>
        <!--End of Creating and populating stock deal mechanic map by Id for dynamic calculation on VF page
        (for HousePouringSpirits, PremiumPouringSpirits, HousePouringChampagne-->

<!--        <apex:actionFunction name="setCaiTotalSpendFreeCasesApex" action="{!setCaiTotalSpendFreeCases}" reRender="">-->
<!--            <apex:param value="" name="{!MT_EXT_ID}"/>-->
<!--            <apex:param value="" name="{!CAI_TOTAL_SPEND_FREE_CASES}"/>-->
<!--        </apex:actionFunction>-->
        <apex:actionFunction name="clearMessage" action="{!clearMessage}" reRender="messagePanel"/>

        <div class="container1">
            <apex:pageBlock id="main_pageBlock">
                <apex:outputPanel id="messagePanel" onclick="clearMessage();">
                    <apex:pageMessages id="pageMsg"></apex:pageMessages>
                </apex:outputPanel>
                <apex:pageblockButtons >
                    <apex:commandButton value="{!$Label.EUR_CRM_Save}"
                                        action="{!saveContract}" rerender="pageMsg"
                                        status="loading">
                        <apex:param name="{!IS_QUICK_SAVE}" value="false"/>
                    </apex:commandButton>
                    <apex:commandButton value="Quick Save"
                                        action="{!saveContract}" rerender="main_pageBlock, pageMsg"
                                        oncomplete="preventReturnKeyPress(); removeSymbol(); setTables();"
                                        status="loading">
                        <apex:param name="{!IS_QUICK_SAVE}" value="true"/>
                    </apex:commandButton>
                    <apex:commandButton value="{!$Label.EUR_CRM_Exit}" action="{!cancel}"
                                        rerender="none"
                                        status="loading"/>
                </apex:pageblockButtons>

                <div id="mechanicTypeTabs" class="tabLink">
                    <ul>
                        <li><a href="#tab_HousePouring">{!housePouringWrapper.mtName}</a></li>
                        <li><a href="#tab_PremiumPouringSpirits">{!premiumPouringSpiritsWrapper.mtName}</a></li>
                        <li><a href="#tab_HousePouringChampagne">{!housePouringChampagneWrapper.mtName}</a></li>
                        <li><a href="#tab_MustStock">{!mustStockWrapper.mtName}</a></li>
                        <li><a href="#tab_MayStock">{!mayStockWrapper.mtName}</a></li>
                        <li><a href="#tab_Cocktail">{!cocktailWrapper.mtName}</a></li>
                        <li><a href="#tab_MarketingPackage">Marketing Package</a></li>
                    </ul>

                    <div id="tab_HousePouring">
                        <apex:pageBlock id="pageBlock_HousePouring">
                            <apex:pageBlockSection id="pageblock_cpi_housepouring" title="{!EDIT_CPI_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!CPI_TABLE_PREFIX}{!housePouringWrapper.mtId}">
                                        <apex:repeat value="{!housePouringWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                            <apex:repeat value="{!housePouringWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                <tr id="row_housePouring_{!bqWrap.bq.Id}" class="caiContent">
                                                    <td>
                                                        <apex:commandLink value="Remove"
                                                                          action="{!removeProduct}"
                                                                          reRender="pageBlock_HousePouring, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setHousePouringTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!housePouringWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqWrap.cpi.EUR_CRM_Brand_Quality__c}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:inputField styleclass="cpiQty"
                                                                         value="{!bqWrap.cpi.EUR_Min_Qty_Per_Annum_9L__c}"
                                                                         onchange=" setHousePouringTable();"
                                                        />
                                                    </td>
                                                    <td><apex:inputField styleclass="cpiRetro" value="{!bqWrap.cpi.EUR_CRM_Retro_Per_9L__c}"
                                                                         onchange="setHousePouringTable();"

                                                        />
                                                    </td>
                                                    <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_Optics__c}"/></td>
                                                    <td>
                                                        <apex:selectList styleclass="cpiSDM"
                                                                         value="{!bqWrap.cpi.EUR_CRM_Stock_Deal_Mechanic__c}" size="1" multiSelect="false"
                                                                         onChange="setHousePouringTable();"
                                                        >
                                                            <apex:selectOptions value="{!bqWrap.sdmSelectOptions}"/>
                                                        </apex:selectList>
                                                    </td>
                                                    <td>
                                                        <span id="cpiFreeCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Free_Cases_9L__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpend" id="housePouring_totalSpend_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Total_Spend__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpendFC" id="housePouring_totSpFCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Total_Spend_inc_free_cases__c}</span>
                                                    </td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                        <tfoot>
                                        <tr>
                                            <th style="text-align:right;" colspan="7" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                            <th id="footer_total_housePouring" rowspan="1" colspan="1">
                                                <span id="span_footer_total_housePouring"/>
                                            </th>
                                            <th rowspan="1" colspan="1">
                                                <span id="span_footer_totalFreeCases_housePouring">{!housePouringWrapper.cai.EUR_CRM_Total_Spent_Free_cases__c}</span>
                                            </th>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                            <br/>
                            <apex:pageBlockSection id="pageblock_product_housepouring" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                <apex:outputPanel >
                                    <table id="{!BQ_TABLE_PREFIX}{!housePouringWrapper.mtId}">
                                        <apex:repeat value="{!housePouringWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                            <apex:repeat value="{!housePouringWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                            <tr>
                                                <td>
                                                    <apex:commandLink value="Add"
                                                                      action="{!addProduct}"
                                                                      rerender="pageBlock_HousePouring, pageBlock_Cocktail"
                                                                      onComplete="preventReturnKeyPress(); setHousePouringTable();"
                                                                      status="loading">
                                                        <apex:param name="{!MT_EXT_ID}" value="{!housePouringWrapper.mtExtId}"/>
                                                        <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                    </apex:commandLink>
                                                </td>
                                                <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                            </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                        </apex:pageBlock>
                    </div>

                    <div id="tab_PremiumPouringSpirits">
                        <apex:pageBlock id="pageBlock_PremiumPouringSpirits">
                            <apex:pageBlockSection id="pageblock_cpi_PremiumPouringSpirits" title="{!EDIT_CPI_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!CPI_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}">
                                        <apex:repeat value="{!premiumPouringSpiritsWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                            <apex:repeat value="{!premiumPouringSpiritsWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                <tr id="row_PremiumPouringSpirits_{!bqWrap.bq.Id}" class="caiContent">
                                                    <td>
                                                        <apex:commandLink value="Remove"
                                                                          action="{!removeProduct}"
                                                                          reRender="pageBlock_PremiumPouringSpirits, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setPremiumPouringSpiritsTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!premiumPouringSpiritsWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqWrap.cpi.EUR_CRM_Brand_Quality__c}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:inputField styleclass="cpiQty"
                                                                         value="{!bqWrap.cpi.EUR_Min_Qty_Per_Annum_9L__c}"
                                                                         onchange="setPremiumPouringSpiritsTable();"
                                                        />
                                                    </td>
                                                    <td><apex:inputField styleclass="cpiRetro" value="{!bqWrap.cpi.EUR_CRM_Retro_Per_9L__c}"
                                                                         onchange="setPremiumPouringSpiritsTable();"
                                                        />
                                                    </td>
                                                    <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_Optics__c}"/></td>
                                                    <td style="width:10%">
                                                        <apex:selectList styleclass="cpiSDM"
                                                                         onChange="setPremiumPouringSpiritsTable();"
                                                                         value="{!bqWrap.cpi.EUR_CRM_Stock_Deal_Mechanic__c}" size="1" multiSelect="false" >
                                                            <apex:selectOptions value="{!bqWrap.sdmSelectOptions}"/>
                                                        </apex:selectList>
                                                    </td>
                                                    <td style="width:10%">
                                                        <span id="cpiFreeCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Free_Cases_9L__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpend" id="PremiumPouringSpirits_totalSpend_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Total_Spend__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpendFC" id="PremiumPouringSpirits_totSpFCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Total_Spend_inc_free_cases__c}</span>
                                                    </td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                        <tfoot>
                                        <tr>
                                            <th style="text-align:right;" colspan="7" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                            <th id="footer_total_PremiumPouringSpirits" rowspan="1" colspan="1">
                                                <span id="span_footer_total_PremiumPouringSpirits"/>
                                            </th>
                                            <th rowspan="1" colspan="1">
                                                <span id="span_footer_totalFreeCases_PremiumPouringSpirits">{!premiumPouringSpiritsWrapper.cai.EUR_CRM_Total_Spent_Free_cases__c}</span>
                                            </th>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                            <br/>
                            <apex:pageBlockSection id="pageblock_product_PremiumPouringSpirits" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!BQ_TABLE_PREFIX}{!premiumPouringSpiritsWrapper.mtId}">
                                        <apex:repeat value="{!premiumPouringSpiritsWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                            <apex:repeat value="{!premiumPouringSpiritsWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                <tr>
                                                    <td>
                                                        <apex:commandLink value="Add"
                                                                          action="{!addProduct}"
                                                                          rerender="pageBlock_PremiumPouringSpirits, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setPremiumPouringSpiritsTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!premiumPouringSpiritsWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                        </apex:pageBlock>
                    </div>

                    <div id="tab_HousePouringChampagne">
                        <apex:pageBlock id="pageBlock_HousePouringChampagne">
                            <apex:pageBlockSection id="pageblock_cpi_HousePouringChampagne" title="{!EDIT_CPI_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!CPI_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}">
                                        <apex:repeat value="{!housePouringChampagneWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                            <apex:repeat value="{!housePouringChampagneWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                <tr id="row_housePouringChampagne_{!bqId}" class="caiContent">
                                                    <td>
                                                        <apex:commandLink value="Remove"
                                                                          action="{!removeProduct}"
                                                                          rerender="pageBlock_HousePouringChampagne, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setHousePouringChampagneTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!housePouringChampagneWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:inputField styleclass="cpiQty"
                                                                         value="{!bqWrap.cpi.EUR_Min_Qty_Per_Annum_9L__c}"
                                                                         onchange="setHousePouringChampagneTable();"
                                                                        />
                                                    </td>
                                                    <td><apex:inputField styleclass="cpiRetro"
                                                                         value="{!bqWrap.cpi.EUR_CRM_Retro_Per_9L__c}"
                                                                         onchange="setHousePouringChampagneTable();"
                                                                         />
                                                    </td>
                                                    <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_Available_by_the_Glass__c}"/></td>
                                                    <td style="width:10%">
                                                        <apex:selectList styleclass="cpiSDM"
                                                                         value="{!bqWrap.cpi.EUR_CRM_Stock_Deal_Mechanic__c}" size="1" multiSelect="false"
                                                                         onChange="setHousePouringChampagneTable();"
                                                        >
                                                            <apex:selectOptions value="{!bqWrap.sdmSelectOptions}"/>
                                                        </apex:selectList>
                                                    </td>
                                                    <td style="width:10%">
                                                        <span id="cpiFreeCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Free_Cases_9L__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpend" id="housePouringChampagne_totalSpend_{!bqId}">{!bqWrap.cpi.EUR_CRM_Total_Spend__c}</span>
                                                    </td>
                                                    <td>
                                                        <span class="cpiTotalSpendFC" id="housePouringChampagne_totSpFCases_{!bqWrap.bq.Id}">{!bqWrap.cpi.EUR_CRM_Total_Spend_inc_free_cases__c}</span>
                                                    </td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                        <tfoot>
                                        <tr>
                                            <th style="text-align:right;" colspan="7" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                            <th id="footer_total_housePouringChampagne" rowspan="1" colspan="1">
                                                <span id="span_footer_total_housePouringChampagne"/>
                                            </th>
                                            <th rowspan="1" colspan="1">
                                                <span id="span_footer_totalFreeCases_housePouringChampagne">{!housePouringChampagneWrapper.cai.EUR_CRM_Total_Spent_Free_cases__c}</span>
                                            </th>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                            <br/>
                            <apex:pageBlockSection id="pageblock_product_HousePouringChampagne" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!BQ_TABLE_PREFIX}{!housePouringChampagneWrapper.mtId}">
                                        <apex:repeat value="{!housePouringChampagneWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                            <apex:repeat value="{!housePouringChampagneWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                            <tr>
                                                <td>
                                                    <apex:commandLink value="Add"
                                                                      action="{!addProduct}"
                                                                      rerender="pageBlock_HousePouringChampagne, pageBlock_Cocktail"
                                                                      onComplete="preventReturnKeyPress(); setHousePouringChampagneTable(); setCocktailTable();"
                                                                      status="loading">
                                                        <apex:param name="{!MT_EXT_ID}" value="{!housePouringChampagneWrapper.mtExtId}"/>
                                                        <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                    </apex:commandLink>
                                                </td>
                                                <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                            </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                        </apex:pageBlock>
                    </div>

                    <div id="tab_MustStock">
                        <apex:pageBlock id="pageBlock_MustStock">
                            <apex:pageBlockSection id="pageblock_cpi_MustStock" title="{!EDIT_CPI_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!CPI_TABLE_PREFIX}{!mustStockWrapper.mtId}">
                                        <apex:repeat value="{!mustStockWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                            <apex:repeat value="{!mustStockWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                <tr>
                                                    <td>
                                                        <apex:commandLink value="Remove"
                                                                          action="{!removeProduct}"
                                                                          rerender="pageBlock_MustStock, pageBlock_MayStock, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setMuskStockTable(); setMayStockTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!mustStockWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                            <apex:pageBlockSection id="pageblock_product_MustStock" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!BQ_TABLE_PREFIX}{!mustStockWrapper.mtId}">
                                        <apex:repeat value="{!mustStockWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                            <apex:repeat value="{!mustStockWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                <tr>
                                                    <td>
                                                        <apex:commandLink value="Add"
                                                                          action="{!addProduct}"
                                                                          rerender="pageBlock_MustStock, pageBlock_MayStock, pageBlock_Cocktail, messagePanel"
                                                                          onComplete="preventReturnKeyPress(); setMuskStockTable(); setMayStockTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!mustStockWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                        </apex:pageBlock>
                    </div>

                    <div id="tab_MayStock">
                        <apex:pageBlock id="pageBlock_MayStock">
                            <apex:pageBlockSection id="pageblock_cpi_MayStock" title="{!EDIT_CPI_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!CPI_TABLE_PREFIX}{!mayStockWrapper.mtId}">
                                        <apex:repeat value="{!mayStockWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                            <apex:repeat value="{!mayStockWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                <tr>
                                                    <td>
                                                        <apex:commandLink value="Remove"
                                                                          action="{!removeProduct}"
                                                                          rerender="pageBlock_MayStock, pageBlock_MustStock, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setMayStockTable(); setMuskStockTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!mayStockWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                            <apex:pageBlockSection id="pageblock_product_MayStock" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                <apex:outputPanel layout="block">
                                    <table id="{!BQ_TABLE_PREFIX}{!mayStockWrapper.mtId}">
                                        <apex:repeat value="{!mayStockWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                            <apex:repeat value="{!mayStockWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                <tr>
                                                    <td>
                                                        <apex:commandLink value="Add"
                                                                          action="{!addProduct}"
                                                                          rerender="pageBlock_MayStock, pageBlock_MustStock, pageBlock_Cocktail"
                                                                          onComplete="preventReturnKeyPress(); setMayStockTable(); setMuskStockTable(); setCocktailTable();"
                                                                          status="loading">
                                                            <apex:param name="{!MT_EXT_ID}" value="{!mayStockWrapper.mtExtId}"/>
                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                        </apex:commandLink>
                                                    </td>
                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                </tr>
                                            </apex:repeat>
                                        </apex:repeat>
                                    </table>
                                </apex:outputPanel>
                            </apex:pageBlockSection>
                        </apex:pageBlock>
                    </div>

                    <div id="tab_Cocktail">
                        <apex:outputPanel id="CocktailContainer">
                            <apex:outputPanel id="CocktailContainer_LumpSum" layout="block" rendered="true">
                                <apex:pageBlock >
                                    <apex:pageBlockSection >
                                        <apex:pageBlockSectionItem >
                                            <apex:outputLabel value="Cocktail Percentage:"/>
                                            <apex:inputField value="{!cocktailWrapper.cai.EUR_CRM_Cocktail_Percent__c}"/>
                                        </apex:pageBlockSectionItem>
                                    </apex:pageBlockSection>
                                </apex:pageBlock>
                            </apex:outputPanel>
                            <apex:outputPanel id="CocktailContainer_PerBQ" layout="block" rendered="true">
                                <apex:pageBlock id="pageBlock_Cocktail">
                                    <apex:pageBlockSection id="pageblock_cpi_Cocktail" title="{!EDIT_CPI_TITLE}" columns="1">
                                        <apex:outputPanel layout="block">
                                            <table id="{!CPI_TABLE_PREFIX}{!cocktailWrapper.mtId}">
                                                <apex:repeat value="{!cocktailWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                    <apex:repeat value="{!cocktailWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                        <tr>
                                                            <td>
                                                                <apex:commandLink value="Remove"
                                                                                  action="{!removeProduct}"
                                                                                  rerender="pageBlock_Cocktail"
                                                                                  onComplete="preventReturnKeyPress(); setCocktailTable();"
                                                                                  status="loading">
                                                                    <apex:param name="{!MT_EXT_ID}" value="{!cocktailWrapper.mtExtId}"/>
                                                                    <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                </apex:commandLink>
                                                            </td>
                                                            <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                            <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_No_of_Cocktails__c}"/></td>
                                                            <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_Cocktail_Menu__c}"/></td>
                                                        </tr>
                                                    </apex:repeat>
                                                </apex:repeat>
                                            </table>
                                        </apex:outputPanel>
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection id="pageblock_product_Cocktail" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                        <apex:outputPanel layout="block">
                                            <table id="{!BQ_TABLE_PREFIX}{!cocktailWrapper.mtId}">
                                                <apex:repeat value="{!cocktailWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                    <apex:repeat value="{!cocktailWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                        <tr>
                                                            <td>
                                                                <apex:commandLink value="Add"
                                                                                  action="{!addProduct}"
                                                                                  rerender="pageBlock_Cocktail"
                                                                                  onComplete="preventReturnKeyPress(); setCocktailTable();"
                                                                                  status="loading">
                                                                    <apex:param name="{!MT_EXT_ID}" value="{!cocktailWrapper.mtExtId}"/>
                                                                    <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                </apex:commandLink>
                                                            </td>
                                                            <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                            <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                        </tr>
                                                    </apex:repeat>
                                                </apex:repeat>
                                            </table>
                                        </apex:outputPanel>
                                    </apex:pageBlockSection>
                                </apex:pageBlock>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </div>

                    <div id="tab_MarketingPackage">
                            <apex:outputPanel id="MarketingContainer_PerBQ" layout="block"  >
                                <div id="SubTabs_MktgPackage">
                                    <ul>
                                        <li><a href="#tab_LumpSum">Lump Sum</a></li>
                                        <li><a href="#tab_BarSupport">Bar Support</a></li>
                                        <li><a href="#tab_MarketingSupport">Marketing Support</a></li>
                                        <li><a href="#tab_Trip">Trip</a></li>
                                        <li><a href="#tab_Education">Education</a></li>
                                        <li><a href="#tab_PointOfSale">Point of Sale</a></li>
                                        <li><a href="#tab_FreeStock">Free Stock</a></li>
                                    </ul>

                                    <div id="tab_LumpSum">
                                        <apex:outputPanel id="panel_LumpSum" layout="block">
                                            <apex:pageBlock >
                                                <apex:pageBlockSection >
                                                    <apex:pageBlockSectionItem >
                                                        <apex:outputLabel value="{!$ObjectType.EUR_CRM_Contract_Activity_Item__c.fields.EUR_CRM_Amount__c.label}"/>
                                                        <apex:inputField value="{!lumpSumWrapper.cai.EUR_CRM_Amount__c}"/>
                                                    </apex:pageBlockSectionItem>
                                                </apex:pageBlockSection>
                                            </apex:pageBlock>
                                        </apex:outputPanel>
                                    </div>
                                    <div id="tab_BarSupport">
                                        <apex:outputPanel id="panel_barSupport" layout="block">
                                            <apex:pageBlock >
                                                <apex:pageBlockSection >
                                                    <apex:pageBlockSectionItem >
                                                        <apex:outputLabel value="{!$ObjectType.EUR_CRM_Contract_Activity_Item__c.fields.EUR_CRM_Amount__c.label}"/>
                                                        <apex:inputField value="{!barSupportWrapper.cai.EUR_CRM_Amount__c}"/>
                                                    </apex:pageBlockSectionItem>
                                                </apex:pageBlockSection>
                                            </apex:pageBlock>
                                        </apex:outputPanel>
                                    </div>

                                    <div id="tab_MarketingSupport">
                                        <apex:pageBlock id="pageBlock_MktgSupport">
                                            <apex:pageBlockSection id="pageblock_cpi_mktgSupport" title="{!EDIT_CPI_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!CPI_TABLE_PREFIX}{!mktgSupportWrapper.mtId}">
                                                        <apex:repeat value="{!mktgSupportWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                            <apex:repeat value="{!mktgSupportWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                                <tr class="caiContent">
                                                                    <td>
                                                                        <apex:commandLink value="Remove"
                                                                                          action="{!removeProduct}"
                                                                                          rerender="pageBlock_MktgSupport"
                                                                                          onComplete="preventReturnKeyPress(); setMktgSupportTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!mktgSupportWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td>
                                                                        <apex:inputField styleClass="cpiValue"
                                                                                         onChange="$('#footer_total_MktgSupport').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!mktgSupportWrapper.mtId}'), 'cpiValue'))"
                                                                                         value="{!bqWrap.cpi.EUR_CRM_Value__c}"/>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                        <tfoot>
                                                        <tr>
                                                            <th style="text-align:right;" colspan="2" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                                            <th id="footer_total_MktgSupport" rowspan="1" colspan="1">
                                                                <apex:outputText id="totalValueField" value="{!mktgSupportWrapper.cai.EUR_CRM_Total_Value__c}"/>
                                                            </th>
                                                        </tr>
                                                        </tfoot>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>

                                            <apex:pageBlockSection id="pageblock_product_mktgSupport" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!BQ_TABLE_PREFIX}{!mktgSupportWrapper.mtId}">
                                                        <apex:repeat value="{!mktgSupportWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                            <apex:repeat value="{!mktgSupportWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                                <tr>
                                                                    <td>
                                                                        <apex:commandLink value="Add"
                                                                                          action="{!addProduct}"
                                                                                          rerender="pageBlock_MktgSupport"
                                                                                          onComplete="preventReturnKeyPress(); setMktgSupportTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!mktgSupportWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </div>

                                    <div id="tab_Trip">
                                        <apex:pageBlock id="pageBlock_Trip">
                                            <apex:pageBlockSection id="pageblock_cpi_Trip" title="{!EDIT_CPI_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!CPI_TABLE_PREFIX}{!tripWrapper.mtId}">
                                                        <apex:repeat value="{!tripWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                            <apex:repeat value="{!tripWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                                <tr class="caiContent">
                                                                    <td>
                                                                        <apex:commandLink value="Remove"
                                                                                          action="{!removeProduct}"
                                                                                          rerender="pageBlock_Trip"
                                                                                          onComplete="preventReturnKeyPress(); setTripTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!tripWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td style="width:10%">
                                                                        <apex:selectList styleclass="cpiCM" value="{!bqWrap.cpi.EUR_CRM_Contract_Mechanic__c}" size="1" multiSelect="false" >
                                                                            <apex:selectOptions value="{!bqWrap.cmSelectOptions}"/>
                                                                        </apex:selectList>
                                                                    </td>
                                                                    <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_No_of_People__c}"/></td>
                                                                    <td>
                                                                        <apex:inputField styleClass="cpiValue"
                                                                                         onChange="$('#footer_total_Trip').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!tripWrapper.mtId}'), 'cpiValue'))"
                                                                                         value="{!bqWrap.cpi.EUR_CRM_Value__c}"/>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                        <tfoot>
                                                            <tr>
                                                                <th style="text-align:right;" colspan="4" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                                                <th id="footer_total_Trip" rowspan="1" colspan="1">
                                                                    <apex:outputText id="totalValueField" value="{!tripWrapper.cai.EUR_CRM_Total_Value__c}"/>
                                                                </th>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                            <apex:pageBlockSection id="pageblock_product_Trip" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!BQ_TABLE_PREFIX}{!tripWrapper.mtId}">
                                                        <apex:repeat value="{!tripWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                            <apex:repeat value="{!tripWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                                <tr>
                                                                    <td>
                                                                        <apex:commandLink value="Add"
                                                                                          action="{!addProduct}"
                                                                                          rerender="pageBlock_Trip"
                                                                                          onComplete="preventReturnKeyPress(); setTripTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!tripWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </div>

                                    <div id="tab_Education">
                                        <apex:pageBlock id="pageBlock_Education">
                                            <apex:pageBlockSection id="pageblock_cpi_Education" title="{!EDIT_CPI_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!CPI_TABLE_PREFIX}{!educationWrapper.mtId}">
                                                        <apex:repeat value="{!educationWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                            <apex:repeat value="{!educationWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                                <tr class="caiContent">
                                                                    <td>
                                                                        <apex:commandLink value="Remove"
                                                                                          action="{!removeProduct}"
                                                                                          rerender="pageBlock_Education"
                                                                                          onComplete="preventReturnKeyPress(); setEducationTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!educationWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td style="width:10%">
                                                                        <apex:selectList styleclass="cpiCM" value="{!bqWrap.cpi.EUR_CRM_Contract_Mechanic__c}" size="1" multiSelect="false" >
                                                                            <apex:selectOptions value="{!bqWrap.cmSelectOptions}"/>
                                                                        </apex:selectList>
                                                                    </td>
                                                                    <td>
                                                                        <apex:inputField styleClass="cpiValue"
                                                                                         onChange="$('#footer_total_Education').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!educationWrapper.mtId}'), 'cpiValue'))"
                                                                                         value="{!bqWrap.cpi.EUR_CRM_Value__c}"/>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                        <tfoot>
                                                        <tr>
                                                            <th style="text-align:right;" colspan="3" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                                            <th id="footer_total_Education" rowspan="1" colspan="1">
                                                                <apex:outputText id="totalValueField" value="{!educationWrapper.cai.EUR_CRM_Total_Value__c}"/>
                                                            </th>
                                                        </tr>
                                                        </tfoot>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                            <apex:pageBlockSection id="pageblock_product_Education" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!BQ_TABLE_PREFIX}{!educationWrapper.mtId}">
                                                        <apex:repeat value="{!educationWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                            <apex:repeat value="{!educationWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                                <tr>
                                                                    <td>
                                                                        <apex:commandLink value="Add"
                                                                                          action="{!addProduct}"
                                                                                          rerender="pageBlock_Education"
                                                                                          onComplete="preventReturnKeyPress(); setEducationTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!educationWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </div>

                                    <div id="tab_PointOfSale">
                                        <apex:pageBlock id="pageBlock_POS">
                                            <apex:pageBlockSection id="pageblock_cpi_POS" title="{!EDIT_CPI_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!CPI_TABLE_PREFIX}{!posWrapper.mtId}">
                                                        <apex:repeat value="{!posWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                            <apex:repeat value="{!posWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                                <tr class="caiContent">
                                                                    <td>
                                                                        <apex:commandLink value="Remove"
                                                                                          action="{!removeProduct}"
                                                                                          rerender="pageBlock_POS"
                                                                                          onComplete="preventReturnKeyPress(); setPOSTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!posWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:inputField value="{!bqWrap.cpi.EUR_CRM_POS_type__c}"/></td>
                                                                    <td>
                                                                        <apex:inputField styleClass="cpiValue"
                                                                                         onChange="$('#footer_total_POS').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!posWrapper.mtId}'), 'cpiValue'))"
                                                                                value="{!bqWrap.cpi.EUR_CRM_Value__c}"/>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                        <tfoot>
                                                        <tr>
                                                            <th style="text-align:right;" colspan="3" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                                            <th id="footer_total_POS" rowspan="1" colspan="1">
                                                                <apex:outputText id="totalValueField" value="{!posWrapper.cai.EUR_CRM_Total_Value__c}"/>
                                                            </th>
                                                        </tr>
                                                        </tfoot>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                            <apex:pageBlockSection id="pageblock_product_POS" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!BQ_TABLE_PREFIX}{!posWrapper.mtId}">
                                                        <apex:repeat value="{!posWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                            <apex:repeat value="{!posWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                                <tr>
                                                                    <td>
                                                                        <apex:commandLink value="Add"
                                                                                          action="{!addProduct}"
                                                                                          rerender="pageBlock_POS"
                                                                                          onComplete="preventReturnKeyPress(); setPOSTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!posWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </div>

                                    <div id="tab_FreeStock">
                                        <apex:pageBlock id="pageBlock_FreeStock">
                                            <apex:pageBlockSection id="pageblock_cpi_FreeStock" title="{!EDIT_CPI_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!CPI_TABLE_PREFIX}{!freeStockWrapper.mtId}">
                                                        <apex:repeat value="{!freeStockWrapper.bqWrapperByBqIdInCPIs}" var="bqId">
                                                            <apex:repeat value="{!freeStockWrapper.bqWrapperByBqIdInCPIs[bqId]}" var="bqWrap">
                                                                <tr class="caiContent">
                                                                    <td>
                                                                        <apex:commandLink value="Remove"
                                                                                          action="{!removeProduct}"
                                                                                          rerender="pageBlock_FreeStock"
                                                                                          onComplete="preventReturnKeyPress(); setFreeStockTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!freeStockWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td>
                                                                        <apex:inputField styleClass="cpiValue"
                                                                                         onChange="$('#footer_total_FreeStock').text(calculateTotalSum($('#{!CPI_TABLE_PREFIX}{!freeStockWrapper.mtId}'), 'cpiValue'))"
                                                                                         value="{!bqWrap.cpi.EUR_CRM_Value__c}"/>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                        <tfoot>
                                                        <tr>
                                                            <th style="text-align:right;" colspan="2" rowspan="1"><apex:outputLabel value="Total Value: "/></th>
                                                            <th id="footer_total_FreeStock" rowspan="1" colspan="1">
                                                                <apex:outputField id="totalValueField" value="{!freeStockWrapper.cai.EUR_CRM_Total_Value__c}"/>
                                                            </th>
                                                        </tr>
                                                        </tfoot>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                            <apex:pageBlockSection id="pageblock_product_FreeStock" title="{!BRAND_QUALITIES_TITLE}" columns="1">
                                                <apex:outputPanel layout="block">
                                                    <table id="{!BQ_TABLE_PREFIX}{!freeStockWrapper.mtId}">
                                                        <apex:repeat value="{!freeStockWrapper.bqWrapperByBqIdAvailable}" var="bqId">
                                                            <apex:repeat value="{!freeStockWrapper.bqWrapperByBqIdAvailable[bqId]}" var="bqWrap">
                                                                <tr>
                                                                    <td>
                                                                        <apex:commandLink value="Add"
                                                                                          action="{!addProduct}"
                                                                                          rerender="pageBlock_FreeStock"
                                                                                          onComplete="preventReturnKeyPress(); setFreeStockTable();"
                                                                                          status="loading">
                                                                            <apex:param name="{!MT_EXT_ID}" value="{!freeStockWrapper.mtExtId}"/>
                                                                            <apex:param name="{!BQ_ID}" value="{!bqId}"/>
                                                                        </apex:commandLink>
                                                                    </td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.Name}"/></td>
                                                                    <td><apex:outputField value="{!bqWrap.bq.EUR_CRM_Category__c}"/></td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </table>
                                                </apex:outputPanel>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </div>

                                </div>
                                <script>
                                    $('#SubTabs_MktgPackage').tabs();
                                </script>
                            </apex:outputPanel>
                    </div>
                </div>
                <script>
                    $('#mechanicTypeTabs').tabs();
                </script>

            </apex:pageBlock>
        </div>
    </apex:form>

    </body>

</apex:page>