<!--
*********************************************************************************
 * Name: ASI_CRM_SG_ContractTargetSim_Page
 * Description: Manage Contract Target Simulation Page
 *
 * Version History
 * Date             Developer               Comments
 * ---------------  --------------------    --------------------------------------------------------------------------------
 * 14/03/2017       Hugo Cheung             Created
 * 20/11/2017       Wilken Lee             	[WL 1.0] Apply validation to prevent change in Sales Case or delete target in simulation
 * 2018-03-28       Vincent Lam             [VL 1.0] put RTM WS price on search SKU
 * 2018-08-06       Wilken Lee             	[WL 2.0] ICM118867976 Fix incorrect Child Outlet search list
-->
<apex:page standardController="ASI_TH_CRM_Contract__c" extensions="ASI_CRM_SG_ContractTargetSim_Controller">
    
    <!-- Import Library -->
    <!-- CSS -->
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/main.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/jquery-ui.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/bootstrap.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/styles/datatables.min.css')}" />
    <!-- JavaScript -->
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/bootstrap.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/datatables.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_SG_Library, '/lib/vertical-datatables.js')}" />
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    
	<!-- Style -->
    <style>
        .link-button {
            cursor: pointer;
            text-decoration: underline;
        }
        
        .savingRecord .fullScreenLoading{
            display : block;
        }

        .fullScreenLoading {
            display    : none;
            position   : fixed;
            z-index    : 1000;
            top        : 0;
            left       : 0;
            height     : 100%;
            width      : 100%;
            background : rgba( 255, 255, 255, .8 ) 
                         url('{!URLFOR($Resource.ASI_CRM_SG_Library, '/images/loading.gif')}')  
                         50% 50% 
                         no-repeat;
        }

        .error {
            border: 2px solid red;
        }
        
        th, td {
                padding-top    : 5px;
                padding-bottom : 5px;
                padding-right  : 10px;
                padding-left   : 10px;
            }
            
        table { 
        }
        
        <!-- Datatable Styling -->
        table.dataTable td {
            height : 30px;
        }
        
        table.dataTable thead tr {
            background-color : #cce6ff;
        }
    
        table.dataTable tbody tr { 
            background-color : #e6f3ff; 
        }
        
        table.dataTable tbody tr:nth-child(even) {
            background-color : white;  
        }
        
        table.dataTable td { 
            border-bottom : 2px solid #e0e0d1; 
        }
		
		.inputField_short {
			width: 50px;
		}

		.inputField_medium {
			width: 75px;
		}

		.inputField_long {
			width: 250px;
		}
		
		.alignRight {
			text-align: right;
		}

    </style>
    
    <!-- JavaScript -->
    <script>
        /****************
        Define Variable
        ****************/
        const ACTION_LABEL                = 'Action';
        const NEW_CONTRACT_TARGET_PREFIX  = 'Contract_Target_';
        const NEW_PAYMENT_SCHEDULE_PREFIX = 'Payment_Schedule_';
        const NEW_CONTRACT_OUTLET_PREFIX  = 'Contract_Outlet_';
        
        const CONST_DATA_TABLE_PROPERTIES    = {
            "bDestroy":true,
            "bStateSave":true,
            "bSearch":false,
            "bFilter" : false,
        	"aLengthMenu":[10,25,50],
        	"iDisplayLength":25,
            "bSort" : false,
            "bPaginate": true,
            "bScrollCollapse": true,
            "bJQueryUI": false
        };
        
        const CONTRACT_ID = '{!contract.Id}';
        const CONTRACT_EFFECTIVE_DATE = '{!contract.ASI_CRM_CN_Effective_Date__c}' ? new Date('{!contract.ASI_CRM_CN_Effective_Date__c}') : null;
        
        const SUB_BRAND_LIST = jQuery.parseJSON('{!JSENCODE(subBrandNameListJson)}');
        
        const CONTRACT_TARGET_RECORD_TYPE_ID  = '{!contractTargetRecordTypeId}';
        const PAYMENT_SCHEDULE_RECORD_TYPE_ID = '{!paymentSponsorshipRecordTypeId}';
        const CONTRACT_OUTLET_RECORD_TYPE_ID  = '{!contractOutletRecordTypeId}';
        
        var NEW_CONTRACT_TARGET_INDEX = 1;
        var NEW_PAYMENT_SCHEDULE_INDEX = 1;
        var NEW_CONTRACT_OUTLET_INDEX = 1;
        
        var deleteContractTargetIdList  = [];
        var deletePaymentScheduleIdList = [];
        var deleteContractOutletIdList = [];
        
        var addedSKUIdList = [];
        
        /*****************
        Datatable Field Config
        *****************/
        const FIELD_CONFIG_MAPPING = {
        	"ACTION"                          : {"title"          : ACTION_LABEL, 
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
																		/*[WL 1.0] BEGIN*/
																		if (full.ASI_CRM_Block_Delete__c == true){
																			return null;
																		}
																		else {
																			return "<a class='link-button' onClick='deleteContractTargetRow(this.parentNode.parentNode)'>Delete</a>";
																		}
																		/*[WL 1.0] END*/
                                                                  }
                                                },
            "SKU"                             : {"title"          : "SKU",
                                                 "data"           : "",
												 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SKU__c';
                                                     					var fieldStr = ""; 
                                                     					if(full.ASI_CRM_SKU__c) {
                                                                        	fieldStr += "<span>"; 
                                                                            fieldStr += "<a href='/" + full.ASI_CRM_SKU__c + "' class='link-button " + fieldAPIName + "'>" + full.ASI_CRM_SKU__r.Name + "</a>";
                                                                            fieldStr += "</span>";
                                                                        }
                                                            	    	return fieldStr;
                                                                    }
                                                },
            
            "ROI"                             : {"title"          : "ROI%",
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ROI';
                                                     					var roi = 0;
                                                     					if(full.ASI_CRM_SG_Return_on_Investment__c && full.ASI_CRM_SG_Net_Sales__c) {
                                                                        	if (full.ASI_CRM_SG_Net_Sales__c == 0) {
																				roi = 0;
																			} else 
																			if (full.ASI_CRM_SG_Net_Sales__c < 0 && full.ASI_CRM_SG_Return_on_Investment__c < 0){
																				roi = full.ASI_CRM_SG_Return_on_Investment__c
																					/ full.ASI_CRM_SG_Net_Sales__c
																					* -100;
																			} else {
																				roi = full.ASI_CRM_SG_Return_on_Investment__c
																					/ full.ASI_CRM_SG_Net_Sales__c
																					* 100;
																			}
																			
                                                                            roi = roi.toFixed(2);
                                                                        }
                                                     					return "<span class='" + fieldAPIName + "'>" + roi + "%" + "</span>";
                                                                    }
                                                },
            
            "Sequence No"                     : {"title"          : "Seq. No.",
                                                 "data"           : "ASI_CRM_Sequence_No__c",
												 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Sequence_No__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_short' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Sub-Brand"                       : {"title"          : "Sub-Brand",
                                                 "data"           : "",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Subbrand__c';
                                                                    	if(full.ASI_CRM_Subbrand__c) {
                                                                        	data = full.ASI_CRM_Subbrand__r.Name;
                                                                        } else {
                                                                        	data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_long' type='text' value=\"" + data + "\" onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Sales In Case"                   : {"title"          : "Sales (Cases)",
                                                 "data"           : "ASI_CRM_TargetCase__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_TargetCase__c';
																		
																		/*[WL 1.0] BEGIN*/
																		/*if(!data) {
																			data = "";
																		}
																		return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";*/
																		if (full.Id.length == 18 && full.ASI_CRM_Block_Delete__c){
																			return !data ? '' : data;
																		}
																		else {																		
																			if(!data) {
																				data = "";
																			}
																			return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
																		}
																		/*[WL 1.0] END*/
                                                                    }
                                                },
            "Sales In 9L"                     : {"title"          : "Sales (9L)",
                                                 "data"           : "ASI_CRM_SG_Target_Sales_9L_Cases__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Target_Sales_9L_Cases__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Duty"                            : {"title"          : "Duty (S$)",
                                                 "data"           : "ASI_CRM_Total_Duty__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_Total_Duty__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "FOB"                             : {"title"          : "FOB (S$)",
                                                 "data"           : "ASI_CRM_Total_FOB__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_Total_FOB__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Handling Cost"                   : {"title"          : "Handling Cost (S$)",
                                                 "data"           : "ASI_CRM_Total_Handling_Cost__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_Total_Handling_Cost__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Sales Incentive"                 : {"title"          : "Sales Incentive<br/>(Bottles/Case)",
                                                 "data"           : "ASI_CRM_SG_Sales_Incentive__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Sales_Incentive__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
        	"Management Incentives"           : {"title"          : "Management<br/>Incentives<br/>(Cases/month)",
                                                 "data"           : "ASI_CRM_SG_Management_Incentives__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Management_Incentives__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Target Incentive"                : {"title"          : "Contract Sponsorship/<br/>Target Incentive<br/>(Total Cases)",
                                                 "data"           : "ASI_CRM_SG_Cont_Sponsor_Target_Incentive__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Cont_Sponsor_Target_Incentive__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    } 
                                                },
            "Others"                          : {"title"          : "Others<br/>(Total Cases)",
                                                 "data"           : "ASI_CRM_SG_Others__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Others__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Total Free Goods Cases"          : {"title"          : "Total<br/>Free Goods<br/>(Cases)",
                                                 "data"           : "ASI_CRM_SG_Total_Free_Goods_Cases__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Total_Free_Goods_Cases__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Total Free Goods 9L"             : {"title"          : "Total<br/>Free Goods<br/>(9L)",
                                                 "data"           : "ASI_CRM_SG_Total_Free_Goods_9L_Cases__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Total_Free_Goods_9L_Cases__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Consumer Price Offer"            : {"title"          : "Consumer<br/>Price Offer<br/>(S$/Bottle)",
                                                 "data"           : "ASI_CRM_SG_Consumer_Price_Offer__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Consumer_Price_Offer__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "WS to Ontrade price"             : {"title"          : "WS - OT<br/>(S$/Bottle)",
                                                 "data"           : "ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Compensation for WS"             : {"title"          : "Compensation<br/>for WS - Price<br/>Difference (S$)",
                                                 "data"           : "ASI_CRM_SG_Compensation_for_WS_Price_Dif__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Compensation_for_WS_Price_Dif__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Wholesaler Margin"               : {"title"          : "Wholesaler<br/>Margin<br/>(S$/Bottle)",
                                                 "data"           : "ASI_CRM_SG_Wholesaler_Margin__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Wholesaler_Margin__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Wholesaler Margin Total"         : {"title"          : "Wholesaler<br/>Margin<br/>Total (S$)",
                                                 "data"           : "ASI_CRM_SG_Wholesaler_Margin_Total__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Wholesaler_Margin_Total__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Contract Margin"                 : {"title"          : "Contract<br/>Margin<br/>- per 9Lc (S$)",
                                                 "data"           : "ASI_CRM_SG_Contract_Margin_per_9Lc__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Contract_Margin_per_9Lc__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Contract Margin Total"           : {"title"          : "Contract<br/>Margin<br/>- Total (S$)",
                                                 "data"           : "ASI_CRM_SG_Contract_Margin_Total__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Contract_Margin_Total__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Bottle Incentive"                : {"title"          : "Bottle<br/>Incentive<br/>(S$/Bottle)",
                                                 "data"           : "ASI_CRM_Bottle_Incentive__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Bottle_Incentive__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Bottle Incentive Total"          : {"title"          : "Bottle<br/>Incentive<br/>- Total (S$)",
                                                 "data"           : "ASI_CRM_Bottle_Incentive_Total__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_Bottle_Incentive_Total__c alignRight",
                                                 /*
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Bottle_Incentive_Total__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='ASI_CRM_Bottle_Incentive_Total__c' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                 */
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Good in Kinds"                   : {"title"          : "Good-in-Kinds (S$)",
                                                 "data"           : "ASI_CRM_SG_Good_in_Kinds__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Good_in_Kinds__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Cash"                            : {"title"          : "Cash (S$)",
                                                 "data"           : "ASI_CRM_SG_Cash__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Cash__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Cash Sponsorship"                : {"title"          : "Cash Sponsorship - Total (S$)",
                                                 "data"           : "ASI_CRM_SG_Cash_Sponsorship_Total__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Cash_Sponsorship_Total__c alignRight",
                                                 /*
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Cash_Sponsorship_Total__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                  */
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Event Total Cases"                : {"title"          : "Events<br />(Total Cases)",
                                                 "data"           : "ASI_CRM_SG_Events_Free_Bottles__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Events_Free_Bottles__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Event by value"                  : {"title"          : "Events<br />(by S$ value)",
                                                 "data"           : "ASI_CRM_SG_Events__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Events__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Signages Total Cases"            : {"title"          : "Signages<br />(Total Cases)",
                                                 "data"           : "ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Signages by value"               : {"title"          : "Signages<br />(by S$ value)",
                                                 "data"           : "ASI_CRM_SG_Signages_Advertising_Spot__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Signages_Advertising_Spot__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Advertising Spot Total Cases"    : {"title"          : "Advertising Spot<br />(Total Cases)",
                                                 "data"           : "ASI_CRM_Advertising_Spot_Free_Bottles__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Advertising_Spot_Free_Bottles__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Advertising Spot by value"       : {"title"          : "Advertising Spot<br />(by S$ value)",
                                                 "data"           : "ASI_CRM_Advertising_Spot__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Advertising_Spot__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Anniversary"                     : {"title"          : "Anniversary<br />(Total Cases)",
                                                 "data"           : "ASI_CRM_SG_Anniversary_Free_Bottles__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Anniversary_Free_Bottles__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Trade Incentive Trips"           : {"title"          : "Trade Incentive<br />Trips (S$)",
                                                 "data"           : "ASI_CRM_SG_Trade_Incentive_Trips__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Trade_Incentive_Trips__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Product Branding Display"        : {"title"          : "Product<br />Branding<br />Display (S$)",
                                                 "data"           : "ASI_CRM_SG_Product_Branding_Display__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Product_Branding_Display__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Adhoc Promotion"                 : {"title"          : "Ad-hoc<br />Promotions(S$)",
                                                 "data"           : "ASI_CRM_SG_Ad_hoc_Promotions__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Ad_hoc_Promotions__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + " inputField_medium' type='text' value='" + data + "' onChange='updateContractTargetValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Trade Advertising FOC"           : {"title"          : "Trade Advertising &<br />Promotional - Total -<br />(FOC: WS -Ontrade SP)",
                                                 "data"           : "ASI_CRM_SG_Trd_Adv_Promo_Total__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Trd_Adv_Promo_Total__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                },
            "Trade Advertising PRS"           : {"title"          : "Trade Advertising &<br />Promotional - Total<br />- PRS(S$)",
                                                 "data"           : "ASI_CRM_SG_Trd_Adv_Promo_TotalPRS__c",
                                                 "defaultContent" : "",
                                                 "className"      : "ASI_CRM_SG_Trd_Adv_Promo_TotalPRS__c alignRight",
                                                 "render"         : function(data, type, full) {
                                                     					return !data ? '' : data.toLocaleString('en-US', {minimumFractionDigits: 2});
                                                                    }
                                                }
        };
        
        const PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING = {
        	"ACTION"                          : {"title"          : ACTION_LABEL, 
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
																		/*[WL 1.0] BEGIN*/
																		if (full.ASI_CRM_Payment_Issued__c === true)
																			return null;
																		else 
																			return "<a class='link-button' onClick='deletePaymentScheduleRow(this.parentNode.parentNode)'>Delete</a>";  
																		/*[WL 1.0] BEGIN*/
                                                                  }
                                                },
            "Cash Sponsorship"                : {"title"          : "Cash Sponsorship<br />(S$)",
                                                 "data"           : "ASI_CRM_Sponsorship__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Sponsorship__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
																		/*[WL 1.0] BEGIN*/
																		if (full.ASI_CRM_Payment_Issued__c === true)
																			return data;
																		else 
																			return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updatePaymentValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
																		/*[WL 1.0] BEGIN*/                                                     					
                                                                    }
                                                },
            "Contract Sponsorship"            : {"title"          : "Free Goods (Act Case)",
                                                 "data"           : "ASI_CRM_Sponsorship__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Sponsorship__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updatePaymentValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
            "Achieved Percent"                : {"title"          : "% of Achieved<br />Sales Target",
                                                 "data"           : "ASI_CRM_Percentof_achieved_Sales_Target__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Percentof_achieved_Sales_Target__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
																		/*[WL 1.0] BEGIN*/
																		if (full.ASI_CRM_Payment_Issued__c === true)
																			return data;
																		else 
																			return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updatePaymentValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
																		/*[WL 1.0] BEGIN*/                                                        					
                                                                    }
                                                },
            "Schedule Date"                   : {"title"          : "Schedule Date",
                                                 "data"           : "ASI_CRM_Schedule_Date__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Schedule_Date__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
																		/*[WL 1.0] BEGIN*/
																		if (full.ASI_CRM_Payment_Issued__c === true)
																			return data;
																		else 
																			return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updatePaymentValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
																		/*[WL 1.0] BEGIN*/   
                                                                    }
                                                },
            "Remarks"                         : {"title"          : "Remarks",
                                                 "data"           : "ASI_CRM_Remarks__c",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Remarks__c';
                                                                    	if(!data) {
                                                                            data = "";
                                                                        }
                                                     					return "<input class='" + fieldAPIName + "' type='text' value='" + data + "' onChange='updatePaymentValue(this.parentNode.parentNode, \"" + fieldAPIName + "\", this.value)'/>";
                                                                    }
                                                },
			/*[WL 1.0] BEGIN*/
            "Created"                         : {"title"          : "Created",
                                                 "data"           : "ASI_CRM_Payment_Issued__c",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_Payment_Issued__c';
                                                                    	if(!data) {
                                                                            data = false;
                                                                        }
																		
                                                     					if (data)
																			return "<input class='" + fieldAPIName + "' type='checkbox' disabled checked />";
																		else 
																			return "<input class='" + fieldAPIName + "' type='checkbox' disabled />";
                                                                    }
                                                }												
			/*[WL 1.0] END*/
        };
        
        const CONTRACT_OUTLET_FIELD_CONFIG_MAPPING = {
        	"ACTION"                          : {"title"          : ACTION_LABEL, 
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
                                                            	    	return "<a class='link-button' onClick='deleteContractOutletRow(this.parentNode.parentNode)'>Delete</a>";  
                                                                  }
                                                },
            "Outlet"                          : {"title"          : "Outlet",
                                                 "data"           : "",
												 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'ASI_CRM_SG_Customer__c';
                                                     					var fieldStr = ""; 
                                                     					if(full.ASI_CRM_SG_Customer__c) {
                                                                        	fieldStr += "<span>"; 
                                                                            fieldStr += "<a href='/" + full.ASI_CRM_SG_Customer__c + "' class='link-button " + fieldAPIName + "'>" + full.ASI_CRM_SG_Customer__r.Name + "</a>";
                                                                            fieldStr += "</span>";
                                                                        }
                                                            	    	return fieldStr;
                                                                    }
                                                },
        };
        
        const SKU_FIELD_CONFIG_MAPPING = {
        	"ACTION"                          : {"title"          : ACTION_LABEL, 
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
                                                            	    	return "<a class='link-button' onClick='addContractTarget(this.parentNode.parentNode)'>Add</a>";  
                                                                  }
                                                },
            "SKU"                             : {"title"          : "SKU",
                                                 "data"           : "sku.Name",
                                                 "defaultContent" : ""
                                                },
            "Sub-Brand"                       : {"title"          : "Sub-Brand",
                                                 "data"           : "",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldStr = ""; 
                                                     					if(full.sku.ASI_MFM_Sub_brand__c) {
                                                                        	fieldStr += "<span>"; 
                                                                            fieldStr += "<a href='/" + full.sku.ASI_MFM_Sub_brand__c + "' class='link-button'>" + full.sku.ASI_MFM_Sub_brand__r.Name + "</a>";
                                                                            fieldStr += "</span>";
                                                                        }
                                                            	    	return fieldStr;
                                                                    }
                                                }
        }
        
        const OUTLET_FIELD_CONFIG_MAPPING = {
        	"ACTION"                          : {"title"          : ACTION_LABEL, 
                                                 "data"           : "",
                                                 "render"         : function(data, type, full) {
                                                            	    	return "<a class='link-button' onClick='addContractOutlet(this.parentNode.parentNode)'>Add</a>";  
                                                                  }
                                                },
            "Outlet"                          : {"title"          : "Outlet",
                                                 "data"           : "",
                                                 "defaultContent" : "",
                                                 "render"         : function(data, type, full) {
                                                     					var fieldAPIName = 'Id';
                                                     					var fieldStr = ""; 
                                                     					if(full.Id) {
                                                                        	fieldStr += "<span>"; 
                                                                            fieldStr += "<a href='/" + full.Id + "' class='link-button'>" + full.Name + "</a>";
                                                                            fieldStr += "</span>";
                                                                        }
                                                            	    	return fieldStr;
                                                                    }
                                                }
        }
        
        /****************
        Define Standard Function
        ****************/
        
        /****************
        Init Function
        ****************/
        $(document).ready(
            function() {
                setTable(jQuery.parseJSON('{!JSENCODE(contractTargetListJson)}'));
                setPaymentScheduleTable(jQuery.parseJSON('{!JSENCODE(cashPaymentScheduleListJson)}'), jQuery.parseJSON('{!JSENCODE(contractPaymentScheduleListJson)}'));
				setContractOutletTable(jQuery.parseJSON('{!JSENCODE(contractContractOutletListJson)}'));
                setSKUSearchTable(null);
				setOutletSearchTable(jQuery.parseJSON('{!JSENCODE(contractContractOutletListJson)}'), jQuery.parseJSON('{!JSENCODE(childOutletListJson)}'));
                initAutoComplete();
				initDatepicker();
            }
        );
        
        function setTable(contractTargetList) {
            var skuTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            skuTableProperties["aaData"] = contractTargetList;
            skuTableProperties["rowId"]  = "Id";
            
            var skuColumns = [];
            skuColumns.push(FIELD_CONFIG_MAPPING["ACTION"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["SKU"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["ROI"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Sequence No"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Sub-Brand"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Sales In Case"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Sales In 9L"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Duty"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["FOB"]);
            skuColumns.push(FIELD_CONFIG_MAPPING["Handling Cost"]);

            skuTableProperties["aoColumns"] = skuColumns;
            
            $("#skuDataTable").dataTable(skuTableProperties);
            
            var freeGoodTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            freeGoodTableProperties["aaData"] = contractTargetList;
            freeGoodTableProperties["rowId"]  = "Id";
            
            var freeGoodColumns = [];
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["ACTION"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["SKU"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["ROI"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Sales Incentive"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Management Incentives"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Target Incentive"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Others"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Total Free Goods Cases"]);
            freeGoodColumns.push(FIELD_CONFIG_MAPPING["Total Free Goods 9L"]);
            freeGoodTableProperties["aoColumns"]  = freeGoodColumns;
            
            $("#freeGoodDataTable").dataTable(freeGoodTableProperties);
            
            var contractMarginTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            contractMarginTableProperties["aaData"] = contractTargetList;
            contractMarginTableProperties["rowId"]  = "Id";
            
            var contractMarginColumns = [];
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["ACTION"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["SKU"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["ROI"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Consumer Price Offer"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["WS to Ontrade price"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Compensation for WS"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Wholesaler Margin"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Wholesaler Margin Total"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Contract Margin"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Contract Margin Total"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Bottle Incentive"]);
            contractMarginColumns.push(FIELD_CONFIG_MAPPING["Bottle Incentive Total"]);
            contractMarginTableProperties["aoColumns"]  = contractMarginColumns;
            
            $("#contractMarginDataTable").dataTable(contractMarginTableProperties);
            
            var cashSponsorshipTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            cashSponsorshipTableProperties["aaData"] = contractTargetList;
            cashSponsorshipTableProperties["rowId"]  = "Id";
            
            var cashSponsorshipColumns = [];
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["ACTION"]);
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["SKU"]);
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["ROI"]);
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["Good in Kinds"]);
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["Cash"]);
            cashSponsorshipColumns.push(FIELD_CONFIG_MAPPING["Cash Sponsorship"]);
            cashSponsorshipTableProperties["aoColumns"]  = cashSponsorshipColumns;
            
            $("#cashSponsorshipDataTable").dataTable(cashSponsorshipTableProperties);
            
            var apTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            apTableProperties["aaData"] = contractTargetList;
            apTableProperties["rowId"]  = "Id";

            var apColumns = [];
            apColumns.push(FIELD_CONFIG_MAPPING["ACTION"]);
            apColumns.push(FIELD_CONFIG_MAPPING["SKU"]);
            apColumns.push(FIELD_CONFIG_MAPPING["ROI"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Event Total Cases"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Event by value"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Signages Total Cases"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Signages by value"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Advertising Spot Total Cases"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Advertising Spot by value"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Anniversary"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Trade Incentive Trips"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Product Branding Display"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Adhoc Promotion"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Trade Advertising FOC"]);
            apColumns.push(FIELD_CONFIG_MAPPING["Trade Advertising PRS"]);
            apTableProperties["aoColumns"]  = apColumns;
            
            $("#apDataTable").dataTable(apTableProperties);
        }
        
       	function setPaymentScheduleTable(paymentCashSponsorshipList, paymentContractSponsorshipList) {
            var paymentCashSponsorshipTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            paymentCashSponsorshipTableProperties["aaData"] = paymentCashSponsorshipList;
            paymentCashSponsorshipTableProperties["rowId"]  = "Id";
            
            var paymentCashSponsorshipColumns = [];
            paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["ACTION"]);
            paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Cash Sponsorship"]);
            paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Achieved Percent"]);
            paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Schedule Date"]);
            paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Remarks"]);
			
			/*[WL 1.0] BEGIN*/
			paymentCashSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Created"]);
			/*[WL 1.0] END*/
			
            paymentCashSponsorshipTableProperties["aoColumns"] = paymentCashSponsorshipColumns;
            
            $("#paymentCashSponsorshipDataTable").dataTable(paymentCashSponsorshipTableProperties);
            
            var paymentContractSponsorshipTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            paymentContractSponsorshipTableProperties["aaData"] = paymentContractSponsorshipList;
            paymentContractSponsorshipTableProperties["rowId"]  = "Id";
            
            var paymentContractSponsorshipColumns = [];
            paymentContractSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["ACTION"]);
            paymentContractSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Contract Sponsorship"]);
            paymentContractSponsorshipColumns.push(PAYMENT_SCHEDULE_FIELD_CONFIG_MAPPING["Achieved Percent"]);
            paymentContractSponsorshipTableProperties["aoColumns"] = paymentContractSponsorshipColumns;
            
            $("#paymentContractSponsorshipDataTable").dataTable(paymentContractSponsorshipTableProperties);
        }
       
        function setSKUSearchTable(skuPriceWrapperList) {
            var skuSearchTableProperties       = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            skuSearchTableProperties["aaData"] = skuPriceWrapperList;
            skuSearchTableProperties["rowId"]  = "sku.Id";
            
            var skuSearchColumns = [];
            skuSearchColumns.push(SKU_FIELD_CONFIG_MAPPING["ACTION"]);
            skuSearchColumns.push(SKU_FIELD_CONFIG_MAPPING["SKU"]);
            skuSearchColumns.push(SKU_FIELD_CONFIG_MAPPING["Sub-Brand"]);
            skuSearchTableProperties["aoColumns"] = skuSearchColumns;
            
            $(".addSKUTable").dataTable(skuSearchTableProperties);
        }
        
       	function setContractOutletTable(contractOutletList) {
            var contractOutletTableProperties = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            contractOutletTableProperties["aaData"] = contractOutletList;
            contractOutletTableProperties["rowId"]  = "Id";
            
            var contractOutletColumns = [];
            contractOutletColumns.push(CONTRACT_OUTLET_FIELD_CONFIG_MAPPING["ACTION"]);
            contractOutletColumns.push(CONTRACT_OUTLET_FIELD_CONFIG_MAPPING["Outlet"]);
            contractOutletTableProperties["aoColumns"] = contractOutletColumns;
            
            $("#contractOutletDataTable").dataTable(contractOutletTableProperties);
        }
       
        function setOutletSearchTable(contractOutletList, childOutletList) {
            var contractOutletIdList = [];
			var searchableList = [];
            for(var i = 0 ; i < contractOutletList.length ; i++) {
                /*[WL 2.0] BEGIN*/
				//contractOutletIdList.push(childOutletList[i].Id);
				contractOutletIdList.push(contractOutletList[i].ASI_CRM_SG_Customer__c);
				/*[WL 2.0] END*/
            }
            for(var i = 0 ; i < childOutletList.length ; i++) {
				/*[WL 2.0] BEGIN*/
                //if (!(contractOutletIdList.indexOf(childOutletList[i].Id) > -1)) searchableList.push(childOutletList[i]);
				if (contractOutletIdList.indexOf(childOutletList[i].Id) <= -1) searchableList.push(childOutletList[i]);
				/*[WL 2.0] END*/
            }
			var outletSearchTableProperties       = jQuery.extend({}, CONST_DATA_TABLE_PROPERTIES);
            outletSearchTableProperties["aaData"] = searchableList;
            outletSearchTableProperties["rowId"]  = "Id";
            
            var outletSearchColumns = [];
            outletSearchColumns.push(OUTLET_FIELD_CONFIG_MAPPING["ACTION"]);
            outletSearchColumns.push(OUTLET_FIELD_CONFIG_MAPPING["Outlet"]);
            outletSearchTableProperties["aoColumns"] = outletSearchColumns;
            
            $(".addOutletTable").dataTable(outletSearchTableProperties);
        }
        
        function initAutoComplete() {
        	$('.ASI_CRM_Subbrand__c').each(function(index) {
                $(this).autocomplete({
                    source    : SUB_BRAND_LIST,
                    minLength : 3,
					select    : function( event, ui ) {
						//$(this).trigger("change");
					}
                });
            });
        }
        
        function initDatepicker() {
        	$('.ASI_CRM_Schedule_Date__c').each(function(index) {
                $(this).datepicker({
                    dateFormat: "yy-mm-dd"
                });
            });
        }
        
        /****************
        Table Event Function
        ****************/
        function addContractTarget(row) {
            var skuPriceWrapper = $(".addSKUTable").DataTable().row(row).data();
            var sku = skuPriceWrapper.sku;
            
			var skuHistoricCostWS = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_Selling_Price_Per_Bottle_PRS_Wholesaler'];
            var skuHistoricCostWSOnTrade = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_Selling_Price_Per_Bottle_Wholesaler_On_Trade'];
            var skuHistoricCostIGC = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_IGC'];
            var skuHistoricCostDuty = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_CRM_Duty_Per_Bottle'];
            var skuHistoricCostFob = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_CRM_FOB_Per_Bottle'];
            var skuHistoricCostHandlingCost = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_CRM_Handling_Cost_Per_Bottle'];
			/* [VL 1.0] BEGIN */
			var skuHistoricCostWSRTM = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_RTM_Wholesaler_Price_Per_Bottle'];
			var skuHistoricCostOTRTM = skuPriceWrapper.skuPriceRecordTypeMap['ASI_CRM_SG_Open_Outlet_Price_Per_Bottle'];
			/* [VL 1.0] END */
            
            if(skuHistoricCostWS && CONTRACT_EFFECTIVE_DATE > skuHistoricCostWS.ASI_CRM_EffectiveDate__c) {
            	skuHistoricCostWS = null;
            }
            
            if(skuHistoricCostWSOnTrade && CONTRACT_EFFECTIVE_DATE > skuHistoricCostWSOnTrade.ASI_CRM_EffectiveDate__c) {
            	skuHistoricCostWSOnTrade = null;
            }
            
            if(skuHistoricCostIGC && CONTRACT_EFFECTIVE_DATE > skuHistoricCostIGC.ASI_CRM_EffectiveDate__c) {
           		skuHistoricCostIGC = null;
            }
            
            if(skuHistoricCostDuty && CONTRACT_EFFECTIVE_DATE > skuHistoricCostDuty.ASI_CRM_EffectiveDate__c) {
            	skuHistoricCostDuty = null;
            }
            
            if(skuHistoricCostFob && CONTRACT_EFFECTIVE_DATE > skuHistoricCostFob.ASI_CRM_EffectiveDate__c) {
            	skuHistoricCostFob = null;
            }
			
            if(skuHistoricCostHandlingCost && CONTRACT_EFFECTIVE_DATE > skuHistoricCostHandlingCost.ASI_CRM_EffectiveDate__c) {
            	skuHistoricCostHandlingCost = null;
            }
            
            //Create new contract target record
            var newContractTarget = {};
            newContractTarget["Id"]                                          = NEW_CONTRACT_TARGET_PREFIX + NEW_CONTRACT_TARGET_INDEX;
            newContractTarget["ASI_CRM_Contract__c"]                         = CONTRACT_ID;
            newContractTarget["RecordTypeId"]                                = CONTRACT_TARGET_RECORD_TYPE_ID;
            newContractTarget["ASI_CRM_SKU__c"]                              = sku.Id;
            newContractTarget["ASI_CRM_SKU__r"]                              = {"Name" : sku.Name};
            newContractTarget["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"]      = skuHistoricCostWS ? skuHistoricCostWS.ASI_CRM_Price__c : sku.ASI_CRM_SG_Selling_Price_Per_Btl_PRS_WS__c;
            newContractTarget["ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c"] = skuHistoricCostWSOnTrade ? skuHistoricCostWSOnTrade.ASI_CRM_Price__c : sku.ASI_CRM_SG_Selling_Price_Per_Btl_WS_On__c;
            newContractTarget["ASI_CRM_SG_IGC_Cost_Per_case__c"]             = skuHistoricCostIGC ? skuHistoricCostIGC.ASI_CRM_Cost__c : sku.ASI_CRM_SG_IGC_Cost_Per_case__c;
            newContractTarget["ASI_CRM_Duty_Per_Bottle__c"]                  = skuHistoricCostDuty ? skuHistoricCostDuty.ASI_CRM_Cost__c : 0;
            newContractTarget["ASI_CRM_FOB_Per_Bottle__c"]                   = skuHistoricCostFob ? skuHistoricCostFob.ASI_CRM_Cost__c : 0;
            newContractTarget["ASI_CRM_Handling_Cost_Per_Bottle__c"]         = skuHistoricCostHandlingCost ? skuHistoricCostHandlingCost.ASI_CRM_Cost__c : 0;
            newContractTarget["ASI_CRM_SG_IGC_Cost_Per_9Lc__c"]              = skuHistoricCostIGC ? skuHistoricCostIGC.ASI_CRM_SG_IGC_Cost_Per_9Lc__c : sku.ASI_CRM_SG_IGC_Cost_Per_9Lc__c;
			/* [VL 1.0] BEGIN */
			newContractTarget["ASI_CRM_RTM_Price_Per_Bottle_PRS_WS__c"]      = skuHistoricCostWSRTM ? skuHistoricCostWSRTM.ASI_CRM_Price__c : 0;
			newContractTarget["ASI_CRM_RTM_Price_Per_Bottle_WS_OT__c"]       = skuHistoricCostOTRTM ? skuHistoricCostOTRTM.ASI_CRM_Price__c : 0;
			/* [VL 1.0] END */
            newContractTarget["ASI_CRM_SG_Btls_Per_Case__c"]                 = sku.ASI_HK_CRM_Packaging_Size__c;
            newContractTarget["ASI_CRM_SG_Size_cl__c"]                       = sku.ASI_HK_CRM_Std_Bottle_Size__c;
            
            //Add new contract target record to data table and redraw
            $("#skuDataTable").DataTable().row.add(newContractTarget).draw();
            $("#freeGoodDataTable").DataTable().row.add(newContractTarget).draw();
            $("#contractMarginDataTable").DataTable().row.add(newContractTarget).draw();
            $("#cashSponsorshipDataTable").DataTable().row.add(newContractTarget).draw();
            $("#apDataTable").DataTable().row.add(newContractTarget).draw();
            
            $("#skuDataTable").DataTable().page('last').draw('page');
            $("#freeGoodDataTable").DataTable().page('last').draw('page');
            $("#contractMarginDataTable").DataTable().page('last').draw('page');
            $("#cashSponsorshipDataTable").DataTable().page('last').draw('page');
            $("#apDataTable").DataTable().page('last').draw('page');
            
            //Remove sku in search sku table
        	$('.addSKUTable').each(function(index) {
                $(this).DataTable().row("#" + sku.Id).remove().draw();
            });
            //$(".addSKUTable").DataTable().row("#" + sku.Id).remove().draw();
            
            initAutoComplete();
            
            //Add index
            NEW_CONTRACT_TARGET_INDEX++;
            
            addedSKUIdList.push(sku.Id);
        }
        
        function addPaymentCashSponsorship() {
            //Create new payment cash sponsorship record
            var newPaymentCashSponsorship = {};
            newPaymentCashSponsorship["Id"]                  = NEW_PAYMENT_SCHEDULE_PREFIX + NEW_PAYMENT_SCHEDULE_INDEX;
            newPaymentCashSponsorship["ASI_CRM_Contract__c"] = CONTRACT_ID;
            newPaymentCashSponsorship["RecordTypeId"]        = PAYMENT_SCHEDULE_RECORD_TYPE_ID;
            newPaymentCashSponsorship["ASI_CRM_Type__c"]     = "Cash Sponsorship";
			/*[WL 1.0] BEGIN*/
			newPaymentCashSponsorship["ASI_CRM_Payment_Issued__c"]     = false;
			/*[WL 1.0] END*/
            
            //Add new payment cash sponsorship record to data table and redraw
            $("#paymentCashSponsorshipDataTable").DataTable().row.add(newPaymentCashSponsorship).draw();
            $("#paymentCashSponsorshipDataTable").DataTable().page('last').draw('page');
			
			initDatepicker();
            
            //Add index
            NEW_PAYMENT_SCHEDULE_INDEX ++;
        }
        
        function addPaymentContractSponsorship() {
            //Create new payment contract sponsorship record
            var newPaymentCashSponsorship = {};
            newPaymentCashSponsorship["Id"] = NEW_PAYMENT_SCHEDULE_PREFIX + NEW_PAYMENT_SCHEDULE_INDEX;
            newPaymentCashSponsorship["ASI_CRM_Contract__c"] = CONTRACT_ID;
            newPaymentCashSponsorship["RecordTypeId"] = PAYMENT_SCHEDULE_RECORD_TYPE_ID;
            newPaymentCashSponsorship["ASI_CRM_Type__c"] = "Contract Sponsorship";
            
            //Add new payment cash sponsorship record to data table and redraw
            $("#paymentContractSponsorshipDataTable").DataTable().row.add(newPaymentCashSponsorship).draw();
            $("#paymentContractSponsorshipDataTable").DataTable().page('last').draw('page');
            
            //Add index
            NEW_PAYMENT_SCHEDULE_INDEX ++;
        }
        
        function addContractOutlet(row) {
            var selectedOutlet = $(".addOutletTable").DataTable().row(row).data();
            
            //Create new contract target record
            var newContractOutlet = {};
            newContractOutlet["Id"]                                          = NEW_CONTRACT_OUTLET_PREFIX + NEW_CONTRACT_OUTLET_INDEX;
            newContractOutlet["ASI_CRM_SG_Contract__c"]                      = CONTRACT_ID;
            newContractOutlet["RecordTypeId"]                                = CONTRACT_OUTLET_RECORD_TYPE_ID;
            newContractOutlet["ASI_CRM_SG_Customer__c"]                      = selectedOutlet.Id;
            newContractOutlet["ASI_CRM_SG_Customer__r"]                      = {"Name" : selectedOutlet.Name};
            
            //Add new contract target record to data table and redraw
            $("#contractOutletDataTable").DataTable().row.add(newContractOutlet).draw();
            $("#contractOutletDataTable").DataTable().page('last').draw('page');
            
            //Remove sku in search sku table
            $(".addOutletTable").DataTable().row("#" + selectedOutlet.Id).remove().draw();
            
            //Add index
            NEW_CONTRACT_OUTLET_INDEX++;
        }
        
        function updateContractTargetValue(row, fieldAPIName, newValue) {
            //Update all contract target data table
            //Update one table will auto update all table, coz data is linked to same source
            var contractTargetData = $("#skuDataTable").DataTable().row(row).data();
            contractTargetData[fieldAPIName] = newValue;
            
            if(fieldAPIName == 'ASI_CRM_Subbrand__c') {
            	switch (checkSubbrand(newValue, $("#skuDataTable").DataTable().row(row).index())) {
					case 'passed' : 
						$("#" + row.id + " .ASI_CRM_Subbrand__c").removeClass('error');
						$('.saveErrorPanel').css("display","none");
						break;
					case 'duplicated' : 
						$("#" + row.id + " .ASI_CRM_Subbrand__c").addClass('error');
						$('.saveErrorPanel').css("display","block");
						$('.errorMessage').html('Duplicated Sub-Brand : ' + newValue);
						break;
					case 'invalid' :
						$("#" + row.id + " .ASI_CRM_Subbrand__c").addClass('error');
						$('.saveErrorPanel').css("display","block");
						$('.errorMessage').html('Invalid Sub-Brand : ' + newValue);
						break;
				}
            } else {
            	$("#" + row.id + " .ASI_CRM_Subbrand__c").removeClass('error');
            	$('.saveErrorPanel').css("display","none");
            }
            recalculateContractTargetValue(row.id, contractTargetData);
        }
        
        function updatePaymentValue(row, fieldAPIName, newValue) {
            var rowId = row.id;
            if($("#paymentCashSponsorshipDataTable").DataTable().row("#" + rowId).length > 0) {
                var paymentCashSponsorshipData = $("#paymentCashSponsorshipDataTable").DataTable().row(row).data();
            	paymentCashSponsorshipData[fieldAPIName] = newValue;
            }
            if($("#paymentContractSponsorshipDataTable").DataTable().row("#" + rowId).length > 0) {
                var paymentContractSponsorshipData = $("#paymentContractSponsorshipDataTable").DataTable().row(row).data();
                paymentContractSponsorshipData[fieldAPIName] = newValue;
            }
        }
        
        function deleteContractTargetRow(row) {
            var rowId = row.id;
            if(!rowId.startsWith(NEW_CONTRACT_TARGET_PREFIX)) {
                deleteContractTargetIdList.push(rowId);
            } else {
                var contractTargetData = $("#skuDataTable").DataTable().row(row).data();
            	var index = addedSKUIdList.indexOf(contractTargetData["ASI_CRM_SKU__c"]);
				addedSKUIdList.splice(index, 1);
            }
            
            
            $("#skuDataTable").DataTable().row(row).remove().draw();
            $("#freeGoodDataTable").DataTable().row(row).remove().draw();
            $("#contractMarginDataTable").DataTable().row(row).remove().draw();
            $("#cashSponsorshipDataTable").DataTable().row(row).remove().draw();
            $("#apDataTable").DataTable().row(row).remove().draw();
        }
        
        function deletePaymentScheduleRow(row) {
            var rowId = row.id;
            if(!rowId.startsWith(NEW_PAYMENT_SCHEDULE_PREFIX)) {
                deletePaymentScheduleIdList.push(rowId);
            }
            if($("#paymentCashSponsorshipDataTable").DataTable().row("#" + rowId).length > 0) {
                $("#paymentCashSponsorshipDataTable").DataTable().row(row).remove().draw();
            }
            if($("#paymentContractSponsorshipDataTable").DataTable().row("#" + rowId).length > 0) {
                $("#paymentContractSponsorshipDataTable").DataTable().row(row).remove().draw();
            }
        }
       
        function deleteContractOutletRow(row) {
            var rowId = row.id;
            if(!rowId.startsWith(NEW_CONTRACT_OUTLET_PREFIX)) {
                deleteContractOutletIdList.push(rowId);
            }
            if($("#contractOutletDataTable").DataTable().row("#" + rowId).length > 0) {
                $("#contractOutletDataTable").DataTable().row(row).remove().draw();
            }
        }
       
        /****************
        Execute Controller Function
        ****************/
        function searchSKUJS(inputField) {
            if(inputField.val()) {
            	//Show loading gif
            	$("body").addClass("savingRecord");
                searchSKU(inputField.val(), JSON.stringify(addedSKUIdList));
            }
        }
        
        function searchSKUComplete(skuPriceWrapperListJson) {
            //Hide the loading gif
            $("body").removeClass("savingRecord");
            setSKUSearchTable(jQuery.parseJSON(skuPriceWrapperListJson));
        }
        
        function calculateROIJS() {
            //Show loading gif
            $("body").addClass("savingRecord");
            
            var calculateContractTargetList = [];
            
        	var contractTargetList = $("#skuDataTable").DataTable().rows().data();
            for(var i = 0 ; i < contractTargetList.data().length ; i++) {
                calculateContractTargetList.push(contractTargetList[i]);
            }
            
            calculateROI(JSON.stringify(calculateContractTargetList));
        }
        
        function calculateROIComplete(oldROI, newROI) {
            //Display the error message and change the problem field to red
            $('.infoPanel').css("display","block");
            
            $('.infoMessage').html('Original ROI% = ' + oldROI + '%, New ROI% = ' + newROI + '%');
            
            //Hide the loading gif
            $("body").removeClass("savingRecord");
        }
        
		function sortBySequenceNo(originalContractTargetList){
			var upsertContractTargetList  = [];
			for (outerIndex = 0; outerIndex < originalContractTargetList.length; outerIndex++){
				for (innerIndex = 0; innerIndex < originalContractTargetList.length - outerIndex - 1; innerIndex++){
					if(originalContractTargetList[innerIndex].ASI_CRM_Sequence_No__c == null ||
						originalContractTargetList[innerIndex].ASI_CRM_Sequence_No__c == ''
					){
						originalContractTargetList[innerIndex].ASI_CRM_Sequence_No__c = 0;
					}
					if(originalContractTargetList[innerIndex+1].ASI_CRM_Sequence_No__c == null ||
						originalContractTargetList[innerIndex+1].ASI_CRM_Sequence_No__c == ''
					){
						originalContractTargetList[innerIndex+1].ASI_CRM_Sequence_No__c = 0;
					}
					
					if (originalContractTargetList[innerIndex].ASI_CRM_Sequence_No__c > originalContractTargetList[innerIndex+1].ASI_CRM_Sequence_No__c){
						var temp = originalContractTargetList[innerIndex];
						originalContractTargetList[innerIndex] = originalContractTargetList[innerIndex+1];
						originalContractTargetList[innerIndex+1] = temp;
					} else 
					if (originalContractTargetList[innerIndex].ASI_CRM_Sequence_No__c == originalContractTargetList[innerIndex+1].ASI_CRM_Sequence_No__c &&
						originalContractTargetList[innerIndex].ASI_CRM_SKU__r.Name.toLowerCase() > originalContractTargetList[innerIndex+1].ASI_CRM_SKU__r.Name .toLowerCase()
					){
						var temp = originalContractTargetList[innerIndex];
						originalContractTargetList[innerIndex] = originalContractTargetList[innerIndex+1];
						originalContractTargetList[innerIndex+1] = temp;
					}
				}
			}
			for (index = 0; index < originalContractTargetList.length; index++){
				originalContractTargetList[index].ASI_CRM_Sequence_No__c = index+1;
				upsertContractTargetList.push(originalContractTargetList[index]);
			}
			console.log(upsertContractTargetList);
			return upsertContractTargetList;
		}
		
		function calculateWSMargin(originalContractTargetList){
			var upsertContractTargetList  = [];
			for (index = 0; index < originalContractTargetList.length; index++){
				if((originalContractTargetList[index].ASI_CRM_SG_Consumer_Price_Offer__c != null && originalContractTargetList[index].ASI_CRM_SG_Consumer_Price_Offer__c != '') &&
					(originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c == null || originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c == '')
				){
					price_consumerOffer = originalContractTargetList[index].ASI_CRM_SG_Consumer_Price_Offer__c;
					price_PRSWS = originalContractTargetList[index].ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c;
					price_WSOT = originalContractTargetList[index].ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c;
					if (price_consumerOffer < price_WSOT && price_PRSWS <= price_WSOT){
						if (price_consumerOffer <= price_PRSWS){
							originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c = price_WSOT - price_PRSWS;
						} else
						if (price_consumerOffer > price_PRSWS && price_consumerOffer < price_WSOT){
							originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c = price_WSOT - price_consumerOffer;
						}
					}
					/*
					if (price_consumerOffer >= price_PRSWS){
						originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c = price_WSOT - price_consumerOffer;
					} else {
						originalContractTargetList[index].ASI_CRM_SG_Wholesaler_Margin__c = price_WSOT - price_PRSWS;
					}
					*/
				}
				upsertContractTargetList.push(originalContractTargetList[index]);
			}
			console.log(upsertContractTargetList);
			return upsertContractTargetList;
		}
		
        function saveRecord(isQuickSave) {
            if($('.error').length > 0) {
            	return;
            }
            
            //Show loading gif
        	$("body").addClass("savingRecord");
            
            //Hide the error message
            $('.saveErrorPanel').css("display","none");
            $('.infoPanel').css("display","none");
            	
            var upsertContractTargetList  = [];
            var upsertPaymentScheduleList = [];
            var upsertContractOutletList  = [];
            
            var contractTargetList = $("#skuDataTable").DataTable().rows().data();
            for(var i = 0 ; i < contractTargetList.data().length ; i++) {
            	var cloneContractTarget = jQuery.extend({}, contractTargetList[i]);
                if(cloneContractTarget.Id.startsWith(NEW_CONTRACT_TARGET_PREFIX)) {
                	delete cloneContractTarget["Id"];
                }
                upsertContractTargetList.push(cloneContractTarget);
            }
			
			upsertContractTargetList = sortBySequenceNo(upsertContractTargetList);
			upsertContractTargetList = calculateWSMargin(upsertContractTargetList);
            
            var paymentCashSponsorshipList = $("#paymentCashSponsorshipDataTable").DataTable().rows().data();
            for(var i = 0 ; i < paymentCashSponsorshipList.data().length ; i++) {
            	var clonePaymentCashSponsorship = jQuery.extend({}, paymentCashSponsorshipList[i]);
                if(clonePaymentCashSponsorship.Id.startsWith(NEW_PAYMENT_SCHEDULE_PREFIX)) {
                	delete clonePaymentCashSponsorship["Id"];
                }
                upsertPaymentScheduleList.push(clonePaymentCashSponsorship);
            }
            
            var paymentContractSponsorshipList = $("#paymentContractSponsorshipDataTable").DataTable().rows().data();
            for(var i = 0 ; i < paymentContractSponsorshipList.data().length ; i++) {
            	var clonePaymentContractSponsorship = jQuery.extend({}, paymentContractSponsorshipList[i]);
                if(clonePaymentContractSponsorship.Id.startsWith(NEW_PAYMENT_SCHEDULE_PREFIX)) {
                	delete clonePaymentContractSponsorship["Id"];
                }
                upsertPaymentScheduleList.push(clonePaymentContractSponsorship);
            }
            
            var contractOutletList = $("#contractOutletDataTable").DataTable().rows().data();
            for(var i = 0 ; i < contractOutletList.data().length ; i++) {
            	var cloneContractOutlet = jQuery.extend({}, contractOutletList[i]);
                if(cloneContractOutlet.Id.startsWith(NEW_CONTRACT_OUTLET_PREFIX)) {
                	delete cloneContractOutlet["Id"];
                }
                upsertContractOutletList.push(cloneContractOutlet);
            }
            
            saveSimulation(isQuickSave, JSON.stringify(upsertContractTargetList), JSON.stringify(deleteContractTargetIdList), 
                 JSON.stringify(upsertPaymentScheduleList), JSON.stringify(deletePaymentScheduleIdList), 
                 JSON.stringify(upsertContractOutletList), JSON.stringify(deleteContractOutletIdList));
            
        }
        
        function saveRecordComplete(contractTargetListJson, cashPaymentScheduleListJson, contractPaymentScheduleListJson, contractOutletListJson, childOutletListJson, 
                                    hasError, exceptionListJson) {
            //Hide the loading gif
            $("body").removeClass("savingRecord");
            
            if(!hasError) {
                //Clear search sku data table
                $(".addSKUTable").DataTable().clear();

                setTable(jQuery.parseJSON(contractTargetListJson));
				setPaymentScheduleTable(jQuery.parseJSON(cashPaymentScheduleListJson), jQuery.parseJSON(contractPaymentScheduleListJson));
				setContractOutletTable(jQuery.parseJSON(contractOutletListJson), jQuery.parseJSON(childOutletListJson));
                
                //Reset the prefix index
                NEW_CONTRACT_TARGET_INDEX = 1;
                NEW_PAYMENT_SCHEDULE_INDEX = 1;
                NEW_CONTRACT_OUTLET_INDEX = 1;

                //Clear the delete id list
                deleteContractTargetIdList  = [];
                deletePaymentScheduleIdList = [];
                deleteContractOutletIdList  = [];

                //Clear the added sku id list
                addedSKUIdList = [];
				
				$("#reviseButton").show();
            } else {
            	showError(exceptionListJson);
            }
        }
        
        /****************
        Other Function
        ****************/
        //Display error when error occur in save process
        function showError(exceptionListJson) {
            //Display the error message
            $('.saveErrorPanel').css("display","block");
            
            var errorMessage = '';
            
            var exceptionList = jQuery.parseJSON(exceptionListJson);
            for(var errorIndex = 0 ; errorIndex < exceptionList.length ; errorIndex++) {
            	var exceptionObj = exceptionList[errorIndex];
                errorMessage += exceptionObj['errorMessage'] + '<br />';
            }
            
            //Assign the error message to page
            $('.errorMessage').html(errorMessage);
        }
        
        //Update data table field display value
        function updateValue(rowId, className, newValue) {
            /*
			$("#" + rowId + " ." + className).text(newValue.toFixed(2));
			*/
			$("#" + rowId + " ." + className).text(newValue.toLocaleString('en-US', {minimumFractionDigits: 2}));
        }
        
        /****************
        Business Logic Function
        ****************/
        function checkSubbrand(newValue, rowIndex) {
            var isValid = 'passed';
			rowIndex = rowIndex.toString();
			console.log(rowIndex);
            
        	var contractTargetList = $("#skuDataTable").DataTable().rows().data();
            for(var index in contractTargetList) {
			console.log(contractTargetList[index]);
				if (newValue == ''){
				
				} else
				if(newValue != '' && SUB_BRAND_LIST.indexOf(newValue) == -1) {
                	isValid = 'invalid';
					break;
                } else
                if(rowIndex != index) {
                	if (contractTargetList[index].ASI_CRM_Subbrand__r != undefined && contractTargetList[index].ASI_CRM_Subbrand__r.Name == newValue){
						isValid = 'duplicated';
						break;
					} else 
					if (contractTargetList[index].ASI_CRM_Subbrand__c != undefined && contractTargetList[index].ASI_CRM_Subbrand__c == newValue){
						isValid = 'duplicated';
						break;
					}
					
                }
            }
            return isValid;
        }
        
        function recalculateContractTargetValue(rowId, contractTargetData) {
        	contractTargetData["ASI_CRM_SG_Target_Sales_9L_Cases__c"] = parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                                      * parseFloat(contractTargetData["ASI_CRM_SG_Size_cl__c"] ? contractTargetData["ASI_CRM_SG_Size_cl__c"] : 0)
                                                                      * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                      / 900;

            contractTargetData["ASI_CRM_SG_Target_Sales_Cases_FOC__c"] = parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0); 
        	
            var inflationRate     = {!InflationRate};
            var distributionRate  = {!DistributionRate};
            var contractEndDate   = new Date('{!contract.ASI_TH_CRM_End_Date__c}');
            var contractStartDate = new Date('{!contract.ASI_TH_CRM_Start_Date__c}');
            var contractPeriod    = Math.round((((contractEndDate - contractStartDate)/86400000)/30));
         	
            contractTargetData["ASI_CRM_Total_Management_Incentives__c"] = parseFloat(contractTargetData["ASI_CRM_SG_Management_Incentives__c"] ? contractTargetData["ASI_CRM_SG_Management_Incentives__c"] : 0)
                                                                         * contractPeriod;
            
            contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] = parseFloat(contractTargetData["ASI_CRM_SG_Sales_Incentive__c"] ? contractTargetData["ASI_CRM_SG_Sales_Incentive__c"] : 0)
                                                                       * parseFloat(contractTargetData["ASI_CRM_SG_Target_Sales_Cases_FOC__c"] ? contractTargetData["ASI_CRM_SG_Target_Sales_Cases_FOC__c"] : 0)
                                                                       / parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 1)
                                                                       + parseFloat(contractTargetData["ASI_CRM_Total_Management_Incentives__c"] ? contractTargetData["ASI_CRM_Total_Management_Incentives__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Others__c"] ? contractTargetData["ASI_CRM_SG_Others__c"] : 0)
                                                                       +parseFloat (contractTargetData["ASI_CRM_SG_Cont_Sponsor_Target_Incentive__c"] ? contractTargetData["ASI_CRM_SG_Cont_Sponsor_Target_Incentive__c"] : 0);
            
            contractTargetData["ASI_CRM_Total_Duty__c"] = (parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                           + parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0))
                                                        * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                        * parseFloat(contractTargetData["ASI_CRM_Duty_Per_Bottle__c"] ? contractTargetData["ASI_CRM_Duty_Per_Bottle__c"] : 0);

         	contractTargetData["ASI_CRM_Total_FOB__c"] = (parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                           + parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0))
                                                       * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                       * parseFloat(contractTargetData["ASI_CRM_FOB_Per_Bottle__c"] ? contractTargetData["ASI_CRM_FOB_Per_Bottle__c"] : 0);
            
            contractTargetData["ASI_CRM_Total_Handling_Cost__c"] = (parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0) 
                                                                    + parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0))
                                                                 * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                 * parseFloat(contractTargetData["ASI_CRM_Handling_Cost_Per_Bottle__c"] ? contractTargetData["ASI_CRM_Handling_Cost_Per_Bottle__c"] : 0);
            
            contractTargetData["ASI_CRM_SG_Total_Free_Goods_9L_Cases__c"] = parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0)
                                                                          * parseFloat(contractTargetData["ASI_CRM_SG_Size_cl__c"] ? contractTargetData["ASI_CRM_SG_Size_cl__c"] : 0)
                                                                          * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                          / 900;
            
            if(!contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] || contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] == 0 || 
               contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] > contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"]) {
            	contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] = 0; 
            } else {
                contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] = parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                                                  * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                                  * (parseFloat(contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] ? contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] : 0)
                                                                                     - parseFloat(contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] ? contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] : 0));
            }
            
            contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"] = parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                                        * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                        * parseFloat(contractTargetData["ASI_CRM_SG_Wholesaler_Margin__c"] ? contractTargetData["ASI_CRM_SG_Wholesaler_Margin__c"] : 0);
            
            if(!contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] || contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] == 0) {
            	contractTargetData["ASI_CRM_SG_Contract_Margin_per_9Lc__c"] = 0;
            } else {
                contractTargetData["ASI_CRM_SG_Contract_Margin_per_9Lc__c"] = ((parseFloat(contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] ? contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] : 0)
                                                                                - parseFloat(contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] ? contractTargetData["ASI_CRM_SG_Consumer_Price_Offer__c"] : 0))
                                                                            + parseFloat(contractTargetData["ASI_CRM_SG_Wholesaler_Margin__c"] ? contractTargetData["ASI_CRM_SG_Wholesaler_Margin__c"] : 0))
                                                                            * 900
                                                                            / parseFloat(contractTargetData["ASI_CRM_SG_Size_cl__c"] ? contractTargetData["ASI_CRM_SG_Size_cl__c"] : 0);
            }
            
            contractTargetData["ASI_CRM_SG_Contract_Margin_Total__c"] = parseFloat(contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] ? contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] : 0)
                                                                      + parseFloat(contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"] ? contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"] : 0);
            
            contractTargetData["ASI_CRM_Bottle_Incentive_Total__c"] = parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                        * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                        * parseFloat(contractTargetData["ASI_CRM_Bottle_Incentive__c"] ? contractTargetData["ASI_CRM_Bottle_Incentive__c"] : 0);

            contractTargetData["ASI_CRM_SG_Cash_Sponsorship_Total__c"] = parseFloat(contractTargetData["ASI_CRM_SG_Good_in_Kinds__c"] ? contractTargetData["ASI_CRM_SG_Good_in_Kinds__c"] : 0)
                                                                      + parseFloat(contractTargetData["ASI_CRM_SG_Cash__c"] ? contractTargetData["ASI_CRM_SG_Cash__c"] : 0);
            
            contractTargetData["ASI_CRM_SG_Trd_Adv_Promo_Total__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Events__c"] ? contractTargetData["ASI_CRM_SG_Events__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] ? contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] ? contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] ? contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_Advertising_Spot__c"] : 0)) 
                                                                    + ((parseFloat(contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] : 0)
                                                                        + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] ? contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] : 0)
                                                                        + parseFloat(contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] : 0)
                                                                        + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] ? contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] : 0))
                                                                       * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                       * parseFloat(contractTargetData["ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c"] ? contractTargetData["ASI_CRM_SG_Selling_Price_Btl_WS_On_Trade__c"] : 0));
            
            contractTargetData["ASI_CRM_SG_Trd_Adv_Promo_TotalPRS__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Events__c"] ? contractTargetData["ASI_CRM_SG_Events__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] ? contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] ? contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] ? contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_Advertising_Spot__c"] : 0))
                                                                       + ((parseFloat(contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] : 0)
                                                                           + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] ? contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] : 0)
                                                                           + parseFloat(contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] : 0)
                                                                           + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] ? contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] : 0))
                                                                          * parseFloat(contractTargetData["ASI_CRM_SG_IGC_Cost_Per_case__c"] ? contractTargetData["ASI_CRM_SG_IGC_Cost_Per_case__c"] : 0));
		
            contractTargetData["ASI_CRM_SG_Free_Goods__c"] = -(parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0) 
                                                               * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                               * parseFloat(contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] ? contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] : 0));
            
            contractTargetData["ASI_CRM_SG_Total_Allowances_Discounts__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Free_Goods__c"] ? contractTargetData["ASI_CRM_SG_Free_Goods__c"] : 0)
                                                                              - parseFloat(contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"] ? contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"] : 0)
                                                                              - parseFloat(contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] ? contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"] : 0)
                                                                              - parseFloat(contractTargetData["ASI_CRM_SG_Good_in_Kinds__c"] ? contractTargetData["ASI_CRM_SG_Good_in_Kinds__c"] : 0)
                                                                              - parseFloat(contractTargetData["ASI_CRM_SG_Cash__c"] ? contractTargetData["ASI_CRM_SG_Cash__c"] : 0) 
                                                                              - (parseFloat(contractTargetData["ASI_CRM_Bottle_Incentive__c"] ? contractTargetData["ASI_CRM_Bottle_Incentive__c"] : 0)
                                                                                 * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                                                 * parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)));
            
            contractTargetData["ASI_CRM_SG_Gross_Sales__c"] = ((parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0)
                                                                + parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0))
                                                               * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0)
                                                               * parseFloat(contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] ? contractTargetData["ASI_CRM_SG_Selling_Price_Btl_PRS_WS__c"] : 0));
            
            contractTargetData["ASI_CRM_SG_Distribution_Cost__c"] = -(parseFloat(contractTargetData["ASI_CRM_SG_Gross_Sales__c"] ? contractTargetData["ASI_CRM_SG_Gross_Sales__c"] : 0)
                                                                      * parseFloat(distributionRate ? distributionRate: 0) / 100);
            
            contractTargetData["ASI_CRM_SG_Net_Sales__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Gross_Sales__c"] ? contractTargetData["ASI_CRM_SG_Gross_Sales__c"] : 0)
                                                            + parseFloat(contractTargetData["ASI_CRM_SG_Total_Allowances_Discounts__c"] ? contractTargetData["ASI_CRM_SG_Total_Allowances_Discounts__c"] : 0)) 
            
            contractTargetData["ASI_CRM_SG_Cost_of_Sales__c"] = -(((parseFloat(contractTargetData["ASI_CRM_FOB_Per_Bottle__c"] ? contractTargetData["ASI_CRM_FOB_Per_Bottle__c"] : 0) 
                                                                    + parseFloat(contractTargetData["ASI_CRM_Handling_Cost_Per_Bottle__c"] ? contractTargetData["ASI_CRM_Handling_Cost_Per_Bottle__c"] : 0))
                                                                   * (1 + (parseFloat(inflationRate ? inflationRate : 0) / 100))
                                                                   + parseFloat(contractTargetData["ASI_CRM_Duty_Per_Bottle__c"] ? contractTargetData["ASI_CRM_Duty_Per_Bottle__c"] : 0))
                                                                  * (parseFloat(contractTargetData["ASI_CRM_TargetCase__c"] ? contractTargetData["ASI_CRM_TargetCase__c"] : 0)
                                                                     + parseFloat(contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] ? contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"] : 0))
                                                                  * parseFloat(contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] ? contractTargetData["ASI_CRM_SG_Btls_Per_Case__c"] : 0))
                                                                  + parseFloat(contractTargetData["ASI_CRM_SG_Distribution_Cost__c"] ? contractTargetData["ASI_CRM_SG_Distribution_Cost__c"] : 0);
            
            contractTargetData["ASI_CRM_SG_Gross_Margin__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Net_Sales__c"] ? contractTargetData["ASI_CRM_SG_Net_Sales__c"] : 0)
                                                                + parseFloat(contractTargetData["ASI_CRM_SG_Cost_of_Sales__c"] ? contractTargetData["ASI_CRM_SG_Cost_of_Sales__c"] : 0));
            
            contractTargetData["ASI_CRM_SG_Trade_A_P_Total_PRS__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Events__c"] ? contractTargetData["ASI_CRM_SG_Events__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_SG_Signages_Advertising_Spot__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] ? contractTargetData["ASI_CRM_SG_Trade_Incentive_Trips__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] ? contractTargetData["ASI_CRM_SG_Product_Branding_Display__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] ? contractTargetData["ASI_CRM_SG_Ad_hoc_Promotions__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_SG_Ad_hoc_Others_Total__c"] ? contractTargetData["ASI_CRM_SG_Ad_hoc_Others_Total__c"] : 0)
                                                                       + (parseFloat(contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Events_Free_Bottles__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] ? contractTargetData["ASI_CRM_SG_Signages_Ad_Spot_Free_Btl__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] ? contractTargetData["ASI_CRM_SG_Anniversary_Free_Bottles__c"] : 0)
                                                                          + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] ? contractTargetData["ASI_CRM_Advertising_Spot_Free_Bottles__c"] : 0))
                                                                       * parseFloat(contractTargetData["ASI_CRM_SG_IGC_Cost_Per_case__c"] ? contractTargetData["ASI_CRM_SG_IGC_Cost_Per_case__c"] : 0)
                                                                       + parseFloat(contractTargetData["ASI_CRM_Advertising_Spot__c"] ? contractTargetData["ASI_CRM_Advertising_Spot__c"] : 0));
            
            contractTargetData["ASI_CRM_SG_Return_on_Investment__c"] = (parseFloat(contractTargetData["ASI_CRM_SG_Gross_Margin__c"] ? contractTargetData["ASI_CRM_SG_Gross_Margin__c"] : 0)
                                                                        - parseFloat(contractTargetData["ASI_CRM_SG_Trade_A_P_Total_PRS__c"] ? contractTargetData["ASI_CRM_SG_Trade_A_P_Total_PRS__c"] : 0));
            
            //Update the data table value
        	updateValue(rowId, 'ASI_CRM_SG_Target_Sales_9L_Cases__c', contractTargetData["ASI_CRM_SG_Target_Sales_9L_Cases__c"]);	
        	updateValue(rowId, 'ASI_CRM_SG_Target_Sales_Cases_FOC__c', contractTargetData["ASI_CRM_SG_Target_Sales_Cases_FOC__c"]);
        	updateValue(rowId, 'ASI_CRM_Total_Management_Incentives__c', contractTargetData["ASI_CRM_Total_Management_Incentives__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Total_Free_Goods_Cases__c', contractTargetData["ASI_CRM_SG_Total_Free_Goods_Cases__c"]);
        	updateValue(rowId, 'ASI_CRM_Total_Duty__c', contractTargetData["ASI_CRM_Total_Duty__c"]);
        	updateValue(rowId, 'ASI_CRM_Total_FOB__c', contractTargetData["ASI_CRM_Total_FOB__c"]);
        	updateValue(rowId, 'ASI_CRM_Total_Handling_Cost__c', contractTargetData["ASI_CRM_Total_Handling_Cost__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Total_Free_Goods_9L_Cases__c', contractTargetData["ASI_CRM_SG_Total_Free_Goods_9L_Cases__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Compensation_for_WS_Price_Dif__c', contractTargetData["ASI_CRM_SG_Compensation_for_WS_Price_Dif__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Wholesaler_Margin_Total__c', contractTargetData["ASI_CRM_SG_Wholesaler_Margin_Total__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Contract_Margin_per_9Lc__c', contractTargetData["ASI_CRM_SG_Contract_Margin_per_9Lc__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Contract_Margin_Total__c', contractTargetData["ASI_CRM_SG_Contract_Margin_Total__c"]);
        	updateValue(rowId, 'ASI_CRM_Bottle_Incentive_Total__c', contractTargetData["ASI_CRM_Bottle_Incentive_Total__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Cash_Sponsorship_Total__c', contractTargetData["ASI_CRM_SG_Cash_Sponsorship_Total__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Trd_Adv_Promo_Total__c', contractTargetData["ASI_CRM_SG_Trd_Adv_Promo_Total__c"]);
        	updateValue(rowId, 'ASI_CRM_SG_Trd_Adv_Promo_TotalPRS__c', contractTargetData["ASI_CRM_SG_Trd_Adv_Promo_TotalPRS__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Free_Goods__c', contractTargetData["ASI_CRM_SG_Free_Goods__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Total_Allowances_Discounts__c', contractTargetData["ASI_CRM_SG_Total_Allowances_Discounts__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Gross_Sales__c', contractTargetData["ASI_CRM_SG_Gross_Sales__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Distribution_Cost__c', contractTargetData["ASI_CRM_SG_Distribution_Cost__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Net_Sales__c', contractTargetData["ASI_CRM_SG_Net_Sales__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Cost_of_Sales__c', contractTargetData["ASI_CRM_SG_Cost_of_Sales__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Gross_Margin__c', contractTargetData["ASI_CRM_SG_Gross_Margin__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Trade_A_P_Total_PRS__c', contractTargetData["ASI_CRM_SG_Trade_A_P_Total_PRS__c"]);
            updateValue(rowId, 'ASI_CRM_SG_Return_on_Investment__c', contractTargetData["ASI_CRM_SG_Return_on_Investment__c"]);
            
          	//update ROI field
            var roi = 0;
            if(contractTargetData["ASI_CRM_SG_Return_on_Investment__c"] && contractTargetData["ASI_CRM_SG_Net_Sales__c"]) {
            	if (contractTargetData["ASI_CRM_SG_Net_Sales__c"] == 0){
					roi = 0;
				} else 
				if (contractTargetData["ASI_CRM_SG_Return_on_Investment__c"] < 0 && contractTargetData["ASI_CRM_SG_Net_Sales__c"] < 0){
					roi = contractTargetData["ASI_CRM_SG_Return_on_Investment__c"]
						/ contractTargetData["ASI_CRM_SG_Net_Sales__c"]
						* -100;
				} else {
					roi = contractTargetData["ASI_CRM_SG_Return_on_Investment__c"]
						/ contractTargetData["ASI_CRM_SG_Net_Sales__c"]
						* 100;
				}
				
            	roi = roi.toFixed(2);
            }
            
            $("#" + rowId + " .ROI").html(roi + "%");
        }
    </script>
    
    <body>
        <div class="fullScreenLoading"></div>
        <!-- Error Message Dialog -->
        <div class="saveErrorPanel alert alert-danger" style="display: none;">
            <strong>Error</strong> 
            <br />
            <p class="errorMessage"></p>
        </div>
        
        <div class="infoPanel alert alert-info" style="display: none;">
            <strong>Info</strong>
            <br />
            <p class="infoMessage"></p>
        </div>
        
        <!-- Defind Action Function -->
        <apex:form >
            <apex:actionFunction name="searchSKU" action="{!searchSKU}" reRender="pageMsg" onComplete="searchSKUComplete('{!JSENCODE(skuPriceWrapperListJson)}')">
                <apex:param name="skuName" value="" />
				<apex:param name="filterOutSKUIdListJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="calculateROI" action="{!calculateROI}" reRender="pageMsg" onComplete="calculateROIComplete('{!oldROI}', '{!newROI}')">
                <apex:param name="contractTargetListJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="saveSimulation" action="{!saveSimulation}" reRender="pageMsg" 
                                 onComplete="saveRecordComplete('{!JSENCODE(contractTargetListJson)}', '{!JSENCODE(cashPaymentScheduleListJson)}', '{!JSENCODE(contractPaymentScheduleListJson)}', '{!JSENCODE(contractContractOutletListJson)}', '{!JSENCODE(childOutletListJson)}', {!hasError}, '{!JSENCODE(exceptionListJson)}');">
                <apex:param name="IS_QUICK_SAVE" value="" />
                <apex:param name="updateContractTargetListJson" value="" />
                <apex:param name="deleteContractTargetListJson" value="" />
                <apex:param name="updatePaymentScheduleListJson" value="" />
                <apex:param name="deletePaymentScheduleListJson" value="" />
                <apex:param name="updateContractOutletListJson" value="" />
                <apex:param name="deleteContractOutletListJson" value="" />
            </apex:actionFunction>
            <apex:actionFunction name="reviseContract" action="{!reviseContract}" />
            <apex:actionFunction name="deleteSimulation" action="{!deleteSimulation}" />
            <apex:actionFunction name="cancel" action="{!cancel}"/>
        </apex:form>
        
        <!-- Body -->
        <apex:pageBlock id="detail_pageBlock">
            <apex:pageblockButtons >
                <input type="button" class="btn calculateROI" onclick="calculateROIJS()" value="Calculate ROI%" />
                <input type="button" class="btn saveBtn" onclick="saveRecord(false)" value="Save Simulation" />
                <input type="button" class="btn quickSaveBtn" onclick="saveRecord(true)" value="Quick Save Simulation" />
                <input type="button" class="btn quickSaveBtn" onclick="deleteSimulation()" value="Delete Simulation" />
				<!-- Hide for UAT -->
				
                <input type="button" class="btn quickSaveBtn" onclick="reviseContract()" value="Confirm Simulation & Revise to Draft" id="reviseButton" style="{!IF(isSimulate,'','display:none;')}"/>
				
                <input type="button" class="btn cancelBtn" onclick="cancel()" value="Cancel" />
            </apex:pageblockButtons>
            
            <!-- Nav bar -->
            <div class="row">
                <div class="container-fluid">
                    <div class="panel with-nav-tabs panel-primary">
                        <!-- Nav bar header -->
                        <div class="panel-heading">
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="#skuDiv" data-toggle="tab">SKU</a></li>
                                <li><a href="#freeGoodDiv" data-toggle="tab">Free Goods</a></li>
                                <li><a href="#contractMarginDiv" data-toggle="tab">Contract Margin</a></li>
                                <li><a href="#cashSponsorshipDiv" data-toggle="tab">Cash Sponsorship</a></li>
                                <li><a href="#apDiv" data-toggle="tab">A&amp;P</a></li>
                                <li><a href="#paymentScheduleDiv" data-toggle="tab">Payment Schedule</a></li>
                                <li style="{!IF(isParentAccount, '','display:none')}"><a href="#contractOutletDiv" data-toggle="tab">Contract Outlets</a></li>
                            </ul>
                        </div>
    
                        <!-- Nav bar body -->
                        <div class="panel-body">
                            <div class="tab-content">
                                <!-- SKU Data Table -->
                                <div class="tab-pane fade in active" id="skuDiv">
                                    <div>
                                		<table id="skuDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="skuDivSearchSKU">SKU</label>
                                        <input type="text" id="skuDivSearchSKU"/>
                                        <input type="button" class="btn" value="Search" onClick="searchSKUJS($('#skuDivSearchSKU'))"/>
                                        <br />
                                        <br />
                                    	<table class="addSKUTable" width="100%"/>
                                    </div>
                                </div>
                                <!-- Free Good Data Table -->
                                <div class="tab-pane fade in" id="freeGoodDiv">
									<div>
                                		<table id="freeGoodDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="freeGoodDivSearchSKU">SKU</label>
                                        <input type="text" id="freeGoodDivSearchSKU"/>
                                        <input type="button" class="btn" value="Search" onClick="searchSKUJS($('#freeGoodDivSearchSKU'))"/>
                                        <br />
                                        <br />
                                    	<table class="addSKUTable" width="100%"/>
                                    </div>
                                </div>
                                <!-- Contract Margin Data Table -->
                                <div class="tab-pane fade in" id="contractMarginDiv">
                                    <div>
                                		<table id="contractMarginDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="contractMarginDivSearchSKU">SKU</label>
                                        <input type="text" id="contractMarginDivSearchSKU"/>
                                        <input type="button" class="btn" value="Search" onClick="searchSKUJS($('#contractMarginDivSearchSKU'))"/>
                                        <br />
                                        <br />
                                    	<table class="addSKUTable" width="100%"/>
                                    </div>
                                </div>
                                <!-- Cash Sponsorship Data Table -->
                                <div class="tab-pane fade in" id="cashSponsorshipDiv">
                                    <div>
                                		<table id="cashSponsorshipDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="cashSponsorshipDivSearchSKU">SKU</label>
                                        <input type="text" id="cashSponsorshipDivSearchSKU"/>
                                        <input type="button" class="btn" value="Search" onClick="searchSKUJS($('#cashSponsorshipDivSearchSKU'))"/>
                                        <br />
                                        <br />
                                    	<table class="addSKUTable" width="100%"/>
                                    </div>
                                </div>
                                <!-- A&P Data Table -->
                                <div class="tab-pane fade in" id="apDiv">
                                    <div>
                                		<table id="apDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="apDivSearchSKU">SKU</label>
                                        <input type="text" id="apDivSearchSKU"/>
                                        <input type="button" class="btn" value="Search" onClick="searchSKUJS($('#apDivSearchSKU'))"/>
                                        <br />
                                        <br />
                                    	<table class="addSKUTable" width="100%"/>
                                    </div>
                                </div>
                                <!-- Payment Schedule Data Table -->
                                <div class="tab-pane fade in" id="paymentScheduleDiv">
                                	<div>
                                        <input type="button" class="btn" value="Add New Cash Sponsorship" onClick="addPaymentCashSponsorship();"/>
                                        <br />
                                        <br />
                                        <table id="paymentCashSponsorshipDataTable" width="100%" />
                                    </div>
                                    
                                    <hr />
                                    
                                	<div>
                                        <input type="button" class="btn" value="Add New Contract Sponsorship" onClick="addPaymentContractSponsorship();"/>
                                        <br />
                                        <br />
                                        <table id="paymentContractSponsorshipDataTable" width="100%" />
                                    </div>
                                </div>
                                <!-- Contract Outlet Data Table -->
                                <div class="tab-pane fade in" id="contractOutletDiv">
                                    <div>
                                		<table id="contractOutletDataTable" width="100%"/>
                                    </div>
                                    <hr />
									<div>
                                        <label for="contractOutletDivSearchOutlet">Outlet</label>
                                        <br />
                                        <br />
                                    	<table class="addOutletTable" width="100%"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </apex:pageBlock>
    </body>
    
</apex:page>