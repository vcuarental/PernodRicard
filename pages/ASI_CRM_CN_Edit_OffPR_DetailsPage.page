<!--
 - Created by Jeffrey Cheung on 3/9/2018.
 -->

<apex:page id="ASI_CRM_CN_Edit_OffPR_DetailsPage" standardController="ASI_TH_CRM_PaymentRequest__c" extensions="ASI_CRM_CN_EditOffPaymentDetailCtrl" action="{!Calculation}" docType="html-5.0" sidebar="false" >
    <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_AddOn_CSS_V3_3_2, '/bower_components/Font-Awesome/css/font-awesome.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_AddOn_CSS_V3_3_2, '/bower_components/Font-Awesome/css/font-awesome.min.css')}" />

    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_CN_Jquery, 'jquery-ui1.10.4.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.ASI_Library, 'dist/css/bootstrap.min.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_CN_Jquery, 'jquery1.10.2.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_CN_Jquery, 'jquery-ui1.10.4.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_Library, 'dist/js/bootstrap.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ASI_CN_DataTables, 'datatables.min.js')}"/>

    <style>
        .module-table td {
            min-width: 15%;
        }
        .module-table tr td:nth-child(odd){
            font-weight: bold !important;
            text-align: right !important;
        }
        .module-header-table{
            width: 100%;
        }

        .module-header-table td {
            width: 15%;
            padding: 0.1rem;
            border: 1px solid #ddd;
        }

        .module-header-table tr td:nth-child(odd) {
            text-align: right  !important;
            font-weight: bold !important;
        }

        .BSCommandButton{
            color: #333 !important;
            background-color: #fff !important;
            border-color: #ccc !important;
            margin-left: 0.5em !important;
            margin-right: 0.5em !important;
            margin-bottom: 0.5em !important;
            padding: 3px 6px !important;
        }


        .PanelHeader{
            color: #fff;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
            background-color: #337ab7;
            border: 1px solid #337ab7;
            padding: 10px 15px;
            text-align: center;
            width: 20%;
        }

        .PanelBody{
            padding: 0.3em;
            background-color: #fff;
            border: 1px solid #337ab7;
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
            border-top-right-radius: 3px;
            margin-bottom: 20px;
        }


        .FontWeightCSS{
            font-weight: bold;
        }


        .MethodologyLabel{
            font-weight: bold !important;
            text-align: right !important;
        }



        .ApexInputDateField{
            text-align: right;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 10em !important;
        }

        .ApexInputNumberField{
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 10em !important;
        }



        .ApexInputRemarkField{
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }



        .ApexPickListField{
            width: 16em; text-align:
                right; padding: 3px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .BorderBottom{
            border-bottom: 1px solid #ddd;
        }

        .MethodologyLabel{
            font-weight: bold !important;
            text-align: right !important;
        }

        .requiredField{
            border-left: 3px solid red !important;
        }

        .overpaidIncentive {
            color: red !important;
        }
    </style>
    <apex:outputPanel rendered="{!isView}">
        <chatter:feedWithFollowers entityid="{!ASI_TH_CRM_PaymentRequest__c.id}"/>
    </apex:outputPanel>

    <!--View Page Logic-->
    <script type="text/javascript">
        window.onload = function() {
            $('input[type=text]').blur();
        };

        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            }
            else {
                window.onload = function () {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }


        function checkPage() {
            if (document.getElementsByName("piSubmit")[0] != null)
                document.getElementsByName("piSubmit")[0].style.display = 'none';
            if (document.getElementsByName("piSubmit")[0] != null)
                document.getElementsByName("piSubmit")[0].style.display = 'none';
            if (document.getElementsByName("piRemove")[0] != null) {
                var orgFunc = document.getElementsByName("piRemove")[0].onclick;
                document.getElementsByName("piRemove")[0].onclick = function () {
                    recallApprovalRequest(orgFunc);
                };
            }
            var anchors = document.getElementsByTagName("a");
            var reassignBackToRelatedList = "apex%2FASI_MFM_TW_Approval_Related_List%3Finline%3D1%26id%3D"; // the pattern of URL returning to related list iframe
            for (var i = 0; i < anchors.length; i++) {
                if (anchors[i].href.indexOf(reassignBackToRelatedList) > 0) {
                    anchors[i].href = anchors[i].href.replace(reassignBackToRelatedList, ""); // remove the url portion of returning to related list iframe
                }
                if (anchors[i].href.indexOf("salesforce.com") > 0) {
                    anchors[i].setAttribute('target', '_top'); // open the link in parent window when user press any links containing "salesforce.com" in URL
                }
            }


        }

        function recallApprovalRequest(func) {
            var recallApprovalRequestBackToRelatedList = "apex%2FASI_MFM_TW_Approval_Related_List%3Finline%3D1%26id%3D";  // the pattern of URL returning to related list iframe
            var funcStr = func.toString();
            var urlIndexStart = funcStr.indexOf("https");
            var funcStr2 = funcStr.substring(urlIndexStart, funcStr.length);
            var urlIndexEnd = funcStr2.indexOf(",") - 1;
            var urlStr = funcStr2.substring(0, urlIndexEnd); // extract the url of cancel button from the original onClick function
            urlStr = urlStr.replace(recallApprovalRequestBackToRelatedList, ""); // remove the url portion of returning to related list iframe
            var newWin = window.open(urlStr, "_top");  // open the window "Recall Approval Request" in parent window when the user press the button "Recall Approval Request"
        }

        addLoadEvent(function () {
            checkPage();
        });

    </script>

    <script type='text/javascript'>
        $(document).ready(function() {
            var BrandList=document.getElementsByClassName("bPageFooter");
            for( var i=0; i<BrandList.length ; i++){
                BrandList[i].innerHTML='';
            }

        });

        $(document).on('mousemove', function(e){
            $('#loadtext').css({
                left:  e.pageX,
                top:   e.pageY
            });
            $('input[type=text]').on('keydown', function(e) {
                if (e.which == 13) {
                    e.preventDefault();
                }
            });
        });


        //**************************************BRSF Function*****************************************************





        function SetAdjustmentPercent(HistoricalPaidAmountId,ApplicationPaymentAmountId,ActualPaymentId,Adjustmentclass){
            var HistoricalPaidAmount = StringToNumberStr($('#'+HistoricalPaidAmountId)[0].childNodes[0].textContent);

            var ApplicationAmount=StringToNumberStr($('#'+ApplicationPaymentAmountId)[0].childNodes[0].textContent);
            var ActualPayment= StringToNumberStr($('#'+ActualPaymentId)[0].childNodes[0].value);
            var AdjustmentPercent=100;

            if(ActualPayment && ApplicationAmount && ApplicationAmount!=0){
                console.log('ActualPayment'+ActualPayment);
                console.log('ApplicationAmount'+ApplicationAmount);
                console.log('HistoricalPaidAmount'+HistoricalPaidAmount);
                AdjustmentPercent=(ActualPayment/(ApplicationAmount))*100;
            }
            $('.'+Adjustmentclass)[0].textContent=formatNumber(AdjustmentPercent) + '%';

        }



        //**************************************VEC Function*****************************************************



        function ChangingVECEndDate(itm){
            if(confirm('After Changing Display Date, Volume will refresh, confirm?\n更改Display日期，系统会自动刷新销量，确定？')) {
                ChangingVECDate(itm);
            }
        }





        function QuickGoTo(ElementId){
            var e = document.getElementById(ElementId);
            if (!!e && e.scrollIntoView) {
                e.scrollIntoView();
            }
        }

        //*******************Shared function********************************
        function formatNumber(number){
            if(number && number.toLocaleString){
                return number.toLocaleString('en', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            return number;
        }

        //remove comma
        function StringToNumberStr( i ) {
            return typeof i === 'string' ? i.replace(/\s/g, '').replace(/[\$,]/g, '')*1 : typeof i === 'number' ?   i : 0;
        };


        function currencyToFloat(currencyStr){
            if (typeof currencyStr === 'string') {
                var numStr = currencyStr.replace(/,/g, '');
                if (/^-?\d+\.?\d*$/.test(numStr)) {
                    return parseFloat(numStr);
                }
            }
            return null;
        }

    </script>

    <apex:outputPanel id="dataFactory">
        <script>
            var PSF_Item_MapJSON = {!PSF_Item_MapJSON};
        </script>
    </apex:outputPanel>

    <!--**************************************PSF Function*****************************************************-->
    <script>


        function ChangingPSFEndDate(that){
            if(confirm('After Changing PSF Date, Volume will refresh, confirm?\n更改PSF日期，系统会自动刷新销量，确定？')) {
                updateLinesBeforeApex();
                ChangingPSFDate(that,JSON.stringify(PSF_Item_MapJSON));
            }
        }

        function drawPSFTable(tableId){
            let key = tableId.split('_')[1];
            let interimData = PSF_Item_MapJSON[key];
            let KPIBase = interimData.Module.ASI_CRM_CN_KPI_Base__c;
            let methodology = interimData.Module.ASI_CRM_Methodology__r.Name;
            let volumeBase = interimData.Module.ASI_CRM_Volume_Base__c;
            let criteria = interimData.Module.ASI_CRM_CN_Criteria__c;
            let createdVersion = interimData.Module.ASI_CRM_Parent_Module__r.ASI_CRM_Created_PO_Version__c;
            let isDolphin = {!ContractSelected.ASI_CRM_CN_Is_Dolphin__c};
            let isEdit = {!isEdit};

            let displayColumns =  [
                {
                    title: '{!$ObjectType.ASI_MFM_Sub_brand__c.Label}',
                    data: 'ASI_CRM_CN_Sub_Brand__r.Name',
                    render: function (data, type, row, meta) {
                        return `<a href="/${row.ASI_CRM_CN_Sub_Brand__c}">${data}</a>`;
                    },
                    visible: volumeBase === 'By Sub-Brand',
                },
                {
                    title: "",
                    data: 'ASI_CRM_Line_Name__c',
                    render: function (data, type, row, meta) {
                        return `<a href="/${row.ASI_CRM_Product_Category__c}">${data}</a>`;
                    },
                    visible: volumeBase === 'By Category'
                },
                {
                    title: "",
                    data: function ( row, type, val, meta ) {
                        return '{!$Label.ASI_CRM_CN_By_Total}';
                    },
                    visible: volumeBase === 'By Total'
                },
                {
                    title: '{!$Label.ASI_CRM_CN_Incentive_Per_Bottle}',
                    className: 'number',
                    data: 'ASI_CRM_CN_Incentive_BT__c',
                    render: function (data, type, row, meta) {
                        let classes = [];

                        if (row.ASI_CRM_CN_Allow_Changing_Incentive__c && data > row.ASI_CRM_Max_Incentive__c) {
                            classes.push('overpaidIncentive');
                        }

                        if(row.ASI_CRM_CN_Allow_Changing_Incentive__c && isEdit){
                            classes.push('ApexInputNumberField');
                            return `<input type="number" min="0" step=".01" class="${classes.join(' ')}" value="${data}" onChange="changeIncentivePerBottle(${meta.row}, this.value, '${tableId}')"/>`;
                        } else {
                            return `<span class="${classes.join(' ')}">${data}</span>`;

                        }
                    },
                    visible: KPIBase === 'Volume base' && volumeBase === 'By Sub-Brand',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_CTD_Intake_Std_Btl}',
                    className: 'number summable',
                    data: 'ASI_CRM_CN_Actual_Vol__c',
                    visible: KPIBase === 'Volume base' && volumeBase === 'By Sub-Brand',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_CTD_Intake_Std_Btl}({!$Label.ASI_CRM_CN_CR12_Extra_Eqv})',
                    className: 'number summable',
                    data: 'ASI_CRM_CTD_Actual_Vol__c',
                    visible: KPIBase === 'Volume base' && methodology !== 'Per Incentive Btl' && methodology !== 'Others',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_Contract_Volume_Target}({!$Label.ASI_CRM_CN_Std_Btl})',
                    className: 'number summable',
                    data: function(row, type, set, meta){
                        if(!row.ASI_CRM_CN_Contract_BRSF_Line_Item__r){
                            return 0;
                        }
                        if(createdVersion === '0.0'){
                            return row.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Contract_Total_QTY_std_Btl__c;
                        }else {
                            return row.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Est_Total_QTY_std_Btl__c;
                        }
                    },
                    visible: KPIBase === 'Volume base' && volumeBase === 'By Sub-Brand',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_Contract_Volume_Target}({!$Label.ASI_CRM_CN_CR12_Extra_Eqv})',
                    className: 'number summable',
                    data: function(row, type, set, meta){
                        if(!row.ASI_CRM_CN_Contract_BRSF_Line_Item__r){
                            return 0;
                        }
                        if(createdVersion === '0.0'){
                            return row.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Contract_Total_QTY_CR12_Eqv__c;
                        }else {
                            return row.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Est_Total_QTY_CR12_Eqv__c;
                        }
                    },
                    visible: KPIBase === 'Volume base' && methodology !== 'Per Incentive Btl' && methodology !== 'Others',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_Contract_Total_Amount}',
                    className: 'number',
                    data: 'ASI_CRM_V0_0_Full_Contract_Target__c',
                    visible: KPIBase === 'Volume base' && volumeBase !== 'By Sub-Brand',
                },
                // {
                //     title: 'Target Value',
                //     className: 'number',
                //     data: 'ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_CN_Contract_Purchase_Value__c',
                //     visible: KPIBase === 'Value base' && criteria === 'NA',
                // },
                {
                    title: isDolphin?'{!$Label.ASI_CRM_CN_Outlet_Reception_Scan}':'{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CTD_Actual_Purchase_Value__c.Label}',
                    className: 'number summable',
                    data: 'ASI_CRM_CTD_Actual_Purchase_Value__c',
                    visible: KPIBase === 'Value base'  && !(volumeBase === 'By Total' && criteria === 'By Ladder' || criteria === 'By Tax'),
                },
                // Dolphin 合同，增加一列outlet intake对应的销售额 ref，只参考
                {
                    title: '{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CTD_Actual_Purchase_Value_Ref__c.Label}',
                    className: 'number summable',
                    data: 'ASI_CRM_CTD_Actual_Purchase_Value_Ref__c',
                    visible: KPIBase === 'Value base'  && isDolphin,
                },
                {
                    title: "{!$ObjectType.ASI_CRM_CN_Contract_BRSF_Line_Item__c.Fields.ASI_CRM_CN_Min_Purchase_Target__c.Label}",
                    data: 'ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_CN_Min_Purchase_Target__c',
                    className: 'number',
                    visible: KPIBase === 'Value base' && volumeBase === 'By Total' && criteria === 'By Ladder'
                },
                {
                    title: "{!$ObjectType.ASI_CRM_CN_Contract_BRSF_Line_Item__c.Fields.ASI_CRM_CN_Max_Purchase_Target__c.Label}",
                    data: 'ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_CN_Max_Purchase_Target__c',
                    render: function ( data, type, row ) {
                        return data ? formatNumber(data) : '&infin;';
                    },
                    className: 'number',
                    visible: KPIBase === 'Value base' && volumeBase === 'By Total' && criteria === 'By Tax'
                },
                {
                    title: '{!$ObjectType.ASI_CRM_CN_Contract_BRSF_Line_Item__c.Fields.ASI_CRM_CN_Rebate_Percent__c.Label}',
                    className: 'number percent',
                    data: 'ASI_CRM_CN_Rebate_Percent__c',
                    render: function (data, type, row, meta) {
                        let classes = [];

                        if (row.ASI_CRM_CN_Allow_Changing_Incentive__c && data > row.ASI_CRM_Max_Incentive__c) {
                            classes.push('overpaidIncentive');
                        }

                        if(row.ASI_CRM_CN_Allow_Changing_Incentive__c && isEdit){
                            classes.push('ApexInputNumberField');
                            return `
                                <input type="number" min="0" step=".01" class="${classes.join(' ')}" value="${data}" onChange="changeRebatePercent(${meta.row}, this.value, '${tableId}')"/>%`;
                        } else {
                            return `<span class="${classes.join(' ')}">${data}%</span>`;

                        }
                    },
                    visible: KPIBase === 'Value base' && methodology.includes('Rebate%'),
                },
                {
                    title: '{!$ObjectType.ASI_CRM_CN_Contract_BRSF_Line_Item__c.Fields.ASI_CRM_CN_Target__c.Label}',
                    className: 'number',
                    data: 'ASI_CRM_CN_Target__c',
                    render: function (data, type, row, meta) {
                        let classes = [];

                        if (row.ASI_CRM_CN_Allow_Changing_Incentive__c && data > 0) {
                            classes.push('overpaidIncentive');
                        }

                        if(row.ASI_CRM_CN_Allow_Changing_Incentive__c && isEdit){
                            classes.push('ApexInputNumberField');
                            return `<input type="number" min="0" step=".01" class="${classes.join(' ')}" value="${data}" onChange="changeTargetOrRebate(${meta.row}, this.value, 'target', '${tableId}')"/>`;
                        } else {
                            return `<span class="${classes.join(' ')}">${data}</span>`;

                        }
                    },
                    visible: KPIBase === 'Value base' && methodology === 'Reach X get Y',
                },
                {
                    title: '{!$ObjectType.ASI_CRM_CN_Contract_BRSF_Line_Item__c.Fields.ASI_CRM_CN_Rebate__c.Label}',
                    className: 'number',
                    data: 'ASI_CRM_CN_Rebate__c',
                    render: function (data, type, row, meta) {
                        let classes = [];

                        if (row.ASI_CRM_CN_Allow_Changing_Incentive__c && data > 0) {
                            classes.push('overpaidIncentive');
                        }

                        if(row.ASI_CRM_CN_Allow_Changing_Incentive__c && isEdit){
                            classes.push('ApexInputNumberField');
                            return `<input type="number" min="0" step=".01" class="${classes.join(' ')}" value="${data}" onChange="changeTargetOrRebate(${meta.row}, this.value, 'rebate','${tableId}')"/>`;
                        } else {
                            return `<span class="${classes.join(' ')}">${data}</span>`;

                        }
                    },
                    visible: KPIBase === 'Value base' && methodology === 'Reach X get Y',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_CTD_Payable_Amount}',
                    className: 'number summable',
                    data: 'ASI_CRM_CN_Total_Payable__c',
                    visible: methodology !== 'Others',
                },
                {
                    title: '{!$Label.ASI_CRM_CN_Actual_Achievement}',
                    className: 'number percent achievementSum',
                    data: 'ASI_CRM_CN_Completion_Rate__c',
                    visible: KPIBase !== 'Value base' &&methodology !== 'Others',
                },

            ];
            let table = $(tableId).DataTable({
                paging: false,
                ordering: false,
                searching: false,
                info: false,
                footerCallback: function (tfoot, data, start, end, display) {
                    var api = this.api();
                    var htmlString = '';

                    var summableColumns = api.columns('.summable').indexes();
                    var achievementColumn = api.columns('.achievementSum').indexes();

                    api.columns().every(function () {
                        var column = this;

                        if (column.visible()) {
                            htmlString += '<th>';

                            var sum = '';
                            if (summableColumns.indexOf(column.index()) !== -1) {
                                sum = this
                                    .data()
                                    .reduce(function (a, b) {
                                        var x = parseFloat(a) || 0;
                                        var y = parseFloat(b) || 0;
                                        return x + y;
                                    }, 0);
                                htmlString += formatNumber(sum);
                            }
                            if (achievementColumn.indexOf(column.index()) !== -1) {
                                sum = interimData.TotalCompletionRatio;
                                htmlString += formatNumber(sum) + '%';
                            }
                            htmlString += '</th>';

                        }

                    });
                    $(tfoot).select('tr').html(htmlString);

                },
                columnDefs: [
                    {
                        targets: getColumnIndexesWithClass(displayColumns, 'percent'),
                        defaultContent: 0.00,
                        render: function ( data, type, row ) {
                            return formatNumber(data || 0) + '%';
                        }
                    },
                    {
                        targets: getColumnIndexesWithClass(displayColumns, 'number'),
                        defaultContent: 0.00,
                        render: function ( data, type, row ) {
                            return formatNumber(data || 0);
                        }
                    },
                    {
                        targets: '_all',
                        defaultContent: '',
                    },
                ],
                data: Object.keys(interimData.DetailLineMap).sort().map(key => interimData.DetailLineMap[key]),
                // data: Object.values(interimData.DetailLineMap),
                columns: displayColumns
            })
            table.draw()
        }


        function getColumnIndexesWithClass( columns, className ) {
            var indexes = [];
            $.each( columns, function( index, columnInfo ) {
                if( columnInfo.className && columnInfo.className.split(' ').some(columnClassName => columnClassName === className) ) {
                    indexes.push( index );
                }
            } );

            return indexes;
        }

        function changeIncentivePerBottle(rowIndex, newValue, tableId){
            let lineItem = $(tableId).DataTable().row(rowIndex).data();
            lineItem.ASI_CRM_CN_Incentive_BT__c = newValue;
            lineItem.ASI_CRM_CN_Total_Payable__c = lineItem.ASI_CRM_CN_Incentive_BT__c * lineItem.ASI_CRM_CN_Actual_Vol__c;
            $(tableId).DataTable().row(rowIndex).data(lineItem).draw();
            let applicationPaymentAmount = calculateApplicationPaymentAmount(tableId);
            PSFSettingActualPayment(applicationPaymentAmount, tableId.split('_')[1]);
        }
        function changeRebatePercent(rowIndex, newValue, tableId){
            newValue = newValue || 0;

            let lineItem = $(tableId).DataTable().row(rowIndex).data();
            lineItem.ASI_CRM_CN_Rebate_Percent__c = newValue;
            lineItem.ASI_CRM_CN_Total_Payable__c = lineItem.ASI_CRM_CTD_Actual_Purchase_Value__c * lineItem.ASI_CRM_CN_Rebate_Percent__c / 100;
            $(tableId).DataTable().row(rowIndex).data(lineItem).draw();
            let applicationPaymentAmount = calculateApplicationPaymentAmount(tableId);
            PSFSettingActualPayment(applicationPaymentAmount, tableId.split('_')[1]);
        }
        function changeTargetOrRebate(rowIndex, newValue, change, tableId){
            newValue = newValue || 0;
            let lineItem = $(tableId).DataTable().row(rowIndex).data();

            if(change === 'target'){
                lineItem.ASI_CRM_CN_Target__c = newValue;
            }
            if(change === 'rebate'){
                lineItem.ASI_CRM_CN_Rebate__c = newValue;
            }
            if (!lineItem.ASI_CRM_CN_Target__c || !lineItem.ASI_CRM_CN_Rebate__c) {
                lineItem.ASI_CRM_CN_Total_Payable__c = 0;
            } else {
                lineItem.ASI_CRM_CN_Total_Payable__c = parseInt(lineItem.ASI_CRM_CTD_Actual_Purchase_Value__c / lineItem.ASI_CRM_CN_Target__c) * lineItem.ASI_CRM_CN_Rebate__c;
            }
            $(tableId).DataTable().row(rowIndex).data(lineItem).draw();
            let applicationPaymentAmount = calculateApplicationPaymentAmount(tableId);
            PSFSettingActualPayment(applicationPaymentAmount, tableId.split('_')[1]);
        }

        function calculateApplicationPaymentAmount(tableId) {
            let moduleId = tableId.split('_')[1];
            let sum = $(tableId).DataTable().data().reduce(function (initialValue, data) {
                return initialValue + (parseFloat(data.ASI_CRM_CN_Total_Payable__c) || 0);
            }, 0);

            sum = sum - PSF_Item_MapJSON[moduleId].Module.ASI_CRM_Historical_Paid_Amount__c;
            $('#PSFApplicationPaymentAmount_' + moduleId).text(formatNumber(sum));

             return sum;
        }






        //Setting Actual Payment
        function  PSFSettingActualPayment(ApplicationPaymentAmount,ModuleId){
            var HistoricalPaidAmount = StringToNumberStr($('#PSFHistoricalPaidAmount_'+ModuleId)[0].childNodes[0].textContent);
            $('.PSFAdjustment_'+ModuleId)[0].textContent='100.00%';
            $('#PSFActualPayment_'+ModuleId)[0].childNodes[0].value= formatNumber(ApplicationPaymentAmount);

            //var ActualPayment= ApplicationPaymentAmount*Number($('.PSFAdjustment_'+ModuleId)[0].value)/100;
            //$('#PSFActualPayment_'+ModuleId)[0].childNodes[0].textContent= formatNumber(ActualPayment.toFixed(2));
        }





        function updateLinesBeforeApex(){
            for(let key in PSF_Item_MapJSON){
                console.log('#PSF_'+key)
                // let newMap = {};
                let linesFromDataTable = $('#PSF_'+key).DataTable().data();

                // To preserve the order after refresh from BE
                Object.keys( PSF_Item_MapJSON[key].DetailLineMap).sort().forEach(function (sortedKey, index) {
                    PSF_Item_MapJSON[key].DetailLineMap[sortedKey] =  linesFromDataTable[index]
                })
            }
        }

        function saveRecord(isQuickSave) {
            updateLinesBeforeApex();

            saveRecordApex(isQuickSave, JSON.stringify(PSF_Item_MapJSON));
        }

    </script>

    <apex:form id="EditHeavyPaymentDetailPageId" >
        <div class="bs ">

            <div class="container-fluid" >
                <div style="display: grid; grid-template-columns: 20% 80% ; grid-template-rows: auto;" >
                    <div style="grid-column-start: 1; grid-column-end: 1;" >
                        <div style="font-weight: bold; font-family: Arial,Helvetica,sans-serif; color: #000; font-size: 1.3em; margin: 0.5em;">
                            {!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Label}
                        </div>
                    </div>

                    <div style="grid-column-start: 2; grid-column-end: 2;  margin-top: 0.5em;" >
                        <apex:outputPanel layout="block" rendered="{!isView}">
                            <apex:commandButton value="{!$Label.ASI_HK_CRM_VF_COMMON_BTN_Edit}" styleClass="BSCommandButton" action="{!GoEditHeader}" rendered="{!PH.ASI_TH_CRM_Status__c == 'Draft'}"/>
                            <apex:commandButton value="{!$Label.ASI_CRM_CN_VF_BTN_Form_Preview}" styleClass="BSCommandButton" onClick="window.open('/apex/ASI_CRM_CN_OffPaymentRequestForm?id={!PH.id}&pdf=1');"/>

                            <apex:commandButton value="{!$Label.ASI_CRM_CN_VF_BTN_Submit_Approval}" styleClass="BSCommandButton"
                                                action="{!GoToCheckPoint}" reRender="pageMessage" status="ActionStatus"
                                                oncomplete="return false;"
                                                rendered="{!PH.ASI_TH_CRM_Status__c == 'Draft'}"/>

                            <apex:commandButton styleClass="BSCommandButton" value="{!$Label.ASI_CRM_CN_View} {!$Label.ASI_CRM_CN_Check_Point}"
                                                onclick="window.location.href='/apex/ASI_CRM_CN_OffPaymentCheckPage?id={!PH.Id}&Type=ViewCheckPoint'"
                                                oncomplete="return false;"
                                                rendered="{!PH.ASI_TH_CRM_Status__c != 'Draft'  }"/>


                            <apex:commandButton value="{!$Label.ASI_CRM_CN_CTD_Sales_Report}" styleClass="BSCommandButton"
                                                onclick="window.open('/apex/ASI_CRM_CN_OffContractVolumeReportPage?id={!PH.ASI_TH_CRM_Contract__c}')"/>

                            <apex:commandButton value="{!$Label.ASI_CRM_CN_VF_BTN_Payment_Instruction}" styleClass="BSCommandButton"
                                                rendered="{!PH.ASI_TH_CRM_Status__c=='Paid'}"
                                                onClick="window.open('/apex/ASI_CRM_CN_HeavyPaymentSlipPage?id={!PH.id}&PTSelected=Instruction');"/>
                            <apex:commandButton value="{!$Label.ASI_CRM_CN_VF_BTN_Payment_Receipt}" styleClass="BSCommandButton"
                                                onClick="window.open('/apex/ASI_CRM_CN_HeavyPaymentSlipPage?id={!PH.id}&PTSelected=Receipt');"
                                                rendered="{!PH.ASI_TH_CRM_Status__c=='Paid'}"/>
                            <apex:commandButton value="{!$Label.ASI_CRM_CN_Auto_PO_Modification}" styleClass="BSCommandButton"
                                                action="{!AutoPOModification}" status="ActionStatus" reRender="pageMessage"
                                                rendered="{!PH.ASI_TH_CRM_Status__c=='Paid' && PH.ASI_CRM_CN_Last_Payment__c && !PH.ASI_CRM_Auto_PO_Modification__c}"/>

                            <apex:commandButton value="{!$Label.ASI_CRM_CN_Contract_Return}"
                                                styleClass="BSCommandButton"
                                                action="{!GoReturn}" rendered="{!showReturn}" reRender="pageMessage"/>

                            <!--20191108:AM@Introv START-->
                            <apex:commandButton value="Tax Calculation" action="{!reDirectToTaxSavingPage}" rendered="{!PH.ASI_TH_CRM_Status__c == 'Paid' || PH.ASI_TH_CRM_Status__c == 'Approved'}" reRender="pageMessage" styleClass="BSCommandButton"/>
                            <!--20191108:AM@Introv END-->
                            
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" rendered="{!isEdit}">
                            <apex:actionFunction name="saveRecordApex" action="{!saveItems}" reRender="EditHeavyPaymentDetailPageId,errorMessage" status="ActionStatus">
                                <apex:param name="isQuickSave" value=""/>
                                <apex:param name="PSF_Item_MapJSON" value=""/>
                            </apex:actionFunction>
                            <input type="button" class="btn BSCommandButton" onclick="saveRecord(false)" value="{!$Label.ASI_CRM_CN_IOM_Save}"/>
                            <input type="button" class="btn BSCommandButton" onclick="saveRecord(true)" value="{!$Label.ASI_CRM_CN_Quick_Save}" />

                            <apex:commandButton styleClass="BSCommandButton"  value="{!$Label.ASI_CRM_CN_IOM_Cancel}"
                                                action="{!CancelProcess}" />
                            <apex:commandButton value="{!$Label.ASI_CRM_CN_Volume_Report}" styleClass="BSCommandButton"
                                                onclick="window.open('/apex/ASI_CRM_CN_OffContractVolumeReportPage?id={!PH.ASI_TH_CRM_Contract__c}')" />
                            <apex:commandButton styleClass="BSCommandButton"  value="{!$Label.ASI_CRM_CN_Quick_to_Display}"
                                                onclick="QuickGoTo('DisplayItemMapDivIdPart');" oncomplete="return false;"  rendered="{!!ContractSelected.ASI_CRM_CN_Is_Dolphin__c}"/>
                            <apex:commandButton styleClass="BSCommandButton"  value="{!$Label.ASI_CRM_CN_Quick_to_Other_Cost}"
                                                onclick="QuickGoTo('PaymentFixCostDivIdPart');" oncomplete="return false;"/>
                        </apex:outputPanel>
                    </div>
                </div>

                <apex:messages id="errorMessage"/>

                <apex:outputPanel layout="block" id="pageMessage">
                <div class="alert alert-danger fade in" style="{!IF(UpsertPermission,'display:none;','')}"  id="SaveFailPart">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    <strong>Oops, we meet following error:</strong><br/>
                    <apex:outputText escape="false" value="{!msg}"/>
                </div>
                </apex:outputPanel>

                <!--Header Info-->
                <div class="row  ">
                    <div class="panel panel-primary">
                        <div class="panel-heading" style="font-weight: bold">
                            {!$Label.ASI_CRM_CN_VF_LABEL_Header_Info}
                        </div>
                        <div class="panel-body" style="padding: 0.5em">

                            <table class="table table-condensed module-table">
                                <tr>
                                    <td style="width: 20% ">
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.Name.Label}"/>
                                    </td>
                                    <td style="width: 25% ">
                                        <apex:outputField value="{!PH.name}"/>
                                    </td>
                                    <td style="width: 15% ">
                                        <apex:outputText value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Payment_Raised_Date__c.Label}"/>
                                    </td>
                                    <td style="width: 40% ">
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Payment_Raised_Date__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_PO_No__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputLink value="ASI_CRM_CN_ViewContractOffPage?id={!PH.ASI_TH_CRM_Contract__c}">{!PH.ASI_CRM_CN_PO_No__c}</apex:outputLink>
                                    </td>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_PO_Start_Date__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_PO_Start_Date__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_OutletWS__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_OutletWS__c}" id="outlet_ws"/>
                                    </td>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_PO_End_Date__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_PO_End_Date__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Promotion_Type__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Promotion_Type__c}"/>
                                    </td>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_TH_CRM_Status__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_TH_CRM_Status__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Last_Payment__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Last_Payment__c}"/>
                                    </td>
                                    <td>{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Payment_Type__c.Label}</td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Payment_Type__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Last_Year_Payment__c.Label}</td>
                                    <td colspan="3">
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Last_Year_Payment__c}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        {!$Label.ASI_CRM_CN_Payment_Description}
                                    </td>
                                    <td colspan="3">
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Description__c}"/>
                                    </td>
                                </tr>

                                <tr style=" {!IF(PH.ASI_TH_CRM_Contract__r.ASI_CRM_CN_Outlet_WS__r.RecordType.DeveloperName == 'ASI_CRM_CN_WS','','display:none;')}  ">
                                    <td>
                                        {!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_Volume_Option__c.Label}
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_Volume_Option__c}" id="paymenttype"/>
                                    </td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_TH_CRM_GL_Date__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_TH_CRM_GL_Date__c}"/>
                                    </td>
                                    <td>
                                        <apex:outputLabel value="{!$ObjectType.ASI_TH_CRM_PaymentRequest__c.Fields.ASI_CRM_CN_Invoice_Date__c.Label}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!PH.ASI_CRM_CN_Invoice_Date__c}"/>
                                    </td>
                                </tr>

                            </table>
                        </div>
                    </div>


                </div>

                <!-- Buttons to edit page-->
                <div class="row">
                    <div class="col-md-offset-4">
                        <apex:commandButton styleClass="BSCommandButton"
                                            rendered="{!PH.ASI_TH_CRM_Status__c == 'Draft' && isView}"
                                            value="{!$Label.ASI_CRM_CN_VF_BTN_Payee_Detail}"
                                            action="{!GoEditDetailPage}"/>
                        <apex:commandButton styleClass="BSCommandButton"
                                            rendered="{!PH.ASI_TH_CRM_Status__c == 'Draft' && isView}"
                                            value="{!$Label.ASI_CRM_CN_VF_BTN_Payee_Info}" action="{!GoEditPayee}"/>
                    </div>
                </div>

                <!-- Payment Summmary-->
                <div class="row" style="{!IF(isView, '', 'display:none')}">
                    <div class="PanelHeader">{!$Label.ASI_CRM_CN_Payment_Summary}</div>
                    <div class="PanelBody">
                        <apex:outputPanel id="PaymentSummaryPanel">
                            <table class="bs table table-condensed" style=" margin-bottom: 0;" id="PaymentSummaryDataTable">
                                <thead>
                                <tr>
                                    <th>{!$Label.ASI_CRM_CN_Payment_Summary}</th>
                                    <th>{!$Label.ASI_CRM_CN_PO_Estimated_Amount}</th>
                                    <th>{!$Label.ASI_CRM_CN_PO_Remaining_Amount}</th>
                                    <th>{!$Label.ASI_CRM_CN_Payment_Request_Amount}</th>
                                </tr>
                                </thead>
                                <apex:variable value="{!0}" var="POEstimatedAmountTotal"/>
                                <apex:variable value="{!0}" var="PORemainingAmountTotal"/>
                                <apex:variable value="{!0}" var="PaymentRequestAmountTotal"/>
                                <tbody>
                                <apex:repeat value="{!PaymentSummaryList}" var="PaymentSummary" id="PaymentSummaryListItem">
                                    <apex:variable var="POEstimatedAmountTotal" value="{!POEstimatedAmountTotal+PaymentSummary.POEstimatedAmount}"/>
                                    <apex:variable var="PORemainingAmountTotal" value="{!PORemainingAmountTotal+PaymentSummary.POEstimatedAmount - PaymentSummary.PaidAmount}"/>
                                    <apex:variable var="PaymentRequestAmountTotal" value="{!PaymentRequestAmountTotal+PaymentSummary.PaymentRequestAmount}"/>
                                    <tr>
                                        <td class="BorderBottom">
                                            {!PaymentSummary.Name}
                                        </td>
                                        <td class="BorderBottom">
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                <apex:param value="{!PaymentSummary.POEstimatedAmount}"/>
                                            </apex:outputText>
                                        </td>
                                        <td class="BorderBottom">
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                <apex:param value="{!PaymentSummary.POEstimatedAmount - PaymentSummary.PaidAmount}"/>
                                            </apex:outputText>
                                        </td>
                                        <td class="BorderBottom">
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                <apex:param value="{!PaymentSummary.PaymentRequestAmount}"/>
                                            </apex:outputText>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                <tr class="FontWeightCSS" style="background-color: #e3e3d7;">
                                    <td> {!$Label.ASI_CRM_CN_Total_Amount}
                                    </td>
                                    <td>
                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                            <apex:param value="{!POEstimatedAmountTotal}"/>
                                        </apex:outputText>
                                    </td>
                                    <td>
                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                            <apex:param value="{!PORemainingAmountTotal}"/>
                                        </apex:outputText>
                                    </td>
                                    <td>
                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                            <apex:param value="{!PaymentRequestAmountTotal}"/>
                                        </apex:outputText>
                                    </td>

                                </tr>
                                </tbody>

                            </table>
                        </apex:outputPanel>
                    </div>

                </div>


                <!-----------------------------------------------PSF-------------------------------------------------------------->


                <apex:actionFunction name="ChangingPSFDate" action="{!GeneratePSFVol}" rerender="PSFPanel,dataFactory,pageMessage,OtherPaymentDetailPanel" status="ActionStatus">
                    <apex:param name="PARAMID" value=""/>
                    <apex:param name="PSF_Item_MapJSON" value=""/>
                </apex:actionFunction>


                <div class="row">
                    <apex:outputPanel id="PSFPanel">
                        <div class="PanelHeader">{!$Label.ASI_CRM_CN_PSF}</div>
                        <div class="PanelBody">
                            <apex:variable value="{!0}" var="i"/>
                            <apex:repeat value="{!PSF_Item_Map}" var="itm" id="PSFitem">
                                <apex:variable var="i" value="{!i+1}"/>

                                <div class="panel panel-primary">
                                    <div class="panel-heading">{!$Label.ASI_CRM_CN_Module} {!i}</div>

                                    <div class="panel-body">

                                        <table class="bs table table-condensed module-header-table">
                                            <tr>
                                                <td>{!$Label.ASI_CRM_CN_Start_Date}</td>
                                                <td>
                                                    <apex:outputField value="{!PH.ASI_CRM_CN_PO_Start_Date__c}"/>
                                                </td>
                                                <td>{!$Label.ASI_CRM_CN_End_Date}</td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_End_Date__c}" rendered="{!isView || (isEdit && i==1 && ContractSelected.ASI_CRM_CN_Is_Dolphin__c)}"/>
                                                    <apex:inputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_End_Date__c}" styleClass="ApexInputDateField" onchange="ChangingPSFEndDate('{!itm}');"  rendered="{!isEdit &&(!ContractSelected.ASI_CRM_CN_Is_Dolphin__c ||(ContractSelected.ASI_CRM_CN_Is_Dolphin__c && i>1)) }"/>
                                                </td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Methodology__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.Name}" rendered="{!!showCN}"/>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.ASI_CRM_Chinese_Name__c} " rendered="{!showCN}"/>
                                                </td>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Volume_Base__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Parent_Module__r.ASI_CRM_Volume_Base__c}"/>
                                                </td>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Unit__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Parent_Module__r.ASI_CRM_Unit__c}"/>
                                                </td>
                                            </tr>

                                            <tr style="{!IF(PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.Name == 'Reach X get Y', 'display:none;', '')}">
                                                <td>
                                                    <apex:outputText value="{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_CN_Minimal_Achievement__c.Label}"/>
                                                </td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_CN_Minimal_Achievement__c}"/>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_CN_CTD_Minimal_Achievement__c.Label}"/>
                                                </td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_CN_CTD_Minimal_Achievement__c}"/>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_CN_Is_Capped__c.Label}" rendered="{!PSF_Item_Map[itm].Module.ASI_CRM_CN_Criteria__c == 'By Ladder'}"/>
                                                </td>
                                                <td>
                                                    <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_CN_Is_Capped__c}" rendered="{!PSF_Item_Map[itm].Module.ASI_CRM_CN_Criteria__c == 'By Ladder'}"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="1">
                                                    {!$Label.ASI_CRM_CN_Contract_Terms_Ref}
                                                </td>
                                                <td colspan="5">
                                                    <apex:outputText escape="false" value="{!PSF_Item_Map[itm].Module.ASI_CRM_Parent_Module__r.ASI_CRM_Payment_Reference__c}"/>
                                                </td>
                                            </tr>
                                            <tr style="{!IF(PSF_Item_Map[itm].Module.ASI_CRM_CN_Criteria__c == 'By Tax' || PSF_Item_Map[itm].Module.ASI_CRM_CN_Criteria__c == 'By Ladder', '', 'display:none;')}">
                                                <!-- <td>Value Target</td> -->
                                                <td>{!$Label.ASI_CRM_CN_Value_Target}</td>
                                                <td>
                                                    <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                        <apex:param value="{!PSF_Item_Map[itm].ValueTarget}"/>
                                                    </apex:outputText>
                                                </td>
                                                <!-- <td>{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CTD_Actual_Purchase_Value__c.Label}</td> -->
                                                <td>{!$Label.ASI_CRM_CN_CTD_Actual_PurchaseValue}</td>
                                                <td colspan="3">
                                                    <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                        <apex:param value="{!PSF_Item_Map[itm].CTDPurchaseValue}"/>
                                                    </apex:outputText>
                                                </td>
                                            </tr>
                                        </table>

                                        <apex:outputPanel rendered="{!isEdit &&(!ContractSelected.ASI_CRM_CN_Is_Dolphin__c ||(ContractSelected.ASI_CRM_CN_Is_Dolphin__c && i>1)) }">
                                            <div class="bs text-center">
                                                <apex:commandButton styleClass="BSCommandButton" value="{!$Label.ASI_CRM_CN_VF_BTN_Regen_Vol}"
                                                                    onclick="ChangingPSFEndDate('{!itm}');" onComplete="return null;" rendered="{!isEdit}"/>
                                                <apex:commandButton styleClass="BSCommandButton"
                                                                    value="{!$Label.ASI_CRM_CN_Reset}"
                                                                    action="{!resetModule}"
                                                                    oncomplete="Rerender();"
                                                                    rerender="PSFPanel,dataFactory" status="ActionStatus"  rendered="{!isEdit}">
                                                    <apex:param name="PARAMID" value="{!itm}"/>
                                                </apex:commandButton>
                                            </div>
                                        </apex:outputPanel>

                                        <table id="PSF_{!itm}" class="bs table table-condensed data-table" style="{!IF(PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.Name == 'Others', 'display:none', '')}">
                                            <tfoot>
                                            <tr></tr>
                                            </tfoot>
                                        </table>

                                        <apex:dataTable value="{!PSF_Item_Map[itm].DetailLineMap}" var="line" styleClass="bs table table-condensed" rendered="{!PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.Name == 'Others'}">
                                            <apex:column >
                                                <apex:facet name="header">{!$Label.ASI_CRM_CN_Contract_Total_Amount}</apex:facet>
                                                <apex:outputField value="{!PSF_Item_Map[itm].DetailLineMap[line].ASI_CRM_V0_0_Full_Contract_Target__c}"/>
                                            </apex:column>
                                            <apex:column >
                                                <apex:facet name="header">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Historical_Paid_Amount__c.Label}</apex:facet>
                                                <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Historical_Paid_Amount__c}"/>
                                            </apex:column>
                                            <apex:column >
                                                <apex:facet name="header">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Actual_Payment__c.Label}</apex:facet>
                                                <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Actual_Payment__c}" rendered="{!isView}"/>
                                                <apex:inputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Actual_Payment__c}"
                                                                 styleClass="ApexInputNumberField" rendered="{!isEdit}"/>
                                            </apex:column>
                                            <apex:column >
                                                <apex:facet name="header">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Overpayment_Reason__c.Label}</apex:facet>
                                                <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_PSF_Overpayment_Reason__c}" rendered="{!isView}"/>
                                                <apex:selectList value="{!PSF_Item_Map[itm].Module.ASI_CRM_PSF_Overpayment_Reason__c}" styleClass="ApexPickListField" multiSelect="false" size="1" rendered="{!isEdit}">
                                                    <apex:selectOptions value="{!PSFOverpaymentReasons}"/>
                                                </apex:selectList>
                                            </apex:column>
                                            <apex:column >
                                                <apex:facet name="header">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Other_Comments__c.Label}</apex:facet>
                                                <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Other_Comments__c}" rendered="{!isView}"/>
                                                <apex:inputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Other_Comments__c}" rendered="{!isEdit}"/>
                                            </apex:column>
                                        </apex:dataTable>

                                        <apex:outputPanel rendered="{!PSF_Item_Map[itm].Module.ASI_CRM_Methodology__r.Name != 'Others'}">
                                            <table class="bs table table-condensed" style="margin-bottom: 0; width:70%;">
                                                <tr>
                                                    <td style="border-left: 1px solid #ddd; " class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Historical_Paid_Amount__c.Label}
                                                    </td>
                                                    <td id="{!'PSFHistoricalPaidAmount_'+itm}">
                                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                            <apex:param value="{!PSF_Item_Map[itm].Module.ASI_CRM_Historical_Paid_Amount__c}"/>
                                                        </apex:outputText>
                                                    </td>
                                                    <td style="border-left: 1px solid #ddd; " class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Application_Payment_Amount__c.Label}
                                                    </td>
                                                    <td style="border-right: 1px solid #ddd; " id="{!'PSFApplicationPaymentAmount_'+itm}">
                                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                            <apex:param value="{!PSF_Item_Map[itm].Module.ASI_CRM_Application_Payment_Amount__c}"/>
                                                        </apex:outputText>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style=" border-left: 1px solid #ddd; " class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Adjustment__c.Label}
                                                    </td>
                                                    <td>
                                                        <apex:outputText value="{0,number,#,###,##0.00}%" styleClass="{!'PSFAdjustment_'+itm}">
                                                            <apex:param value="{!PSF_Item_Map[itm].Module.ASI_CRM_Adjustment__c}"/>
                                                        </apex:outputText>
                                                    </td>
                                                    <td style=" border-left: 1px solid #ddd; " class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Actual_Payment__c.Label}
                                                    </td>
                                                    <td style=" border-right: 1px solid #ddd; " id="{!'PSFActualPayment_'+itm}">
                                                        <apex:outputText value="{0, number, ###,###,###,###,##0.00}" rendered="{!isView || (isEdit && i==1 && ContractSelected.ASI_CRM_CN_Is_Dolphin__c)}">
                                                            <apex:param value="{!PSF_Item_Map[itm].Module.ASI_CRM_Actual_Payment__c}"/>
                                                        </apex:outputText>
                                                        <apex:inputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Actual_Payment__c}" rendered="{!isEdit && (!ContractSelected.ASI_CRM_CN_Is_Dolphin__c ||(ContractSelected.ASI_CRM_CN_Is_Dolphin__c && i>1))}"
                                                                         onchange="SetAdjustmentPercent('{!'PSFHistoricalPaidAmount_'+itm}','{!'PSFApplicationPaymentAmount_'+itm}','{!'PSFActualPayment_'+itm}','{!'PSFAdjustment_'+itm}');"
                                                                         styleClass="ApexInputNumberField"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style=" border-left: 1px solid #ddd;  border-bottom: 1px solid #ddd;" class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Overpayment_Reason__c.Label}
                                                    </td>
                                                    <td style=" border-bottom: 1px solid #ddd;">
                                                        <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_PSF_Overpayment_Reason__c}" rendered="{!isView || (isEdit && i==1 && ContractSelected.ASI_CRM_CN_Is_Dolphin__c)}"/>
                                                        <apex:selectList value="{!PSF_Item_Map[itm].Module.ASI_CRM_PSF_Overpayment_Reason__c}" styleClass="ApexPickListField" multiSelect="false" size="1" rendered="{!isEdit && (!ContractSelected.ASI_CRM_CN_Is_Dolphin__c ||(ContractSelected.ASI_CRM_CN_Is_Dolphin__c && i>1))}">
                                                            <apex:selectOptions value="{!PSFOverpaymentReasons}"/>
                                                        </apex:selectList>
                                                    </td>
                                                    <td style=" border-left: 1px solid #ddd; border-bottom: 1px solid #ddd;" class="MethodologyLabel">
                                                        {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Other_Comments__c.Label}
                                                    </td>
                                                    <td style=" border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
                                                        <apex:outputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Other_Comments__c}" rendered="{!isView || (isEdit && i==1 && ContractSelected.ASI_CRM_CN_Is_Dolphin__c)}"/>
                                                        <apex:inputField value="{!PSF_Item_Map[itm].Module.ASI_CRM_Other_Comments__c}" rendered="{!isEdit && (!ContractSelected.ASI_CRM_CN_Is_Dolphin__c ||(ContractSelected.ASI_CRM_CN_Is_Dolphin__c && i>1))}"/>
                                                    </td>
                                                </tr>
                                            </table>

                                        </apex:outputPanel>



                                    </div>
                                </div>
                            </apex:repeat>
                        </div>

                        <script>
                            for (let key in PSF_Item_MapJSON) {
                                let tableId = '#PSF_'+ key;
                                drawPSFTable(tableId);
                            }

                        </script>

                    </apex:outputPanel>


                </div>


                <apex:outputPanel rendered="{!DisplayVEC}">

                    <apex:actionFunction name="ChangingVECDate" action="{!GenerateVECVol}" rerender="VECPanel,EditHeavyPaymentDetailPageId"  status="ActionStatus">
                        <apex:param name="PARAMID" value="" />
                    </apex:actionFunction>

                    <!--------------------------------Display Listing -------------------------------------------------------------->

                    <div class="row"  id="DisplayItemMapDivIdPart">

                        <div class="PanelHeader">{!$Label.ASI_CRM_CN_Display}</div>
                        <div class="PanelBody" >
                            <apex:variable var="i" value="{!0}"/>
                            <apex:repeat value="{!DisplayItemMap}" var="moduleId" id="DisplayItem">
                                <apex:variable var="i" value="{!i+1}"/>
                                <apex:variable var="interimData" value="{!DisplayItemMap[moduleId]}"/>

                                <div class="panel panel-primary">
                                    <div class="panel-heading">{!$Label.ASI_CRM_CN_Module} {!i}</div>
                                    <div class="panel-body">
                                        <table class="bs table table-condensed module-table module-header-table">
                                            <tr>
                                                <td>{!$Label.ASI_CRM_CN_Start_Date}</td>
                                                <td>
                                                    <apex:outputField value="{!PH.ASI_CRM_CN_PO_Start_Date__c}"/>
                                                </td>
                                                <td>{!$Label.ASI_CRM_CN_End_Date}</td>
                                                <td>
                                                    <apex:outputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_End_Date__c}" rendered="{!isView}"/>
                                                    <apex:inputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_End_Date__c}" styleClass="ApexInputDateField" onchange="ChangingVECEndDate('{!moduleId}');"  rendered="{!isEdit}"/>
                                                </td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Methodology__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_Methodology__r.Name}" rendered="{!!showCN}"/>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_Methodology__r.ASI_CRM_Chinese_Name__c} " rendered="{!showCN}"/>
                                                </td>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Volume_Base__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_Parent_Module__r.ASI_CRM_Volume_Base__c}"/>
                                                </td>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Unit__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_Parent_Module__r.ASI_CRM_Unit__c}"/>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_CN_Minimal_Achievement__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_CN_Minimal_Achievement__c}"/>
                                                </td>
                                                <td>{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_CN_CTD_Minimal_Achievement__c.Label}</td>
                                                <td>
                                                    <apex:outputField value="{!interimData.Module.ASI_CRM_CN_CTD_Minimal_Achievement__c}"/>
                                                </td>
                                                <td></td>
                                                <td></td>

                                            </tr>
                                            <tr>
                                                <td colspan="1">
                                                    {!$Label.ASI_CRM_CN_Contract_Terms_Ref}
                                                </td>
                                                <td colspan="5">
                                                    <apex:outputText escape="false" value="{!interimData.Module.ASI_CRM_Parent_Module__r.ASI_CRM_Payment_Reference__c}"/>
                                                </td>
                                            </tr>
                                        </table>

                                        <apex:outputPanel rendered="{!isEdit}">
                                            <div class="bs text-center">
                                                <apex:commandButton styleClass="BSCommandButton" value="{!$Label.ASI_CRM_CN_VF_BTN_Regen_Vol}"
                                                                    onclick="ChangingVECEndDate('{!moduleId}');" onComplete="return null;"/>
                                                <apex:commandButton styleClass="BSCommandButton"
                                                                    value="{!$Label.ASI_CRM_CN_Reset}"
                                                                    action="{!resetModule}"
                                                                    oncomplete="Rerender();"
                                                                    rerender="VECPanel,EditHeavyPaymentDetailPageId" status="ActionStatus">
                                                    <apex:param name="PARAMID" value="{!moduleId}"/>
                                                </apex:commandButton>
                                            </div>
                                        </apex:outputPanel>


                                        <apex:outputPanel id="VECPanel">

                                            <table class="bs table table-condensed" id="VECDataTable"  >
                                                <thead>
                                                <tr>
                                                    <th></th>
                                                    <th><apex:outputText value="{!$Label.ASI_CRM_CN_Contract_Total_Amount}" /></th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Historical_Paid_Amount__c.Label}</th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Actual_Payment__c.Label}</th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Overpayment_Reason__c.Label}</th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Other_Comments__c.Label}</th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}"><apex:outputText value="{!$Label.ASI_CRM_CN_Contract_Volume_Target}" /></th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}"><apex:outputText value="{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CTD_Actual_Vol__c.Label}" /></th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}"><apex:outputText value="{!$Label.ASI_CRM_CN_Actual_Achievement}" /></th>
                                                    <th style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}"><apex:outputText value="{!$Label.ASI_CRM_CN_CTD_Payable_Amount}" escape="false"/></th>
                                                </tr>
                                                </thead>
                                                <tbody>

                                                <apex:repeat value="{!interimData.DetailLineMap}"  var="itm" id="VECitem" >
                                                    <apex:variable var="line" value="{!interimData.DetailLineMap[itm]}"/>
                                                    <tr>
                                                        <td>
                                                            {!$Label.ASI_CRM_CN_By_Total}
                                                        </td>
                                                        <td>
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!line.ASI_CRM_V0_0_Full_Contract_Target__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!interimData.Module.ASI_CRM_Historical_Paid_Amount__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">
                                                            <apex:outputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Actual_Payment__c}" rendered="{!isView}"/>
                                                            <apex:inputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Actual_Payment__c}"
                                                                             onchange="SetAdjustmentPercent('VECHistoricalPaidAmount_{!moduleId}','VECApplicationPaymentAmount_{!moduleId}','VECActualPayment_{!moduleId}','VECAdjustment_{!moduleId}');"
                                                                             styleClass="ApexInputNumberField" rendered="{!isEdit && DisplayItemMap[moduleId].Module.ASI_CRM_Methodology__r.Name == 'Others'}"/>
                                                        </td>
                                                        <td>
                                                            <apex:outputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_VEC_Overpayment_Reason__c}" rendered="{!isView}"/>
                                                            <apex:selectList value="{!DisplayItemMap[moduleId].Module.ASI_CRM_VEC_Overpayment_Reason__c}" styleClass="ApexPickListField" multiSelect="false" size="1" rendered="{!isEdit}">
                                                                <apex:selectOptions value="{!DisplayOverpaymentReasons}"/>
                                                            </apex:selectList>

                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','','display:none')}">
                                                            <apex:outputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Other_Comments__c}" rendered="{!isView}"/>
                                                            <apex:inputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Other_Comments__c}" rendered="{!isEdit && DisplayItemMap[moduleId].Module.ASI_CRM_Methodology__r.Name == 'Others'}"/>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}">
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!IF(DisplayItemMap[moduleId].Module.ASI_CRM_Created_PO_Version__c == '0.0',line.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Contract_Total_QTY_CR12_Eqv__c,line.ASI_CRM_CN_Contract_BRSF_Line_Item__r.ASI_CRM_Est_Total_QTY_CR12_Eqv__c)}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}">
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!line.ASI_CRM_CTD_Actual_Vol__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}">
                                                            <apex:outputText value="{0,number,#,###,##0.00}%">
                                                                <apex:param value="{!line.ASI_CRM_CN_Completion_Rate__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td style="{!IF(interimData.Module.ASI_CRM_Methodology__r.Name == 'Others','display:none','')}">
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!line.ASI_CRM_CN_Total_Payable__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                </apex:repeat>

                                                </tbody>

                                            </table>


                                            <apex:outputPanel rendered="{!DisplayItemMap[moduleId].Module.ASI_CRM_Methodology__r.Name != 'Others'}">
                                                <table class="bs table table-condensed" style="margin-bottom: 0; width:60%;" >
                                                    <tr>
                                                        <td style="border-left: 1px solid #ddd; "   class="MethodologyLabel">
                                                            {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Historical_Paid_Amount__c.Label}
                                                        </td>
                                                        <td id="VECHistoricalPaidAmount_{!moduleId}">
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!interimData.Module.ASI_CRM_Historical_Paid_Amount__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                        <td  style="border-left: 1px solid #ddd; "  class="MethodologyLabel" >
                                                            {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Application_Payment_Amount__c.Label}
                                                        </td>
                                                        <td style="border-right: 1px solid #ddd; " id="VECApplicationPaymentAmount_{!moduleId}" >
                                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}">
                                                                <apex:param value="{!interimData.Module.ASI_CRM_Application_Payment_Amount__c}"/>
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style=" border-left: 1px solid #ddd; " class="MethodologyLabel"  >{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Adjustment__c.Label}</td>
                                                        <td>
                                                            <apex:outputText value="{0,number,#,###,##0.00}%" styleClass="VECAdjustment_{!moduleId}">
                                                                <apex:param value="{!interimData.Module.ASI_CRM_Adjustment__c}" />
                                                            </apex:outputText>

                                                        </td>
                                                        <td style=" border-left: 1px solid #ddd; " class="MethodologyLabel"  >{!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Actual_Payment__c.Label}</td>
                                                        <td style=" border-right: 1px solid #ddd; "  id="VECActualPayment_{!moduleId}" >
                                                            <apex:outputText value="{0,number,#,###,##0.00}" rendered="{!isView}">
                                                                <apex:param value="{!interimData.Module.ASI_CRM_Actual_Payment__c}" />
                                                            </apex:outputText>
                                                            <apex:inputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Actual_Payment__c}"
                                                                             onchange="SetAdjustmentPercent('VECHistoricalPaidAmount_{!moduleId}','VECApplicationPaymentAmount_{!moduleId}','VECActualPayment_{!moduleId}','VECAdjustment_{!moduleId}');"
                                                                             styleClass="ApexInputNumberField" rendered="{!isEdit}"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style=" border-left: 1px solid #ddd;  border-bottom: 1px solid #ddd;"  class="MethodologyLabel" >
                                                            {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Overpayment_Reason__c.Label}
                                                        </td>
                                                        <td style=" border-bottom: 1px solid #ddd;"  >
                                                            <apex:outputField value="{!interimData.Module.ASI_CRM_VEC_Overpayment_Reason__c}" rendered="{!isView}"/>
                                                            <apex:selectList value="{!DisplayItemMap[moduleId].Module.ASI_CRM_VEC_Overpayment_Reason__c}" styleClass="ApexPickListField" multiSelect="false" size="1" rendered="{!isEdit}">
                                                                <apex:selectOptions value="{!DisplayOverpaymentReasons}"/>
                                                            </apex:selectList>
                                                        </td>
                                                        <td style=" border-left: 1px solid #ddd; border-bottom: 1px solid #ddd;" class="MethodologyLabel"  >
                                                            {!$ObjectType.ASI_CRM_Module__c.Fields.ASI_CRM_Other_Comments__c.Label}
                                                        </td>
                                                        <td style=" border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;"  >
                                                            <apex:outputField value="{!interimData.Module.ASI_CRM_Other_Comments__c}" rendered="{!isView}"/>
                                                            <apex:inputField value="{!DisplayItemMap[moduleId].Module.ASI_CRM_Other_Comments__c}" rendered="{!isEdit}"/>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </apex:outputPanel>

                                        </apex:outputPanel>

                                    </div>
                                </div>
                            </apex:repeat>
                        </div>

                    </div>

                </apex:outputPanel>

                <!-------------------------------- Other Cost -------------------------------------------------->

                <div class="row" id="PaymentFixCostDivIdPart">

                    <div class="PanelHeader">{!$Label.ASI_CRM_CN_Other_Cost}</div>
                    <div class="PanelBody" >

                        <apex:outputPanel id="OtherPaymentDetailPanel">
                            <table class="bs table table-condensed" style="margin-bottom: 0;" id="OtherPaymentDetailDataTable"  >
                                <thead>
                                <tr>
                                    <th>{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CN_Expense_Type__c.Label}</th>
                                    <th>{!$ObjectType.ASI_CRM_Contract_Cost__c.Fields.ASI_CRM_CN_Estimate_Amount__c.Label}</th>
                                    <th  style="{!IF(ContractSelected.ASI_CRM_CN_Is_Dolphin__c,'','display:none;')}">{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CN_Estimate_Amount_Rate__c.Label}</th>
                                    <th>{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_Historical_Paid_Amount__c.Label}</th>
                                    <th style="{!IF(ContractSelected.ASI_CRM_CN_Is_Dolphin__c,'','display:none;')}">{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_Application_Payment_Amount__c.Label}</th>
                                    <th>{!if(ContractSelected.ASI_CRM_CN_Is_Dolphin__c,$Label.ASI_CRM_CN_Actual_Payment_Amount,$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_TH_CRM_Amount__c.Label)}</th>
                                    <th>{!$ObjectType.ASI_TH_CRM_PaymentRequestLineItem__c.Fields.ASI_CRM_CN_Comment__c.Label}</th>
                                </tr>
                                </thead>
                                <tbody>
                                <apex:repeat value="{!OtherPaymentLineList}"  var="OtherPaymentLine" id="OtherPaymentLineTable" >
                                    <tr>

                                        <td>
                                            <apex:outputField value="{!OtherPaymentLine.ASI_CRM_CN_Expense_Type__c}"/>
                                        </td>
                                        <td>
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}"><apex:param value="{!OtherPaymentLine.ASI_CRM_CN_Contract_Cost__r.ASI_CRM_CN_Estimate_Amount__c}"/></apex:outputText>
                                        </td>
                                        <td style="{!IF(ContractSelected.ASI_CRM_CN_Is_Dolphin__c,'','display:none;')}">
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}%">
                                                <apex:param value="{!OtherPaymentLine.ASI_CRM_CN_Contract_Cost__r.ASI_CRM_CN_Estimate_Amount_Rate__c}" />
                                            </apex:outputText>
                                        </td>

                                        <td>
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}"><apex:param value="{!OtherPaymentLine.ASI_CRM_Historical_Paid_Amount__c}"/></apex:outputText>
                                        </td>
                                        <td style="{!IF(ContractSelected.ASI_CRM_CN_Is_Dolphin__c,'','display:none;')}">
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}"><apex:param value="{!OtherPaymentLine.ASI_CRM_Application_Payment_Amount__c}"/></apex:outputText>
                                        </td>

                                        <td>
                                            <apex:outputText value="{0, number, ###,###,###,###,##0.00}" rendered="{!isView}"> 
                                            <apex:param value="{!OtherPaymentLine.ASI_TH_CRM_Amount__c}"/>
                                            </apex:outputText>
                                            <apex:inputField value="{!OtherPaymentLine.ASI_TH_CRM_Amount__c}" styleClass="ApexInputNumberField" rendered="{!isEdit}"/>
                                        </td>
                                        <td>
                                            <apex:outputText value="{!OtherPaymentLine.ASI_CRM_CN_Comment__c}" rendered="{!isView}"/>
                                            <apex:inputField value="{!OtherPaymentLine.ASI_CRM_CN_Comment__c}" styleClass="ApexInputNumberField" rendered="{!isEdit}"/>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                </tbody>

                            </table>
                        </apex:outputPanel>

                    </div>
                </div>

                <!-- Cash -->
                <div class="row  " style="{!IF(cashtype && isView,'padding-top: 1em;','display:none;')}  ">

                    <div class="PanelHeader">{!$Label.ASI_CRM_CN_VF_LABEL_Cash}</div>
                    <div class="PanelBody">

                        <apex:outputPanel id="PayeeCashDetailPanel">
                            <table class="bs table table-condensed" style="margin-bottom: 0;" id="PayeeCashDetailDataTable">
                                <thead>
                                <tr>

                                    <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Cash_Payee_Name_T1__c.Label}</th>
                                    <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Amount__c.Label}</th>
                                    <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Reason__c.Label}</th>
                                    <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Comfirm_Receipt__c.Label}</th>
                                </tr>
                                </thead>
                                <tbody>

                                <apex:repeat value="{!Payee_Item_Map_CASH}" var="itm" id="PayeeCashDetailLineTable">
                                    <tr>
                                        <td>
                                            <apex:outputField value="{!Payee_Item_Map_CASH[itm].ASI_CRM_CN_Cash_Payee_Name_T1__c}"/>
                                        </td>
                                        <td>
                                            <apex:outputField value="{!Payee_Item_Map_CASH[itm].ASI_CRM_CN_Amount__c}"/>
                                        </td>
                                        <td>
                                            <apex:outputField value="{!Payee_Item_Map_CASH[itm].ASI_CRM_CN_Reason__c}"/>
                                        </td>
                                        <td>
                                            <apex:outputField value="{!Payee_Item_Map_CASH[itm].ASI_CRM_CN_Comfirm_Receipt__c}"/>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                </tbody>

                            </table>
                        </apex:outputPanel>
                    </div>

                </div>


                <div class="row  " style="{!IF(discounttype && isView,'padding-top: 1em;','display:none;')}  ">
                        <div style="display: grid; grid-template-columns: 20% 80% ; grid-template-rows: auto;">
                            <div class="HeaderCss" style="grid-column-start: 1; grid-column-end: 1;">{!$Label.ASI_CRM_CN_VF_LABEL_Discount}</div>
                            <div style="grid-column-start: 2; grid-column-end: 2;  "></div>
                        </div>
                        <div class="PanelBody">

                            <apex:outputPanel id="PayeeDiscountDetailPanel">
                                <table class="bs table table-condensed" style="margin-bottom: 0;" id="PayeeDiscountDetailDataTable">
                                    <thead>
                                    <tr>

                                        <th>{!$Label.ASI_CRM_CN_VF_LABEL_T2_WS}</th>
                                        <th>{!$Label.ASI_CRM_CN_VF_LABEL_T1_WS}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Discount_Amount__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Reason__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Instruction_Sent_Time__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Comfirm_Receipt__c.Label}</th>
                                    </tr>
                                    </thead>
                                    <tbody>

                                    <apex:repeat value="{!Payee_Item_Map_DISCOUNT}" var="itm" id="PayeeDiscountDetailLineTable">
                                        <tr>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Payee_T2__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Payee_T1__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Amount__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Reason__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Instruction_Sent_Time__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_DISCOUNT[itm].ASI_CRM_CN_Comfirm_Receipt__c}"/>
                                            </td>

                                        </tr>
                                    </apex:repeat>
                                    </tbody>

                                </table>
                            </apex:outputPanel>
                        </div>

                </div>


                <div class="row  " style="{!IF(discounttype && isView,'padding-top: 1em;','display:none;')}  ">
                        <div style="display: grid; grid-template-columns: 20% 80% ; grid-template-rows: auto;">
                            <div class="HeaderCss" style="grid-column-start: 1; grid-column-end: 1;">{!$Label.ASI_CRM_CN_VF_LABEL_Others}</div>
                            <div style="grid-column-start: 2; grid-column-end: 2;  "></div>
                        </div>
                        <div class="PanelBody">

                            <apex:outputPanel id="PayeeOtherWSDetailPanel">
                                <table class="bs table table-condensed" style="margin-bottom: 0;" id="PayeeOtherWSDetailDataTable">
                                    <thead>
                                    <tr>

                                        <th>{!$Label.ASI_CRM_CN_VF_LABEL_T2_WS}</th>
                                        <th>{!$Label.ASI_CRM_CN_VF_LABEL_T1_WS}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Discount_Amount__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Reason__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Instruction_Sent_Time__c.Label}</th>
                                        <th>{!$ObjectType.ASI_CRM_CN_PH_Payee_Line_Item__c.Fields.ASI_CRM_CN_Comfirm_Receipt__c.Label}</th>
                                    </tr>
                                    </thead>
                                    <tbody>

                                    <apex:repeat value="{!Payee_Item_Map_CD}" var="itm" id="PayeeOtherWSDetailLineTable">
                                        <tr>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Payee_T2__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Payee_T1__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Amount__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Reason__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Instruction_Sent_Time__c}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!Payee_Item_Map_CD[itm].ASI_CRM_CN_Comfirm_Receipt__c}"/>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    </tbody>

                                </table>
                            </apex:outputPanel>
                        </div>

                </div>
            </div>
        </div>


        <apex:actionstatus id="ActionStatus">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb;
                                                                     height: 100%; width:100%; opacity:0.65;">
                    <div class="waitingHolder" id="loadtext" style="position: absolute;" align="left" valign="top">
                        &nbsp;&nbsp;&nbsp;
                        <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                        <span class="waitingDescription">Please Wait...</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>

    </apex:form>

    <apex:relatedList id="Attachments" subject="{!pageid}" list="CombinedAttachments" rendered="{!isView}"/>
    <apex:relatedList id="Approval" subject="{!pageid}" list="ProcessSteps" rendered="{!isView}"/>
    <apex:relatedList id="ApprovalComment" subject="{!pageid}" list="Payment_Request_Approval_Comments__r" rendered="{!isView}"/>

</apex:page>