<apex:page controller="ASI_MFM_KR_FV_Controller"  docType="html-5.0" sidebar="false"  action="{!init}">
    
    <header>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>  
        <!--------------------------------------------------   Added by Kammy on 3 Mar 2016 Start:--------------------------------------------------------------->
        
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/css/bootstrap.min.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Datatable_V1_10_7, 'DataTables-1.10.7/media/css/jquery.dataTables.min.css')}" />
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/css/SimpleTable.css')}" /> 
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_JqueryUI_V1_11_4,'jquery-ui-1.11.4.custom/jquery-ui.css')}"/> 
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_JQuery_V1_9_1, 'js/jquery.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_JQuery_V1_9_1, 'js/jquery-ui.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Plug_in_for_JQuery_V1_0_0, 'ASI_JS_plug_in_for_jQuery/dist/js/calx_js/numeral.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Plug_in_for_JQuery_V1_0_0, 'ASI_JS_plug_in_for_jQuery/dist/js/jquery-calx-2.2.3.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/js/bootstrap.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Plug_in_for_JQuery_V1_0_0, 'ASI_JS_plug_in_for_jQuery/dist/js/typeahead.bundle.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_DataTables_V1_10_11, 'DataTables-1.10.11/media/js/jquery.dataTables.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_MFM_JP_Library, 'dist/js/numericInput.min.js')}" />
        
        <apex:includeScript value="{!URLFOR($Resource.ASI_MFM_JP_Library, 'dist/js/CurrencyUtil.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_MFM_JP_Library, 'dist/js/currency.js')}" />
        <!--------------------------------------------------   Added by Kammy on 3 Mar 2016 End. --------------------------------------------------------------->
        
        
        <style>
            
            /* highlight results */ 
            .ui-autocomplete span.hl_results {
            background-color: #ffff66;
            }
            
            /* loading - the AJAX indicator */
            .ui-autocomplete-loading {
            background: white url('/img/loading.gif') right center no-repeat;
            }
            
            
            .ui-autocomplete-input{ 
            //border-left: 3px solid darkred !important;    
            }
            
            .ui-autocomplete {
            height: 200px;
            width: 400px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            overflow:auto;
            /* add padding to account for vertical scrollbar */
            padding-right: 20px;
            left: 0;
            }
            /* IE 6 doesn't support max-height
            * we use height instead, but this forces the menu to always be this tall
            */
            *html .ui-autocomplete {
            height: 200x;
            }
            
            
            .dateFormat{
            display:none;
            }             
            .bs.panel-heading.div-size {
            border-radius: 10px;
            }
            
            body {
            font-family: Arial;
            font-size: 9pt;
            }
            
            th { 
            white-space: nowrap; 
            }    
            
            .divbssearch{
            padding-top:-1px !important;
            }
            .divsearch{
            margin-right: 35px !important;
            }
            
            .divsearchlg{
            margin-right: 30px !important;
            }            
            .searchcss {
            width:100% !important;
            height:29px !important;
            }
            
            th { 
            white-space: nowrap; 
            }
            
            
            .inputlookupcss{
            padding: 5px 10px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 3px;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            
            }
            
            .headerNum {
            text-align: right;
            }
            .headerCen {
            text-align: center;
            }
            .numberAmount{
            text-align:right;
            font-weight:bold;
            }
            .PosRight{
            text-align:right;
            }
            div#dt_PoLineItems_filter{
            float:left;
            text-align:right;
            }
            tfoot input {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
            display: table-header-group;
            }
            .changecss{
            background-color: #d0e4fe ;
            color: #C0C0C0 !important;
            }
            .boxed {
            border-radius: 5px;
            background-color: #449d44; /*Add a background color to the box*/
            text-align:center; /*Align the text to the center*/
            color:#ffffff;
            }
            .RefCSS{
            background-color: #b3ecff;
            }
            .HeaderCSS{
            background-color: #3399ff;
            }
            .DetailCSS{
            background-color: #d9ffb3;
            }
            
            .style-1 input[type="text"] {
            padding: 5px 10px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 3px;
            width:80%;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            
            }
            
        </style>
        
        
        <script type="text/javascript">     
        
        $j = jQuery.noConflict();
        
        var resultTable = null;
        var invoiceNumberPrev;
        var invoiceNumberCurrent;
        var info;
        var currentRecordStart = null;
        var currentRecordEnd = null;
        var currentPageNumber = null; 
        var Payee=[];
        var Taxcode=[];
        var APcode=[];
        var datatableILength = 50;
        var api; 
        var defaultHiddenCols = [1, 2, 4, 6, 19, 20, 24, 25, 26];//20180108 Introv
        var resetHiddenCols=[];
        
        var aismfm = aismfm  || {};
        aismfm.component = aismfm.component || {};
        
        
        aismfm.component.FVDFFunction = function(){
            function init() {
                $j('.headerCen_input input').change();
                $j('.Invalid_input input').change();
                $j('.invoiceNumber input').change();
                $j('.invoiceDate input').change();
                $j('.APremark textarea').change();
                $j('.invoiceDueDate input').change();
                $j('.BusinessUnit input').change();
                $j('.TaxExplanationCode input').change();
                $j('.Phase input').change();
                $j('.GLOffset input').change();
                $j('.taxcode input').change();
            }
            
            return {
                init: init
            };
        }();        
        
        //20180108 Introv
        function defaultColumnVisibility(){
            console.log('defaultColumnVisibility');
            for (var i = 0; i < defaultHiddenCols.length; i++) {
                var column = resultTable.column( defaultHiddenCols[i] );
                console.log('column: '+column);
                column.visible(false);
                var selector = "a.toggle-vis[data-column='" + defaultHiddenCols[i] + "']";
                $j( selector ).addClass('changecss');
                $j( selector ).attr("Visi", "false");
            }
        }
        //20180108 End
        
        //20180201 Introv
        function saveColumnVisibility(){
            console.log('saveColumnVisibility');
            resetHiddenCols = [];
            for (var i = 0; i < resultTable.columns().header().length; i++) {
                var column = resultTable.column( i );
                if(!column.visible()){
                    resetHiddenCols.indexOf(i) === -1 ? resetHiddenCols.push(i) : console.log("This item already exists");
                }
            }
            console.log('resetHiddenCols');
            console.log(resetHiddenCols);
        }
        
        function resetColumnVisibility(){
            console.log('resetColumnVisibility');
            for (var i = 0; i < resetHiddenCols.length; i++) {
                var column = resultTable.column( resetHiddenCols[i] );
                console.log('column: '+column);
                column.visible(false);
                var selector = "a.toggle-vis[data-column='" + resetHiddenCols[i] + "']";
                $j( selector ).addClass('changecss');
                $j( selector ).attr("Visi", "false");
            }
        }
        //20180201 End
        
        function initFVPage(config) {
            if (config) {
                ACCodeRecordTypeName=config.ACCodeRecordTypeName;
                setResultTable(true);
                defaultColumnVisibility();
                //buttonAction(); //20180120 clear
                retrieveTaxCode();
                retrieveAPCode();
                retrievePayee();
            }
        }      
        
        
        
        function updateHiddenJsonData(id){
            
            var hiddenJsonData = $j('input[id$=hiddenBlock]').val();  
            var obj = JSON.parse(hiddenJsonData);  
            
            $j.each(obj, function(){  
                if(this.recordId == id){  
                    this.FVerify = $j('#FVerify_' + this.recordId + '_chkbox input').is(':checked');
                    this.Invalid = $j('#Invalid_' + this.recordId + '_chkbox input').is(':checked');
                    this.invoiceDateStr   = $j('#invoiceDate_' + this.recordId + '_datefield input').val()?  $j('#invoiceDate_' + this.recordId + '_datefield input').val() :null; 
                    this.invoiceNumber = $j('#invoiceNo_' + this.recordId + '_textfield input').val()?  $j('#invoiceNo_' + this.recordId + '_textfield input').val() :null; 
                    this.APremark = $j('#APremarks_' + this.recordId + '_textfield input').val()?  $j('#APremarks_' + this.recordId + '_textfield input').val() :null;
                    this.TaxAmount = $j('#TaxAmount_' + this.recordId + '_numberfield input').val()?  $j('#TaxAmount_' + this.recordId + '_numberfield input').val() :null;
                    
                    this.invoiceDueDateStr   = $j('#invoiceDueDate_' + this.recordId + '_datefield input').val()?  $j('#invoiceDueDate_' + this.recordId + '_datefield input').val() :null; 
                    this.GLOffset=$j('#GLOffset_' + this.recordId + '_picklistfield select').val()?  $j('#GLOffset_' + this.recordId + '_picklistfield select').val() :null;
                    this.BusinessUnit =  $j('#BusinessUnit_' + this.recordId + '_picklistfield select').val()?  $j('#BusinessUnit_' + this.recordId + '_picklistfield select').val() :null; 
                    this.TaxExplanationCode=$j('#TaxExplanationCode_' + this.recordId + '_picklistfield select').val()?  $j('#TaxExplanationCode_' + this.recordId + '_picklistfield select').val() :null;
                    this.Phase=$j('#Phase_' + this.recordId + '_picklistfield select').val()?  $j('#Phase_' + this.recordId + '_picklistfield select').val() :null;
                    this.taxcode =  $j('#taxcode_' + this.recordId + '_lkupfield input').val()?  $j('#taxcode_' + this.recordId + '_lkupfield input').val() :null; 
                }   
            });  
            var objString = JSON.stringify(obj);            
            $j('input[id$=hiddenBlock]').val(objString);  
        }  
        
        
        function changelookupfield(id){
            var hiddenJsonData = $j('input[id$=hiddenBlock]').val();  
            var obj = JSON.parse(hiddenJsonData);  
            console.log('changelookupfield !!! ');
            $j.each(obj, function(){  
                if(this.recordId == id){  
                    
                    this.FVerify = $j('#FVerify_' + this.recordId + '_chkbox input').is(':checked');
                    this.Invalid = $j('#Invalid_' + this.recordId + '_chkbox input').is(':checked');
                    this.invoiceDateStr   = $j('#invoiceDate_' + this.recordId + '_datefield input').val()?  $j('#invoiceDate_' + this.recordId + '_datefield input').val() :null; 
                    this.invoiceNumber = $j('#invoiceNo_' + this.recordId + '_textfield input').val()?  $j('#invoiceNo_' + this.recordId + '_textfield input').val() :null; 
                    this.APremark = $j('#APremarks_' + this.recordId + '_textfield input').val()?  $j('#APremarks_' + this.recordId + '_textfield input').val() :null;
                    this.TaxAmount = $j('#TaxAmount_' + this.recordId + '_numberfield input').val()?  $j('#TaxAmount_' + this.recordId + '_numberfield input').val() :null;
                    this.invoiceDueDateStr   = $j('#invoiceDueDate_' + this.recordId + '_datefield input').val()?  $j('#invoiceDueDate_' + this.recordId + '_datefield input').val() :null; 
                    this.BusinessUnit =  $j('#BusinessUnit_' + this.recordId + '_picklistfield select').val()?  $j('#BusinessUnit_' + this.recordId + '_picklistfield select').val() :null; 
                    this.TaxExplanationCode=$j('#TaxExplanationCode_' + this.recordId + '_picklistfield select').val()?  $j('#TaxExplanationCode_' + this.recordId + '_picklistfield select').val() :null;
                    this.Phase=$j('#Phase_' + this.recordId + '_picklistfield select').val()?  $j('#Phase_' + this.recordId + '_picklistfield select').val() :null;
                    this.GLOffset=$j('#GLOffset_' + this.recordId + '_picklistfield select').val()?  $j('#GLOffset_' + this.recordId + '_picklistfield select').val() :null;
                    var APCodeName=$j('#apCode_' + this.recordId + '_lkupfield span input').val(); 
                    if(isNaN(APCodeName)){
                        this.apCode=findValueInList(APcode,APCodeName);
                    }else{
                        this.apCode=null;
                    }
                    
                    var PayeeName=$j('#Payee_' + this.recordId + '_lkupfield span input').val();  
                    if(isNaN(PayeeName)){
                        this.Payee=findValueInList(Payee,PayeeName);
                    }else{
                        this.Payee=null;
                    }
                }   
            });  
            var objString = JSON.stringify(obj);             
            $j('input[id$=hiddenBlock]').val(objString);  
        }  
        
        
        //Find input value in Object List 
        function findValueInList(obj,ValueNow){
            var backvalue;
            $j.each(obj, function(iIndex, sElement) {
                if(sElement.label==ValueNow){
                    backvalue=sElement.value;
                }
            }); 
            return backvalue;
        }
        
        //Payee
        
        function retrievePayee() {
            
            var whereClause =   ' WHERE RecordType.DeveloperName = \'ASI_KR_Supplier\' ';
            
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.ASI_MFM_KR_FV_Controller.findSObjects}','Account', whereClause 
                , callbackPayee
                , {escape: true, timeout: 10000}
            ); 
        }
        
        
        function callbackPayee(result, event){
            if (event.status) {
                if (result) {
                    Payee = [];
                    var size = result.length;
                    for (var i = 0; i < size; i++) {
                        var Supplier = new Object();
                        Supplier.label =  htmlEncode(result[i]["Name"]);
                        Supplier.value =  htmlEncode(result[i]["Id"]);
                        Payee.push(Supplier);
                    }
                }
            } else {
                
            }   
            
        }
        
        
        function retrieveTaxCode() {
            
            var whereClause =   ' WHERE RecordType.DeveloperName = \'ASI_MFM_KR_Tax_Code\' and ASI_MFM_Inactive__c = false  ';
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.ASI_MFM_KR_FV_Controller.findSObjects}','ASI_MFM_Tax_Code__c', whereClause 
                , callbackTaxcode
                , {buffer: false,escape: true, timeout: 10000}
            ); 
        }
        
        
        function callbackTaxcode(result, event){
            if (event.status) {
                if (result) {
                    Taxcode = [];
                    var size = result.length;
                    for (var i = 0; i < size; i++) {
                        //Tax Code 
                        var tx = new Object();
                        tx.label =  htmlEncode(result[i]["Name"]);
                        tx.value =  htmlEncode(result[i]["Id"]);
                        if(result[i]["ASI_MFM_Description__c"]){
                            tx.Description=htmlEncode(result[i]["ASI_MFM_Description__c"]);
                        }else{
                            tx.Description='';
                        }
                        
                        if(result[i]["ASI_MFM_Tax_Expl_Code__c"]){
                            tx.TEC='('+htmlEncode(result[i]["ASI_MFM_Tax_Expl_Code__c"])+')';
                        }else{
                            tx.TEC='';
                        }
                        
                        Taxcode.push(tx);
                    }
                }
            } else {
                // TODO: Handle error
                //displayErrorMsg(event.message);
            }   
            initalizeAutoCompleteComponent();
        }
        
        function retrieveAPCode() {
            
            var whereClause =   ' WHERE RecordType.DeveloperName = \'ASI_KR_AP_Code\' ';
            
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.ASI_MFM_KR_FV_Controller.findSObjects}','ASI_MFM_AP_Code__c', whereClause 
                , callbackAPcode
                , {escape: true, timeout: 10000}
            ); 
        }
        
        
        function callbackAPcode(result, event){
            if (event.status) {
                if (result) {
                    APcode = [];
                    var size = result.length;
                    for (var i = 0; i < size; i++) {
                        //AP code
                        var ap = new Object();
                        ap.label =  htmlEncode(result[i]["Name"]);
                        ap.value =  htmlEncode(result[i]["Id"]);
                        APcode.push(ap);
                    }
                }
            } else {
                
            }   
            
        }
        
        function initalizeAutoCompleteComponent() {
            $j( ".lookupInput" ).each(function(){
                
                $j(this).find('input.ASI_MFM_Tax_Code__c').autocomplete({
                    source: Taxcode,
                    response: function(event, ui) 
                    {   
                        if(ui.content.length===0){ //console.log("No result found");
                            var temp = new Object();
                            temp.label='No result found';
                            temp.value='';
                            temp.Description='';
                            temp.TEC='';
                            ui.content.push(temp);
                        }
                    },
                    minLength: 0,
                    autoFocus: true,
                    scroll: true,
                    change: function (event, ui) {
                        console.log('Change!!');
                        if (!ui.item) {
                            this.value = '';
                            var Nowid= $j(this).attr('data-id');
                            $j('#taxcode_' +Nowid + '_lkupfield input').val('');
                        }
                    },
                    select: function(event, ui){ 
                        console.log('Select '+ui.item.label);
                        
                        var TEC = ui.item.TEC; //20180122 Introv
                        TEC = TEC.replace(/([.*+?^$|(){}\[\]])/mg, "");
                        console.log('Select '+TEC);
                        
                        if(ui.item.label!='No result found'){
                            var Nowid= $j(this).attr('data-id');
                            $j('#taxcode_' +Nowid + '_lkupfield input').val(ui.item.value);
                            $j(this).val(ui.item.label);
                            
                            $j('#TaxExplanationCode_' +Nowid + '_picklistfield').val(TEC);//20180122 Introv
                            $j('#TaxExplanationCode_' +Nowid + '_picklistfield').html(TEC);
                            
                            var hiddenJsonData = $j('input[id$=hiddenBlock]').val();  
                            var obj = JSON.parse(hiddenJsonData); 
                            
                            $j.each(obj, function(){  
                                if(this.recordId == Nowid){  
                                    this.taxcode=ui.item.value;
				                    this.TaxExplanationCode=TEC;//20180122 Introv
                                }   
                            });  
                            var objString = JSON.stringify(obj);             
                            $j('input[id$=hiddenBlock]').val(objString);  
                            
                            //$j(this).next().next().children().val(ui.item.value);                
                            event.preventDefault();
                        }
                        
                    },
                    focus: function(event, ui){
                        
                        event.preventDefault();
                    }  
                    
                }).focus(function () {
                    $j(this).autocomplete("search", $j(this).val() );
                    
                    // $j(this).autocomplete("search", '' );
                }).each(function() {
                    
                    $j(this).data('ui-autocomplete')._renderItem = function( ul, item ) {
                        return $j("<li style='200px'>").html("<a style='margin-left: 2px;'><span><strong>" + item.label + "</strong></span><span style='margin-right: 2px; '>  &nbsp; &nbsp; &nbsp; "+item.TEC +'&nbsp; &nbsp; &nbsp; '+item.Description+ "</span><a>").appendTo(ul); 
                    };
                    
                });
                
            })     
            
            
        }
        
        function htmlEncode( input ) {
            var e = document.createElement('div');
            e.innerHTML = input;
            return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
        };
        
        
        function setResultTable(newTable){

            initalizeAutoCompleteComponent();
            var SumAmt = 0;
            var TotalSum = 0;
            var invoiceNumberPrev;
            var invoiceNumberCurrent;
            
            
            resultTable =  $j("#dt_PaymentLineItems").on( 'init.dt', function () {
                currentRecordStart = 0; //init value 
                currentRecordEnd = datatableILength; 
            } ).DataTable({              
                "bDestroy":true,
                "bAutoWidth":false,
                "pagingType": "full_numbers",
                "dom": '<<t>ip>',
                "iDisplayLength": datatableILength,
                "order": [],
                "columnDefs": [
                    { 
                        "targets": 0, //checkbox
                        "searchable": false,
                        "orderable": false
                    },{ 
                        "targets": 1, //checkbox
                        "searchable": false,
                        "orderable": false
                    },
                    { 
                        "targets": -2, //AP Remark
                        "searchable": false,
                        "orderable": false
                    } ,
                    {
                        "render": function ( data, type, row ) {
                            return formatNumber(data);// +' '+ row[24] + ''; //for Payment Amount
                        },
                        "targets": 13, // render place:Payment Amount
                        type: 'currency'
                    },{
                        "render": function ( data, type, row ) {
                            return formatNumber(data);// +' '+ row[24] + ''; //col 24 is currency
                        },
                        "targets": 14, 
                        type: 'currency'
                    },{
                        "render": function ( data, type, row ) {
                            return formatNumber(data);// +' '+ row[24] + ''; //col 24 is currency
                        },
                        "targets": 12, 
                        type: 'currency'
                    }
                    /*
                    ,
                    { 
                        "visible": false,   //Currency
                        "targets": 25
                    }
                    */
                    
                    
                ],
                
                "initComplete": function(settings, json) {
                    if(newTable){//20180120  (false in search and save)
                    	buttonAction(); console.log( 'DataTables has finished its initialisation.' );
					}
                },
                "fnDrawCallback": function() {   
                    console.log( 'fnDrawCallback' );
                    api = this.api();
                    // buttonAction();
                    $j('.headerCen_input input').change();
                    $j('.Invalid_input input').change();
                    $j('.invoiceNumber input').change();
                    $j('.invoiceDate input').change();
                    $j('.APremark input').change();
                    $j('.TaxAmount input').change();
                    $j('.invoiceDueDate input').change();
                    $j('.BusinessUnit input').change();
                    $j('.taxcode input').change(); 
                    $j('#checkall').click(function(event) {  //on click :  check all data
                        var checked = this.checked;
                        api.column(0, {page:'current'} ).nodes().to$().each(function(index) {    
                            if (checked) {
                                $j(this).find('.Chkbox').each(function() {    
                                    
                                    var currentRow = $j(this).attr('data-row');
                                    var celllineId = $j(this).attr('data-id');
                                    //if(currentRow && currentRow>currentRecordStart && currentRow<=currentRecordEnd ){
                                    $j(this).prop( "checked",true); 
                                    updateHiddenJsonData(celllineId);
                                }); 
                            } else {
                                
                                $j(this).find('.Chkbox').each(function() {    
                                    
                                    var currentRow = $j(this).attr('data-row');
                                    var celllineId = $j(this).attr('data-id');
                                    $j(this).prop( "checked",false);
                                    updateHiddenJsonData(celllineId);
                                }); 
                            }
                        });    
                    });    
                    
                    $j('.headerCen_input input').on('click', function (event) {
                        
                        var FVFlag =$j(this).is( ":checked" ) ;
                        var paymentId = $j(this).attr('data-payment');
                        var invoiceId = $j(this).attr('data-invoice');
                        var lineId = $j(this).attr('data-id');
                        
                        if(FVFlag){
                            $j(this).prop( "checked",true);
                        }else{
                            $j(this).prop( "checked",false);
                        }
                        updateHiddenJsonData(lineId); 
                        
                        api.column(0).nodes().to$().each(function(index) {  
                            
                            $j(this).find('.Chkbox').each(function() {    
                                //Get related Payment Line with same Payment and Same invoice Number
                                var paymentCellId = $j(this).attr('data-payment');
                                var invoiceCellId = $j("#invoiceNo_"+$j(this).attr('data-id')+"_textfield").children().val();//$j(this).attr('data-invoice');
                                
                                var celllineId = $j(this).attr('data-id');                                
                                if( paymentCellId && paymentId && invoiceCellId && invoiceId){
                                    if(paymentCellId == paymentId && invoiceCellId == invoiceId && celllineId!==lineId){
                                        if(FVFlag) { 
                                            $j(this).prop( "checked",true);  
                                            updateHiddenJsonData(celllineId); 
                                        }
                                        else {  
                                            $j(this).prop( "checked",false); 
                                            updateHiddenJsonData(celllineId); 
                                        } 
                                    }
                                }
                            });
                            
                        });
                        
                    }); 
                    //End : check Finance Verify
                
                }, "footerCallback": function( tfoot, data, start, end, display ) {
                    console.log('Enter footerCallback');
                    api = this.api(),data;
                    var intVal = function ( i ) {//console.log(i);
                        return typeof i === 'string' ? i.replace(/\s/g, '').replace(/[\$,]/g, '')*1 : typeof i === 'number' ?	i : 0;
                    };
                    //Calculate Total sum
                    TotalSum = api.column(26).data().reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    },0 );
                    //Calculate currenct page amount
                    SumAmt = api.column(26, { page: 'current'} ).data().reduce( function (a, b) {
                        
                        return intVal(a) + intVal(b);
                    }, 0 );
                    TotalSum = parseFloat(TotalSum);
                    SumAmt = parseFloat(SumAmt);
                    
                    $j('#totalSum').html(formatNumber(SumAmt.toFixed(2))+" (Total: "+formatNumber(TotalSum.toFixed(2))+' KRW )');
                    
                } 
                
            });
            
            
            $j("#dt_PaymentLineItems").on( 'page.dt', function () {
                info = resultTable.page.info();
                if(info){
                    currentPageNumber = info.page;
                    currentRecordStart = info.start? info.start: 0;
                    currentRecordEnd = info.end ?  info.end: 0;
                }
                initalizeAutoCompleteComponent();
            } );
            
            //buttonAction();
            SetColumnVisibility();
        }      
        
        function formatNumber(n) {
            
            //20180108 Introv
            var m = '';
            
            if(n.indexOf('.') > -1){
                
                m = '.' + n.split('.')[1];
                n = n.split('.')[0];
            }
            
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + m;
        }
        
        function SetColumnVisibility(){
            $j( "a.toggle-vis" ).each(function( index ) {
                console.log( $j(this).attr('Visi') + ": " + $j(this).attr('data-column'));
                if($j(this).attr('Visi') =='false'){
                    var column = resultTable.column( $j(this).attr('data-column') );
                    column.visible(false);
                }
            });
        }
        
        function buttonAction(){
            console.log('buttonAction');
            $j('a.toggle-vis').on( 'click', function (e) {
				console.log('buttonAction click');
                e.preventDefault();
                console.log($j(this).attr('data-column'));
                // Get the column API object
                var column = resultTable.column( $j(this).attr('data-column') );
                // Toggle the visibility
                column.visible( ! column.visible() );
                console.log(column.visible());
                if(!column.visible()){
                    $j(this).addClass('changecss');
                    $j(this).attr("Visi", "false");
                }
                else{
                    $j(this).removeClass('changecss');
                    $j(this).attr("Visi", "true");

                }
            } );    
            
            $j('#showAll').on('click',function(e){
				console.log('buttonAction showall');
                e.preventDefault();
                var columNum = 0; 
                resultTable.columns().every( function (index ) {
                    resultTable.column(columNum).visible(true);
                    columNum++;
                });
                $j('#tc1,#tc2').removeClass('changecss');
                resultTable.columns.adjust().draw( false ); // adjust column sizing and redraw      
                
                
                $j( "a.toggle-vis" ).each(function( index ) {
                    console.log( $j(this).attr('Visi') + ": " + $j(this).attr('data-column'));
                    var column = resultTable.column( $j(this).attr('data-column') );
                    column.visible(true);
                    
                    //20180120
                    var selector = "a.toggle-vis[data-column='" + index + "']";
                	$j( selector ).attr("Visi", "true");
                });
            });
        }                  
        
        $j(document).ready(function(){
            initFVPage({
                ACCodeRecordTypeName : ''
            });
        });
        
        $j(document).on('mousemove', function(e){
            $j("#loadtext").css({
                left:  e.pageX,
                top:   e.pageY
            });
        });
        function openAccountWin(id){
            window.open("/"+id);
        }
        
        </script>
        
        
    </header>
    
    
    <body class="bs">
        <apex:form id="DFFVerifyForm" >
            <div style="margin:0; width: 250em;" >
                <div class="bs row">
                    <div class="bs col-md-12">
                        <div class="bs col-xs-12 col-sm-6 col-md-6">
                            <apex:outputPanel styleclass="bs"   >
                                <div class="panel panel-primary " >
                                    <div class="panel-heading">
                                        <h5>
                                            KR Finance Verify
                                        </h5>
                                    </div>   
                                    <div class="alert alert-danger fade in" style="{!IF(UpsertPermission,'display:none;','')}"  id="SaveFailPart">
                                        
                                        <strong>Error! Can not Save!</strong><br/>
                                        <apex:outputText escape="false" value="{!Msg}"/>
                                    </div>  
                                    <div class="alert alert-success fade in" style="{!IF(SaveSuccess,'','display:none;')}" id="SaveSuccessPart">
                                        <strong>Save Success!</strong> <br/>
                                        <apex:outputText escape="false" value="{!Msg}"/>
                                    </div>    
                                    
                                    <div class="control-group panel-body ">
                                        <div class="bs row">
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;" >Company:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:selectList id="selectList1" value="{!Company}" size="1" styleClass="form-control searchcss input-sm">
                                                        <apex:selectOption itemValue="" itemLabel=" "/>
                                                        <apex:selectOption itemValue="PRK" itemLabel="PRK"/>
                                                        <apex:selectOption itemValue="PRKI" itemLabel="PRKI"/>
                                                    </apex:selectList>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;" >Verify:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:selectList id="BAV1" value="{!FinVerify}" size="1" styleClass="form-control searchcss input-sm">
                                                        <apex:selectOption itemValue="" itemLabel=" "/>
                                                        <apex:selectOption itemValue="Checked" itemLabel="Checked"/>
                                                        <apex:selectOption itemValue="Unchecked" itemLabel="Unchecked"/>
                                                    </apex:selectList>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;" >Fiscal Year:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:selectList id="fiscalyear" value="{!Fiscalyear}" size="1" styleClass="form-control searchcss input-sm">
                                                        <apex:selectOption itemValue="FY1213" itemLabel="FY1213"/>
                                                        <apex:selectOption itemValue="FY1314" itemLabel="FY1314"/>
                                                        <apex:selectOption itemValue="FY1415" itemLabel="FY1415"/>
                                                        <apex:selectOption itemValue="FY1516" itemLabel="FY1516"/>
                                                        <apex:selectOption itemValue="FY1617" itemLabel="FY1617"/>
                                                        <apex:selectOption itemValue="FY1718" itemLabel="FY1718"/>
                                                        <apex:selectOption itemValue="FY1819" itemLabel="FY1819"/>
                                                        <apex:selectOption itemValue="FY1920" itemLabel="FY1920"/>
                                                        <apex:selectOption itemValue="FY2021" itemLabel="FY2021"/>
                                                        <apex:selectOption itemValue="FY2122" itemLabel="FY2122"/>
                                                        <apex:selectOption itemValue="FY2223" itemLabel="FY2223"/>
                                                    </apex:selectList>    
                                                </div>
                                            </div>
                                            
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;">Invoice No:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:inputText value="{!InvoiceNumber}"  styleClass="form-control searchcss input-sm" html-placeholder="Invoice No"  />
                                                </div>
                                            </div>
                                             
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;">Payment ID:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:inputText value="{!Payment_ID}"  styleClass="form-control searchcss input-sm" html-placeholder="Payment ID"  />
                                                </div>
                                            </div>
                                            
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;">Payee:</apex:outputLabel>
                                                <div class="form-group divsearch style-1" id="pofilterDiv1">
                                                    <apex:inputField value="{!pofilter.ASI_MFM_Supplier_Name__c}"  html-placeholder="Payee"  />
                                                </div>
                                            </div> 
                                            
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;">G/L Date From:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:inputField value="{!fromDate.ASI_MFM_G_L_Date__c}"  styleClass="form-control searchcss input-sm" html-placeholder="G/L Date From"  />
                                                </div>
                                            </div> 
                                            <div class="col-md-2">
                                                <apex:outputLabel style="font-weight:bold;">G/L Date To:</apex:outputLabel>
                                                <div class="form-group divsearch">
                                                    <apex:inputField value="{!ToDate.ASI_MFM_G_L_Date__c}"  styleClass="form-control searchcss input-sm" html-placeholder="G/L Date To"  />
                                                </div>
                                            </div> 
                                        </div>
                                        
                                        <div class="bs row">
                                            
                                            <div class="col-md-2">  
                                                <div class="form-group divsearch"> 
                                                    <apex:commandButton value="Search"
                                                                        styleClass="bs btn btn-default btn-sm btn-block"
                                                                        action="{!runSearch}"
                                                                        status="ActionStatus"
                                                                        onclick="resultTable.page.len( -1 ).draw(false);"
                                                                        oncomplete="setResultTable(false);"
                                                                        rerender="SaveSuccessPart,results,SaveFailPart,hiddenJsonData,hiddenBlock" />
                                                </div> 
                                            </div>
                                            <div class="col-md-2">  
                                                <div class="form-group divsearch"> 
                                                    <apex:outputLink styleClass="bs btn btn-info btn-sm "
                                                                     target="_blank"
                                                                     value="/{!reportFolderid}"> Report Folder</apex:outputLink>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group divsearch boxed">
                                                    <apex:outputLabel style="font-weight:bold; text-align:left; ">G/L Date:</apex:outputLabel>
                                                    <apex:inputField value="{!UpdatedGLDate.ASI_MFM_G_L_Date__c}"  styleClass="form-control searchcss input-sm" html-placeholder="G/L Date"  />
                                                </div>
                                            </div>
                                            <div class="col-md-2">  
                                                <div class="form-group divsearch">
                                                    <apex:outputLabel style="font-weight:bold; text-align:left; "> </apex:outputLabel>
                                                    <apex:commandButton value="Save"
                                                                        styleClass="bs btn btn-success btn-sm btn-block"
                                                                        action="{!save}"
                                                                        status="ActionStatus"
                                                                        onclick="resultTable.page.len( -1 ).draw(false);"
                                                                        oncomplete="saveColumnVisibility();setResultTable(true);resetColumnVisibility();"
                                                                        rerender="SaveSuccessPart,DFFVerifyForm,results,SaveFailPart,hiddenJsonData,hiddenBlock" >  <!--,errors -->
                                                    </apex:commandButton>
                                                </div>
                                            </div>
                                            <div class="col-md-2">  
                                                <div class="form-group divsearch">
                                                    <apex:outputLabel style="font-weight:bold; text-align:left; "> </apex:outputLabel>
                                                    <apex:commandButton value="Export CSV"
                                                                        styleClass="bs btn btn-success btn-sm btn-block"
                                                                        action="{!exportCSV}"
                                                                        status="ActionStatus"
                                                                        >  <!--,errors-->
                                                    </apex:commandButton>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bs row" style="margin:0.5em;" >
                                            <button type="button" class="bs btn btn-warning btn-sm" style="padding: 3px 5px; " id="showAll">Show All</button>
                                            Toggle Column:
                                            <a class="toggle-vis" data-column="1" Visi="true" id="tc1" >Plan ID</a>-
                                            <a class="toggle-vis" data-column="2" Visi="true" id="tc1">PO Receipt ID</a>-
                                            <a class="toggle-vis" data-column="3" Visi="true" id="tc1">PO ID</a>-
                                            <a class="toggle-vis" data-column="4" Visi="true" id="tc1">PO Line ID</a>-
                                            <a class="toggle-vis" data-column="5" Visi="true"  id="tc1">Payment ID</a>-
                                            <a class="toggle-vis" data-column="6"  Visi="true" id="tc1">Payment Line ID</a>-
                                            <a class="toggle-vis" data-column="7"  Visi="true" id="tc1">VAT ID</a>-
                                            <a class="toggle-vis" data-column="8" Visi="true" id="tc1">Payment Term</a>-    <!--Modified By 2017-09-08 Linus@introv-->
                                            <a class="toggle-vis" data-column="9"  Visi="true" id="tc1">G/L Date</a>-
                                            <a class="toggle-vis" data-column="10"  Visi="true" id="tc1">Tax Explanation Code</a>-
                                            <a class="toggle-vis" data-column="11"  Visi="true" id="tc1">Tax Code</a>-
                                            <a class="toggle-vis" data-column="12"  Visi="true" id="tc1">Exchange Rate</a>-
                                            <a class="toggle-vis" data-column="13"  Visi="true" id="tc1">Total Payment Amount (Including VAT)</a>-
                                            <a class="toggle-vis" data-column="14"  Visi="true" id="tc1">Payment Amount</a>-
                                            <a class="toggle-vis" data-column="15" Visi="true"  id="tc1">VAT Amount</a>-
                                            <a class="toggle-vis" data-column="16"  Visi="true" id="tc1"  >Payee</a>-
                                            <a class="toggle-vis" data-column="17"  Visi="true" id="tc1">Invoice Number</a>- 
                                            <a class="toggle-vis" data-column="18"  Visi="true" id="tc1"   >Invoice Date</a>- 
                                            <a class="toggle-vis" data-column="19"  Visi="true" id="tc1">Fiscal Year</a>-
                                            <a class="toggle-vis" data-column="20"  Visi="true" id="tc1">Branch/Plant</a>-
                                            <a class="toggle-vis" data-column="21" Visi="true"  id="tc1">Phase</a>-
                                            <a class="toggle-vis" data-column="22"  Visi="true" id="tc1">GL Offset</a>-
                                            <a class="toggle-vis" data-column="23"  Visi="true" id="tc1">AP Code</a>-
                                            <a class="toggle-vis" data-column="24"  Visi="true" id="tc1">Sub Brand</a>-
                                            <a class="toggle-vis" data-column="25"  Visi="true" id="tc1">Currency</a>-
                                            <a class="toggle-vis" data-column="26"  Visi="true" id="tc1">Supply Amount(KRW)</a>-
                                            <a class="toggle-vis" data-column="27"  Visi="true" id="tc1">ETL</a>-
                                            <a class="toggle-vis" data-column="28"  Visi="true" id="tc1">ETL Date</a>-
                                            <a class="toggle-vis" data-column="29"  Visi="true" id="tc1">AP Remark</a>-
                                            <a class="toggle-vis" data-column="30"  Visi="true" id="tc1">Verify By</a>
                                        </div>
                                        
                                    </div>
                                </div>
                            </apex:outputPanel> 
                        </div>
                      
                    </div>
                </div>
            </div>
            

              <div class="container-fluid" style="margin:0;">
                <div class="bs row">
                    <div lass="bs col-xs-12" >                       
                        
                        <apex:outputPanel id="hiddenJsonData">  
                            <apex:inputHidden id="hiddenBlock" value="{!jsonDataMinimal}" />  
                        </apex:outputPanel>  
                        
                        <apex:outputPanel styleclass="bs panel-primary" id="results">
                          
                            <br/> 
                            <apex:variable value="{!0}" var="i"/>
                            
                            <table width="100%" border="0" id="dt_PaymentLineItems" class="hover table-striped responsive no-wrap display compact">
                                <thead>
                                    <tr>
                                        <th colspan="7"  class="RefCSS" style="text-align: center;" >Reference </th>
                                        <th colspan="9" class="HeaderCSS" style="text-align: center;"   >Payment Header  </th>   <!--Modified By 2017-09-08 Linus@introv-->
                                        <th colspan="15" class="DetailCSS" style="text-align: center;"  > Payment Details</th>
                                    </tr>
                                    
                                    <tr>
                                        <th class="RefCSS"  style="text-align: center;" ><span> Verify</span><br/> <input type="checkbox" id="checkall"/></th>
                                        <th class="RefCSS"  >Plan ID</th>
                                        <th class="RefCSS"  >PO Receipt ID</th>
                                        <th class="RefCSS">PO ID</th>
                                        <th class="RefCSS">PO Line ID</th>
                                        <th class="RefCSS">Payment ID</th>
                                        <th class="RefCSS" >Payment Line ID</th>
                                        <th class="HeaderCSS" >VAT ID</th>
                                        <th class="HeaderCSS" >Payment Term</th>   <!--Modified By 2017-09-08 Linus@introv-->
                                        <th class="HeaderCSS">G/L Date</th>
                                        <th class="HeaderCSS">Tax Explanation Code</th>
                                        <th class="HeaderCSS">Tax Code</th>
                                        <th class="HeaderCSS">Exchange Rate</th>
                                        <th class="HeaderCSS">Total Payment Amount <br/>(Including VAT)</th><!--20170207,edited by Leo-->
                                        <th class="HeaderCSS">Payment Amount</th>
                                        <th class="HeaderCSS">VAT Amount</th>
                                        <th class="DetailCSS"  >Payee</th>
                                        <th class="DetailCSS" >Invoice Number</th>
                                        <th class="DetailCSS"  >Invoice Date</th>
                                        <th class="DetailCSS">Fiscal Year</th>
                                        <th class="DetailCSS">Branch/Plant</th>
                                        <th class="DetailCSS">Phase</th>
                                        <th class="DetailCSS">GL Offset</th>
                                        <th class="DetailCSS">AP Code</th>
                                        <th class="DetailCSS">Sub Brand</th>
                                        <th class="DetailCSS">Currency</th>
                                        <th class="DetailCSS">Supply Amount(KRW)</th>
                                        <th class="DetailCSS">ETL</th>
                                        <th class="DetailCSS" >ETL Date</th>
                                        <th class="DetailCSS" >AP Remark</th>
                                        <th class="DetailCSS" >Verify By</th>  
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:repeat value="{!LineItem}" var="line">
                                        <apex:variable var="i" value="{!i+1}"/>
                                        <tr>
                                            <td class="headerCen_input headerCen" id="FVerify_{!line.id}_chkbox">
                                                <apex:inputfield value="{!line.ASI_MFM_Payment_Line_Item_Finance_Verify__c}" html-data-invoice="{!line.ASI_MFM_Invoice_Number__c}" html-data-id="{!line.id}" html-data-payment="{!line.ASI_MFM_Payment__r.Id}"  html-data-row="{!i}" styleClass="Chkbox" onchange="updateHiddenJsonData('{!line.id}')" rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}"/>
                                                <apex:outputfield value="{!line.ASI_MFM_Payment_Line_Item_Finance_Verify__c}"  rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"/>
                                            </td> 
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_PO_Line_Item__r.ASI_MFM_PO__r.ASI_MFM_Plan__c}"></apex:outputField></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_PO_Receipt_Item__c}"></apex:outputField></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_PO_Line_Item__r.ASI_MFM_PO__c}"></apex:outputField></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_PO_Line_Item__c}"></apex:outputField></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_Payment__c}"></apex:outputField></td>
                                            <td class="headerCen" >
                                                <apex:outputLink value="{!LEFT($Api.Partner_Server_URL_140, FIND('.com/',$Api.Partner_Server_URL_140)+3)}/{!line.id}" target="_blank">
                                                    <apex:outputField value="{!line.name}"/>
                                                </apex:outputLink>
                                            </td>
                                            <td class="headerCen" >{!line.ASI_MFM_Payee__r.ASI_KOR_Venue_Business_License_Number__c}</td>
                                            <td class="headerCen" >{!line.ASI_MFM_Payment__r.ASI_MFM_Payment_Term__c}</td>  <!--Modified By 2017-09-08 Linus@introv-->
                                            <td><apex:outputField value="{!line.ASI_MFM_G_L_Date__c}"></apex:outputField></td>
                                            
                                            <td class="TaxExplanationCode headerCen" id="TaxExplanationCode_{!line.id}_picklistfield" >
                                                {!line.ASI_MFM_KR_Tax_Explanation_Code__c}<!--20180326 Introv-->
                                            </td>
                                            
                                            <td class="taxcode" id="taxcode_{!line.id}_lkupfield" >
                                                <!--<apex:inputField styleClass="ASI_MFM_Tax_Code__c" value="{!line.ASI_MFM_Tax_Code__c}" html-data-id="{!line.id}"  onchange="initalizeAutoCompleteComponent();updateHiddenJsonData('{!line.id}')"  rendered="{!if(OR(line.ASI_MFM_ETL__c=true,line.ASI_MFM_Currency__c!='KRW'),False,true)}" ></apex:inputField>--><!--20170426,Elufa-->
                                                <apex:inputField styleClass="ASI_MFM_Tax_Code__c" value="{!line.ASI_MFM_Tax_Code__c}" html-data-id="{!line.id}"  onchange="initalizeAutoCompleteComponent();updateHiddenJsonData('{!line.id}')"  rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}" ></apex:inputField> <!--20170426,Elufa-->
                                                <apex:outputField value="{!line.ASI_MFM_Tax_Code__c}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputField>
                                            </td>
                                             <td class="headerNum">
                                                {!if(isnull(line.ASI_MFM_Payment__r.ASI_MFM_Exchange_Rate__c),'-',ROUND(line.ASI_MFM_Payment__r.ASI_MFM_Exchange_Rate__c,4))}
                                            </td>
                                             
                                            <td class="numberAmount" id="TaxAmount_{!line.id}_numberfield" ><!--20170207,edited by Leo-->
                                               <apex:outputText value="{0, number, ###,###,###,###,##0.00}" ><apex:param value="{!line.ASI_MFM_Payment__r.ASI_MFM_KR_TotalPayAmtIncludeVAT__c}"/></apex:outputText></td><!--20170207,edited by Leo-->
                                            <td class="numberAmount" ><apex:outputText value="{0, number, ###,###,###,###,##0.00}" ><apex:param value="{!line.ASI_MFM_Payment__r.ASI_MFM_Payment_Amount__c}"/></apex:outputText></td>
                                           
                                            <td class="numberAmount" > <apex:outputField value="{!line.ASI_MFM_Payment__r.ASI_MFM_KR_VAT_Amount__c}" ></apex:outputField></td><!--20170207,edited by Leo-->
                                            
                                            <td class="Payeecls" id="Payee_{!line.id}_lkupfield"  >
                                                <apex:inputField value="{!line.ASI_MFM_Payee__c}"  html-data-id="{!line.id}"  onchange="changelookupfield('{!line.id}')"  rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}"/> 
                                                <apex:outputField value="{!line.ASI_MFM_Payee__c}" html-data-id="{!line.id}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"/>
                                            </td>
                                             <td class="invoiceNumber" id="invoiceNo_{!line.id}_textfield">
                                                <apex:inputField value="{!line.ASI_MFM_Invoice_Number__c}" html-data-invoice="{!line.ASI_MFM_Invoice_Number__c}"  html-data-id="{!line.id}" html-data-payment="{!line.ASI_MFM_Payment__r.Id}"  onchange="updateHiddenJsonData('{!line.id}')" rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}" styleClass="invoiceNumberText"></apex:inputField>
                                                <apex:outputText value="{!line.ASI_MFM_Invoice_Number__c}" html-data-id="{!line.id}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputText>
                                            </td> 
                                            <td class="invoiceDate" id="invoiceDate_{!line.id}_datefield">
                                                <apex:inputField value="{!line.ASI_MFM_Invoice_Date__c}" html-data-id="{!line.id}" html-data-invoice="{!line.ASI_MFM_Invoice_Number__c}" onchange="updateHiddenJsonData('{!line.id}')" rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}" ></apex:inputField>
                                                <apex:outputField value="{!line.ASI_MFM_Invoice_Date__c}" html-data-id="{!line.id}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputField>
                                            </td>
                                            <td>{!line.ASI_MFM_PO_Line_Item__r.ASI_MFM_PO__r.ASI_MFM_Plan__r.ASI_MFM_Fiscal_year__c}
                                                <div style="display:none;">
                                                    <apex:inputField value="{!line.ASI_MFM_Company__c}" ></apex:inputField>
                                                </div>
                                            </td>
                                            <td class="BusinessUnit" id="BusinessUnit_{!line.id}_picklistfield" >
                                                <apex:inputField value="{!line.ASI_MFM_Business_Unit__c}"  html-data-id="{!line.id}" onchange="updateHiddenJsonData('{!line.id}')"  rendered="{!IF(line.ASI_MFM_Company__c='PRK',false,true)}"></apex:inputField>
                                                <apex:outputField value="{!line.ASI_MFM_Business_Unit__c}" rendered="{!IF(line.ASI_MFM_Company__c='PRK',true,false)}"></apex:outputField>
                                                <div style="display:none;">
                                                    <apex:inputField value="{!line.ASI_MFM_Business_Unit__c}"   rendered="{!IF(line.ASI_MFM_Company__c='PRK',true,false)}"></apex:inputField>
                                                </div>
                                            </td>
                                            <td class="Phase" id="Phase_{!line.id}_picklistfield" >
                                                <apex:inputField value="{!line.ASI_MFM_Phase__c}" html-data-id="{!line.id}"  onchange="updateHiddenJsonData('{!line.id}')"  rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}" ></apex:inputField>
                                                <apex:outputField value="{!line.ASI_MFM_Phase__c}"  rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputField>
                                            </td>
                                            <td class="GLOffset" id="GLOffset_{!line.id}_picklistfield" >
                                                <apex:inputField value="{!line.ASI_MFM_GL_Offset__c}" html-data-id="{!line.id}"  onchange="updateHiddenJsonData('{!line.id}')"  rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}" ></apex:inputField>
                                                <apex:outputField value="{!line.ASI_MFM_GL_Offset__c}"  rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputField>
                                            </td>
                                            <td class="apCode" id="apCode_{!line.id}_lkupfield">
                                                <apex:inputField value="{!line.ASI_MFM_AP_Code__c}"  html-data-id="{!line.id}"  onchange="changelookupfield('{!line.id}')"  rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}"/> 
                                                <apex:outputField value="{!line.ASI_MFM_AP_Code__c}" html-data-id="{!line.id}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"/>
                                            </td>
                                            <td><apex:outputField value="{!line.ASI_MFM_PO_Line_Item__r.ASI_MFM_Sub_brand_Code__c}"></apex:outputField></td>
                                            <td> {!line.ASI_MFM_Currency__c}</td>
                                             <td class="numberAmount" ><apex:outputText value="{0, number, ###,###,###,###,##0.00}" ><apex:param value="{!if(isnull(line.ASI_MFM_Payment__r.ASI_MFM_Exchange_Rate__c),line.ASI_MFM_Payment_Amount__c,ROUND((line.ASI_MFM_Payment__r.ASI_MFM_Exchange_Rate__c)*line.ASI_MFM_Payment_Amount__c,2))}"/></apex:outputText></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_ETL__c}"></apex:outputField></td>
                                            <td class="headerCen" ><apex:outputField value="{!line.ASI_MFM_ETL_Date__c}"></apex:outputField></td>
                                            <td class="APremark" id="APremarks_{!line.id}_textfield"> 
                                                <apex:inputField value="{!line.ASI_MFM_AP_Remark__c}" html-data-id="{!line.id}" html-data-invoice="{!line.ASI_MFM_Invoice_Number__c}" onchange="updateHiddenJsonData('{!line.id}')" rendered="{!if(line.ASI_MFM_ETL__c=true,False,true)}"></apex:inputField>
                                                <apex:outputField value="{!line.ASI_MFM_AP_Remark__c}" rendered="{!if(line.ASI_MFM_ETL__c=true,true,False)}"></apex:outputField>
                                            </td>
                                            <td> 
                                                <apex:outputField value="{!line.ASI_MFM_Verify_by__r.name}"></apex:outputField>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                               
                                <tfoot>
                                    <tr class="summary">
                                        <td colspan='23'></td>
                                        <td><b>Summary:</b></td>
                                        <td colspan='6' class="numberAmount" ><span style="float:left;font-size: 120%;" id ='totalSum'></span></td>
                                    </tr>
                                </tfoot>
                            </table> 
                        </apex:outputPanel>
                    </div>
                </div>
            </div>
        </apex:form>
        
        <!---------------------Loading-------------------------------------->
        <apex:actionstatus id="ActionStatus">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb;
                                                                     height: 100%; width:100%; opacity:0.65;"> 
                    <div class="waitingHolder" id="loadtext" style="position: absolute;" align="left" valign="top">
                        &nbsp;&nbsp;&nbsp;
                        <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                        <span class="waitingDescription">Please Wait...</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus> 
        
        
        
    </body>
</apex:page>