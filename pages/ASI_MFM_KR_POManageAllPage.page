<apex:page standardController="ASI_MFM_PO__c"  sidebar="false"  docType="html-5.0" showHeader="true" extensions="ASI_MFM_KR_POManageAllController" action="{!init}">
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/css/bootstrap.min.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Datatable_V1_10_7, 'DataTables-1.10.7/media/css/jquery.dataTables.min.css')}" />
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/css/SimpleTable.css')}" /> 
        <apex:stylesheet value="{!URLFOR($Resource.ASI_JS_JqueryUI_V1_11_4,'jquery-ui-1.11.4.custom/jquery-ui.css')}"/>        
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_JQuery_V1_9_1, 'js/jquery.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_JQuery_V1_9_1, 'js/jquery-ui.min.js')}" />  
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Bootstrap_V3_3_5, 'dist/js/bootstrap.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_DataTables_V1_10_11, 'DataTables-1.10.11/media/js/jquery.dataTables.min.js')}" />
        
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Plug_in_for_JQuery_V1_0_0, 'ASI_JS_plug_in_for_jQuery/dist/js/numericInput.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.ASI_JS_Plug_in_for_JQuery_V1_0_0, 'ASI_JS_plug_in_for_jQuery/dist/js/CurrencyUtil.js')}" />
        <script type="text/javascript">
        
        $j = jQuery.noConflict();
        var headerId = null;
        var resultTable;
        var POLTable;
        var datatableILength = 15;   
        var api;   
        var SKU = [];
        var Customers = [];
        var CustomerTypeName = null,CurrencyName=null;
        var totalAmountDecimalPlace = 2;
        var SKURCName = null;
        
        function initPage(config) {
            if (config) {
                CurrencyName=config.CurrencyName;
                if(CurrencyName=='KRW'){
                    totalAmountDecimalPlace=0;
                }
                headerId = config.headerId; //CustomerTypeName=config.CustomerTypeName;
                SKURCName=config.SKURCName;
                setResultTable(true);
                setLineTable(true);//retrieveCustomer();
                retrieveSKUCode();
                console.log(totalAmountDecimalPlace+'CurrencyName : '+CurrencyName);
            }
        }  
        function setResultTable(newTable){
            var SumAmt = 0;//retrieveCustomer();
            retrieveSKUCode();
            resultTable =  $j('#dt_PaymentLineItems').on( 'init.dt', function () {
                
            }).DataTable({
                "bDestroy":true,
                "bSearch":false,
                "dom": '<"top">irt<"bottom"p><"clear">',
                "bAutoWidth":false,                     
                "bSort": false, 
                "iDisplayLength":datatableILength,
                "sPaginationType": "full_numbers",
                "bLengthChange": false,
                "order": [],
                "columnDefs": [{
                    "targets": [ 0 ],
                    "searchable": false,
                    "orderable": false
                }],
                "fnDrawCallback": function() {   
                    api = this.api();
                },
                "footerCallback": function( tfoot, data, start, end, display ) {
                    api = this.api();
                      calculateSum();
                }
            });
        }
        
        //SKU    
        function retrieveSKUCode() {
            
            var whereClause =   ' WHERE RecordType.DeveloperName = \''+ SKURCName+ '\' and ASI_MFM_Sub_brand__r.Name like \'POS%\''; // + '\' and Name like \'9%\'';
            var statement='id,name, ASI_MFM_Sub_brand__r.Name,ASI_MFM_Sub_brand__c,ASI_MFM_SKU_Description__c,ASI_HK_CRM_UOM1__c,ASI_MFM_SKU_Code__c ';
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.ASI_MFM_KR_POManageAllController.findList}','ASI_MFM_SKU_Code__c', statement,whereClause 
                , callbackSKUCode
                , {buffer: false,escape: true, timeout: 10000}
            );       
        }
        function callbackSKUCode(result, event){
            if (event.status) {
                if (result) {
                    SKU=[];
                    var size = result.length;
                    for (var i = 0; i < size; i++) {
                        var skus = new Object();
                        skus.label =  htmlEncode(result[i]["Name"]);
                        skus.value =  htmlEncode(result[i]["Id"]);
                        skus.sb=htmlEncode(result[i]["ASI_MFM_Sub_brand__c"]);
                        skus.Description= htmlEncode(result[i]["ASI_MFM_SKU_Description__c"]);
                        SKU.push(skus);
                    }
                    
                }
            }else {
            }   
            
            initalizeAutoCompleteComponent();
        }
      
        
        function initalizeAutoCompleteComponent() {
             $j(".skuCodeClass").autocomplete({
                 source: 
                 SKU,
                 search: function(event, ui) {
                     var sValue = $j(this).attr('data-sb');
                     var aSearch = [];
                      $j(SKU).each(function(iIndex, sElement) {
                          //if(sElement.sb==sValue){
                            var skus = new Object();
                            skus.label=sElement.label;
                            skus.value=sElement.value;
                            skus.desc=sElement.Description;
                            aSearch.push(skus);
                          // }
                    }); 
                     
                     //showing no result information 
                     if(aSearch.length==0){
                         var message= new Object();
                         message.label='No result';
                         message.value='';
                         aSearch.push(message);
                     }
                     
                    $j(this).autocomplete('option', 'source', aSearch);
                     
                 }, response: function(event, ui) 
                 {
                    if(ui.content.length===1){ 
                        var detectflag= false;
                        for(var key in ui.content) {//  console.log(key);//console.log(ui.content[key]);console.log(ui.content[key].label);
                            //find the ui if exist 'No result'
                            if(ui.content[key].label=='No result'){
                                detectflag=true;// console.log("detect flag: No result found");
                            }
                        }
                        if(detectflag){// exist 'No result'
                            console.log("No result found");
                            $j(this).next().next().children().val('');  
                        }
                    }
                     
                 }, minLength: 0,
                 autoFocus: true,
                 scroll: true,
                 change: function (event, ui) {
                     if (!ui.item) {
                         this.label = '';
                         $j(this).val('');
                         $j(this).next().next().children().val('');   
                     }
                 },
                 select: function(event, ui){
                     if(ui.item.label!='No result'){
                         $j(this).val(ui.item.label);
                         $j(this).next().next().children().val(ui.item.value);            
                         $j(this).closest('.input').find('.value').val(ui.item.value);//console.log( $j(this).closest('.input').find('.value')+':' + ui.item.value);
                         event.preventDefault();
                     }
                 },
                 focus: function(event, ui){
                     if(ui.item.label!='No result'){
                         $j(this).val(ui.item.label);
                         event.preventDefault();
                     }
                 }  
             }).focus(function () {
                $j(this).autocomplete("search", "");
                event.preventDefault();
            }).each(function() {
                $j(this).data('ui-autocomplete')._renderItem = function( ul, item ) {
                    
                    if(item.label=='No result'){
                         return $j("<li>").html("<a style='margin-left: 2px;'><span><strong>" + item.label + "</strong>   </span><a>").appendTo(ul); 
                    }else{
                        /* var mestemp='';
                        if(item.desc.length>30){
                            mestemp=item.desc.substring(0, 30)+'...';
                        }else{
                            mestemp=item.desc;
                        }*/
                    return $j("<li style='width:300px' >").html("<a style='margin-left: 2px;  '><span><strong>" + item.label + "</strong>:    </span><span >" + item.desc+ "</span><a>").appendTo(ul); 
                    }
                    
                };                        
            });

        }
        
        
        function setLineTable(newTable){
            
            POLTable =  $j('#dt_PoLineItems').DataTable({
                "bDestroy":true,
                "bSort":true,
                "dom": '<"top">irt<"bottom"p><"clear">',
                "iDisplayLength":datatableILength,
                "order": [],
                "columnDefs": [
                    {
                        "targets": [ 0 ], // action button
                        "searchable": false,
                        "orderable": false
                    },
                    {//  Amount 
                        "render": function ( data, type, row ) {
                            return formatNumber(data) +' '+ row[13] + ''; 
                        },"targets": 11,
                        type: 'currency' 
                    },
                    {//  Rest Amount 
                        "render": function ( data, type, row ) {
                            return formatNumber(data) +' '+ row[13] + ''; 
                        },"targets": 12,
                        type: 'currency' 
                    },
                    /*
                    { 
                        "visible": false,   //Currency 
                        "targets": [-1]
                    }
                    */
                    { //Introv 20180121
                        "visible": false,   //Currency 
                        "targets": 13
                    }
                    
                ]
                
                
            });
        }
        
        
        function CalAmount(Id){
            var UnitCost=0;
            var Quantity=0;
            var bothvar=false;
            //console.log(Id);  
            
            if(parseFloat($j('#UnitCost_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""))>0){
                UnitCost=parseFloat($j('#UnitCost_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""));
                bothvar=true;
            }else{
                bothvar=false;
            }
            
            if(parseFloat($j('#Quantity_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""))){
                Quantity=parseFloat($j('#Quantity_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""));
                bothvar=true;
            }else{
                bothvar=false;
            }
            //console.log(Quantity);
            if(bothvar){     
                
                $j('#totalAmount_manageAll_' + Id + '_totalAmount input').val((Quantity*UnitCost).toFixed(2));
            }
             calculateSum();
        }
        
        function formatNumber(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function CalAmount1(Id){
            var TotalAmount=0;
            var Quantity=0;
            var bothvar=false;
            var unitCost = 0;
            var Currency = '';
            
            if(parseFloat($j('#totalAmount_manageAll_' + Id + '_totalAmount input').val().replace(/[$,]+/g,""))>0){
                TotalAmount=parseFloat($j('#totalAmount_manageAll_' + Id + '_totalAmount input').val().replace(/[$,]+/g,"")); 
                bothvar=true;
            }else{
                bothvar=false;
            }            
            if(parseFloat($j('#Quantity_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""))>0){
                Quantity=parseFloat($j('#Quantity_manageAll_' + Id + '_input input').val().replace(/[$,]+/g,""));
                bothvar=true;
            }else{
                bothvar=false;
            }
            
            if(bothvar){
                unitCost = parseFloat(TotalAmount/Quantity).toFixed(2);
                Currency = $j('#Currency_manageAll').text();                                
                if($j('#Currency_manageAll').text('KRW')){
                    $j('#UnitCost_manageAll_' + Id + '_input input').val(unitCost);
                }
                else{
                    $j('#UnitCost_manageAll_' + Id + '_input input').val(TotalAmount/Quantity);
                }
            }
            calculateSum();
        }
        
        
        function htmlEncode( input ) {
            var e = document.createElement('div');
            e.innerHTML = input;
            return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
        };
        
        
        $j(document).on('mousemove', function(e){
            $j('#loadtext').css({
                left:  e.pageX,
                top:   e.pageY
            });
        });
        
        $j(document).ready(function() {
            
            initPage({
                headerId: '{!header.Id}',
                CurrencyName: '{!header.ASI_MFM_Currency__c}',// CustomerTypeName:'{!Customer_Developer_Name}',
                SKURCName:'{!SKU_RecordType_Developer_Name}'
            });
        } );
        //EstimatedPRBudgetId
          
        function replaceAll(str, find, replace) {
            return str.replace(new RegExp(find, 'g'), replace);
            
        }

        function calculateSum(){
           var TotalEstimatedPRBudget=0;
            //Estimated PR budget
            var column = api.column(9).data(); 
            for(var i=0;i<column.length;i++){//console.log($j(column[i])[0].outerText);
                var NowAmount=$j(column[i])[0].outerText;
                NowAmount=replaceAll(NowAmount,",", "");
                NowAmount=replaceAll(NowAmount," ", "");
                console.log('NowAmount : '+parseFloat(NowAmount));
                TotalEstimatedPRBudget+=parseFloat(NowAmount);
                
            }
            console.log(TotalEstimatedPRBudget);
            $j('#EstimatedPRBudgetId').html(formatNumber(TotalEstimatedPRBudget.toFixed(totalAmountDecimalPlace)));   
            
            
            
            var sum = 0;
             api.column(13).nodes().to$().each(function(index) {
                $j(this).find('.amount').each(function() { 
                    var columnAmount = $j(this).val().replace(/[$,]+/g,"");//console.log(columnAmount);
                     if(!isNaN(columnAmount) && columnAmount.length!=0) {
                        sum += parseFloat(columnAmount);
                    }
                });
            });
            $j('#totalSum').html(formatNumber(sum.toFixed(totalAmountDecimalPlace)));         
        }
        </script>
        
        <style type="text/css">
            div.hid {display: none;}
            .dateFormat{
            display:none;
            }
            body {
            font-family: Arial;
            font-size: 9pt;
            }
            /* highlight results */ 
            .ui-autocomplete span.hl_results {
            background-color: #ffff66;
            }
            
            /* loading - the AJAX indicator */
            .ui-autocomplete-loading {
            background: white url('/img/loading.gif') right center no-repeat;
            }
            
            
            .ui-autocomplete-input{ 
            //border-left: 3px solid darkred !important;    
            }
            
            .ui-autocomplete {
            height: 200px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            overflow:auto;
            /* add padding to account for vertical scrollbar */
            padding-right: 20px;
            left: 0;
            }
            /* IE 6 doesn't support max-height
            * we use height instead, but this forces the menu to always be this tall
            */
            *html .ui-autocomplete {
            height: 200x;
            }
            
            th { 
            white-space: nowrap; 
            }
            
            
            .amount{
            border-left: 3px solid darkred !important;          
            
            }
            
            .dropdownDiv {
            border-radius: 5px;
            margin-bottom: 5px;
            color: #666;
            display: inline-block;
            padding: 10px;
            
            }
            .headsUpDiv {
            padding: 5px; 
            border-radius: 3px; 
            background-color: rgb(217, 237, 247); 
            color: #31708f; 
            border: 1px solid #9acfea; 
            display: inline-block;
            }
            .div-size {
            height: 30px;
            }
            .btn-round {
            align: center;
            width: 30px;
            height: 30px;
            border-radius: 100% !important;
            font-size: 14px !important;
            padding: 3px !important;
            }
            .btn-size {
            height: 30px;
            }
            
            
            .btn-round.btn-lg {
            width: 48px;
            height: 48px;
            }
            
            .btn-round.btn-sm {
            width: 34px;
            height: 34px;
            }
            
            .btn-round.btn-xs {
            width: 24px;
            height: 24px;
            }
            
            
            .bs.panel-heading.div-size {
            border-radius: 10px;
            }
            
            body {
            font-family: Arial;
            font-size: 9pt;
            }
            
            th { 
            white-space: nowrap; 
            }  
            
            
            .requirefield{
            border-left: 3px solid darkred !important;          
            
            }
            
            .centerNum {
            font-weight:bold;
            text-align: center;
            }
            .rightNum {
            font-weight:bold;
            text-align: right;
            padding-right:5px !important;
            }
            .headerCen {
            text-align: center !important;
            }
              .LookupCss input[type="text"] {
            padding: 5px 10px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 3px;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            
            }

            
        </style>
    </head>
    
    <apex:form id="frm_allForm" styleclass="objectFormCls" >
        <div id="divForm" class="bs container-fluid">
            <div class="bs row" style="margin:0;">
                <div class="bs col-xs-5">  
                    <apex:outputPanel styleclass="bs panel-primary" id="POReceiptDetailPanel">
                        <div class="bs panel-heading div-size" >
                            <h5 class="bs panel-title" >Purchase Order</h5>
                        </div>
                        <div class="bs panel-body">                                           
                            <div class="bs table-responsive" > 
                                <table class="bs table table-condensed">
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.Name.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 5px;"/></td>
                                        <td>
                                            <apex:outputLink value="{!LEFT($Api.Partner_Server_URL_140, FIND('.com/',$Api.Partner_Server_URL_140)+3)}/{!Header.ID}" target="_blank">
                                                <apex:outputField value="{!Header.Name}"></apex:outputField>
                                            </apex:outputLink>
                                        </td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_PO_Raised_Date__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_PO_Raised_Date__c}"></apex:outputField>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Supplier_Name__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_Supplier_Name__c}"></apex:outputField></td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Status__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td> <apex:outputField value="{!Header.ASI_MFM_Status__c}"></apex:outputField> </td>
                                    </tr>
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Plan__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_Plan__c}"></apex:outputField></td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Project_Code__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_Project_Code__c}"></apex:outputField></td> 
                                    </tr>
                                    
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Currency__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td class="Currency_manageAll" id="Currency_manageAll" ><apex:outputField value="{!Header.ASI_MFM_Currency__c}"></apex:outputField></td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_Exchange_Rate__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_Exchange_Rate__c}"></apex:outputField> </td> 
                                    </tr>
                                    
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_PO_Start_Date__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_PO_Start_Date__c}"></apex:outputField> </td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_PO_End_Date__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_PO_End_Date__c}"></apex:outputField></td> 
                                    </tr>
                                    <tr>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_PO_Amount__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_PO_Amount__c}"></apex:outputField> </td>
                                        <td><apex:outputLabel value="{!$ObjectType.ASI_MFM_PO__c.Fields.ASI_MFM_PO_Balance_in_PO_Currency__c.Label}" styleclass="control-label" style="color: #4a4a56; font-size: 9pt; vertical-align: middle; padding-right: 10px;"/> </td>
                                        <td><apex:outputField value="{!Header.ASI_MFM_PO_Balance_in_PO_Currency__c}"></apex:outputField></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </apex:outputPanel>
                </div>
                <div class="bs col-xs-12">  
                    <apex:outputPanel styleclass="bs panel-primary" id="LinePanel">
                        <div class="bs panel-heading div-size" >
                            <h5 class="bs panel-title">PO Line Items</h5>
                        </div>  
                        <div class="bs panel-body">
                            <div id="alertMeg"></div>
                            <div class="alert alert-danger fade in" style="{!IF(UpsertPermission,'display:none;','')}"  id="SaveFailPart">
                                
                                <strong>Error,Can not Save!</strong><br/>
                                <apex:outputText escape="false" value="{!Msg}"/>
                            </div>  
                            
                            
                            <div class="alert alert-success fade in" style="{!IF(SaveSuccess,'','display:none;')}" id="SaveSuccessPart">
                                <strong>Quick Save Success!</strong>
                                <apex:outputText escape="false" value="{!Msg}"/>
                            </div>    
                            
                            <div class='bs wrapper text-center' id='bs toolbar' >
                                <div class="bs btn-group " role="group" >
                                    <apex:commandLink styleClass="bs btn btn-default btn-size" 
                                                      value="Save"
                                                      style="font-weight: bold"
                                                      action="{!saveLinetems}"
                                                      status="ActionStatus"
                                                      onclick="resultTable.page.len( -1 ).draw(false);"
                                                      oncomplete="setResultTable(true);setLineTable(true);"
                                                      reRender="SaveFailPart, SaveSuccessPart, LinePanel, poLinePanel"
                                                      rendered="{!IF(header.ASI_MFM_Status__c=='Draft', true, false)}"
                                                      target="_parent" >
                                        <apex:param name="IS_QUICK_SAVE" value="false"/>
                                    </apex:commandLink>
                                </div>&nbsp;        
                                <div class="bs btn-group " role="group" >
                                    <apex:commandButton styleClass="bs btn btn-default btn-size"
                                                        style="font-weight: bold"
                                                        value="Quick Save"
                                                        action="{!onCommitted}"
                                                        status="ActionStatus"
                                                        onclick="resultTable.page.len( -1 ).draw(false);"
                                                        oncomplete="setResultTable(true);setLineTable(true);"
                                                        reRender="SaveFailPart, SaveSuccessPart, LinePanel, poLinePanel"
                                                        rendered="{!IF(header.ASI_MFM_Status__c=='Draft', true, false)}"
                                                        html-data-loading-text="Loading..." >
                                        <apex:param name="IS_QUICK_SAVE" value="true"/>
                                    </apex:commandButton>
                                </div>&nbsp;
                                <div class="bs btn-group " role="group" >
                                    
                                    <apex:commandButton styleClass="bs btn btn-default btn-size"
                                                        style="font-weight: bold"
                                                        value="Cancel"
                                                        action="{!cancel}" 
                                                        html-data-loading-text="Loading..."
                                                        html-formnovalidate="formnovalidate"/>
                                </div>                             
                            </div>
                            <table id="dt_PaymentLineItems" class="hover responsive no-wrap compact" style="width: 100%;" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>PR Item</th>
                                        <th>Sub-brand</th>
                                        <th>Sub Ledger</th>
                                        <th>A/P Code</th>
                                        <th>Basic POSM</th>
                                        <th>Customer</th>
                                        <th>Venue Where</th>
                                        <th>PR Description</th>
                                        <th>Estimated<br/> PR budget</th>
                                        <th>Unit Cost</th>
                                        <th>Quantity</th>
                                        <th>UOM</th>
                                        <th>Amount</th> 
                                        <th>Delivery Date</th> 
                                        <th>G/L Date</th>
                                        <th>Remark</th>
                                        <th>Consumer Prize</th>  <!-- 20180121 Introv -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:variable value="{!0}" var="i"/>
                                    <apex:repeat value="{!allUpLineMap}" var="PolId">
                                        <apex:variable var="i" value="{!i+1}"/>
                                        <tr>
                                            <td><apex:commandLink styleClass="bs btn btn-default btn-round pull-left btn-sm"
                                                                  style="border: none;background-color: transparent;"
                                                                  reRender="SaveFailPart, SaveSuccessPart, LinePanel, poLinePanel" 
                                                                  action="{!removeLine}"
                                                                  onclick="resultTable.page.len( -1 ).draw(false);"
                                                                  oncomplete="setResultTable(true);setLineTable(true);"
                                                                  status="ActionStatus"
                                                                  immediate="false"
                                                                  title="Remove line {!i}"
                                                                  html-formnovalidate="formnovalidate"
                                                                  html-data-loading-text="Loading..." >
                                                <span class="bs glyphicon glyphicon-trash"  style="color:red;font-size: 20px;"></span>
                                                <apex:param name="PARAM_PORLine_ID" value="{!PolId}" />
                                                </apex:commandLink>
                                                
                                            </td>
                                            <td><apex:outputField value="{!allUpLineMap[PolId].line.ASI_MFM_Purchase_Request_Line__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allUpLineMap[PolId].line.ASI_MFM_Sub_brand_Code__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allUpLineMap[PolId].line.ASI_MFM_KR_subLedger__c}"></apex:outputField></td><!--2015-12-22-->
                                            <td><apex:outputField value="{!allUpLineMap[PolId].line.ASI_MFM_AP_Code__c}"></apex:outputField></td>
                                            <td class="lookupCen" id="SKU_manageAll_{!PolId}_input"   >
                                                <apex:input value="{!allUpLineMap[PolId].SKU}" html-data-id="{!PolId}" html-data-sb="{!allUpLineMap[PolId].line.ASI_MFM_Sub_brand_Code__c}" styleClass="skuCodeClass form-control searchcss input-sm" style="width: 12em; " />
                                                <div class="hid" >
                                                    <apex:inputText value="{!allUpLineMap[PolId].SKUID}" styleclass="value" />
                                                </div>
                                            </td> 
                                            
                                            <td class="lookupCen1">
                                              
                                                <apex:outputLink value="{!LEFT($Api.Partner_Server_URL_140, FIND('.com/',$Api.Partner_Server_URL_140)+3)}/{!allUpLineMap[PolId].CustomerId}">
                                                    <apex:outputText value="{!allUpLineMap[PolId].Customer}" />
                                                </apex:outputLink>
                                                
                                            </td> 
                                            <td class="lookupCen1">
                                                <apex:outputLink value="{!LEFT($Api.Partner_Server_URL_140, FIND('.com/',$Api.Partner_Server_URL_140)+3)}/{!allUpLineMap[PolId].VenueWhereID}">
                                                    <apex:outputText value="{!allUpLineMap[PolId].VenueWhere}" />
                                                </apex:outputLink>
                                            </td>     
                                            <td>{!allUpLineMap[PolId].Description}</td>
                                            <td class="rightNum PORLAvailAmt" >
                                                <apex:outputText value="{0, number, ###,###,###,###,##0.00}"  style="width: 8em" ><apex:param value="{!allUpLineMap[PolId].PORLAvailableAmount}"/></apex:outputText>
                                            </td>
                                            <td class="rightNum UnitCost_manageAll_input" id="UnitCost_manageAll_{!PolId}_input"  >
                                                <apex:inputtext rendered="{!if(Header.ASI_MFM_Project_Code__r.ASI_MFM_Pre_Payment__c,true,false)}" styleclass="bs form-control input-sm"  value="{!allUpLineMap[PolId].line.ASI_MFM_TH_Unit__c}" html-readonly="true"  style="text-align: right;"  ></apex:inputtext>
                                                <apex:inputField rendered="{!if(Header.ASI_MFM_Project_Code__r.ASI_MFM_Pre_Payment__c,false,true)}" value="{!allUpLineMap[PolId].line.ASI_MFM_TH_Unit__c}" onchange="CalAmount('{!PolId}');" styleClass="form-control searchcss input-sm requirefield" style="width: 8em" ></apex:inputField>
                                            </td >
                                            <td  class="rightNum Quantity_manageAll_input" id="Quantity_manageAll_{!PolId}_input" >
                                                <apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_KR_Quantity__c}" onchange="CalAmount('{!PolId}');" styleClass="form-control searchcss input-sm requirefield"  style="width: 8em"  ></apex:inputField>
                                            </td>
                                            
                                            <td><apex:outputText value="{!allUpLineMap[PolId].line.ASI_MFM_UOM__c}"></apex:outputText></td>
                                            
                                            <td class="rightNum totalAmount_manageAll_input" id="totalAmount_manageAll_{!PolId}_totalAmount"  >
                                                 
                                                <apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_Amount__c}"
                                                                 onchange="CalAmount1('{!PolId}');"
                                                                 styleClass="amount form-control searchcss input-sm requirefield"
                                                                 style="width: 10em"   ></apex:inputField>
                                            </td>
                                            <td><apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_Delivery_Date__c}" styleClass="form-control searchcss input-sm input-sm"  style="width: 10em"></apex:inputField>
                                            </td>
                                            <td><apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_G_L_Date__c}" styleClass="form-control searchcss input-sm" style="width: 8em"></apex:inputField></td>
                                            <td><apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_PO_Remark__c}" styleClass="form-control searchcss input-sm" style="width: 15em" ></apex:inputField></td>
                                            <td><!-- 20180121 Introv -->
                                                <apex:inputField value="{!allUpLineMap[PolId].line.ASI_MFM_Consumer_Prize__c}" html-placeholder="Consumer Prize"></apex:inputField>
                                            </td> 
                                        </tr>
                                    </apex:repeat> 
                                </tbody>
                                  <tfoot>
                                    <tr class="summary">
                                        <td colspan='9'></td>
                                        <td colspan='1' ><b>Summary:</b></td>
                                        <td colspan='4' ><span style="float:left;font-size: 120%;" id ='EstimatedPRBudgetId'></span></td>
                                        <td colspan='4' class="numberAmount" ><span style="float:left;font-size: 120%;" id ='totalSum'></span></td>
                                        
                                    </tr>
                                </tfoot>
                                
                            </table>
                            
                        </div>
                    </apex:outputPanel>
                    
                    <!-----------------------------Selected Line-------------------------------->
                    <apex:outputPanel styleclass="bs panel-primary" id="poLinePanel" rendered="{!if(Header.ASI_MFM_Is_Direct_Payment__c=true,false,true)}">
                        <div class="bs panel-heading div-size">
                            <h5 class="bs panel-title">PR Line Items</h5>
                        </div>   
                        <div class="bs panel-body">  
                            <table id="dt_PoLineItems" class="hover responsive no-wrap compact" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>PR Line No</th>
                                        <th>Plan Line Item</th>
                                        <th>Customer</th>
                                        <th>A/P code</th>
                                        <th>A/C code</th>
                                        <th>Sub-Brand</th>
                                        <th>Sub Ledger</th>
                                        <th>UOM</th>
                                        
                                        <th>Quantity</th> 
                                        <th>Description</th>
                                        <th>Estimated PR budget</th>
                                        <th>Remainig Amount</th>
                                        <th>Currency</th>
                                        <th>Consumer Prize</th>  <!-- 20180121 Introv -->
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    <apex:repeat value="{!allDownLineMap}" var="PolIne">
                                        <tr>
                                            <td> <apex:commandLink styleClass="bs btn btn-success btn-round pull-left btn-sm" 
                                                                   style="border: none;background-color: transparent;"
                                                                   action="{!addLineItem}"
                                                                   reRender="SaveFailPart, SaveSuccessPart, LinePanel, poLinePanel" 
                                                                   immediate="false"
                                                                   status="ActionStatus"
                                                                   onclick="resultTable.page.len( -1 ).draw(false);POLTable.page.len( -1 ).draw(false);"
                                                                   oncomplete="setResultTable(true);setLineTable(true);"
                                                                   html-formnovalidate="formnovalidate">
                                                <span class="bs glyphicon glyphicon-plus"  style="color:green;font-size: 20px;"></span>
                                                <apex:param name="PARAM_POLINE_SOURCE_ITEM_ID" value="{!PolIne}" />
                                                </apex:commandLink>
                                            </td>
                                            <td>
                                                <apex:outputLink value="{!LEFT($Api.Partner_Server_URL_140, FIND('.com/',$Api.Partner_Server_URL_140)+3)}/{!allDownLineMap[PolIne].line.id}" target="_blank">
                                                    <apex:outputField value="{!allDownLineMap[PolIne].line.name}"></apex:outputField>
                                                </apex:outputLink>
                                            </td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Plan_Line_Item__c}"></apex:outputField></td>  <!----<td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Purchase_Request__c}"></apex:outputField></td>---->
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Plan_Line_Item__r.ASI_MFM_AccountsAdditionalField__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_AP_Code__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_A_C_Code__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Plan_Line_Item__r.ASI_MFM_Sub_brand_Code__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Plan_Line_Item__r.ASI_MFM_KR_subLedger__c}"></apex:outputField></td><!--2015-12-22-->
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_UOM__c}" ></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Quantity__c}"></apex:outputField></td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Description__c}"></apex:outputField></td>
                                            <td class="rightNum"><apex:outputText value="{0, number, ###,###,###,###,##0.00}"><apex:param value="{!allDownLineMap[PolIne].line.ASI_MFM_Estimated_PR_budget__c}"/></apex:outputText></td>
                                            <td class="rightNum"><apex:outputText value="{0, number, ###,###,###,###,##0.00}"><apex:param value="{!allDownLineMap[PolIne].line.ASI_MFM_Rest_Amount__c}"/></apex:outputText></td>
                                            <td>{!allDownLineMap[PolIne].line.ASI_MFM_Purchase_Request__r.ASI_MFM_Currency__c}</td>
                                            <td><apex:outputField value="{!allDownLineMap[PolIne].line.ASI_MFM_Consumer_Prize__c}"></apex:outputField></td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                               
                                
                            </table>
                        </div>
                    </apex:outputPanel>             
                </div>
            </div>
        </div>
        
        <apex:actionstatus id="ActionStatus">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb;
                                                                     height: 100%; width:100%; opacity:0.65;"> 
                    <div class="waitingHolder" id="loadtext" style="position: absolute;" align="left" valign="top">
                        &nbsp;&nbsp;&nbsp;
                        <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                        <span class="waitingDescription">Please Wait...</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>
    </apex:form>
    
    
</apex:page>