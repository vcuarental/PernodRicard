<apex:page standardController="ASI_HK_CRM_Visitation_Plan_Detail__c" extensions="ASI_CRM_TW_SalesCallPlanPageCtrl" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false" cache="false" showHeader="false" standardStylesheets="false" action="{!dateValidation}" id="apexPage">
<html> 
<head> 
    <title>拜訪日報</title>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/> 
    <apex:stylesheet value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/css/app.min.css')}"/>       
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/jQuery2.0.2.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/jquery.touchwipe.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ASI_CRM_TW_MobileDesignTemplates, 'common/js/main.min.js')}"/>
    
    <script src="{!URLFOR($Resource.ASI_CRM_TW_jQuery, 'jquery-1.11.1.min.js')}"></script>

    <!-- Salesforce1 -->    
    <apex:includeScript value="/canvas/sdk/js/publisher.js" />

    <!-- CSS goes in the document HEAD or added to your external stylesheet -->
    <style type="text/css">
        .number_of_mouth{width:10%;height:20px}
        table a:link {
            color: #666;
            //font-weight: bold;
            text-decoration:underline;
        }
        table a:visited {
            color: #999999;
            font-weight:bold;underline;
        }
        table a:active,
        table a:hover {
            color: #bd5a35;
            text-decoration:underline;
        }
        table {
            font-family:Century Gothic, sans-serif, Microsoft JhengHei;
            color:#666;
            font-size:10px;
            text-shadow: 1px 1px 0px #fff;
            background:#eaebec;
            
            //border:#ccc 1px solid;
        
            -moz-border-radius:10px;
            -webkit-border-radius:10px;
            border-radius:10px;
        
            -moz-box-shadow: 0 1px 2px #d1d1d1;
            -webkit-box-shadow: 0 1px 2px #d1d1d1;
            box-shadow: 0 1px 2px #d1d1d1;          
        }
        table th {
            padding:5px 10px 5px 10px;
            //border-top:1px solid #fafafa;
            //border-bottom:1px solid #e0e0e0;
        
            //background: #ddeeff;
            //background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));
            //background: -moz-linear-gradient(top,  #FF9966,  #FF9966);
        }
        table th:first-child {
            text-align: left;
            padding-left:20px;
        }
        table tr:first-child th:first-child {
            -moz-border-radius-topleft:10px;
            -webkit-border-top-left-radius:10px;
            border-top-left-radius:10px;
        }
        table tr:first-child th:last-child {
            -moz-border-radius-topright:10px;
            -webkit-border-top-right-radius:10px;
            border-top-right-radius:10px;
        }
        table tr {
            text-align: center;
            padding-left:20px;
        }
        table td:first-child {
            text-align: left;
            padding-left:20px;
            border-left: 0;
        }
        table td {
            padding:13px;
            //border-top: 1px solid #ffffff;
            //border-bottom:1px solid #e0e0e0;
            //border-left: 1px solid #e0e0e0;
        
            background: #fafafa;
            background: -webkit-gradient(linear, left top, left bottom, from(#fbfbfb), to(#fafafa));
            background: -moz-linear-gradient(top,  #fbfbfb,  #fafafa);
        }
        table tr.even td {
            background: #f6f6f6;
            background: -webkit-gradient(linear, left top, left bottom, from(#f8f8f8), to(#f6f6f6));
            background: -moz-linear-gradient(top,  #f8f8f8,  #f6f6f6);
        }
        table tr:last-child td {
            border-bottom:0;
        }
        table tr:last-child td:first-child {
            -moz-border-radius-bottomleft:10px;
            -webkit-border-bottom-left-radius:10px;
            border-bottom-left-radius:10px;
        }
        table tr:last-child td:last-child {
            -moz-border-radius-bottomright:10px;
            -webkit-border-bottom-right-radius:10px;
            border-bottom-right-radius:10px;
        }
        table tr:hover td {
            //background: #f2f2f2;
            background: -webkit-gradient(linear, left top, left bottom, from(#E0ECF8), to(#E0ECF8));
            //background: -moz-linear-gradient(top,  #f2f2f2,  #f0f0f0);  
        }
        table.gridtable {
            width: 100%;
            margin-left:auto; 
            margin-right:auto;
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
            font-size:14px;
            color:#333333;
            //border-width: 1px;
            //border-color: #666666;
            border-collapse: collapse;
        }
        table.gridtable th {
            //border-width: 1px;
            //padding: 8px;
            //border-style: solid;
            //border-color: #666666;
            //background-color: #dedede;
            font-weight: bold;
            background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));
        }
        table.gridtable td {
            //border-width: 1px;
            //padding: 8px;
            //border-style: solid;
            //border-color: #666666;
            background-color: #ffffff;
        }
        .hBanner {
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
            font-size: 16px;
            color: #333;
            line-height: 90%;
            margin: .2em 0 .4em 0; 
            text-decoration-line: underline;
            border-bottom:1px dotted;
        }
        fieldset {
            border-style:none;
        }
        label {
            display:inline-block;
            cursor:pointer;
            //position:relative;
            //padding-left:25px;
            //margin-right:3px;
            font-size:13px;
            margin-left:-8px;
        }        
        .wrapper {
            width:150px;
            margin:0;
        }
        .myButton {
            -moz-box-shadow:inset 0px 1px 0px 0px #ffffff;
            -webkit-box-shadow:inset 0px 1px 0px 0px #ffffff;
            box-shadow:inset 0px 1px 0px 0px #ffffff;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #f9f9f9), color-stop(1, #e9e9e9));
            background:-moz-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-webkit-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-o-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:-ms-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
            background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
            filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f9f9f9', endColorstr='#e9e9e9',GradientType=0);
            background-color:#f9f9f9;
            -moz-border-radius:6px;
            -webkit-border-radius:6px;
            border-radius:6px;
            border:1px solid #dcdcdc;
            display:inline-block;
            cursor:pointer;
            color:#666666;
            font-size:15px;
            padding:5px 15px;
            text-decoration:none;
            text-shadow:0px 1px 0px #ffffff;
            font-family: Century Gothic, sans-serif, Microsoft JhengHei;
        }
        .myButton:hover {
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #e9e9e9), color-stop(1, #f9f9f9));
            background:-moz-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-webkit-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-o-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:-ms-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
            background:linear-gradient(to bottom, #e9e9e9 5%, #f9f9f9 100%);
            filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#e9e9e9', endColorstr='#f9f9f9',GradientType=0);
            background-color:#e9e9e9;
        }
        .myButton:active {
            position:relative;
            top:1px;
        }
    </style>
    <script type="text/javascript">
        var isClicked = false;
        
        function OnRowClick(row) {
            document.getElementById("{!$Component.apexPage.formSalesCallPlan.hdnField}").value = row.rowIndex;    
        }
        function checkDoubleSubmit(obj){
            if (isClicked) {
                return false;
            }else {
                isClicked = true;
                obj.className = 'btnDisabled';//only shows the button as disabled.
                refreshCurrentTab();
                return true;
            }
        }
    
    //20171127 Introv
    function removeSecond(that){
        
        that.value = that.value.substring(0, 16);
    }
    </script>
</head> 
<body>

<div data-role="page">
    <div data-role="content">
        <apex:form id="formSalesCallPlan" enctype="multipart/form-data">
        <apex:inputHidden id="hdnField" value="{!theRow}"/>
        <section class="border-bottom">
            <div class="content">
                <table class="gridtable">
                    <th>實際開始時間</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));"><apex:input type="datetime-local" value="{!VisitDateF}" onchange="removeSecond(this)" /></td>

                    <th>實際結束時間</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF));"><apex:input type="datetime-local" value="{!VisitDateT}" onchange="removeSecond(this)" /></td>
                    
                    <th>擇期原因</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); -moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px"><apex:input type="text" value="{!strCxlReason}" /></td>
                    
                    <th>取消原因</th>
                    <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); -moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px"><apex:inputField value="{!objVisitPlanDetail.ASI_CRM_Cancel_Reason__c}" /></td>
                    
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>拜訪目的</th>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#EAEAEA), to(#FFFFFF)); width: 80%;-moz-border-radius-topright: 10px;-webkit-border-top-right-radius: 10px;border-top-right-radius: 10px; -moz-border-radius-bottomright: 0px;-webkit-border-bottom-right-radius: 0px;border-bottom-right-radius: 0px;" > 
                            <apex:input type="text" value="{!strObjective}" />
                        </td>
                    </tr>
                </table>
                <table class="gridtable">
                    <tr>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#FFFFFF)); width: 80%" rowspan="2"> 
                            <apex:inputTextarea value="{!strRemarks}"/>
                        </td>
                        <td style="background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#FFFFFF))">
                            <apex:commandButton styleclass="myButton" action="{!quickSave}" value="儲存" onclick="return checkDoubleSubmit(this)" rendered="{!allowEdit}" />
                            <apex:commandButton styleclass="myButton" action="{!Save}" value="提交" onclick="return checkDoubleSubmit(this)" rendered="{!allowEdit}" style="margin-top: 6px" />
                        </td>
                    </tr>
                </table>

                <!-- <apex:pageMessages id="pageMsgs" /> -->
                <apex:messages id="pageMsgs" styleClass="error" style="color: red" />
        
                <div style="width: 100%">
                    
                </div>
            </div>
        </section>
       
        <div id="tabbed-list-view-nav" class="tabbed-list-view-nav">
            <a href="#" class="{!If (CurrentPage == '0', 'span-25 on', 'span-25')}">Page 1</a>
            <a href="#" class="{!If (CurrentPage == '1', 'span-25 on', 'span-25')}">Page 2</a>
            <a href="#" class="{!If (CurrentPage == '2', 'span-25 on', 'span-25')}">Page 3</a>
            <a href="#" class="span-25">Page 4</a>
        </div>
        
        <ul class="tabbed-list-view slide-{!CurrentPage}">
            <li>
                <!-- Start of Page 1 -->
                 <br/>
                <span class="hBanner">步驟 1. 計劃 &amp; 準備</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>客戶代碼</th>
                        <th>區</th>
                        <th>客戶名稱</th>
                        <th>次通路</th>
                        <th>地址</th>
                        <th>電話</th>
                        <th>業務員</th>
                    </tr>
                    <tr>
                        <td><apex:outputLink value="{!URLFOR($Action.Account.Edit, objAccount.id)}" target="_blank">{!objAccount.ASI_KOR_Customer_Code__c}</apex:outputLink></td>
                        <td>{!objAccount.ASI_TH_CRM_Region__c}</td>
                        <td>{!objAccount.Name}</td>
                        <td>{!objAccountAddt.ASI_CRM_CN_Sub_Channel__r.Name}</td>
                        <td>{!objAccount.ASI_HK_CRM_Address__c}</td>
                        <td>{!objAccount.Phone}</td>
                        <td>{!objAccount.Owner.Name}</td>
                    </tr>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th style="background:#EAEAEA">Year</th>
                        <th colspan="4" style="background:#EAEAEA">月銷量</th>
                        <th style="background:#EAEAEA">形象指標</th>
                        <th style="background:#EAEAEA">銷售潛力</th>
                    </tr>
                    <tr>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th>PRT 銷量</th>
                        <th>PRT 佔比</th>
                        <th>總銷量</th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <apex:repeat value="{!lstSVCon}" var="objSalesVolCon">
                    <tr>
                        <td>{!objSalesVolCon.strRecDate}</td>
                        <td>{!objSalesVolCon.strType}</td>
                        <td>{!objSalesVolCon.decVol}</td>
                        <td>{!objSalesVolCon.strShare}</td>
                        <td>{!objSalesVolCon.decTotal}</td>
                        <apex:variable value="v1" var="" rendered="{!allowSetup}"><td>{!objAccountAddt.ASI_TH_CRM_OutletImage__r.Name}</td></apex:variable>
                        <apex:variable value="v2" var="" rendered="{!!allowSetup}"><td><font color="red">空白</font></td></apex:variable>
                        <td>{!objAccountAddt.ASI_CRM_Sales_Potential__c}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th style="background:#EAEAEA">最近訪查日期</th>
                        <th colspan="4" style="background:#EAEAEA">月銷量</th>
                        <th style="background:#EAEAEA">形象指標</th>
                        <th style="background:#EAEAEA">銷售潛力</th>
                    </tr>
                    <tr>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th>PRT 銷量</th>
                        <th>PRT 佔比</th>
                        <th>總銷量</th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <apex:repeat value="{!lstSVCal}" var="objSalesVolCal">
                    <tr>
                        <td>{!objSalesVolCal.strRecDate}</td>
                        <td>{!objSalesVolCal.strType}</td>
                        <td>{!objSalesVolCal.decVol}</td>
                        <td>{!objSalesVolCal.strShare}</td>
                        <td>{!objSalesVolCal.decTotal}</td>
                        <apex:variable value="v1" var="" rendered="{!allowSetup}"><td>{!objAccountAddt.ASI_TH_CRM_OutletImage__r.Name}</td></apex:variable>
                        <apex:variable value="v2" var="" rendered="{!!allowSetup}"><td><font color="red">空白</font></td></apex:variable>
                        <td>{!strCalSalesPotential}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>Key man</th>
                        <th>職稱</th>
                        <th>生日</th>
                        <th>行動電話</th>
                        <th>信箱</th>
                    </tr>
                    <apex:repeat value="{!objAccount.Contacts}" var="Contact">
                    <tr>
                        <td><apex:outputLink value="{!URLFOR($Action.Contact.Edit, Contact.id)}" target="_blank">{!Contact.Name}</apex:outputLink></td>
                        <td>{!Contact.Title}</td>
                        <td><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                            <apex:param value="{!Contact.Birthdate}" /> 
                        </apex:outputText></td>
                        <td>{!Contact.MobilePhone}</td>
                        <td>{!Contact.Email}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable" style="{!IF(!allowEdit,'display:none','')}">
                    <tr>
                        <th>General Photos</th>                        
                    </tr>
                </table>
                <div style="float: left; width:25%;{!IF(!allowEdit,'display:none','')}">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 1)" />
                    <div id="divFileGeneralMsg"></div>
                </div>
                
                <!--<div class="hBanner">&nbsp;&nbsp;General Photos</div>
                <div style="float: left; width:25%">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 1)" />
                    <div id="divFileGeneralMsg"></div>
                </div>-->
                <br/>
                <br/>

                <div style="float: right;">
                    <input type="button" class="myButton" value="添加聯絡人" onclick="window.open('{!URLFOR( $Action.Contact.NewContact , $ObjectType.Contact ,[accid= objAccount.Id ])}&retURL={!objAccount.Id}', '_blank');" style="{!IF(!allowEdit,'display:none','')}" />
                </div> 
                <div style="float: right;">&nbsp;&nbsp;</div>               
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">     
                    <apex:commandlink target="_blank" action="{!outletImageSetup}"><!-- style="{!IF(allowSetup,'display:none','')}"--> 
                        <apex:commandButton styleclass="myButton" value="店形象設置"/>
                    </apex:commandlink><br/><br/>               
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 1 -->
            </li>
            <li>
                <!-- Start of Page 2 -->
                <br/>
                <span class="hBanner">步驟 2. 問候/ 步驟 3. 追踪銷售進度</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>品牌</th>
                        <th>優先權</th>
                        <th>Offtake<br/>{!LastOfftakeYear}年{!LastOfftakeMonth}月</th>
                        <th>鋪貨</th>
                        <th>排面</th>
                        <th>
                            <apex:outputText value="OFF - 標價 / ON- 進店價" rendered="{!strChannelCode != 'CVS'}">
                            </apex:outputText>
                        </th>
                        <th>實際售價</th>
                        <th>庫存</th>
                        <th>銷量(bot.)<br/>{!LastDepletionYear}年{!LastDepletionMonth}月</th>
                    </tr>
                    <apex:repeat value="{!lstSalesMovnt}" var="objSalesMovnt">
                    <tr>
                        <td>{!objSalesMovnt.strSubBrand}</td>
                        <td>{!objSalesMovnt.strPriority}</td>
                        <td>{!objSalesMovnt.decQTDPurchase}</td>
                        <td>
                            <apex:selectRadio value="{!objSalesMovnt.strSalesMovntOpt}" style="width:170px;">
                                <apex:selectOptions value="{!SalesMovntOpt}" />
                                <!--<apex:selectOption itemLabel="Yes" itemValue="Y"/>
                                <apex:selectOption itemLabel="No" itemValue="N"/>-->
                            </apex:selectRadio>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decFacing}" id="decFacing" rendered="{!LEN(objSalesMovnt.strErrorMessageFacing)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageFacing)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decFacing}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageFacing}</div>
                            </apex:outputPanel>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decListPrice}" id="decListPrice" rendered="{!LEN(objSalesMovnt.strErrorMessageListPrice)==0 && strChannelCode != 'CVS'}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageListPrice)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decListPrice}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageListPrice}</div>
                            </apex:outputPanel>
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decActualRSP}" id="decActualRSP" rendered="{!LEN(objSalesMovnt.strErrorMessageActualRSP)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageActualRSP)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decActualRSP}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageActualRSP}</div>
                            </apex:outputPanel>                        
                        </td>
                        <td>
                            <apex:input value="{!objSalesMovnt.decCurrentStock}" id="decCurrentStock" rendered="{!LEN(objSalesMovnt.strErrorMessageCurrentStock)==0}" type="number"/>
                            <apex:outputPanel rendered="{!LEN(objSalesMovnt.strErrorMessageCurrentStock)!=0}">
                                 <apex:input styleClass="error" value="{!objSalesMovnt.decCurrentStock}" type="number"/>
                                 <div style="color: red;"><strong>Error:</strong>&nbsp;{!objSalesMovnt.strErrorMessageCurrentStock}</div>
                            </apex:outputPanel>                        
                        </td>
                        <td>{!objSalesMovnt.decTurnoverBotl}</td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <table class="gridtable" style="{!IF(!allowEdit,'display:none','')}">
                    <tr>
                        <th>Merchan Photos</th>                        
                    </tr>
                </table>
                <div style="float: left; width:25%;{!IF(!allowEdit,'display:none','')}">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 2)" />
                    <div id="divFileMerchanMsg"></div>
                </div>
                <br/>
                <br/>
                <!--<div class="hBanner">&nbsp;&nbsp;Merchan Photos</div>
                <div style="float: left; width:25%">
                    <input type="file" onchange="fileChosen(this, '{!strVPID}', 2)" />
                    <div id="divFileMerchanMsg"></div>
                </div>-->
                
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">
                    <input type="button" class="myButton" value="月銷售調查" onClick="window.open('/apex/asi_crm_tw_marketsurvey_page?accountId={!objAccount.Id}&channelCode={!strChannelCode}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div> 
                <div style="float: right;">&nbsp;&nbsp;</div>               
                <div style="float: right; {!IF(!allowEdit,'display:none','')}">
                    <input type="button" class="myButton" value="瓶頭回收" onClick="window.open('/apex/ASI_CRM_TW_CapCollection_Page?accountId={!objAccount.Id}&channelCode={!strChannelCode}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 2 -->
            </li>
            <li>
                <!-- Start of Page 3 -->
                <br/>
                <span class="hBanner">步驟 4. 佈達活動與活動執行進度追蹤/ 步驟 5. 取得訂單</span>
                <br/>
                <br/>
                <br/>
                <apex:pageBlock id="suppliertableid">
                    <table class="gridtable" id="gridtableid">
                        <tr>
                            <th width='2%'></th>
                            <th width='10%'>活動代碼</th>
                            <th width='25%'>活動名稱</th>
                            <th width='8%'>活動期間</th>
                            <th width='8%'>採購期限</th>
                            <th width='12%'>參與活動</th>
                            <!--<th>單位/口</th>-->
                            <th width='30%'>供貨商</th>
                            <th width='5%'></th>
                        </tr>
                        <apex:repeat value="{!lstPromoStatus}" var="objPromoStatus">
                        <tr onmouseover="OnRowClick(this)">
                            <td>
                                <apex:commandButton styleclass="myButton" value="x" action="{!RemoveRow}" rerender="suppliertableid" rendered="{!allowEdit}"/>
                            </td>
                            <td>
                                <apex:outputLink value="{!URLFOR($Action.Attachment.Download, objPromoStatus.idAttachment)}" target="_blank" rendered="{!If(objPromoStatus.idAttachment == null,false,true)}"> {!objPromoStatus.strPromo}</apex:outputLink>
                                <apex:outputText rendered="{!If(objPromoStatus.idAttachment == null,true,false)}">{!objPromoStatus.strPromo}</apex:outputText>
                            </td>
                            <td>{!objPromoStatus.strDesc}</td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dteStart}" /> 
                                </apex:outputText>
                                <br/>
                                <apex:outputText >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至</apex:outputText>
                                <br/>
                                <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                    <apex:param value="{!objPromoStatus.dteEnd}" /> 
                                </apex:outputText>
                            </td>
                            <td style="width: 90px;"><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!objPromoStatus.dtePurchaseDue}" /> 
                            </apex:outputText></td>
                            <td>
                                <div>
                                    <apex:input value="{!objPromoStatus.decOfferUnit}" id="decOfferUnit" rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)==0}" type="number" style="width: 70%;"/>&nbsp;口
                                    <apex:outputPanel rendered="{!LEN(objPromoStatus.strErrorMessageOfferUnit)!=0}">
                                         <apex:input styleClass="error" value="{!objPromoStatus.decOfferUnit}" type="number"/>
                                         <div style="color: red;"><strong>Error:</strong>&nbsp;{!objPromoStatus.strErrorMessageOfferUnit}</div>
                                    </apex:outputPanel>      
                                </div>
                            </td>
                            <td>         
                                <div style="float: center;">                   
                                    <apex:selectList value="{!objPromoStatus.idSupplier}" size="1" label="">
                                        <apex:selectOptions value="{!supplierList}"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                            </td>
                            <td>
                                <div style="float: left ;display:inline-block">
                                    <apex:commandButton styleclass="myButton" value="增加" action="{!AddRow}" rerender="suppliertableid" rendered="{!allowEdit}"/>
                                </div>                           
                            </td>
                        </tr>
                        </apex:repeat>
                    </table>
                </apex:pageblock>

                <br/>
                <div style="float: right">
                    <input type="button" class="myButton" value="Brand Portfolio" onClick="window.open('https://pernod-ricard.my.salesforce.com/_ui/core/chatter/groups/GroupProfilePage?g=0F9D0000000Uc63');"/>
                    <!-- <apex:commandButton value="Purchase Order" /> -->
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 3 -->
            </li>
            <li>
                <!-- Start of Page 4 -->
                <br/>
                <span class="hBanner">步驟 6. 檢查平行輸入/ 步驟 7. 結束拜訪 &amp; 記錄</span>
                <br/>
                <br/>
                <br/>
                <table class="gridtable">
                    <tr>
                        <th>日期</th>
                        <th>品牌</th>
                        <th>容量</th>
                        <th>擺放處</th>
                        <th>進口商</th>
                        <th>酒精度</th>
                        <th>發現數量</th>
                        <th>預估數量</th>
                        <th style="{!IF(!allowEdit,'display:none','')}">GMA Photo</th>
                    </tr>
                    <apex:repeat value="{!lstGMARec}" var="objGMA">
                    <tr>
                        <td><apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                            <apex:param value="{!objGMA.dteDate}" /> 
                        </apex:outputText></td>
                        <td>{!objGMA.strSubBrand}</td>
                        <td>{!objGMA.strSize}</td>
                        <td>{!objGMA.strDisplay}</td>
                        <td>{!objGMA.strImporter}</td>
                        <td>{!objGMA.decAlcholo}</td>
                        <td>{!objGMA.decVol}</td>
                        <td>{!objGMA.decEstVol}</td>
                        <td style="{!IF(!allowEdit,'display:none','')}">
                            <input type="file" onchange="fileChosen(this, '{!objGMA.idRec}', 3)" />
                            <div id="divFileGMAMsg_{!objGMA.idRec}"></div>
                        </td>
                    </tr>
                    </apex:repeat>
                </table>
                <br/>
                <div style="float: right;">
                    <input type="button" class="myButton" value="New GMA" onClick="window.open('/a6V/e?{!GMAtoVPDId}={!objVisitPlanDetail.Name}&{!GMAtoVPDId}_lkid={!objVisitPlanDetail.Id}&{!GMAtoAccId}={!encodedAccountName}&{!GMAtoAccId}_likd={!objAccount.id}&retURL=%2F{!objVisitPlanDetail.Id}');" style="{!IF(!allowEdit,'display:none','')}"/>
                </div>
                <div style="float: right; width: 10%">
                    &nbsp;
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <!-- End of Page 4 -->
            </li>
        </ul><!--.tabbed-list-view-->
        </apex:form>

    </div><!-- /content -->
</div><!-- /page -->

<script type="text/javascript">
    var maxStringSize = 6000000;    //Maximum String size is 6,000,000 characters
    var maxFileSize = 4350000;      //After Base64 Encoding, this is the max file size
    var chunkSize = 950000;         //Maximum Javascript Remoting message size is 1,000,000 characters
    var file;
    var attachment;
    var attachmentName;
    var fileSize;
    var positionIndex;
    var doneUploading;
    j$ = jQuery.noConflict();
    
    function fileChosen(fileChosenEvent, parentRecId, pType) {
        
        // Get file
        file = fileChosenEvent.files[0];
        
        // Is it an image?
        if(!file.type.match('image')) {
            alert('Must use an image! Received: ' + file.type);
            return;
        }
        console.log(file);
        
        if(file.size <= maxFileSize) {
            attachmentName = file.name;
            var fileReader = new FileReader();
            
            fileReader.onload = function(readerEvent) {
                if (pType == 2)
                    attachmentName = 'Merchan_' + file.name;
                else if (pType == 3)
                    attachmentName = 'GMA_' + file.name;
                else
                    attachmentName = 'General_' + file.name;
                
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext("2d");
                
                var img = new Image();
                img.onload = function (imageEvent) {
                    var W = img.width;
                    var H = img.height;
                    var ratio = W/H;
                    canvas.width = W;
                    canvas.height = H;
                    ctx.drawImage(img, 0, 0); //draw image
                    if(W>=H)
                        resample_hermite(canvas, W, H, 320, 320/ratio);
                    else
                        resample_hermite(canvas, W, H, 320*ratio, 320);
                }
                img.src = readerEvent.target.result;
            }
            fileReader.readAsDataURL(file);  //Read the body of the file
            
            function resample_hermite(canvas, W, H, W2, H2){
                var time1 = Date.now();
                W2 = Math.round(W2);
                H2 = Math.round(H2);
                var img = canvas.getContext("2d").getImageData(0, 0, W, H);
                var img2 = canvas.getContext("2d").getImageData(0, 0, W2, H2);
                var data = img.data;
                var data2 = img2.data;
                var ratio_w = W / W2;
                var ratio_h = H / H2;
                var ratio_w_half = Math.ceil(ratio_w/2);
                var ratio_h_half = Math.ceil(ratio_h/2);
                
                for(var j = 0; j < H2; j++){
                    for(var i = 0; i < W2; i++){
                        var x2 = (i + j*W2) * 4;
                        var weight = 0;
                        var weights = 0;
                        var weights_alpha = 0;
                        var gx_r = gx_g = gx_b = gx_a = 0;
                        var center_y = (j + 0.5) * ratio_h;
                        for(var yy = Math.floor(j * ratio_h); yy < (j + 1) * ratio_h; yy++){
                            var dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
                            var center_x = (i + 0.5) * ratio_w;
                            var w0 = dy*dy //pre-calc part of w
                            for(var xx = Math.floor(i * ratio_w); xx < (i + 1) * ratio_w; xx++){
                                var dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                                var w = Math.sqrt(w0 + dx*dx);
                                if(w >= -1 && w <= 1){
                                    //hermite filter
                                    weight = 2 * w*w*w - 3*w*w + 1;
                                    if(weight > 0){
                                        dx = 4*(xx + yy*W);
                                        //alpha
                                        gx_a += weight * data[dx + 3];
                                        weights_alpha += weight;
                                        //colors
                                        if(data[dx + 3] < 255)
                                            weight = weight * data[dx + 3] / 250;
                                        gx_r += weight * data[dx];
                                        gx_g += weight * data[dx + 1];
                                        gx_b += weight * data[dx + 2];
                                        weights += weight;
                                        }
                                    }
                                }       
                            }
                        data2[x2]     = gx_r / weights;
                        data2[x2 + 1] = gx_g / weights;
                        data2[x2 + 2] = gx_b / weights;
                        data2[x2 + 3] = gx_a / weights_alpha;
                        }
                    }
                console.log("hermite = "+(Math.round(Date.now() - time1)/1000)+" s");
                canvas.getContext("2d").clearRect(0, 0, Math.max(W, W2), Math.max(H, H2));
                canvas.width = W2;
                canvas.height = H2;
                canvas.getContext("2d").putImageData(img2, 0, 0);
                
                //attachment = window.btoa(this.result);  //Base 64 encode the file before sending it
                attachment = canvas.toDataURL();
                attachment = attachment.substring(attachment.indexOf(',')+1,attachment.length);
                //alert(attachment);
                
                positionIndex=0;
                fileSize = attachment.length;
                console.log("Total Attachment Length: " + fileSize);
                doneUploading = false;
                if(fileSize < maxStringSize) {
                    uploadAttachment(parentRecId, pType, null);
                } else {
                    alert("Base 64 Encoded file is too large.  Maximum size is " + maxStringSize + " your file is " + fileSize + ".");
                }
            }
        } else {
                alert("File must be under 4.3 MB in size.  Your file is too large.  Please try again.");
        }
    }

    function uploadAttachment(parentRecId, pType, fileId) {
        var attachmentBody = "";
        if(fileSize <= positionIndex + chunkSize) {
            attachmentBody = attachment.substring(positionIndex);
            doneUploading = true;
        } else {
            attachmentBody = attachment.substring(positionIndex, positionIndex + chunkSize);
        }
        
        if (pType == 2)
            j$('#divFileMerchanMsg').text('Uploading Merchan Photo, please wait...');
        if (pType == 3)
            j$('#divFileGMAMsg_' + parentRecId).text('Uploading GMA Photo, please wait');
        if (pType == 1)
            j$('#divFileGeneralMsg').text('Uploading General Photo, please wait');
        
        console.log("Uploading " + attachmentBody.length + " chars of " + fileSize);
        ASI_CRM_TW_SalesCallPlanPageCtrl.insertAttachment(parentRecId, attachmentBody, attachmentName, pType, fileId, 
        function(result, event) {
            console.log(result);
            if(event.type === 'exception') {
                console.log("exception");
                console.log(event);
            } else if(event.status) {
                if(result.substring(0,3) == '00P') {
                    if(doneUploading == true) {
                        if (pType == 2)
                            j$('#divFileMerchanMsg').text('Merchan Photo Upload Successful');
                        if (pType == 3)
                            j$('#divFileGMAMsg_' + parentRecId).text('GMA Photo Upload Successful');
                        if (pType == 1)
                            j$('#divFileGeneralMsg').text('General Photo Upload Successful');
                        //alert(result);
                    } else {
                        positionIndex += chunkSize;
                        uploadAttachment(parentRecId, pType, result);
                    }
                }
            } else {
                console.log(event.message);
            }
        },
        {buffer: true, escape: true, timeout: 120000}
        );
    }
</script>

</body>
</html>
</apex:page>