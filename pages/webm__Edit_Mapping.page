<apex:page standardController="webm__Webmerge_Mapping__c" extensions="webm.WebmergeMappingExtension" title="Edit Formstack Mapping" readOnly="false">
 
    <!-- <apex:stylesheet value="{!$Resource.vfbootstrap}"/> -->
	<apex:stylesheet value="{!URLFOR($Resource.webm__SLDS080, 'assets/styles/salesforce-lightning-design-system-vf.min.css')}"/>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    
    <style>
    	.radio-option{
    		margin-left: 15px;
    	}
    	.radio-option label {
    		font-weight:normal !important;
    	}
    	
    	input[type=radio] {
    		margin-right:4px !important;
    		margin-left:4px !important;
    	}
    	
    	.slds-form-element {
			margin-bottom: 1.5em;
		}
		
		.radio-table {
			width:auto !important;
		}
		
		.radio-table td {
			padding: .5em;
		}
		
		.hidden {
			display: none;
		}
    </style>
    
    <div class="slds">
        <div class="slds-page-header">
		  <div class="slds-grid">
		    <div class="slds-col slds-has-flexi-truncate">
		      <div class="slds-media">
		        <div class="slds-media__figure">
		          <img src="https://www.webmerge.me/images/favicon.png" style="max-height:50px;" />
		        </div>
		        <div class="slds-media__body">
		          <p class="slds-text-heading--label">Formstack Documents</p>
		          <div class="slds-grid">				            
		            <h1 class="slds-text-heading--medium slds-m-right--small slds-truncate slds-align-middle">
		            	Update Mapping
		           	</h1>
		          </div>
		        </div>
		      </div>
		    </div>
		  </div>
		</div>
            
        <apex:outputPanel rendered="{!NOT(loggedIn)}">
			<div class = "slds-grid slds-col--padded">
				<div role="alert" class="slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture">
					<span class="slds-assistive-text">Error</span>
					<h2>
						<span><strong>Uh oh!</strong> You're not logged in to Formstack. <apex:outputLink value="/apex/Webmerge_Settings">Enter your API Keys to get started</apex:outputLink></span>
					</h2>
				</div>
		    </div>
		</apex:outputPanel>
		
        
          <apex:outputPanel rendered="{!loggedIn}">
              <apex:form styleClass="slds-form--stacked slds-wrap slds-m-top--large">
              <div class = "slds-grid slds-col--padded">
                  <div class = "slds-large-size--8-of-12">
                                          
                          <div class="slds-form-element">
                              <label class="slds-form-element__label">Mapping ID</label><br />
                              <div class="slds-form-element__control">
                              	{!Webmerge_Mapping__c.Id}
                          	  </div>
                          </div>        
                          <div class="slds-form-element">
                              <label class="slds-form-element__label">Mapping Name</label><br />
                              <div class="slds-form-element__control">
                              	<apex:inputField value="{!webm__Webmerge_Mapping__c.Name}" styleClass="slds-input" html-placeholder="Mapping Name" html-maxlength="80" />
                          	  </div>
                          </div>
                              
                          <div class="slds-form-element">
                              <label class="slds-form-element__label">Description</label><br />
                              <div class="slds-form-element__control">
                                <apex:inputTextArea value="{!webm__Webmerge_Mapping__c.webm__Description__c}" styleClass="slds-textarea"  html-placeholder="Mapping Description" html-maxlength="255"/>
                          	  </div>
                          </div>
                          
                          <div class="slds-form-element">
                              <label class="slds-form-element__label">Salesforce Object</label><br />
                              <div class="slds-form-element__control">
	                              <apex:selectList value="{!webm__Webmerge_Mapping__c.webm__Salesforce_Object_Name__c}" size="1" styleClass="slds-select">
	   							    <apex:selectOptions value="{!supportedObjects}" />
	   							  </apex:selectList>
	   						  </div>
                          </div>
                                                          
                          <div class = "slds-form-element">
							<label class="slds-form-element__label">Formstack Resource</label>
							<div class="slds-form-element__control">
								<apex:selectRadio value="{!resourceType}" styleClass="radio-table">
									<apex:selectOptions value="{!resourceRadioOptions}" />
									<apex:actionSupport event="onchange" action="{!populateRemoteDocuments}" rerender="remoteDocumentContainer" status="loadingDocs"/>
								</apex:selectRadio>
								<apex:actionStatus id="loadingDocs" startText="Loading..." />
							</div>
						</div>
 						
	 					<apex:outputPanel id="remoteDocumentContainer">
	 					<div class = "slds-form-element">
							<label class="slds-form-element__label"><apex:outputText value="Select a Document" rendered="{!IF(resourceType == 'Document', true, false)}" /> <apex:outputText value="Select a Route" rendered="{!IF(resourceType == 'Route', true, false)}" /> <span style = "color: red">*</span></label><br />
							<div class="slds-form-element__control">
								<apex:selectList value="{!webm__Webmerge_Mapping__c.webm__Webmerge_Document_Id__c}" size="1" styleClass="slds-select">
									<apex:selectOptions value="{!remoteDocumentOptions}" />
								</apex:selectList>
							</div>
						</div>
						</apex:outputPanel>
                                                 
                          <fieldset class = "slds-form-element">
                          	<legend class="slds-form-element__label slds-form-element__label--top">Optional Settings</legend>
                          	
                          	  <div class="slds-form-element__control">
                               <apex:outputLabel for="testMode">
                               	 <apex:inputField id="testMode" value="{!webm__Webmerge_Mapping__c.webm__Test_Mode__c}" />&nbsp;&nbsp;
                               	 <span class="slds-form-element__label">Run in Test Mode</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="batch">
                               	 <apex:inputField id="batch" value="{!webm__Webmerge_Mapping__c.webm__Batch__c}" />&nbsp;&nbsp;
                               	 <span class="slds-form-element__label">Run in Batch Mode (process document behind-the-scenes)</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="preview">
                               	 <apex:inputField id="preview" value="{!webm__Webmerge_Mapping__c.webm__Preview__c}" />&nbsp;&nbsp;
                               	 <span class="slds-form-element__label">Allow Users to Preview Document</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="saveAttachment">
                               	 <apex:inputField id="saveAttachment" value="{!webm__Webmerge_Mapping__c.webm__Save_Attachment__c}" />&nbsp;&nbsp;
                                 <span class="slds-form-element__label">Save Documents as Attachments</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="saveFile">
                               	 <apex:inputField id="saveFile" value="{!webm__Webmerge_Mapping__c.webm__Save_File__c}" />&nbsp;&nbsp;
                                 <span class="slds-form-element__label">Save Documents in Files</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="downloadFile">
                                 <apex:inputField id="downloadFile" value="{!webm__Webmerge_Mapping__c.webm__Download_File__c}" />&nbsp;&nbsp;
                                 <span class="slds-form-element__label">Immediately Download/Open File</span>
                               </apex:outputLabel>
                              </div>
                              <div class="slds-form-element__control">
                               <apex:outputLabel for="postToChatter">
                                 <apex:inputField id="postToChatter" styleClass="post-to-chatter" value="{!webm__Webmerge_Mapping__c.webm__Post_to_Chatter__c}" onclick="if(this.checked){$('.chatter-feeds').show();}else{$('.chatter-feeds').hide();}" />&nbsp;&nbsp;
                                 <span class="slds-form-element__label">Post Documents to Chatter</span>
                               </apex:outputLabel>
								<apex:selectList id="chatter_feeds" value="{!webm__Webmerge_Mapping__c.webm__Post_to_Chatter_Feeds__c}" size="1" styleClass="slds-select chatter-feeds" style="width:auto; display:inline; margin-left:10px;">
		   							<apex:selectOptions value="{!chatterFeeds}" />
		   						</apex:selectList>
		   						<script type="text/javascript">
		   							if(!$('.post-to-chatter').prop('checked')){
		   								$('.chatter-feeds').hide();
		   							}
		   						</script>
                             </div>
                          </fieldset>
                  
                          <hr />
                              
                          <div class="slds-text-heading--medium">Field Mapping</div><br />
                          
                          <apex:outputPanel id="fieldMappingsContainer">
                              <table class="table slds-table slds-table--bordered" id="sfFieldSelectTable">
                                  <thead>
                                      <tr class="slds-text-heading--label">
                                          <th>Formstack Field</th>
                                          <th>Salesforce Field</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <apex:repeat value="{!fieldMappings}" var="mapping">
                                          <tr class="field-mapping">
                                              <td>
                                                  <span class="wm-field-name">{!mapping.Webmerge_Field_Name__c}</span>
                                              </td>
                                              <td>
                                                 	<div style = "position: relative">
                                                      <apex:inputText id="sfObjectField" value="{!mapping.webm__Salesforce_Field_Name__c}" styleClass="slds-input autocomplete" html-placeholder="--None--"  />
                                                      <apex:inputHidden id="sfObjectFieldId" value="{!mapping.webm__Salesforce_Field_Id__c}" />
                                                      <span class = "caret"></span>
                                                  </div>
                                                  <div class="row text-input-label" style="{!IF(mapping.Salesforce_Field_Id__c == '<<text>>' || mapping.Salesforce_Field_Id__c == '<<textarea>>' || mapping.Salesforce_Field_Id__c == '<<select>>' || mapping.Salesforce_Field_Id__c == '<<radio>>' || mapping.Salesforce_Field_Id__c == '<<checkbox>>' || mapping.Salesforce_Field_Id__c == '<<file>>', '', 'display:none;')} margin-top:1em;">
                                                  	<div class="col-md-2" style="margin-top:0.5em">Label:</div>
                                                  	<div class="col-md-10">
    													<apex:inputText id="sfTextFieldLabel" value="{!mapping.webm__Text_Input_Label__c}" styleClass="slds-input" html-placeholder="Enter field label..."  />                                              	
                                                  	</div>
                                                  </div>                                                  
                                                  <div class="row text-input-options" style="{!IF(mapping.webm__Salesforce_Field_Id__c == '<<select>>' || mapping.webm__Salesforce_Field_Id__c == '<<radio>>' || mapping.webm__Salesforce_Field_Id__c == '<<checkbox>>' || mapping.webm__Salesforce_Field_Id__c == '<<soql>>', '', 'display:none;')} margin-top:1em;">
                                                  	<div class="col-md-2 text-input-options-label" style="margin-top:0.5em">{!IF(mapping.webm__Salesforce_Field_Id__c == '<<soql>>', 'SOQL Query', 'Options (1 per line)')}:</div>
                                                  	<div class="col-md-10">
    													<apex:inputTextarea id="sfTextFieldOptions" value="{!mapping.webm__Text_Input_Options__c}" styleClass="slds-textarea"  />                                              	
                                                  	</div>
                                                  </div>
                                                  <div class="row text-input-label" style="{!IF(mapping.webm__Salesforce_Field_Id__c == '<<text>>' || mapping.webm__Salesforce_Field_Id__c == '<<textarea>>' || mapping.webm__Salesforce_Field_Id__c == '<<select>>' || mapping.webm__Salesforce_Field_Id__c == '<<radio>>' || mapping.webm__Salesforce_Field_Id__c == '<<checkbox>>' || mapping.webm__Salesforce_Field_Id__c == '<<file>>' || contains(mapping.webm__Salesforce_Field_Id__c, '-select') || contains(mapping.webm__Salesforce_Field_Id__c, '-multiselect'), '', 'display:none;')} margin-top:1em;">
                                                  	<apex:outputLabel for="required">
                               	 						<div class="col-md-2" style="margin-top:0.5em">Required?</div>
	                                                  	<div class="col-md-10">
	    													<apex:inputField id="required" value="{!mapping.webm__Text_Input_Required__c}" />                                            	
	                                                  	</div>
	                                                </apex:outputLabel>
	                                              </div>
                                              </td>
                                          </tr>
                                      </apex:repeat>
                                  </tbody>
                              </table>
                              <div align="right" style="padding-top:1em">
                              	<a href="javascript://" onclick="$('.sf-import-fields').toggle();">Import</a> /
                              	<a href="javascript://" onclick="$('.sf-export-fields').toggle();">Export</a>
                              </div>
                              <div align="left" class="sf-import-fields hidden">
                              		<p>Insert JSON</p>
                              		<apex:inputTextarea id="sfImportFields" value="{!importFieldsJSON}" styleClass="slds-textarea" /> 
                              </div>
                              <div align="left" class="sf-export-fields hidden">
                              		<p>Copy &amp; paste this JSON to another mapping</p>
                              		<apex:inputTextarea id="sfExportFields" value="{!exportFieldsJSON}" readonly="true" styleClass="slds-textarea"  />  
                              </div>
                              
                          </apex:outputPanel>
                      </div>
                  </div>
                                      
                  <hr />
                  
                  <apex:outputPanel id="autogenerationOption" rendered="{!credentials.webm__Use_Triggers__c}">
	                  <div class = "slds-grid slds-col--padded">
	                      <div class = "slds-large-size--8-of-12">
	                          <div class="slds-form-element">
	                              <apex:outputLabel for="autogen">
	                              	<apex:inputField id="autogen" value="{!webm__Webmerge_Mapping__c.webm__Autogenerate__c}">
		                                   <apex:actionSupport event="onchange" rerender="autogenerationOuter" oncomplete="bootstrapAutocomplete()"/>
		                              </apex:inputField>
		                              &nbsp;
	                              	Automatically generate the documents given the following rule <em>(Account, Contact, Lead, &amp; Opportunity)</em>
	                              </apex:outputLabel> 
	                          </div>
	                      </div>
	                  </div>
	              </apex:outputPanel>

                  <apex:outputPanel id="autogenerationOuter" >
                      <apex:outputPanel id="autogeneration" rendered="{!webm__Webmerge_Mapping__c.webm__Autogenerate__c}" >
                      
                          <div class = "slds-grid slds-col--padded">
                              <div class = "slds-large-size--8-of-12">
                                  <h5 style = "display: block;">Evaluate the following rule when a record is:</h5> 
                                  <p>
                                      <apex:inputField value="{!webm__Webmerge_Mapping__c.webm__Evaluation_Criteria__c}" styleClass="slds-select" />
                                  </p>
                              </div>
                          </div>
                          <div class = "slds-grid slds-col--padded">
                              <div class = "slds-large-size--12-of-12">
                          
                                  <h5 style = "display: block; margin-top: 1.5em; margin-bottom:1em;">Generate this document automatically when the following criteria are met:</h5>
                                                      
                                  <apex:outputPanel id="mappingCriterion">

                                      <apex:actionFunction name="recalcType" action="{!recalculateType}" rerender="mappingCriterionValue" status="change" oncomplete="bootstrapAutocomplete()">
                                          <apex:param name="changedCrit" assignTo="{!criteriaToRecalculate}" value=""/>
                                      </apex:actionFunction>

                                      <table class = "table slds-table slds-table--bordered">
                                  
                                          <thead>
                                              <tr class="slds-text-heading--label">
                                                  <th>Field</th>
                                                  <th>Operator</th>
                                                  <th>Value</th>  
                                              </tr>
                                          </thead>
                                          <tbody>
                                          <apex:repeat value="{!mappingCriteria}" var="c">
                                          <tr>
                                              <td>
                                                  <div style = "position:relative">
                                                      <apex:inputText styleClass="slds-input critField" id="sfCritField" value="{!c.crit.webm__Field__c}" html-placeholder="--None--" />
                                                      <apex:inputHidden id="sfCritFieldId" value="{!c.crit.webm__Field__c}" />
                                                      <apex:inputHidden id="sfCritFieldWrapperId" value="{!c.wrapperId}" />
                                                      <span class = "caret"></span>
                                                  </div>
                                              </td>
                                              <td>
                                                  <apex:selectList value="{!c.crit.webm__Operator__c}" size="1" styleClass="slds-select">
                                                      <apex:selectOption itemValue="equals" itemLabel="equals" />
                                                      <apex:selectOption itemValue="not equal to" itemLabel="not equal to" />
                                                      <apex:selectOption itemValue="less than" itemLabel="less than" />
                                                      <apex:selectOption itemValue="greater than" itemLabel="greater than" />
                                                      <apex:selectOption itemValue="less or equal" itemLabel="less or equal" />
                                                      <apex:selectOption itemValue="greater or equal" itemLabel="greater or equal" />
                                                      <apex:selectOption itemValue="contains" itemLabel="contains" />
                                                      <apex:selectOption itemValue="does not contain" itemLabel="does not contain" />
                                                  </apex:selectList>
                                              </td>
                                              <td>
                                              <apex:outputPanel id="mappingCriterionValue">

                                                  <!--  TEXT FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'STRING', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  COMBOBOX FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'COMBOBOX', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  DATE FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'DATE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  TEXTAREA FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'TEXTAREA', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  URL FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'URL', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  EMAIL FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'EMAIL', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  PERCENT FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'PERCENT', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  INTEGER FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'INTEGER', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  DOUBLE FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'DOUBLE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  REFERENCE FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'REFERENCE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  CURRENCY FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'CURRENCY', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  PHONE FIELD -->
                                                  <apex:inputField value="{!c.crit.webm__Value__c}" rendered="{!IF(c.fieldType == 'PHONE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  BOOLEAN FIELD -->
                                                  <apex:selectList value="{!c.crit.webm__Value__c}" size="1" rendered="{!IF(c.fieldType =='BOOLEAN', TRUE, FALSE)}" styleClass="slds-select">
                                                      <apex:selectOption itemValue="true" itemLabel="true" />
                                                      <apex:selectOption itemValue="false" itemLabel="false" />
                                                  </apex:selectList>
                                                  
                                                  <!-- PICKLIST FIELD -->
                                                  <apex:selectList value="{!c.crit.webm__Value__c}" size="1" rendered="{!IF(c.fieldType=='PICKLIST', TRUE, FALSE)}" styleClass="slds-select">
                                                      <apex:selectOptions value="{!c.fieldOptions}" />
                                                  </apex:selectList>
                                              </apex:outputPanel>
                                              </td>
                                          </tr>          
                                          </apex:repeat>
                                          </tbody>
                                      </table>
                                      <apex:actionStatus id="change" startText="Recalculating Field Type..." />
                                  </apex:outputPanel>
                              </div>
                          </div>
                          <hr />
                      </apex:outputPanel>
                  </apex:outputPanel>
                  
                  <div class = "slds-grid slds-col--padded">
                      <div class = "slds-large-size--8-of-12">
                          <div class="slds-form-element">
                              <apex:outputLabel for="mapping_filter">
                              	<apex:inputField id="mapping_filter" value="{!webm__Webmerge_Mapping__c.webm__Filter__c}">
                                   <apex:actionSupport event="onchange" rerender="filterOuter" oncomplete="bootstrapAutocomplete()"/>
                              	</apex:inputField>
                              	&nbsp;
                              	Only show this mapping given the following rule
                              </apex:outputLabel> 
                          </div>
                      </div>
                  </div>
                  
                  <apex:outputPanel id="filterOuter">
                      <apex:outputPanel id="filter" rendered="{!webm__Webmerge_Mapping__c.webm__Filter__c}" >
                      	
                      	<div class = "slds-grid slds-col--padded">
                              <div class = "slds-large-size--12-of-12">
                                  <h5 style = "display: block; margin-bottom:1em;">Show this mapping if:</h5> 
                                  <p>
                                      <apex:inputField value="{!webm__Webmerge_Mapping__c.webm__Filter_Type__c}" styleClass="slds-select" />
                                  </p>
                              </div>
                          </div>
                          <Br />
                          <div class = "slds-grid slds-col--padded">
                              <div class = "slds-large-size--12-of-12">
                                             
                                  <apex:outputPanel id="mappingFilter">

                                      <apex:actionFunction name="recalcFilterType" action="{!recalculateFilterType}" rerender="mappingFilterValue" status="change" oncomplete="bootstrapAutocomplete()">
                                          <apex:param name="changedFilter" assignTo="{!filterToRecalculate}" value=""/>
                                      </apex:actionFunction>

                                      <table class = "table slds-table slds-table--bordered">
                                  
                                          <thead>
                                              <tr class="slds-text-heading--label">
                                                  <th>Field</th>
                                                  <th>Operator</th>
                                                  <th>Value</th>  
                                              </tr>
                                          </thead>
                                          <tbody>
                                          <apex:repeat value="{!mappingFilter}" var="f">
                                          <tr>
                                              <td>
                                                  <div style = "position:relative">
                                                      <apex:inputText styleClass="slds-input filterField" id="sfFilterField" value="{!f.filter.webm__Field__c}" html-placeholder="--None--" />
                                                      <apex:inputHidden id="sfFilterFieldId" value="{!f.filter.webm__Field__c}" />
                                                      <apex:inputHidden id="sfFilterFieldWrapperId" value="{!f.wrapperId}" />
                                                      <span class = "caret"></span>
                                                  </div>
                                              </td>
                                              <td>
                                                  <apex:selectList value="{!f.filter.webm__Operator__c}" size="1" styleClass="slds-select">
                                                      <apex:selectOption itemValue="equals" itemLabel="equals" />
                                                      <apex:selectOption itemValue="not equal to" itemLabel="not equal to" />
                                                      <apex:selectOption itemValue="less than" itemLabel="less than" />
                                                      <apex:selectOption itemValue="greater than" itemLabel="greater than" />
                                                      <apex:selectOption itemValue="less or equal" itemLabel="less or equal" />
                                                      <apex:selectOption itemValue="greater or equal" itemLabel="greater or equal" />
                                                  </apex:selectList>
                                              </td>
                                              <td>
                                              <apex:outputPanel id="mappingFilterValue">

                                                  <!--  TEXT FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'STRING', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  COMBOBOX FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'COMBOBOX', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  DATE FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'DATE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  TEXTAREA FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'TEXTAREA', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  URL FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'URL', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  EMAIL FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'EMAIL', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  PERCENT FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'PERCENT', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  INTEGER FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'INTEGER', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  DOUBLE FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'DOUBLE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  REFERENCE FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'REFERENCE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  CURRENCY FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'CURRENCY', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  PHONE FIELD -->
                                                  <apex:inputField value="{!f.filter.webm__Value__c}" rendered="{!IF(f.fieldType == 'PHONE', TRUE, FALSE)}" styleClass="slds-input" />
                                                  
                                                  <!--  BOOLEAN FIELD -->
                                                  <apex:selectList value="{!f.filter.webm__Value__c}" size="1" rendered="{!IF(f.fieldType =='BOOLEAN', TRUE, FALSE)}" styleClass="slds-select">
                                                      <apex:selectOption itemValue="true" itemLabel="true" />
                                                      <apex:selectOption itemValue="false" itemLabel="false" />
                                                  </apex:selectList>
                                                  
                                                  <!-- PICKLIST FIELD -->
                                                  <apex:selectList value="{!f.filter.webm__Value__c}" size="1" rendered="{!IF(f.fieldType=='PICKLIST', TRUE, FALSE)}" styleClass="slds-select">
                                                      <apex:selectOptions value="{!f.fieldOptions}" />
                                                  </apex:selectList>
                                              </apex:outputPanel>
                                              </td>
                                          </tr>          
                                          </apex:repeat>
                                          </tbody>
                                      </table>
                                      <apex:actionStatus id="filter_change" startText="Recalculating Field Type..." />
                                  </apex:outputPanel>
                              </div>
                          </div>
                      </apex:outputPanel>
                  </apex:outputPanel>
                  
                  <hr />
                  
                  <div class = "slds-grid slds-col--padded">
                      <div class = "slds-large-size--8-of-12">
                          <apex:commandButton value="Save" action="{!updateMapping}" styleClass="slds-button slds-button--brand slds-float--right" style="margin-left: 15px" />
                          <apex:commandButton value="Save & Activate" action="{!saveAndActivate}" rendered="{!IF(webm__Webmerge_Mapping__c.webm__Active__c == true, false, true)}" styleClass="slds-button slds-button--brand slds-float--right" style="margin-left: 15px" />
                          <apex:commandButton value="Cancel" action="{!doCancel}" styleClass="slds-button slds-button--brand slds-button--inverse slds-float--right" />  
                      </div> 
                  </div>          
              </apex:form>
          </apex:outputPanel>
    </div>

     <script type= "text/javascript">

        //Autocomplete data for criteria mapping
        var criteriaFields = [{!critAutocompleteString}];

        function bootstrapAutocomplete()
        {   

            $( ".critField" ).each( function(index, element) {
                var result = _.findWhere(criteriaFields, {value: $(this).val()});
                if (result){
                    $(this).val(result.label);
                }
            });

            $( ".critField" ).autocomplete({
                minLength: 0,
                source: criteriaFields,
                focus: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    return false;
                },
                select: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    var elementId = $(event['target']).attr('id') + 'Id';
                    $(document.getElementById(elementId)).val( ui.item.value );

                    var wrapperId = $(event['target']).attr('id') + 'WrapperId';
                    recalcType($(document.getElementById(wrapperId)).val());   //call apex:actionFunction

                    return false;
                }
            }).on('click', function(){
                $(this).autocomplete('search', $(this).val());
            }).on('blur', function(event){

                var elementId = $(event['target']).attr('id') + 'Id';

                if($(this).val() === '')
                {
                    console.log('UPDATING ' + elementId);
                    $(document.getElementById(elementId)).val('');
                }

                var wrapperId = $(event['target']).attr('id') + 'WrapperId';
                recalcType($(document.getElementById(wrapperId)).val());   //call apex:actionFunction

                var results = _.findWhere(criteriaFields, {label: $(this).val()});

                if(results || $(this).val() === ''){
                    $(this).css('background', '#fff');
                    $(this).css('color', '#000');
                } else {
                	$(this).css('background', '#CB6769');
	                $(this).css('color', 'white');
                    $(document.getElementById(elementId)).val('');
                }

            });
            
            
            $( ".filterField" ).each( function(index, element) {
                var result = _.findWhere(criteriaFields, {value: $(this).val()});
                if (result){
                    $(this).val(result.label);
                }
            });

            $( ".filterField" ).autocomplete({
                minLength: 0,
                source: criteriaFields,
                focus: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    return false;
                },
                select: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    var elementId = $(event['target']).attr('id') + 'Id';
                    $(document.getElementById(elementId)).val( ui.item.value );

                    var wrapperId = $(event['target']).attr('id') + 'WrapperId';
                    recalcFilterType($(document.getElementById(wrapperId)).val());   //call apex:actionFunction

                    return false;
                }
            }).on('click', function(){
                $(this).autocomplete('search', '');
            }).on('blur', function(event){

                var elementId = $(event['target']).attr('id') + 'Id';

                if($(this).val() === '')
                {
                    console.log('UPDATING ' + elementId);
                    $(document.getElementById(elementId)).val('');
                }

                var wrapperId = $(event['target']).attr('id') + 'WrapperId';
                recalcFilterType($(document.getElementById(wrapperId)).val());   //call apex:actionFunction

                var results = _.findWhere(criteriaFields, {label: $(this).val()});

                if(results || $(this).val() === ''){
                    $(this).css('background', '#fff');
                    $(this).css('color', '#000');
                } else {
                    $(this).css('background', '#CB6769');
                    $(this).css('color', 'white');
                    $(document.getElementById(elementId)).val('');
                }

            });
            

        }

        $(function() {

            bootstrapAutocomplete();

            //Autocomplete data for field mapping
            var availableFields = [{!autocompleteString}];

             $( "#sfFieldSelectTable input[type=hidden]" ).each( function(index, element) {
                var result = _.findWhere(availableFields, {value: $(this).val()});
                var elementId = element['id'].split('Id');
                if (result && elementId){
                    $(document.getElementById(elementId[0])).val(result.label);
                }
            });

            $( "#sfFieldSelectTable input.autocomplete" ).autocomplete({
                minLength: 0,
                source: availableFields,
                focus: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    return false;
                },
                select: function( event, ui ) {
                    $(event['target']).val( ui.item.label );
                    var elementId = $(event['target']).attr('id') + 'Id';
                    $(document.getElementById(elementId)).val( ui.item.value );
                    return false;
                }
            }).on('click', function(){
                $(this).autocomplete('search', $(this).val());
            }).on('blur', function(event){

                var elementId = $(event['target']).attr('id') + 'Id';
                var val = $(this).val();

                if(val === '')
                {
                    $(document.getElementById(elementId)).val('');
                }

                var elementId = $(event['target']).attr('id') + 'Id';

                var results = _.findWhere(availableFields, {label: $(this).val()});

                if(results || $(this).val() === ''){
                    $(this).css('background', '#fff');
                    $(this).css('color', '#000');
                } else {
                	if($(this).val().indexOf('|')){
                		//they typed in their own relationship query like:
                		//parent.child|parentRel.childRel
                		//Case.HealthCloudGA__CarePlanProblem__c|Cases.HealthCloudGA__CarePlanProblems__r
                	}else{
	                    $(this).css('background', '#CB6769');
	                    $(this).css('color', 'white');
                    }
                    $(document.getElementById(elementId)).val(val);
                }
                
                if(val == '<< Text Input >>' || val == '<< Text Input (Long) >>' || val == '<< Dropdown >>' || val == '<< Radio Buttons >>' || val == '<< Checkboxes >>' || val == '<< SOQL Query >>'){
                	var mapping = $(this).closest('.field-mapping');
                	var wm_field = $(mapping).find('.wm-field-name').html();
                	
                	var nameLength = wm_field.length;
	                
	                for(var i = 0; i < nameLength; i++){
	                    
	                    if(wm_field[i] == null || wm_field[i] == ' '){
	                        continue;    
	                    }
	                    
	                    if(i > 0 && wm_field[i] == wm_field[i].toUpperCase()){
	                        wm_field = wm_field.substr(0, i) + ' ' + wm_field.substr(i);
	                        nameLength++; 
	                        i++;  
	                    }
	                    
	                    if(i > 50){
	                     break;   
	                    }
	                }
	                 
                	wm_field = (wm_field.replace(/[_]/ig, ' ').toLowerCase() + '').replace(/^([a-z])|\s+([a-z])/g, function ($1) {
						return $1.toUpperCase().replace(/[  ]+/ig, ' ');
					});
					
					if(val == '<< SOQL Query >>'){
						$(mapping).find('.text-input-options-label').html('SOQL Query');
					}else{
	                	$(mapping).find('.text-input-label').show();
	                	$(mapping).find('.text-input-label input[type=text]').val(wm_field);
                	}
                	
                	if(val == '<< Dropdown >>' || val == '<< Radio Buttons >>' || val == '<< Checkboxes >>' || val == '<< SOQL Query >>'){
                		$(mapping).find('.text-input-options').show();
                	}
                }else{
                	var mapping = $(this).closest('.field-mapping');
                	$(mapping).find('.text-input-label').hide();
                	$(mapping).find('.text-input-options').hide();
                }

            });
            
            $('.field-mapping').each(function(x, item){
            	if($(item).find('input[type=hidden]').val() == '<<text>>'){
            		$(item).find('.text-input-label').show();
            	}
            });

        });

    </script>

</apex:page>