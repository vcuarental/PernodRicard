global with sharing class ASI_MFM_RM_GenPOReceipt_Sche implements Schedulable {
/********************************
 * Created by: SH Ho    
 * Created Date: 2019-01-02
 * Objective: Schedule job to auto generate PO receipt with PO line which G/L Date is today
 * Module: MFM RM
******************************/
    
    public void execute(SchedulableContext SC){
        system.debug('execute start');
        init();
        system.debug('execute end');
    }    
    
    public void init(){
        system.debug('Start running Gen PO Receipt scheduler');        
        
        Id RMPORrtId = Global_RecordTypeCache.getRtId('ASI_MFM_PO_Receipt__cASI_MFM_RM_PO_Receipt');
        Id RMPORIrtId = Global_RecordTypeCache.getRtId('ASI_MFM_PO_Receipt_Item__cASI_MFM_RM_PO_Receipt_Item');
        Id RMPOLrtId = Global_RecordTypeCache.getRtId('ASI_MFM_PO_Line_Item__cASI_MFM_RM_PO_Line_Item');                 
        
        // Create PO receipt header
        Set<Id> PORHeaderid = new Set<id>();
        List<ASI_MFM_PO_Receipt__c> poReceiptList = new List<ASI_MFM_PO_Receipt__c>();
        ASI_MFM_PO_Receipt__c RMPOR = new ASI_MFM_PO_Receipt__c(ASI_MFM_Remarks__c = 'Generated by batch at ' + Datetime.Now().format('yyyy-MM-dd HH:mm:ss',  UserInfo.getTimeZone().getID()),
                                                                    ASI_MFM_Status__c = 'Final',
                                                                    recordtypeId = RMPORrtId);
                                                          
        poReceiptList.add(RMPOR);
        
        Savepoint sp = Database.setSavepoint();
        Database.SaveResult[] srList = Database.insert(poReceiptList, false);
        
        Id RMPORHeaderId;
        for(Database.SaveResult sr: srList){
            if(sr.isSuccess()){
                system.debug('PO Receipt header creates successful'); 
                PORHeaderid.add(sr.getId());
            }else{
                for(Database.Error err : sr.getErrors()) {
                    System.debug('The following error has occurred.');                   
                    System.debug(err.getStatusCode() + ': ' + err.getMessage());
                    System.debug('PO Receipt fields that affected this error: ' + err.getFields());        
                }
                Database.rollback(sp);
            }
        }
        system.debug('PORHeaderID size: ' + PORHeaderId.size());
        if(PORHeaderId != null){
            for(ASI_MFM_PO_Receipt__c POR: [Select id, recordtypeId from ASI_MFM_PO_Receipt__c where id IN :PORHeaderId]){            

                RMPORHeaderId = POR.id;
            }
            database.executeBatch(new ASI_MFM_RM_GenPOReceipt_Batch(RMPORHeaderId, RMPOLrtId, RMPORIrtId));
        }
        
    }

}